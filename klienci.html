<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Klienci (CRM)</title>
<meta name="description" content="Panel klient√≥w ARKON CRM: lista, edycja, tagi, statusy, projekty/umowy/dokumenty, wyszukiwanie, import/eksport CSV/JSON, w≈Çasna struktura p√≥l.">
<style>
  :root{ --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2b8a57; --grid:#243059; --card:#0f1533; --line:#1c2750; --bad:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  input,select{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .chip{display:inline-flex;gap:6px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#cfe1ff}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:2fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--grid);text-align:left;vertical-align:top}
  th{font-size:13px;color:var(--muted)}
  tr.sel{outline:2px solid #67a1ff44}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .status.lead{background:#19224e}
  .status.q{background:#21305f}
  .status.w{background:#24336b}
  .status.c{background:#1d3d2f}
  .status.l{background:#4a1d1d}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .hl{background:#1a2553;padding:2px 6px;border-radius:6px}
  .small{font-size:12px;color:#aeb8da}
  .inline{display:inline-flex;gap:8px;align-items:center}

  /* Drawer (panel edycji) */
  .drawer{position:fixed;right:0;top:0;height:100%;width:480px;max-width:100%;background:linear-gradient(180deg,#0e1433,#0e173d);border-left:1px solid #2b3a77;box-shadow:-20px 0 60px #0008;transform:translateX(100%);transition:.25s;z-index:50;overflow:auto}
  .drawer.open{transform:none}
  .drawer .hd{position:sticky;top:0;background:#101a45;border-bottom:1px solid #2b3a77;padding:12px}
  .drawer .bd{padding:12px}
  .drawer h3{margin:0 0 6px 0}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
  .kv label{font-size:13px;color:#aeb8da}
  .kv input,.kv select,.kv textarea{width:100%}
  textarea{min-height:80px;resize:vertical}

  /* Projects */
  .projects h4{margin:8px 0}
  .project{background:#0d1530;border:1px solid #28356c;border-radius:8px;padding:8px;margin:8px 0}
  .project .row{justify-content:space-between}
  .list-reset{list-style:none;margin:0;padding:0}
  .doc{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #28356c}
  .doc:last-child{border-bottom:0}
  .doc small{opacity:.8}

  /* Modal: struktura p√≥l */
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:60}
  .modal.open{display:flex}
  .modal .box{width:820px;max-width:95vw;background:linear-gradient(180deg,#10173c,#111b48);border:1px solid #2b3a77;border-radius:12px;padding:14px}
  .modal h3{margin:0 0 10px 0}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .reorder{cursor:grab}

  @media print{ nav,.toolbar,.drawer,.modal{display:none!important} }
</style>
</head>
<body>

<header>
  <h1>Klienci ‚Ä¢ ARKON CRM</h1>
  <div class="muted">Lista klient√≥w, statusy, tagi, projekty, umowy i dokumenty. Edytor struktury p√≥l pozwala dodaƒá w≈Çasne kolumny.</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="kalkulator.html">Kalkulator</a>
  <a href="komponenty.html">Komponenty</a>
  <a href="dokumenty.html">Dokumenty</a>
  <a href="upload.html">Przesy≈Ç plik√≥w</a>
  <a href="chat.html">Komunikator</a>
  <a href="ustawienia.html">Ustawienia</a>
</nav>

<div class="wrap">
  <!-- TOOLBAR -->
  <div class="toolbar">
    <button id="btnAdd" class="btn ok">+ Nowy klient</button>
    <button id="btnSchema" class="btn">‚öô Struktura p√≥l</button>
    <button id="btnExportJSON" class="btn ghost">Eksport JSON</button>
    <label class="btn ghost">Import JSON<input id="importJSON" type="file" accept="application/json" hidden></label>
    <button id="btnCSV" class="btn ghost">CSV</button>
    <span class="pill">≈ÅƒÖcznie: <b id="countAll">0</b></span>
    <span class="pill">Widocznych: <b id="countVis">0</b></span>
    <span class="pill">Wybranych: <b id="countSel">0</b></span>
    <span class="pill">Autosave <span id="as" class="hl">ON</span></span>
  </div>

  <!-- FILTRY -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="üîé Szukaj: nazwa, e-mail, telefon, tag‚Ä¶" style="min-width:260px">
      <select id="fStatus">
        <option value="">Status (wszystkie)</option>
        <option value="LEAD">LEAD</option>
        <option value="ZAPYTANIE">ZAPYTANIE</option>
        <option value="W TOKU">W TOKU</option>
        <option value="KLIENT">KLIENT</option>
        <option value="UTRACONY">UTRACONY</option>
      </select>
      <select id="sort">
        <option value="name.asc">Sort: Nazwa ‚Üë</option>
        <option value="name.desc">Sort: Nazwa ‚Üì</option>
        <option value="created.desc">Sort: Najnowsze</option>
        <option value="created.asc">Sort: Najstarsze</option>
      </select>
      <input id="fTag" placeholder="Tag (np. pompa, fotowoltaika)">
      <button id="btnClearFilters" class="btn ghost">Wyczy≈õƒá filtry</button>
    </div>
  </div>

  <div class="grid cols-2">
    <!-- LISTA KLIENT√ìW -->
    <div class="card">
      <div class="muted" style="margin-bottom:6px">Kliknij wiersz, aby edytowaƒá w panelu po prawej. Zaznacz kilka (Ctrl/‚åò) ‚Äî operacje masowe wkr√≥tce.</div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead id="thead">
            <tr>
              <th>‚ñ∂</th>
              <th>Nazwa</th>
              <th>Status</th>
              <th>Kontakt</th>
              <th>Adres</th>
              <th>Tagi</th>
              <!-- pola w≈Çasne do≈ÇƒÖczƒÖ siƒô tutaj -->
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DRAWER ‚Äî EDYCJA -->
    <aside id="drawer" class="drawer" aria-label="Edycja klienta">
      <div class="hd">
        <div class="row">
          <h3 style="margin:0">Edycja klienta</h3>
          <div class="right">
            <button id="btnClose" class="btn ghost">Zamknij</button>
            <button id="btnDel" class="btn bad">Usu≈Ñ</button>
            <button id="btnDup" class="btn">Duplikuj</button>
          </div>
        </div>
      </div>
      <div class="bd">
        <div class="kv">
          <label>Nazwa</label><input id="e_name" placeholder="np. Jan Kowalski / Firma XYZ">
          <label>Status</label>
          <select id="e_status">
            <option>LEAD</option><option>ZAPYTANIE</option><option>W TOKU</option><option>KLIENT</option><option>UTRACONY</option>
          </select>
          <label>E-mail</label><input id="e_email" placeholder="email@domena.pl">
          <label>Telefon</label><input id="e_phone" placeholder="+48 ‚Ä¶">
          <label>Adres</label><input id="e_addr" placeholder="ulica, miasto">
          <label>Tagi (po przecinku)</label><input id="e_tags" placeholder="pompa, fotowoltaika">
          <label>Notatki</label><textarea id="e_notes" placeholder="Wa≈ºne uzgodnienia, terminy, itp."></textarea>
        </div>

        <!-- Pola w≈Çasne -->
        <h4 style="margin:14px 0 6px">Pola w≈Çasne</h4>
        <div id="customFields"></div>

        <!-- Projekty / umowy / dokumenty -->
        <div class="projects">
          <h4>Projekty</h4>
          <div class="small muted">Ka≈ºdy projekt mo≈ºe mieƒá umowy i dokumenty (linki/nazwy plik√≥w). To lokalny szkic ‚Äî do faktycznego uploadu u≈ºyj strony ‚ÄûPrzesy≈Ç plik√≥w‚Äù.</div>
          <div id="projList"></div>
          <div class="right" style="margin-top:8px">
            <button id="btnAddProject" class="btn ok">+ Dodaj projekt</button>
          </div>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- MODAL STRUKTURY -->
<div id="modalSchema" class="modal" role="dialog" aria-modal="true" aria-labelledby="schemaTitle">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h3 id="schemaTitle" style="margin:0">Struktura p√≥l (w≈Çasne kolumny)</h3>
      <div class="right">
        <button id="btnCloseSchema" class="btn ghost">Zamknij</button>
      </div>
    </div>
    <div class="muted" style="margin:6px 0 10px">Dodaj swoje pola do klient√≥w (np. ‚ÄûPowierzchnia domu [m¬≤]‚Äù, ‚Äû≈πr√≥d≈Ço leadu‚Äù). Dostƒôpne typy: tekst, liczba, lista (select), data, checkbox.</div>
    <div class="grid-3">
      <div>
        <label>Nazwa etykiety</label>
        <input id="s_label" placeholder="np. Powierzchnia [m¬≤]">
      </div>
      <div>
        <label>Klucz (bez spacji)</label>
        <input id="s_key" placeholder="np. powierzchnia_m2">
      </div>
      <div>
        <label>Typ</label>
        <select id="s_type">
          <option value="text">text</option>
          <option value="number">number</option>
          <option value="select">select</option>
          <option value="date">date</option>
          <option value="checkbox">checkbox</option>
        </select>
      </div>
    </div>
    <div style="margin-top:8px">
      <label>Opcje (dla ‚Äûselect‚Äù) ‚Äî rozdzielone przecinkami</label>
      <input id="s_opts" placeholder="np. A,B,C">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnAddField" class="btn ok">+ Dodaj pole</button>
      <button id="btnClearFields" class="btn bad">Wyczy≈õƒá wszystko</button>
    </div>

    <h4 style="margin:12px 0 6px">Aktywne pola</h4>
    <div id="schemaList"></div>
    <div class="right" style="margin-top:10px">
      <button id="btnSaveSchema" class="btn">Zapisz schemat</button>
    </div>
  </div>
</div>

<script>
'use strict';

/* ====== helpers ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL');
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const fmtDate = ts => new Date(ts).toLocaleString('pl-PL');

function textMatches(haystack, needle){
  if(!needle) return true;
  haystack = (haystack||'').toString().toLowerCase();
  needle = needle.toLowerCase();
  return haystack.includes(needle);
}

/* ====== storage keys ====== */
const LS = {
  clients: 'arkon_clients_v1',
  schema:  'arkon_clients_schema_v1'
};

/* ====== state ====== */
let clients = loadClients();
let schema  = loadSchema(); // [{key,label,type,opts?}]
let selectedIds = new Set();
let filter = { q:'', status:'', tag:'', sort:'name.asc' };
let openId = null; // id klienta otwartego w panelu

function loadClients(){
  try{ return JSON.parse(localStorage.getItem(LS.clients)||'[]'); }catch{ return []; }
}
function saveClients(){
  localStorage.setItem(LS.clients, JSON.stringify(clients));
  renderTable(); // od≈õwie≈º listƒô
}
function loadSchema(){
  try{ return JSON.parse(localStorage.getItem(LS.schema)||'[]'); }catch{ return []; }
}
function saveSchema(){
  localStorage.setItem(LS.schema, JSON.stringify(schema));
  renderTableHead();
  renderTable();
}

/* ====== seed (gdy pusto) ====== */
if(!clients.length){
  clients = [
    { id:uid(), created:Date.now()-86400000*3, name:'Jan Kowalski', status:'LEAD', email:'jan@kowalski.pl', phone:'+48 500 000 111', address:'Przemk√≥w', tags:['pompa'], notes:'Preferuje kontakt rano.', custom:{}, projects:[
      { id:uid(), name:'Pompa ciep≈Ça 12 kW', stage:'OFERTA', contracts:[{no:'U-2025/01',value:43000,status:'podpisana'}], docs:[{name:'Mapa do cel√≥w projektowych.pdf',size:120000} ] }
    ]},
    { id:uid(), created:Date.now()-86400000*2, name:'Firma XYZ Sp. z o.o.', status:'W TOKU', email:'biuro@xyz.pl', phone:'+48 600 100 200', address:'Legnica', tags:['fotowoltaika','serwis'], notes:'Serwis falownika Fronius.', custom:{}, projects:[]},
    { id:uid(), created:Date.now()-86400000, name:'Teresa Siek', status:'KLIENT', email:'teresa.siek@mail.com', phone:'+48 502 222 333', address:'G≈Çog√≥w', tags:['ocieplenie'], notes:'Do programu CP ‚Äî ocieplenie + stolarka.', custom:{}, projects:[]}
  ];
  saveClients();
}

/* ====== filtr/sort ====== */
$('#q').addEventListener('input', e=>{ filter.q = e.target.value.trim(); renderTable(); });
$('#fStatus').addEventListener('change', e=>{ filter.status = e.target.value; renderTable(); });
$('#fTag').addEventListener('input', e=>{ filter.tag = e.target.value.trim(); renderTable(); });
$('#sort').addEventListener('change', e=>{ filter.sort = e.target.value; renderTable(); });
$('#btnClearFilters').addEventListener('click', ()=>{ filter={q:'',status:'',tag:'',sort:'name.asc'}; $('#q').value=''; $('#fStatus').value=''; $('#fTag').value=''; $('#sort').value='name.asc'; renderTable(); });

/* ====== toolbar ====== */
$('#btnAdd').addEventListener('click', ()=>{ createClient(); });
$('#btnExportJSON').addEventListener('click', ()=>exportJSON());
$('#importJSON').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
$('#btnCSV').addEventListener('click', ()=>exportCSV());

/* ====== schema modal ====== */
$('#btnSchema').addEventListener('click', openSchemaModal);
$('#btnCloseSchema').addEventListener('click', closeSchemaModal);
$('#btnAddField').addEventListener('click', addSchemaField);
$('#btnClearFields').addEventListener('click', ()=>{ if(confirm('UsunƒÖƒá wszystkie pola w≈Çasne?')){ schema=[]; drawSchemaList(); }});
$('#btnSaveSchema').addEventListener('click', ()=>{ saveSchema(); alert('Zapisano schemat. Kolumny od≈õwie≈ºone.'); });

function openSchemaModal(){
  $('#modalSchema').classList.add('open');
  drawSchemaList();
}
function closeSchemaModal(){ $('#modalSchema').classList.remove('open'); }
function addSchemaField(){
  const label = $('#s_label').value.trim();
  const key   = ($('#s_key').value||'').trim();
  const type  = $('#s_type').value;
  const opts  = $('#s_opts').value.trim();
  if(!label || !key) return alert('Podaj etykietƒô i unikalny klucz.');
  if(schema.some(f=>f.key===key)) return alert('Klucz ju≈º istnieje.');
  const field = {label,key,type};
  if(type==='select') field.opts = opts.split(',').map(s=>s.trim()).filter(Boolean);
  schema.push(field);
  $('#s_label').value=''; $('#s_key').value=''; $('#s_opts').value='';
  drawSchemaList();
}
function drawSchemaList(){
  const box = $('#schemaList');
  box.innerHTML = '';
  if(!schema.length){ box.innerHTML = '<div class="muted">Brak dodatkowych p√≥l. Dodaj powy≈ºej.</div>'; return; }
  schema.forEach((f,i)=>{
    const row = document.createElement('div');
    row.className='row';
    row.style.margin='6px 0';
    row.innerHTML = `
      <span class="chip reorder" title="PrzeciƒÖgnij">‚ò∞</span>
      <span class="pill">${f.label}</span>
      <span class="muted">(${f.key} ‚Ä¢ ${f.type}${f.opts? ' ‚Ä¢ '+f.opts.join('/') : ''})</span>
      <span class="right" style="flex:1"></span>
      <button data-i="${i}" class="btn ghost s-up">‚Üë</button>
      <button data-i="${i}" class="btn ghost s-down">‚Üì</button>
      <button data-i="${i}" class="btn bad s-del">Usu≈Ñ</button>`;
    box.appendChild(row);
  });
  // actions
  box.querySelectorAll('.s-del').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.i; schema.splice(i,1); drawSchemaList(); }));
  box.querySelectorAll('.s-up').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.i; if(i>0){ [schema[i-1],schema[i]]=[schema[i],schema[i-1]]; drawSchemaList(); }}));
  box.querySelectorAll('.s-down').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.i; if(i<schema.length-1){ [schema[i+1],schema[i]]=[schema[i],schema[i+1]]; drawSchemaList(); }}));
}

/* ====== table render ====== */
function renderTableHead(){
  const tr = $('#thead tr');
  // usu≈Ñ stare kolumny custom (je≈õli by≈Çy)
  while(tr.children.length > 6) tr.removeChild(tr.lastElementChild);
  // dodaj nowe kolumny schema
  schema.forEach(f=>{
    const th = document.createElement('th');
    th.textContent = f.label;
    tr.appendChild(th);
  });
}
renderTableHead();

function renderTable(){
  // filtr + sort
  let rows = clients.slice();

  if(filter.q){
    const q = filter.q.toLowerCase();
    rows = rows.filter(c =>
      textMatches(c.name,q) || textMatches(c.email,q) || textMatches(c.phone,q) ||
      (c.tags||[]).some(t=>textMatches(t,q)) || textMatches(c.address,q) ||
      schema.some(f=> textMatches((c.custom||{})[f.key], q) )
    );
  }
  if(filter.status){ rows = rows.filter(c=>c.status===filter.status); }
  if(filter.tag){ const t=filter.tag.toLowerCase(); rows = rows.filter(c=>(c.tags||[]).some(x=>x.toLowerCase().includes(t))); }

  rows.sort((a,b)=>{
    switch(filter.sort){
      case 'name.asc':  return a.name.localeCompare(b.name,'pl',{sensitivity:'base'});
      case 'name.desc': return b.name.localeCompare(a.name,'pl',{sensitivity:'base'});
      case 'created.desc': return (b.created||0)-(a.created||0);
      case 'created.asc':  return (a.created||0)-(b.created||0);
      default: return 0;
    }
  });

  // licznik
  $('#countAll').textContent = clients.length;
  $('#countVis').textContent = rows.length;
  $('#countSel').textContent = selectedIds.size;

  const tb = $('#tbody');
  tb.innerHTML = '';
  rows.forEach(c=>{
    const tr = document.createElement('tr');
    if(selectedIds.has(c.id)) tr.classList.add('sel');
    tr.innerHTML = `
      <td><button class="btn ghost open" data-id="${c.id}" title="Otw√≥rz szczeg√≥≈Çy">‚ñ∂</button></td>
      <td><b>${c.name||'‚Äî'}</b><div class="small">${fmtDate(c.created||Date.now())}</div></td>
      <td><span class="status ${statusClass(c.status)}">${c.status||'‚Äî'}</span></td>
      <td>${c.email||''}<div class="small">${c.phone||''}</div></td>
      <td>${c.address||''}</td>
      <td>${(c.tags||[]).map(t=><span class="tag">${escapeHtml(t)}</span>).join('')}</td>
    `;
    // pola custom
    schema.forEach(f=>{
      const td = document.createElement('td');
      let v = (c.custom||{})[f.key];
      if(f.type==='checkbox') td.textContent = v ? 'TAK' : 'NIE';
      else td.textContent = v==null ? '' : v;
      tr.appendChild(td);
    });

    // wyb√≥r/otwieranie
    tr.addEventListener('click', (e)=>{
      if(e.metaKey || e.ctrlKey){
        if(selectedIds.has(c.id)) selectedIds.delete(c.id); else selectedIds.add(c.id);
        renderTable();
      }else{
        openDrawer(c.id);
      }
    });
    tb.appendChild(tr);
  });

  // przyciski otwarcia
  tb.querySelectorAll('.open').forEach(b=>b.addEventListener('click',(e)=>{ e.stopPropagation(); openDrawer(b.dataset.id); }));
}
function statusClass(s){
  switch((s||'').toUpperCase()){
    case 'LEAD': return 'lead';
    case 'ZAPYTANIE': return 'q';
    case 'W TOKU': return 'w';
    case 'KLIENT': return 'c';
    case 'UTRACONY': return 'l';
    default: return '';
  }
}
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* ====== CRUD ====== */
function createClient(){
  const c = { id:uid(), created:Date.now(), name:'Nowy klient', status:'LEAD', email:'', phone:'', address:'', tags:[], notes:'', custom:{}, projects:[] };
  clients.unshift(c);
  saveClients();
  openDrawer(c.id);
}
function deleteClient(id){
  const i = clients.findIndex(x=>x.id===id);
  if(i>=0){ clients.splice(i,1); saveClients(); if(openId===id) closeDrawer(); }
}
function duplicateClient(id){
  const src = clients.find(x=>x.id===id); if(!src) return;
  const copy = JSON.parse(JSON.stringify(src));
  copy.id = uid();
  copy.name = src.name + ' (kopia)';
  copy.created = Date.now();
  clients.unshift(copy);
  saveClients();
  openDrawer(copy.id);
}

/* ====== drawer (edycja) ====== */
const drawer = $('#drawer');
$('#btnClose').addEventListener('click', closeDrawer);
$('#btnDel').addEventListener('click', ()=>{ if(openId && confirm('UsunƒÖƒá klienta?')) deleteClient(openId); });
$('#btnDup').addEventListener('click', ()=>{ if(openId) duplicateClient(openId); });

function openDrawer(id){
  openId = id;
  const c = clients.find(x=>x.id===id); if(!c) return;
  drawer.classList.add('open');
  // podstawowe
  $('#e_name').value  = c.name||'';
  $('#e_status').value = c.status||'LEAD';
  $('#e_email').value = c.email||'';
  $('#e_phone').value = c.phone||'';
  $('#e_addr').value  = c.address||'';
  $('#e_tags').value  = (c.tags||[]).join(', ');
  $('#e_notes').value = c.notes||'';
  // custom
  renderCustomFields(c);
  // projects
  renderProjects(c);
}
function closeDrawer(){ drawer.classList.remove('open'); openId=null; }

['#e_name','#e_email','#e_phone','#e_addr','#e_tags','#e_notes'].forEach(sel=>{
  $(sel).addEventListener('input', debounce(saveEditor, 180));
});
$('#e_status').addEventListener('change', saveEditor);

function saveEditor(){
  if(!openId) return;
  const c = clients.find(x=>x.id===openId); if(!c) return;
  c.name   = $('#e_name').value.trim();
  c.status = $('#e_status').value;
  c.email  = $('#e_email').value.trim();
  c.phone  = $('#e_phone').value.trim();
  c.address= $('#e_addr').value.trim();
  c.tags   = $('#e_tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  c.notes  = $('#e_notes').value;
  // custom
  c.custom = c.custom||{};
  schema.forEach(f=>{
    const el = document.getElementById('cf_'+f.key);
    if(!el) return;
    let v;
    if(f.type==='checkbox') v = !!el.checked;
    else v = el.value;
    c.custom[f.key] = v;
  });
  saveClients();
}

/* ====== custom fields render ====== */
function renderCustomFields(c){
  const box = $('#customFields');
  box.innerHTML='';
  if(!schema.length){ box.innerHTML='<div class="muted">Brak p√≥l w≈Çasnych. Dodaj w ‚ÄûStruktura p√≥l‚Äù.</div>'; return; }
  schema.forEach(f=>{
    const row = document.createElement('div');
    row.className='kv';
    row.style.margin='6px 0';
    const id='cf_'+f.key;
    const val = (c.custom||{})[f.key];
    row.innerHTML = <label for="${id}">${escapeHtml(f.label)}</label>${inputForField(f,id,val)};
    box.appendChild(row);
    const el = row.querySelector('#'+id);
    el.addEventListener('input', debounce(saveEditor, 200));
    if(f.type==='checkbox') el.addEventListener('change', saveEditor);
  });
}
function inputForField(f,id,val){
  switch(f.type){
    case 'number': return <input id="${id}" type="number" value="${val??''}">;
    case 'date':   return <input id="${id}" type="date" value="${val??''}">;
    case 'select': return <select id="${id}">${(f.opts||[]).map(o=><option ${val===o?'selected':''}>${escapeHtml(o)}</option>).join('')}</select>;
    case 'checkbox': return <input id="${id}" type="checkbox" ${val?'checked':''}>;
    default:       return <input id="${id}" type="text" value="${val??''}">;
  }
}

/* ====== projects / contracts / docs ====== */
$('#btnAddProject').addEventListener('click', ()=>{
  if(!openId) return;
  const c = clients.find(x=>x.id===openId); if(!c) return;
  c.projects = c.projects || [];
  c.projects.push({ id:uid(), name:'Nowy projekt', stage:'OFERTA', contracts:[], docs:[] });
  saveClients();
  renderProjects(c);
});

function renderProjects(c){
  const box = $('#projList');
  box.innerHTML = '';
  (c.projects||[]).forEach((p,idx)=>{
    const div = document.createElement('div');
    div.className='project';
    div.innerHTML = `
      <div class="row">
        <div class="inline">
          <input data-k="name" data-p="${p.id}" value="${escapeHtml(p.name)}" style="min-width:260px">
          <select data-k="stage" data-p="${p.id}">
            ${['OFERTA','AUDYT','W REALIZACJI','ZAKO≈ÉCZONY','WSTRZYMANY'].map(s=><option ${p.stage===s?'selected':''}>${s}</option>).join('')}
          </select>
        </div>
        <div class="right">
          <button class="btn ghost" data-act="up" data-p="${p.id}">‚Üë</button>
          <button class="btn ghost" data-act="down" data-p="${p.id}">‚Üì</button>
          <button class="btn bad" data-act="del" data-p="${p.id}">Usu≈Ñ</button>
        </div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div>
          <h5>Umowy</h5>
          <ul class="list-reset" id="contracts_${p.id}">
            ${(p.contracts||[]).map((u,i)=>contractRowHtml(p.id,i,u)).join('')}
          </ul>
          <div class="row">
            <button class="btn ok" data-act="addContract" data-p="${p.id}">+ Umowa</button>
          </div>
        </div>
        <div>
          <h5>Dokumenty (nazwy/linki)</h5>
          <ul class="list-reset" id="docs_${p.id}">
            ${(p.docs||[]).map((d,i)=>docRowHtml(p.id,i,d)).join('')}
          </ul>
          <div class="row">
            <button class="btn ok" data-act="addDoc" data-p="${p.id}">+ Dokument</button>
            <span class="small muted">Do faktycznego przesy≈Çu plik√≥w u≈ºyj <a href="upload.html">Przesy≈Ç plik√≥w</a>.</span>
          </div>
        </div>
      </div>
    `;
    // listenery
    div.querySelectorAll('input[data-k],select[data-k]').forEach(el=>{
      el.addEventListener('input', debounce(()=>{ editProject(c.id, p.id, el.dataset.k, el.value); },200));
      el.addEventListener('change', ()=>{ editProject(c.id, p.id, el.dataset.k, el.value); });
    });
    div.querySelectorAll('[data-act]').forEach(b=>{
      b.addEventListener('click', ()=>{
        const act=b.dataset.act, pid=b.dataset.p;
        switch(act){
          case 'del': if(confirm('UsunƒÖƒá projekt?')) removeProject(c.id, pid); break;
          case 'up': moveProject(c.id, pid,-1); break;
          case 'down': moveProject(c.id, pid,1); break;
          case 'addContract': addContract(c.id, pid); break;
          case 'addDoc': addDoc(c.id, pid); break;
        }
      });
    });
    box.appendChild(div);
  });
}
function editProject(cid,pid,key,val){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  const p = (c.projects||[]).find(x=>x.id===pid); if(!p) return;
  p[key]=val;
  saveClients();
}
function removeProject(cid,pid){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  c.projects = (c.projects||[]).filter(x=>x.id!==pid);
  saveClients(); renderProjects(c);
}
function moveProject(cid,pid,dir){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  const arr=c.projects||[]; const i=arr.findIndex(x=>x.id===pid); if(i<0) return;
  const j=i+dir; if(j<0||j>=arr.length) return;
  [arr[i],arr[j]]=[arr[j],arr[i]];
  saveClients(); renderProjects(c);
}
function contractRowHtml(pid,i,u){
  return `<li class="doc">
    <div class="inline">
      <input data-act="c_no" data-p="${pid}" data-i="${i}" placeholder="Nr umowy" value="${u.no||''}">
      <input data-act="c_val" data-p="${pid}" data-i="${i}" type="number" placeholder="Warto≈õƒá [z≈Ç]" value="${u.value||''}">
      <select data-act="c_stat" data-p="${pid}" data-i="${i}">
        ${['podpisana','w toku','anulowana'].map(s=><option ${u.status===s?'selected':''}>${s}</option>).join('')}
      </select>
    </div>
    <div class="right">
      <button class="btn ghost" data-act="c_del" data-p="${pid}" data-i="${i}">Usu≈Ñ</button>
    </div>
  </li>`;
}
function docRowHtml(pid,i,d){
  return `<li class="doc">
    <div class="inline">
      <input data-act="d_name" data-p="${pid}" data-i="${i}" placeholder="Nazwa lub link" value="${d.name||''}" style="min-width:260px">
      <input data-act="d_size" data-p="${pid}" data-i="${i}" type="number" placeholder="Rozmiar [B]" value="${d.size||''}">
    </div>
    <div class="right">
      <button class="btn ghost" data-act="d_del" data-p="${pid}" data-i="${i}">Usu≈Ñ</button>
    </div>
  </li>`;
}
function addContract(cid,pid){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  const p = (c.projects||[]).find(x=>x.id===pid); if(!p) return;
  p.contracts = p.contracts||[];
  p.contracts.push({no:'',value:0,status:'w toku'});
  saveClients(); renderProjects(c);
  bindProjectLists(cid,pid);
}
function addDoc(cid,pid){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  const p = (c.projects||[]).find(x=>x.id===pid); if(!p) return;
  p.docs = p.docs||[];
  p.docs.push({name:'',size:0});
  saveClients(); renderProjects(c);
  bindProjectLists(cid,pid);
}
function bindProjectLists(cid,pid){
  const c = clients.find(x=>x.id===cid); if(!c) return;
  const p = (c.projects||[]).find(x=>x.id===pid); if(!p) return;

  // contracts
  const ulc = document.getElementById('contracts_'+pid);
  if(ulc){
    ulc.querySelectorAll('[data-act]').forEach(el=>{
      el.addEventListener('input', debounce(()=>handleContractInput(c,p,el),180));
      el.addEventListener('change', ()=>handleContractInput(c,p,el));
      if(el.dataset.act==='c_del') el.addEventListener('click', ()=>{ p.contracts.splice(+el.dataset.i,1); saveClients(); renderProjects(c); bindProjectLists(cid,pid); });
    });
  }
  // docs
  const uld = document.getElementById('docs_'+pid);
  if(uld){
    uld.querySelectorAll('[data-act]').forEach(el=>{
      el.addEventListener('input', debounce(()=>handleDocInput(c,p,el),180));
      el.addEventListener('change', ()=>handleDocInput(c,p,el));
      if(el.dataset.act==='d_del') el.addEventListener('click', ()=>{ p.docs.splice(+el.dataset.i,1); saveClients(); renderProjects(c); bindProjectLists(cid,pid); });
    });
  }
}
function handleContractInput(c,p,el){
  const i = +el.dataset.i;
  const it = p.contracts[i]; if(!it) return;
  switch(el.dataset.act){
    case 'c_no': it.no = el.value; break;
    case 'c_val': it.value = Number(el.value)||0; break;
    case 'c_stat': it.status = el.value; break;
  }
  saveClients();
}
function handleDocInput(c,p,el){
  const i = +el.dataset.i;
  const it = p.docs[i]; if(!it) return;
  switch(el.dataset.act){
    case 'd_name': it.name = el.value; break;
    case 'd_size': it.size = Number(el.value)||0; break;
  }
  saveClients();
}

/* po ka≈ºdym renderze projekt√≥w podpinamy s≈Çuchacze */
const obs = new MutationObserver(()=>{
  if(!openId) return;
  const c = clients.find(x=>x.id===openId); if(!c) return;
  (c.projects||[]).forEach(p=> bindProjectLists(c.id,p.id));
});
obs.observe($('#projList'), {childList:true, subtree:true});

/* ====== export/import ====== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({clients,schema},null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_klienci.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJSON(file){
  try{
    const txt = await file.text();
    const data = JSON.parse(txt);
    if(!data || !Array.isArray(data.clients)) throw new Error('Z≈Çy format.');
    clients = data.clients; schema = Array.isArray(data.schema) ? data.schema : schema;
    saveSchema(); saveClients();
    alert('Zaimportowano.');
  }catch(e){ alert('B≈ÇƒÖd importu: '+e.message); }
}
function exportCSV(){
  // p≈Çaska lista (bez projekt√≥w)
  const cols = ['id','created','name','status','email','phone','address','tags'].concat(schema.map(f=>f.key));
  const rows = [cols.join(';')];
  clients.forEach(c=>{
    const base = [c.id, new Date(c.created||Date.now()).toISOString(), escCsv(c.name), escCsv(c.status), escCsv(c.email), escCsv(c.phone), escCsv(c.address), escCsv((c.tags||[]).join('|'))];
    schema.forEach(f=> base.push(escCsv((c.custom||{})[f.key])));
    rows.push(base.join(';'));
  });
  const a = document.createElement('a');
  const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8'});
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_klienci.csv';
  a.click(); URL.revokeObjectURL(a.href);
}
function escCsv(v){ let s=(v==null?'':String(v)); if(/[;\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; }

/* ====== init ====== */
renderTable();

/* ===== debounce ===== */
function debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms||180); }; }

</script>
</body>
</html>