<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Klienci (CRM)</title>
<meta name="description" content="Panel klient√≥w ARKON CRM: lista, edycja, tagi, statusy, wyszukiwanie oraz zapis w localStorage (wsp√≥lne z baza.html).">
<style>
  :root{ --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2b8a57; --grid:#243059; --card:#0f1533; --line:#1c2750; --bad:#ff6b6b; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  textarea{min-height:80px;resize:vertical}
  .muted{color:var(--muted);font-size:13px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:2fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:10px;border-bottom:1px solid var(--grid);text-align:left;vertical-align:top}
  th{font-size:13px;color:var(--muted)}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .status.lead{background:#19224e}
  .status.q{background:#21305f}
  .status.w{background:#24336b}
  .status.c{background:#1d3d2f}
  .status.l{background:#4a1d1d}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .small{font-size:12px;color:#aeb8da}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}

  /* Drawer */
  .drawer{position:fixed;right:0;top:0;height:100%;width:520px;max-width:100%;background:linear-gradient(180deg,#0e1433,#0e173d);border-left:1px solid #2b3a77;box-shadow:-20px 0 60px #0008;transform:translateX(100%);transition:.25s;z-index:50;overflow:auto}
  .drawer.open{transform:none}
  .drawer .hd{position:sticky;top:0;background:#101a45;border-bottom:1px solid #2b3a77;padding:12px}
  .drawer .bd{padding:12px}
  .drawer h3{margin:0 0 6px 0}

  @media print{ nav,.toolbar,.drawer{display:none!important} }
</style>
</head>
<body>

<header>
  <h1>Klienci ‚Ä¢ ARKON CRM</h1>
  <div class="muted">Lista klient√≥w, statusy, tagi. Dane zapisujƒÖ siƒô w localStorage pod kluczem <code>arkon_clients_v1</code> (wsp√≥lne z <b>baza.html</b>).</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="kalkulator.html">Kalkulator</a>
  <a href="komponenty.html">Komponenty</a>
  <a href="dokumenty.html">Dokumenty</a>
  <a href="upload.html">Przesy≈Ç plik√≥w</a>
  <a href="chat.html">Komunikator</a>
  <a href="ustawienia.html">Ustawienia</a>
  <a href="lidy.html">Lidy</a>
  <a href="baza.html">Baza</a>
</nav>

<div class="wrap">
  <!-- TOOLBAR -->
  <div class="toolbar">
    <button id="btnAdd" class="btn ok">+ Nowy klient</button>
    <button id="btnExportJSON" class="btn ghost">Eksport JSON</button>
    <label class="btn ghost">Import JSON<input id="importJSON" type="file" accept="application/json" hidden></label>
    <button id="btnCSV" class="btn ghost">CSV</button>
    <span class="pill">≈ÅƒÖcznie: <b id="countAll">0</b></span>
    <span class="pill">Widocznych: <b id="countVis">0</b></span>
  </div>

  <!-- FILTRY -->
  <div class="card">
    <div class="row">
      <input id="q" placeholder="üîé Szukaj: nazwa, e-mail, telefon, tag‚Ä¶" style="min-width:260px">
      <select id="fStatus">
        <option value="">Status (wszystkie)</option>
        <option value="LEAD">LEAD</option>
        <option value="ZAPYTANIE">ZAPYTANIE</option>
        <option value="W TOKU">W TOKU</option>
        <option value="KLIENT">KLIENT</option>
        <option value="UTRACONY">UTRACONY</option>
      </select>
      <select id="sort">
        <option value="name.asc">Sort: Nazwa ‚Üë</option>
        <option value="name.desc">Sort: Nazwa ‚Üì</option>
        <option value="created.desc">Sort: Najnowsze</option>
        <option value="created.asc">Sort: Najstarsze</option>
      </select>
      <button id="btnClearFilters" class="btn ghost">Wyczy≈õƒá filtry</button>
    </div>
  </div>

  <div class="grid cols-2">
    <!-- LISTA KLIENT√ìW -->
    <div class="card">
      <div class="muted" style="margin-bottom:6px">Kliknij wiersz, aby edytowaƒá w panelu po prawej.</div>
      <div style="overflow:auto">
        <table id="tbl">
          <thead id="thead">
            <tr>
              <th>‚ñ∂Ô∏è</th>
              <th>Nazwa</th>
              <th>Status</th>
              <th>Kontakt</th>
              <th>Adres</th>
              <th>Tagi</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- DRAWER ‚Äî EDYCJA -->
    <aside id="drawer" class="drawer" aria-label="Edycja klienta">
      <div class="hd">
        <div class="row">
          <h3 style="margin:0">Edycja klienta</h3>
          <div class="right">
            <button id="btnClose" class="btn ghost" type="button">Zamknij</button>
            <button id="btnDel" class="btn bad" type="button">Usu≈Ñ</button>
            <button id="btnDup" class="btn" type="button">Duplikuj</button>
          </div>
        </div>
      </div>
      <div class="bd">
        <div class="row" style="flex-direction:column;gap:10px;align-items:stretch">
          <label>Nazwa<input id="e_name" placeholder="np. Jan Kowalski / Firma XYZ"></label>
          <label>Status
            <select id="e_status">
              <option>LEAD</option><option>ZAPYTANIE</option><option>W TOKU</option><option>KLIENT</option><option>UTRACONY</option>
            </select>
          </label>
          <label>E-mail<input id="e_email" placeholder="email@domena.pl"></label>
          <label>Telefon<input id="e_phone" placeholder="+48 ‚Ä¶"></label>
          <label>Adres<input id="e_addr" placeholder="ulica, miasto"></label>
          <label>Tagi (po przecinku)<input id="e_tags" placeholder="pompa, fotowoltaika"></label>
          <label>Notatki<textarea id="e_notes" placeholder="Wa≈ºne uzgodnienia, terminy, itp."></textarea></label>
        </div>
      </div>
    </aside>
  </div>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
const fmtDate = ts => new Date(ts).toLocaleString('pl-PL');
function escapeHtml(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'}[c])); }
function textMatches(h, n){ if(!n) return true; h=(h||'').toString().toLowerCase(); n=n.toLowerCase(); return h.includes(n); }

/* ===== storage keys (zgodne z baza.html) ===== */
const LS_CLIENTS = 'arkon_clients_v1';

/* ===== state ===== */
let clients = load(LS_CLIENTS, []);
let filter = { q:'', status:'', sort:'name.asc' };
let openId = null;

/* ===== load/save ===== */
function load(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; }
}
function saveClients(){ localStorage.setItem(LS_CLIENTS, JSON.stringify(clients)); renderTable(); }

/* ===== seed (gdy pusto) ===== */
if(!clients.length){
  clients = [
    { id:uid(), created:Date.now()-86400000*2, name:'Jan Kowalski', status:'LEAD', email:'jan@kowalski.pl', phone:'+48 500 000 111', address:'Przemk√≥w', tags:['pompa'], notes:'Preferuje kontakt rano.'},
    { id:uid(), created:Date.now()-86400000, name:'Firma XYZ Sp. z o.o.', status:'W TOKU', email:'biuro@xyz.pl', phone:'+48 600 100 200', address:'Legnica', tags:['fotowoltaika','serwis'], notes:'Serwis falownika.'}
  ];
  saveClients();
}

/* ===== filtr/sort ===== */
$('#q').addEventListener('input', e=>{ filter.q = e.target.value.trim(); renderTable(); });
$('#fStatus').addEventListener('change', e=>{ filter.status = e.target.value; renderTable(); });
$('#sort').addEventListener('change', e=>{ filter.sort = e.target.value; renderTable(); });
$('#btnClearFilters').addEventListener('click', ()=>{ filter={q:'',status:'',sort:'name.asc'}; $('#q').value=''; $('#fStatus').value=''; $('#sort').value='name.asc'; renderTable(); });

/* ===== toolbar ===== */
$('#btnAdd').addEventListener('click', ()=>createClient());
$('#btnExportJSON').addEventListener('click', ()=>exportJSON());
$('#importJSON').addEventListener('change', e=>{ const f=e.target.files[0]; if(f) importJSON(f); e.target.value=''; });
$('#btnCSV').addEventListener('click', ()=>exportCSV());

/* ===== table render ===== */
function renderTable(){
  let rows = clients.slice();

  if(filter.q){
    const q = filter.q.toLowerCase();
    rows = rows.filter(c =>
      textMatches(c.name,q) || textMatches(c.email,q) || textMatches(c.phone,q) ||
      (c.tags||[]).some(t=>textMatches(t,q)) || textMatches(c.address,q)
    );
  }
  if(filter.status){ rows = rows.filter(c=>c.status===filter.status); }

  rows.sort((a,b)=>{
    switch(filter.sort){
      case 'name.asc':  return a.name.localeCompare(b.name,'pl',{sensitivity:'base'});
      case 'name.desc': return b.name.localeCompare(a.name,'pl',{sensitivity:'base'});
      case 'created.desc': return (b.created||0)-(a.created||0);
      case 'created.asc':  return (a.created||0)-(b.created||0);
      default: return 0;
    }
  });

  $('#countAll').textContent = clients.length;
  $('#countVis').textContent = rows.length;

  const tb = $('#tbody'); tb.innerHTML = '';
  rows.forEach(c=>{
    const tr = document.createElement('tr');

    const tagsHtml = (c.tags||[]).map(t=>'<span class=\\"tag\\">'+escapeHtml(t)+'</span>').join('');

    tr.innerHTML =
      '<td><button class="btn ghost open" data-id="'+c.id+'" title="Otw√≥rz" type="button">‚ñ∂Ô∏è</button></td>'+
      '<td><b>'+escapeHtml(c.name||'‚Äî')+'</b><div class="small">'+fmtDate(c.created||Date.now())+'</div></td>'+
      '<td><span class="status '+statusClass(c.status)+'">'+escapeHtml(c.status||'‚Äî')+'</span></td>'+
      '<td>'+escapeHtml(c.email||'')+'<div class="small">'+escapeHtml(c.phone||'')+'</div></td>'+
      '<td>'+escapeHtml(c.address||'')+'</td>'+
      '<td>'+tagsHtml+'</td>';

    tr.addEventListener('click', (e)=>{
      if(!(e.target instanceof HTMLButtonElement)) openDrawer(c.id);
    });
    tb.appendChild(tr);
  });

  tb.querySelectorAll('.open').forEach(b=>b.addEventListener('click',(e)=>{ e.stopPropagation(); openDrawer(b.dataset.id); }));
}
function statusClass(s){
  switch((s||'').toUpperCase()){
    case 'LEAD': return 'lead';
    case 'ZAPYTANIE': return 'q';
    case 'W TOKU': return 'w';
    case 'KLIENT': return 'c';
    case 'UTRACONY': return 'l';
    default: return '';
  }
}

/* ===== CRUD ===== */
function createClient(){
  const c = { id:uid(), created:Date.now(), name:'Nowy klient', status:'LEAD', email:'', phone:'', address:'', tags:[], notes:'' };
  clients.unshift(c); saveClients(); openDrawer(c.id);
}
function deleteClient(id){
  const i = clients.findIndex(x=>x.id===id);
  if(i>=0){ clients.splice(i,1); saveClients(); if(openId===id) closeDrawer(); }
}
function duplicateClient(id){
  const src = clients.find(x=>x.id===id); if(!src) return;
  const copy = JSON.parse(JSON.stringify(src));
  copy.id = uid();
  copy.name = (src.name||'') + ' (kopia)';
  copy.created = Date.now();
  clients.unshift(copy);
  saveClients();
  openDrawer(copy.id);
}

/* ===== drawer (edycja) ===== */
const drawer = $('#drawer');
$('#btnClose').addEventListener('click', closeDrawer);
$('#btnDel').addEventListener('click', ()=>{ if(openId && confirm('UsunƒÖƒá klienta?')) deleteClient(openId); });
$('#btnDup').addEventListener('click', ()=>{ if(openId) duplicateClient(openId); });

function openDrawer(id){
  openId = id;
  const c = clients.find(x=>x.id===id); if(!c) return;
  drawer.classList.add('open');

  $('#e_name').value  = c.name||'';
  $('#e_status').value = c.status||'LEAD';
  $('#e_email').value = c.email||'';
  $('#e_phone').value = c.phone||'';
  $('#e_addr').value  = c.address||'';
  $('#e_tags').value  = (c.tags||[]).join(', ');
  $('#e_notes').value = c.notes||'';

  bindEditorHandlers();
}
function closeDrawer(){ drawer.classList.remove('open'); openId=null; }

function bindEditorHandlers(){
  ['#e_name','#e_email','#e_phone','#e_addr','#e_tags','#e_notes'].forEach(sel=>{
    const el = document.querySelector(sel);
    el.oninput = debounce(saveEditor, 160);
  });
  $('#e_status').onchange = saveEditor;
}
function saveEditor(){
  if(!openId) return;
  const c = clients.find(x=>x.id===openId); if(!c) return;
  c.name   = $('#e_name').value.trim();
  c.status = $('#e_status').value;
  c.email  = $('#e_email').value.trim();
  c.phone  = $('#e_phone').value.trim();
  c.address= $('#e_addr').value.trim();
  c.tags   = $('#e_tags').value.split(',').map(s=>s.trim()).filter(Boolean);
  c.notes  = $('#e_notes').value;
  saveClients();
}

/* ===== export/import ===== */
function exportJSON(){
  const blob = new Blob([JSON.stringify({clients},null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_klienci.json';
  a.click();
  URL.revokeObjectURL(a.href);
}
async function importJSON(file){
  try{
    const txt = await file.text();
    const data = JSON.parse(txt);
    if(!data || !Array.isArray(data.clients)) throw new Error('Z≈Çy format.');
    clients = data.clients;
    saveClients();
    alert('Zaimportowano.');
  }catch(e){ alert('B≈ÇƒÖd importu: '+e.message); }
}
function exportCSV(){
  const cols = ['id','created','name','status','email','phone','address','tags','notes'];
  const rows = [cols.join(';')];
  clients.forEach(c=>{
    const base = [
      c.id,
      new Date(c.created||Date.now()).toISOString(),
      escCsv(c.name), escCsv(c.status), escCsv(c.email), escCsv(c.phone), escCsv(c.address),
      escCsv((c.tags||[]).join('|')), escCsv(c.notes||'')
    ];
    rows.push(base.join(';'));
  });
  const a = document.createElement('a');
  const blob = new Blob([rows.join('\\n')], {type:'text/csv;charset=utf-8'});
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_klienci.csv';
  a.click(); URL.revokeObjectURL(a.href);
}
function escCsv(v){ let s=(v==null?'':String(v)); if(/[;\\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; }

/* ===== init ===== */
renderTable();

/* ===== debounce ===== */
function debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms||180); }; }
</script>
</body>
</html>
