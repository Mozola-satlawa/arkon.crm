<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ARKON CRM ‚Äî wersja rozszerzona (1-plikowa)</title>
  <style>
    :root{
      --bg:#0b1020;--card:#0f1636;--line:#263168;--accent:#3a6df0;
      --text:#e7ecff;--muted:#a3b3ff;--chip:#1a244d;--field:#0e1330;
      --good:#2fbf71;--warn:#ffb84d;--bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#cfe0ff;text-decoration:none}
    .container{max-width:1280px;margin:0 auto;padding:16px}
    .nav{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--bg)}
    .brand{font-weight:700;letter-spacing:.4px}
    .tab{padding:6px 10px;border-radius:8px;cursor:pointer}
    .tab.active{background:var(--chip)}
    .grid{display:grid;gap:16px}
    .cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:1000px){ .cols-3,.cols-2{grid-template-columns:1fr} .side{position:static;max-height:none} }
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
    .small{opacity:.85;color:var(--muted);font-size:13px}
    h1{margin:0 0 10px}
    h2{margin:0 0 10px;font-size:18px}
    .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip)}
    input,select,button,textarea{font:inherit}
    .field{background:var(--field);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:10px 12px;outline:0;width:100%}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid var(--accent);color:#cfe0ff}
    .btn.bad{background:transparent;border:1px solid var(--bad);color:#ffb4b4}
    .btn.good{background:var(--good)}
    table{width:100%;border-collapse:collapse}
    th{font-weight:600;text-align:left;border-bottom:1px solid var(--line);padding:8px 6px;color:var(--muted);font-size:13px;cursor:default;white-space:nowrap}
    th.sort{cursor:pointer}
    td{border-bottom:1px solid #1a244d;padding:8px 6px;vertical-align:top}
    .scroll{overflow:auto}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .spacer{height:6px}
    .muted{opacity:.7}
    .msg{margin-bottom:6px}
    .msg strong{color:#9ec5ff}
    .list-reset{list-style:none;margin:0;padding:0}
    .danger{color:#ffb4b4}
    .status{padding:2px 8px;border-radius:999px}
    .status.W\ toku{background:#24336b}
    .status.Podpisana{background:#1d3d2f}
    .status.Anulowana{background:#4a1d1d}
    /* panel boczny (bez modali/okien) */
    .layout{display:grid;grid-template-columns:1fr 340px;gap:16px}
    .side{position:sticky;top:64px;max-height:calc(100vh - 96px);overflow:auto}
    .cart-row{display:flex;align-items:center;gap:8px}
    .cart-row input[type="number"]{width:80px}
    .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  </style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="brand">ARKON CRM</div>
    <div class="tab active" data-tab="dashboard">Pulpit</div>
    <div class="tab" data-tab="clients">Klienci</div>
    <div class="tab" data-tab="contracts">Umowy</div>
    <div class="tab" data-tab="products">Produkty</div>
    <div class="tab" data-tab="docs">Dokumenty</div>
    <div class="tab" data-tab="chat">Komunikator</div>
    <div class="tab" data-tab="settings">Ustawienia</div>
  </div>

  <div class="container">
    <!-- DASHBOARD -->
    <section id="tab-dashboard" class="grid">
      <h1>Pulpit</h1>
      <div class="grid cols-3">
        <div class="card"><div class="small">Przych√≥d (symulacja)</div><h2 id="db-revenue">0 z≈Ç</h2></div>
        <div class="card"><div class="small">Aktywne umowy</div><h2 id="db-open">0</h2></div>
        <div class="card"><div class="small">BrakujƒÖce dokumenty</div><h2 id="db-missing">0</h2></div>
      </div>
      <div class="card small">
        Porady: <span class="kbd">/</span> fokus wyszukiwania ‚Ä¢ <span class="kbd">Alt+N</span> nowy klient ‚Ä¢
        <span class="kbd">Alt+U</span> nowa umowa ‚Ä¢ zapisz/odtw√≥rz dane w Ustawieniach.
      </div>
    </section>

    <!-- CLIENTS -->
    <section id="tab-clients" class="grid" hidden>
      <h1>Klienci</h1>
      <div class="layout">
        <div class="grid">
          <div class="card">
            <div class="row">
              <input id="cli-q" class="field" placeholder="Szukaj (imiƒô, email, tel, opiekun)..." />
              <select id="cli-sort" class="field" style="max-width:210px">
                <option value="name">Sortuj: Nazwa A‚ÜíZ</option>
                <option value="created_desc">Sortuj: Najnowsze</option>
                <option value="manager">Sortuj: Opiekun</option>
              </select>
            </div>
            <div class="spacer"></div>
            <div class="row">
              <input id="cli-name" class="field" placeholder="Imiƒô i nazwisko" />
              <input id="cli-email" class="field" placeholder="E-mail" />
              <input id="cli-phone" class="field" placeholder="Telefon" />
              <input id="cli-manager" class="field" placeholder="Opiekun" />
              <button id="cli-add" class="btn">Dodaj klienta</button>
            </div>
          </div>

          <div class="card scroll">
            <table>
              <thead>
                <tr>
                  <th class="sort" data-k="id">ID</th>
                  <th class="sort" data-k="name">Nazwa</th>
                  <th>E-mail</th><th>Telefon</th><th class="sort" data-k="manager">Opiekun</th>
                </tr>
              </thead>
              <tbody id="cli-rows"></tbody>
            </table>
            <div id="cli-empty" class="muted" style="padding:8px;display:none">Brak wynik√≥w‚Ä¶</div>
          </div>
        </div>

        <!-- PANEL BOCZNY: szczeg√≥≈Çy klienta -->
        <aside class="side">
          <div class="card" id="cli-side">
            <h2>Szczeg√≥≈Çy klienta</h2>
            <div id="cli-side-none" class="muted">Wybierz klienta z listy, by zobaczyƒá szczeg√≥≈Çy.</div>
            <div id="cli-side-body" hidden>
              <div class="small">ID: <span id="cli-s-id"></span></div>
              <div style="margin:8px 0 12px"><span class="chip" id="cli-s-manager"></span></div>
              <div class="small">Kontakt</div>
              <div id="cli-s-email"></div>
              <div id="cli-s-phone"></div>
              <div class="spacer"></div>
              <div class="small">Notatki</div>
              <textarea id="cli-s-notes" class="field" rows="5" placeholder="W≈Çasne notatki o kliencie‚Ä¶"></textarea>
              <div class="right" style="margin-top:8px">
                <button id="cli-s-save" class="btn good">Zapisz notatki</button>
              </div>
              <div class="spacer"></div>
              <div class="small">Umowy klienta</div>
              <ul id="cli-s-contracts" class="list-reset"></ul>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- CONTRACTS -->
    <section id="tab-contracts" class="grid" hidden>
      <h1>Umowy</h1>
      <div class="layout">
        <div class="grid">
          <div class="card">
            <h2>Nowa umowa</h2>
            <div class="row">
              <select id="ctr-client" class="field" style="min-width:220px"></select>
              <select id="ctr-type" class="field" style="max-width:220px">
                <option value="got√≥wka">Got√≥wka</option>
                <option value="prefinansowanie">Prefinansowanie</option>
              </select>
              <input id="ctr-discount" class="field" type="number" value="0" placeholder="Rabat (z≈Ç)" />
              <input id="ctr-prov" class="field" type="number" step="0.1" value="4" placeholder="Prowizja %"/>
              <button id="ctr-create" class="btn">Utw√≥rz z koszyka produkt√≥w</button>
            </div>
            <div class="small" style="margin-top:8px">Wybierz produkty w zak≈Çadce <b>Produkty</b> i dodaj je do koszyka po prawej. Tu zapiszesz z tego nowƒÖ umowƒô.</div>
          </div>

          <div class="card scroll">
            <h2>Lista um√≥w</h2>
            <table>
              <thead><tr><th>ID</th><th>Klient</th><th>Kwota</th><th>Typ</th><th>Status</th><th>Akcje</th></tr></thead>
              <tbody id="ctr-rows"></tbody>
            </table>
          </div>
        </div>

        <!-- panel boczny: detale umowy + checklista dokument√≥w -->
        <aside class="side">
          <div class="card" id="ctr-side">
            <h2>Szczeg√≥≈Çy umowy</h2>
            <div id="ctr-side-none" class="muted">Wybierz umowƒô z listy po lewej.</div>
            <div id="ctr-side-body" hidden>
              <div class="small">ID: <span id="ctr-s-id"></span></div>
              <div class="small">Klient: <span id="ctr-s-client"></span></div>
              <div class="small">Warto≈õƒá: <span id="ctr-s-total"></span></div>
              <div class="small">Typ: <span id="ctr-s-type" class="chip"></span></div>
              <div class="small">Status: <span id="ctr-s-status" class="chip"></span></div>
              <div class="spacer"></div>
              <div class="small">Dokumenty</div>
              <ul id="ctr-docs" class="list-reset"></ul>
              <div class="right" style="margin-top:8px">
                <button id="ctr-docs-reset" class="btn ghost">Odznacz wszystko</button>
                <button id="ctr-status-signed" class="btn good">Oznacz jako podpisanƒÖ</button>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- PRODUCTS -->
    <section id="tab-products" class="grid" hidden>
      <h1>Produkty i komponenty</h1>
      <div class="layout">
        <div class="grid">
          <div class="card"><div class="row" id="prod-filters"></div></div>
          <div class="card scroll">
            <table>
              <thead><tr><th>SKU</th><th>Nazwa</th><th>Kategoria</th><th>Cena</th><th>Dodaj</th></tr></thead>
              <tbody id="prod-rows"></tbody>
            </table>
          </div>
        </div>
        <aside class="side">
          <div class="card">
            <h2>Koszyk oferty</h2>
            <div id="cart-empty" class="muted">Brak pozycji ‚Äî dodaj z listy produkt√≥w.</div>
            <div id="cart-list"></div>
            <div class="spacer"></div>
            <div class="row">
              <div class="card" style="flex:1"><div class="small">Suma pozycji</div><h2 id="cart-sum">0 z≈Ç</h2></div>
              <div class="card" style="flex:1"><div class="small">Po rabacie</div><h2 id="cart-sum-disc">0 z≈Ç</h2></div>
            </div>
            <div class="small muted">Rabat ustawisz przy tworzeniu umowy.</div>
          </div>
        </aside>
      </div>
    </section>

    <!-- DOCUMENTS -->
    <section id="tab-docs" class="grid" hidden>
      <h1>Dokumenty</h1>
      <div class="card">
        <h2>Domy≈õlna lista wymaganych dokument√≥w</h2>
        <ul id="doc-list" class="list-reset"></ul>
        <div class="right" style="margin-top:10px">
          <button id="doc-add" class="btn ghost">Dodaj pozycjƒô</button>
          <button id="doc-reset" class="btn ghost">Odznacz wszystko</button>
        </div>
      </div>
    </section>

    <!-- CHAT -->
    <section id="tab-chat" class="grid" hidden>
      <h1>Komunikator</h1>
      <div class="card">
        <div id="chat-box" style="border:1px solid var(--line);border-radius:8px;padding:12px;min-height:160px;max-height:300px;overflow:auto;background:#0d1330"></div>
        <div class="row" style="margin-top:8px">
          <input id="chat-text" class="field" placeholder="Napisz wiadomo≈õƒá‚Ä¶" />
          <button id="chat-send" class="btn">Wy≈õlij</button>
        </div>
        <div class="small muted" style="margin-top:8px">To wersja lokalna (bez backendu). Realtime pojawi siƒô po pod≈ÇƒÖczeniu Supabase.</div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings" class="grid" hidden>
      <h1>Ustawienia</h1>
      <div class="grid cols-2">
        <div class="card">
          <h2>Dane</h2>
          <div class="row">
            <button id="export" class="btn">Eksportuj JSON</button>
            <label class="btn ghost">
              Importuj JSON
              <input id="import" type="file" accept="application/json" hidden>
            </label>
          </div>
          <div class="small" style="margin-top:10px">
            Zapis lokalny: <code>localStorage</code>. Przycisk poni≈ºej kasuje lokalny stan.
          </div>
          <div class="row" style="margin-top:8px">
            <button id="wipe" class="btn bad" title="Usuwa zapis lokalny">Wyczy≈õƒá zapisane dane</button>
          </div>
        </div>
        <div class="card">
          <h2>Druk / PDF</h2>
          <div class="row">
            <button class="btn" onclick="window.print()">Drukuj / Zapisz jako PDF</button>
          </div>
          <div class="small" style="margin-top:10px">
            W przysz≈Ço≈õci: generowanie PDF umowy na serwerze (Next.js API) i wysy≈Çka do podpisu (OpenSign/DocuSeal).
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ====== DANE STARTOWE ======
    const seedClients = [
      { id:"C-001", name:"Anna Kowalska", email:"anna@example.com", phone:"600-100-200", manager:"Pawe≈Ç", notes:"" , created_at:Date.now()-86400000*4},
      { id:"C-002", name:"Jan Nowak",    email:"jan@example.com",  phone:"600-100-201", manager:"Pawe≈Ç", notes:"VIP" , created_at:Date.now()-86400000*2},
      { id:"C-003", name:"Piotr Kami≈Ñski", email:"piotr@example.com", phone:"600-100-202", manager:"Kasia", notes:"" , created_at:Date.now()-86400000*1},
    ];
    const seedContracts = [
      { id:"U-1001", client_id:"C-001", customer:"Anna Kowalska", items:[{sku:"PV-410",qty:12,price:520},{sku:"PV-INV8",qty:1,price:4100}], total:21500, type:"got√≥wka", status:"W toku", docs:defaultDocList().map(n=>({name:n,done:false})) , created_at:Date.now()-86400000*2},
      { id:"U-1002", client_id:"C-002", customer:"Jan Nowak",     items:[{sku:"HP-9KW",qty:1,price:15500}], total:42000, type:"prefinansowanie", status:"Zako≈Ñczona", docs:defaultDocList().map(n=>({name:n,done:true})) , created_at:Date.now()-86400000*1},
    ];
    const seedProducts = [
      { sku:"PV-410",  name:"Panel 410W",               category:"fotowoltaika", price:520 },
      { sku:"PV-INV8", name:"Inwerter 8kW",             category:"fotowoltaika", price:4100 },
      { sku:"PV-MNT",  name:"Monta≈º PV standard",       category:"fotowoltaika", price:2500 },
      { sku:"HP-9KW",  name:"Pompa ciep≈Ça 9kW",         category:"pompy",        price:15500 },
      { sku:"HP-BUF",  name:"Bufor 100l",               category:"pompy",        price:850 },
      { sku:"HP-CIRC", name:"Pompa cyrkulacyjna",       category:"pompy",        price:540 },
      { sku:"PC-25",   name:"Kocio≈Ç kondensacyjny 25kW",category:"piece",        price:7800 },
      { sku:"PC-CHIM", name:"Wk≈Çad kominowy",           category:"piece",        price:1200 },
      { sku:"HY-PEX16",name:"Rury PEX 16 (mb)",         category:"hydraulika",   price:3.8 },
      { sku:"HY-CU15", name:"Rury miedziane 15 (mb)",   category:"hydraulika",   price:14.5 },
      { sku:"HY-RAD2", name:"Grzejnik dwukomorowy 120", category:"hydraulika",   price:740 },
      { sku:"HY-RAD3", name:"Grzejnik tr√≥jkomorowy 120",category:"hydraulika",   price:960 },
      { sku:"OC-STY15",name:"Styropian 15cm (m¬≤)",      category:"ocieplenie",   price:42 },
      { sku:"OC-ADH",  name:"Klej do styropianu 25kg",  category:"ocieplenie",   price:45 },
      { sku:"OC-REN",  name:"Tynk silikonowy 25kg",     category:"ocieplenie",   price:120 },
      { sku:"OC-GUTT", name:"Rynny (mb)",               category:"ocieplenie",   price:35 },
      { sku:"OC-PARA", name:"Parapety (szt.)",          category:"ocieplenie",   price:95 },
      { sku:"OC-FLASH",name:"Obr√≥bki blacharskie (mb)", category:"ocieplenie",   price:55 },
    ];
    function defaultDocList(){
      return [
        "Umowa got√≥wkowa / do funduszu",
        "Opinia kominiarza",
        "Protok√≥≈Ç odbioru instalacji",
        "O≈õwiadczenie o przekazaniu ≈õrodk√≥w",
        "Umowa z wykonawcƒÖ",
        "Za≈õwiadczenie o dochodach klienta",
        "Inne za≈ÇƒÖczniki",
      ];
    }

    // ====== STAN / PERSIST ======
    const LSKEY = "arkonCRM_v2";
    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem(LSKEY) || "{}");
        return {
          clients: s.clients || seedClients.slice(),
          contracts: s.contracts || seedContracts.slice(),
          docsMaster: s.docsMaster || defaultDocList().map(n=>({name:n,done:false})),
          chat: s.chat || [{from:"System",text:"Witaj w czacie ARKON üëã",at:Date.now()}],
          cart: s.cart || [], // [{sku,qty,price}]
        };
      }catch{
        return { clients:seedClients.slice(), contracts:seedContracts.slice(), docsMaster:defaultDocList().map(n=>({name:n,done:false})), chat:[{from:"System",text:"Witaj w czacie ARKON üëã",at:Date.now()}], cart:[] };
      }
    }
    let state = loadState();
    function saveState(){
      localStorage.setItem(LSKEY, JSON.stringify(state));
      renderDashboard();
    }

    // ====== POMOCNICZE ======
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const money = x => (Math.round(x)||0).toLocaleString("pl-PL")+" z≈Ç";
    function annuity(P, months, annualPct){
      const r = (annualPct/100)/12;
      if (!P||!months) return 0;
      if (r===0) return Math.round(P/months);
      const a = r*Math.pow(1+r,months)/(Math.pow(1+r,months)-1);
      return Math.round(P*a);
    }
    function uid(prefix, list){
      let n = list.length + 1;
      let id;
      do { id = ${prefix}-${n.toString().padStart(3,"0")}; n++; } while(list.some(x=>x.id===id));
      return id;
    }
    function byId(map,id){ return map.find(x=>x.id===id); }
    function productBySku(sku){ return seedProducts.find(p=>p.sku===sku); }

    // ====== NAWIGACJA ======
    $$(".tab").forEach(el=>{
      el.addEventListener("click", ()=>{
        $$(".tab").forEach(t=>t.classList.remove("active"));
        el.classList.add("active");
        const key = el.dataset.tab;
        $$("section[id^='tab-']").forEach(s => s.hidden = true);
        $("#tab-"+key).hidden = false;
      });
    });

    // ====== DASHBOARD ======
    function renderDashboard(){
      const revenue = state.contracts.reduce((s,c)=>s+(c.total||0),0);
      const open = state.contracts.filter(c=>c.status==="W toku").length;
      const missing = state.contracts.reduce((s,c)=> s + (c.docs? c.docs.filter(d=>!d.done).length : 0), 0);
      $("#db-revenue").textContent = money(revenue);
      $("#db-open").textContent = open;
      $("#db-missing").textContent = missing;
    }

    // ====== KLIENCI ======
    let selectedClientId = null;
    function renderClients(){
      const q = ($("#cli-q").value||"").toLowerCase();
      const sort = $("#cli-sort").value;
      const rows = $("#cli-rows");
      rows.innerHTML = "";
      let list = state.clients
        .filter(r => (r.name+r.email+r.phone+r.manager).toLowerCase().includes(q));
      if(sort==="name") list.sort((a,b)=>a.name.localeCompare(b.name,"pl"));
      if(sort==="manager") list.sort((a,b)=>a.manager.localeCompare(b.manager,"pl"));
      if(sort==="created_desc") list.sort((a,b)=>b.created_at-a.created_at);
      list.forEach(c=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${c.id}</td>
          <td><a href="#" data-id="${c.id}" class="cli-link">${c.name}</a></td>
          <td>${c.email}</td>
          <td>${c.phone}</td>
          <td><span class="chip">${c.manager||"-"}</span></td>`;
        rows.appendChild(tr);
      });
      $("#cli-empty").style.display = list.length? "none":"block";

      // linki do panelu bocznego
      rows.querySelectorAll(".cli-link").forEach(a=>{
        a.addEventListener("click",(e)=>{
          e.preventDefault();
          openClientSide(a.dataset.id);
        });
      });
    }
    $("#cli-q").addEventListener("input", renderClients);
    $("#cli-sort").addEventListener("change", renderClients);
    $("#cli-add").addEventListener("click", ()=>{
      const name=$("#cli-name").value.trim();
      if(!name) return;
      const next = {
        id: uid("C", state.clients),
        name,
        email:$("#cli-email").value.trim(),
        phone:$("#cli-phone").value.trim(),
        manager:$("#cli-manager").value.trim(),
        notes:"",
        created_at:Date.now()
      };
      state.clients=[next,...state.clients];
      ["cli-name","cli-email","cli-phone","cli-manager"].forEach(id=>$("#"+id).value="");
      saveState(); renderClients(); openClientSide(next.id);
    });

    function openClientSide(id){
      selectedClientId = id;
      const c = byId(state.clients,id);
      if(!c){ return; }
      $("#cli-side-none").hidden = true;
      $("#cli-side-body").hidden = false;
      $("#cli-s-id").textContent = c.id;
      $("#cli-s-manager").textContent = c.manager || "-";
      $("#cli-s-email").textContent = "‚úâ " + (c.email||"‚Äî");
      $("#cli-s-phone").textContent = "üìû " + (c.phone||"‚Äî");
      $("#cli-s-notes").value = c.notes||"";
      // umowy klienta
      const ul = $("#cli-s-contracts"); ul.innerHTML="";
      state.contracts.filter(u=>u.client_id===id).forEach(u=>{
        const li=document.createElement("li");
        li.innerHTML = <a href="#" data-id="${u.id}" class="ctr-link">${u.id}</a> ‚Äì ${u.customer} ‚Ä¢ <span class="status ${u.status}">${u.status}</span> ‚Ä¢ ${money(u.total)};
        ul.appendChild(li);
      });
      ul.querySelectorAll(".ctr-link").forEach(a=>{
        a.addEventListener("click",(e)=>{ e.preventDefault(); openContractSide(a.dataset.id); });
      });
    }
    $("#cli-s-save").addEventListener("click",()=>{
      if(!selectedClientId) return;
      const c = byId(state.clients, selectedClientId);
      c.notes = $("#cli-s-notes").value;
      saveState();
    });

    // ====== UMOWY ======
    let selectedContractId = null;
    function renderContracts(){
      const tb = $("#ctr-rows"); tb.innerHTML="";
      state.contracts.sort((a,b)=>b.created_at-a.created_at).forEach(c=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td><a href="#" class="ctr-link" data-id="${c.id}">${c.id}</a></td>
          <td>${c.customer}</td>
          <td>${money(c.total)}</td>
          <td><span class="chip">${c.type}</span></td>
          <td><span class="status ${c.status}">${c.status}</span></td>
          <td>
            <button class="btn ghost ctr-open" data-id="${c.id}">Szczeg√≥≈Çy</button>
          </td>`;
        tb.appendChild(tr);
      });
      tb.querySelectorAll(".ctr-open,.ctr-link").forEach(b=>{
        b.addEventListener("click",(e)=>{ e.preventDefault(); openContractSide(b.dataset.id); });
      });
      // lista klient√≥w do nowej umowy
      const sel=$("#ctr-client"); sel.innerHTML="";
      state.clients.slice().sort((a,b)=>a.name.localeCompare(b.name,"pl")).forEach(c=>{
        const o=document.createElement("option");
        o.value=c.id; o.textContent=${c.name} (${c.id});
        sel.appendChild(o);
      });
    }
    function openContractSide(id){
      selectedContractId = id;
      const c = state.contracts.find(u=>u.id===id);
      if(!c) return;
      $("#ctr-side-none").hidden = true;
      $("#ctr-side-body").hidden = false;
      $("#ctr-s-id").textContent = c.id;
      $("#ctr-s-client").textContent = ${c.customer} (${c.client_id});
      $("#ctr-s-total").textContent = money(c.total);
      $("#ctr-s-type").textContent = c.type;
      $("#ctr-s-status").textContent = c.status;
      // dokumenty
      const ul=$("#ctr-docs"); ul.innerHTML="";
      (c.docs||defaultDocList().map(n=>({name:n,done:false}))).forEach((d,i)=>{
        const li=document.createElement("li");
        li.innerHTML=`
          <label style="display:flex;align-items:center;gap:10px;padding:6px 0">
            <input type="checkbox" ${d.done?"checked":""} data-i="${i}"/>
            <span ${d.done?'style="text-decoration:line-through;opacity:.7"':""}>${d.name}</span>
          </label>`;
        ul.appendChild(li);
      });
      ul.addEventListener("change",e=>{
        const i=+e.target.dataset.i;
        if(Number.isFinite(i)){
          c.docs[i].done=!c.docs[i].done; saveState(); renderDashboard(); openContractSide(id);
        }
      },{once:true});
      $("#ctr-docs-reset").onclick = ()=>{ c.docs.forEach(x=>x.done=false); saveState(); openContractSide(id); };
      $("#ctr-status-signed").onclick = ()=>{ c.status="Podpisana"; saveState(); renderContracts(); openContractSide(id); };
    }

    // tworzenie nowej umowy z koszyka
    $("#ctr-create").addEventListener("click", ()=>{
      const items = state.cart.slice();
      if(!items.length) { alert("Koszyk jest pusty."); return; }
      const clientId = $("#ctr-client").value;
      const client = byId(state.clients, clientId);
      const discount = +$("#ctr-discount").value||0;
      const prov = +$("#ctr-prov").value||0;
      const base = items.reduce((s,i)=>s+i.price*i.qty,0);
      const total = Math.max(0, base - discount);
      const id = uid("U", state.contracts);
      const ctr = {
        id, client_id: client.id, customer: client.name, items, total,
        type: $("#ctr-type").value, status:"W toku",
        docs: defaultDocList().map(n=>({name:n,done:false})),
        commission: Math.round(total*(prov/100)), created_at: Date.now()
      };
      state.contracts=[ctr, ...state.contracts];
      state.cart=[]; saveState();
      renderContracts(); renderCart(); openContractSide(id);
      document.querySelector('.tab[data-tab="contracts"]').click();
    });

    // ====== PRODUKTY + KOSZYK ======
    const prodCats=["wszystko","fotowoltaika","pompy","piece","hydraulika","ocieplenie"];
    function renderProductFilters(){
      const box=$("#prod-filters"); box.innerHTML="";
      prodCats.forEach(c=>{
        const b=document.createElement("button");
        b.className="btn ghost"; b.textContent=c;
        b.addEventListener("click",()=>renderProducts(c));
        box.appendChild(b);
      });
    }
    function renderProducts(cat="wszystko"){
      const rows=$("#prod-rows"); rows.innerHTML="";
      const list=seedProducts.filter(p=>cat==="wszystko"?true:p.category===cat);
      list.forEach(p=>{
        const tr=document.createElement("tr");
        tr.innerHTML = `
          <td>${p.sku}</td>
          <td>${p.name}</td>
          <td><span class="chip">${p.category}</span></td>
          <td>${money(p.price)}</td>
          <td><button class="btn ghost add-prod" data-sku="${p.sku}">Dodaj</button></td>`;
        rows.appendChild(tr);
      });
      rows.querySelectorAll(".add-prod").forEach(btn=>{
        btn.addEventListener("click",()=>{
          const sku=btn.dataset.sku; const prod=productBySku(sku);
          const row = state.cart.find(i=>i.sku===sku);
          if(row) row.qty++; else state.cart.push({sku,qty:1,price:prod.price});
          saveState(); renderCart();
        });
      });
    }
    function renderCart(){
      const box=$("#cart-list"); const empty=$("#cart-empty");
      box.innerHTML="";
      if(!state.cart.length){ empty.style.display="block"; $("#cart-sum").textContent="0 z≈Ç"; $("#cart-sum-disc").textContent="0 z≈Ç"; return; }
      empty.style.display="none";
      state.cart.forEach((i,idx)=>{
        const p=productBySku(i.sku);
        const div=document.createElement("div");
        div.className="cart-row"; 
        div.innerHTML = `
          <div style="flex:1">${p.name} <span class="small chip">${p.sku}</span></div>
          <input type="number" min="1" value="${i.qty}" data-i="${idx}">
          <div style="width:110px;text-align:right">${money(i.price*i.qty)}</div>
          <button class="btn ghost" data-del="${idx}">Usu≈Ñ</button>
        `;
        box.appendChild(div);
      });
      // zmiana ilo≈õci / kasowanie
      box.querySelectorAll('input[type="number"]').forEach(inp=>{
        inp.addEventListener("input",()=>{
          const i=+inp.dataset.i; const v=Math.max(1, +inp.value||1);
          state.cart[i].qty=v; saveState(); renderCart();
        });
      });
      box.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener("click",()=>{ const i=+btn.dataset.del; state.cart.splice(i,1); saveState(); renderCart(); });
      });
      const sum = state.cart.reduce((s,i)=>s+i.price*i.qty,0);
      $("#cart-sum").textContent = money(sum);
      $("#cart-sum-disc").textContent = money(sum); // rabat ustawiany przy tworzeniu umowy
    }

    // ====== DOKUMENTY (wzorzec) ======
    function renderDocsMaster(){
      const ul=$("#doc-list"); ul.innerHTML="";
      state.docsMaster.forEach((d,i)=>{
        const li=document.createElement("li");
        li.innerHTML=`
          <label style="display:flex;align-items:center;gap:10px;padding:6px 0">
            <input type="checkbox" ${d.done?"checked":""} data-i="${i}"/>
            <input class="field" value="${d.name}" data-name="${i}" />
          </label>`;
        ul.appendChild(li);
      });
      ul.addEventListener("change",e=>{
        const i=+e.target.dataset.i;
        if(Number.isFinite(i)){ state.docsMaster[i].done=!state.docsMaster[i].done; saveState(); }
      }, { once:true });
      ul.querySelectorAll('input[data-name]').forEach(inp=>{
        inp.addEventListener("input",()=>{ state.docsMaster[+inp.dataset.name].name = inp.value; saveState(); });
      });
    }
    $("#doc-reset").addEventListener("click",()=>{
      state.docsMaster=state.docsMaster.map(d=>({...d,done:false})); saveState(); renderDocsMaster();
    });
    $("#doc-add").addEventListener("click",()=>{
      state.docsMaster.push({name:"Nowy dokument",done:false}); saveState(); renderDocsMaster();
    });

    // ====== CHAT ======
    function renderChat(){
      const box=$("#chat-box"); box.innerHTML="";
      state.chat.forEach(m=>{
        const div=document.createElement("div");
        const dt = new Date(m.at||Date.now());
        const hh = dt.toLocaleTimeString("pl-PL",{hour:"2-digit",minute:"2-digit"});
        div.className="msg";
        div.innerHTML = <strong>[${hh}] ${m.from}:</strong> <span>${escapeHtml(m.text)}</span>;
        box.appendChild(div);
      });
      box.scrollTop=box.scrollHeight;
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"]/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[c])); }
    $("#chat-send").addEventListener("click",()=>{
      const t=$("#chat-text").value.trim(); if(!t) return;
      state.chat.push({from:"Ja",text:t,at:Date.now()}); $("#chat-text").value=""; saveState(); renderChat();
    });

    // ====== USTAWIENIA: eksport/import/wipe ======
    $("#export").addEventListener("click",()=>{
      const data = JSON.stringify(state,null,2);
      const blob = new Blob([data],{type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "arkon-crm-backup.json"; a.click();
      URL.revokeObjectURL(url);
    });
    $("#import").addEventListener("change",(e)=>{
      const file = e.target.files[0]; if(!file) return;
      const r = new FileReader();
      r.onload = () => {
        try{
          const obj = JSON.parse(r.result);
          state = Object.assign(loadState(), obj); // bezpieczne nadpisanie
          saveState(); boot();
          alert("Import zako≈Ñczony.");
        }catch{ alert("Plik nieprawid≈Çowy."); }
      };
      r.readAsText(file);
    });
    $("#wipe").addEventListener("click",()=>{
      if(confirm("UsunƒÖƒá zapisane dane lokalne?")){
        localStorage.removeItem(LSKEY); state=loadState(); boot();
      }
    });

    // ====== SKR√ìTY KLAWIATUROWE ======
    window.addEventListener("keydown",(e)=>{
      if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement.tagName)){ e.preventDefault(); $("#cli-q").focus(); document.querySelector('.tab[data-tab="clients"]').click(); }
      if(e.altKey && (e.key==="n" || e.key==="N")){ e.preventDefault(); document.querySelector('.tab[data-tab="clients"]').click(); $("#cli-name").focus(); }
      if(e.altKey && (e.key==="u" || e.key==="U")){ e.preventDefault(); document.querySelector('.tab[data-tab="contracts"]').click(); $("#ctr-create").focus(); }
    });

    // ====== BOOT ======
    function boot(){
      // start na Pulpit
      $$(".tab").forEach(t=>t.classList.remove("active"));
      document.querySelector('.tab[data-tab="dashboard"]').classList.add("active");
      $$("section[id^='tab-']").forEach(s=>s.hidden=true);
      $("#tab-dashboard").hidden=false;

      renderDashboard();
      renderClients();
      renderContracts();
      renderProductFilters(); renderProducts(); renderCart();
      renderDocsMaster();
      renderChat();
    }
    boot();
  </script>
</body>
</html>
