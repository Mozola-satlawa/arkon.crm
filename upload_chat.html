<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>📤 Upload do czatu • ARKON (Netlify Functions)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{ --bg:#0b1020; --card:#11183a; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2b8a57; --line:#253166; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:820px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px 0}
    .card{background:linear-gradient(180deg,#101736,#0f1a44);border:1px solid var(--line);border-radius:14px;padding:16px}
    label{display:block;margin:6px 0 4px 0;color:var(--muted);font-size:13px}
    input,select,textarea,button{font:15px/1.3 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
    input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:10px}
    textarea{resize:vertical;min-height:80px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .btn{background:#233261;border:1px solid #3a4ca3;border-radius:10px;padding:10px 12px;color:#fff;cursor:pointer}
    .btn.ok{background:#194d34;border-color:var(--ok)}
    .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
    .drop{margin-top:10px;border:2px dashed #3a4ca3;border-radius:12px;padding:16px;text-align:center;color:#aeb8da}
    .drop.drag{border-color:#7fb3ff;background:#0e1740}
    .muted{color:var(--muted);font-size:12px}
    pre{background:var(--card);border:1px solid #243059;border-radius:10px;padding:12px;color:#cfe1ff;overflow:auto;max-height:260px}
    a.back{display:inline-block;margin-top:14px;color:#aee1ff}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>📤 Upload pliku do komunikatora ARKON (Netlify)</h1>
    <div class="card">
      <div class="row">
        <div>
          <label for="room">Pokój</label>
          <select id="room">
            <option value="global">🌍 Wspólny</option>
            <option value="krolowa">👑 Królowa</option>
            <option value="adrian">👤 Adrian</option>
            <option value="emil">👤 Emil</option>
          </select>
        </div>
        <div>
          <label for="author">Autor (podpis)</label>
          <input id="author" placeholder="np. Pracownik">
        </div>
      </div>

      <label for="text" style="margin-top:10px">Tekst wiadomości (opcjonalnie)</label>
      <textarea id="text" placeholder="Komentarz do załącznika…"></textarea>

      <div class="row" style="margin-top:10px">
        <div>
          <label for="file">Wybierz plik</label>
          <input id="file" type="file">
          <div class="muted">Limit rozmiaru zgodnie z funkcją Netlify.</div>
        </div>
        <div>
          <label>lub „przeciągnij i upuść”</label>
          <div id="drop" class="drop">Upuść plik tutaj</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn ok" id="btnSend">Wyślij ▶</button>
        <button class="btn ghost" id="btnOnlyText">Wyślij tylko tekst</button>
        <button class="btn ghost" id="btnClear">Wyczyść</button>
      </div>

      <div class="row3" style="margin-top:12px">
        <div>
          <label for="uploadEndpoint">Endpoint upload (Netlify)</label>
          <input id="uploadEndpoint" value="/.netlify/functions/upload" spellcheck="false">
        </div>
        <div>
          <label for="msgEndpoint">Endpoint wiadomości (Netlify)</label>
          <input id="msgEndpoint" value="/.netlify/functions/messages" spellcheck="false">
        </div>
        <div>
          <label for="openChat">Powrót do czatu</label>
          <a class="btn ghost" id="openChat" href="index.html">← Otwórz czat</a>
        </div>
      </div>

      <h3 style="margin:16px 0 6px 0">Wynik</h3>
      <pre id="out">[tu pojawi się log]</pre>
    </div>

    <a class="back" href="index.html">← Wróć do aplikacji</a>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const out = $('#out');

  // localStorage klucze
  const LS = k => 'upload_chat_' + k;

  // przywróć zapisane preferencje
  $('#room').value   = localStorage.getItem(LS('room'))   || 'global';
  $('#author').value = localStorage.getItem(LS('author')) || 'Pracownik';
  $('#uploadEndpoint').value = localStorage.getItem(LS('uploadEndpoint')) || '/.netlify/functions/upload';
  $('#msgEndpoint').value    = localStorage.getItem(LS('msgEndpoint'))    || '/.netlify/functions/messages';

  function log(...args){
    out.textContent = args.map(x => {
      if (x instanceof Error) return '❌ ' + x.message;
      if (typeof x === 'object') return JSON.stringify(x, null, 2);
      return String(x);
    }).join('\n\n');
  }
  function savePrefs(){
    localStorage.setItem(LS('room'),   $('#room').value);
    localStorage.setItem(LS('author'), $('#author').value);
    localStorage.setItem(LS('uploadEndpoint'), $('#uploadEndpoint').value);
    localStorage.setItem(LS('msgEndpoint'),    $('#msgEndpoint').value);
  }

  async function uploadFile(file){
    const endpoint = $('#uploadEndpoint').value.trim() || '/.netlify/functions/upload';
    const fd = new FormData();
    fd.append('file', file);
    fd.append('room', $('#room').value);
    const r = await fetch(endpoint, { method:'POST', body: fd });
    if(!r.ok) throw new Error('Upload HTTP '+r.status);
    const j = await r.json();
    if (!j.url) throw new Error('Brak URL w odpowiedzi upload');
    return j.url; // oczekujemy { url: "https://..." }
  }

  async function sendMessage({text, fileUrl}){
    const endpoint = $('#msgEndpoint').value.trim() || '/.netlify/functions/messages';
    const payload = {
      room: $('#room').value,
      author: $('#author').value || 'Pracownik',
      text: text || '',
      file_url: fileUrl || null
    };
    const r = await fetch(endpoint, {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!r.ok) throw new Error('Messages HTTP '+r.status);
    return await r.json();
  }

  async function handleSend(includeFile=true){
    savePrefs();
    const fileInput = $('#file');
    const text = ($('#text').value || '').trim();
    try{
      if(includeFile){
        const f = fileInput.files[0] || window._droppedFile;
        if(!f) { alert('Wybierz plik lub użyj „Wyślij tylko tekst”.'); return; }
        log('⏳ Wysyłanie pliku do Netlify…');
        const url = await uploadFile(f);
        log({upload_url: url, status: 'OK'});
        log('⏳ Tworzenie wiadomości…');
        const msg = await sendMessage({ text, fileUrl: url });
        log({ message_result: msg, note:'gotowe' });
      } else {
        if(!text){ alert('Brak treści do wysłania.'); return; }
        log('⏳ Wysyłanie wiadomości tekstowej…');
        const msg = await sendMessage({ text, fileUrl: null });
        log({ message_result: msg, note:'gotowe (tekst)' });
      }
      // reset UI
      $('#text').value = '';
      $('#file').value = '';
      window._droppedFile = null;
      $('#drop').textContent = 'Upuść plik tutaj';
    }catch(e){
      log(e);
    }
  }

  // Drag & drop
  const drop = $('#drop');
  ;['dragenter','dragover'].forEach(ev=>{
    drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.add('drag'); });
  });
  ;['dragleave','drop'].forEach(ev=>{
    drop.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); drop.classList.remove('drag'); });
  });
  drop.addEventListener('drop', e => {
    const f = e.dataTransfer.files[0];
    if(f){ window._droppedFile = f; drop.textContent = 'Wybrano: '+f.name+' ('+Math.round(f.size/1024)+' KB)'; }
  });

  // Zdarzenia
  $('#btnSend').addEventListener('click', () => handleSend(true));
  $('#btnOnlyText').addEventListener('click', () => handleSend(false));
  $('#btnClear').addEventListener('click', () => { $('#text').value=''; $('#file').value=''; window._droppedFile=null; drop.textContent='Upuść plik tutaj'; out.textContent='[tu pojawi się log]'; });

  // Opcjonalny szybki ping (CORS)
  (async ()=>{
    try{
      await fetch(($('#msgEndpoint').value||'/.netlify/functions/messages'), { method:'OPTIONS' }).catch(()=>null);
      log('ℹ Formularz gotowy.\nEndpointy:\n- upload: '+$('#uploadEndpoint').value+'\n- messages: '+$('#msgEndpoint').value+'\nJeśli zobaczysz błąd CORS/401 przy wysyłce, sprawdź funkcje Netlify.');
    }catch{ /* ignore */ }
  })();
})();
</script>
</body>
</html>
