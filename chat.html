<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Ä¢ Komunikator (Netlify Functions)</title>
<meta name="description" content="Czat oparty o Netlify Functions + Netlify Blobs. Pokoje, reakcje, edycja, kasowanie, za≈Çaduj starsze.">
<style>
  :root{
    --bg:#0b1020; --p1:#101736; --p2:#0f1a44; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0;
    --ok:#2b8a57; --bad:#ff6b6b; --line:#253166; --chip:#162357; --card:#0f1533; --hover:#172152;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:20px}
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:12px;height:calc(100% - 58px);padding:12px;max-width:1500px;margin:auto}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .left{display:flex;flex-direction:column}
  .section{padding:10px;border-bottom:1px solid var(--line)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.bad{background:#42202a;border-color:#7b3341}
  input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:var(--ink)}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .meta{font-size:11px;color:#aeb8da}
  .badge{display:inline-block;padding:1px 6px;border:1px solid #5672d1;border-radius:999px;font-size:10px;background:#0e184a;color:#cfe1ff}
  .msg-wrap{height:calc(100% - 180px);overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .day{display:flex;align-items:center;gap:10px;margin:2px 0}
  .day::before,.day::after{content:"";height:1px;background:#223160;flex:1}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bubble{background:linear-gradient(180deg,#111a3c,#0f1a44);border:1px solid #2a3a75;border-radius:12px;padding:8px 10px;max-width:980px;word-break:break-word}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .bubble .tools{display:flex;gap:6px;opacity:.9;margin-top:4px;flex-wrap:wrap}
  .bubble .tools .btn-icon{background:transparent;border:1px solid #2d3e86;border-radius:8px;padding:2px 6px;cursor:pointer;color:#cfe1ff}
  .bubble .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px;margin-top:4px}
  .reactions{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
  .react{background:#0e184a;border:1px solid #3f57c1;border-radius:999px;padding:2px 6px;font-size:12px;cursor:pointer}
  .children{margin-left:22px;margin-top:6px;border-left:1px dashed #2b3a77;padding-left:10px}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .loadmore{padding:8px 10px;text-align:center;border:1px dashed #2b3a77;border-radius:10px;cursor:pointer;background:#0d1530}
  .hoverable:hover{background:var(--hover)}
  @media(max-width:1060px){ .wrap{grid-template-columns:1fr} .msg-wrap{height:50vh} }
</style>
</head>
<body>
<header>
  <h1 style="display:flex;align-items:center;gap:10px;margin-bottom:6px">
    Komunikator ‚Ä¢ ARKON <span class="badge">Netlify</span>
  </h1>
</header>

<div class="wrap">
  <!-- LEWY PANEL -->
  <aside class="panel left" id="left">
    <div class="section">
      <div class="meta">Pokoje</div>
      <div class="row" style="margin-top:6px">
        <button class="btn ghost" data-room="global">üåç Wsp√≥lny</button>
        <button class="btn ghost" data-room="krolowa">üëë Kr√≥lowa</button>
        <button class="btn ghost" data-room="adrian">üë§ Adrian</button>
        <button class="btn ghost" data-room="emil">üë§ Emil</button>
      </div>
    </div>

    <div class="section">
      <div class="meta">Ja</div>
      <div class="row" style="margin-top:6px">
        <span class="pill">Podpis: <b id="meName">‚Äî</b></span>
        <button class="btn ghost" id="btnName">‚úé Zmie≈Ñ</button>
      </div>
      <div class="meta" id="conn" style="margin-top:6px">inicjalizacja‚Ä¶</div>
    </div>

    <div class="section">
      <div class="meta">Starsze wiadomo≈õci</div>
      <div class="loadmore hoverable" id="btnOlder">‚ü≤ Za≈Çaduj starsze‚Ä¶</div>
    </div>
  </aside>

  <!-- PRAWA STRONA: CZAT -->
  <main class="panel" id="chat" style="display:flex;flex-direction:column">
    <div class="topbar">
      <div class="row">
        <div id="roomTitle"><b>‚Äî</b></div>
      </div>
      <div class="row">
        <input id="file" type="file" hidden>
        <button class="btn ghost" id="btnAttach">üìé Za≈ÇƒÖcz</button>
      </div>
    </div>

    <div id="msgs" class="msg-wrap" aria-live="polite"></div>

    <div class="composer">
      <textarea id="txt" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Ctrl+Enter wysy≈Ça)" rows="2"></textarea>
      <div class="row">
        <button id="btnSend" class="btn ok">Wy≈õlij ‚ñ∂</button>
      </div>
    </div>
  </main>
</div>

<script>
'use strict';

/* === UTIL === */
const $ = s => document.querySelector(s);
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
const INT = new Intl.DateTimeFormat('pl-PL', { dateStyle:'short', timeStyle:'short' });
const linkify = t => (t||'').replace(/(https?:\/\/[^\s)]+)|(www\.[^\s)]+)/gi, (m)=>{
  const url = m.startsWith('http') ? m : 'http://' + m;
  return '<a href="'+url+'" target="_blank" rel="noopener">'+m+'</a>';
});
function dayLabel(ts){ try{ return INT.format(new Date(ts)).split(',')[0]; }catch{ return ''; }}

/* === STAN === */
const state = {
  room: localStorage.getItem('chat_room') || 'global',
  me:   localStorage.getItem('chat_me')   || 'Pracownik',
  oldest: null,
  list: [],
  cache: new Map()
};
$('#meName').textContent = state.me;
$('#roomTitle').innerHTML = '<b>'+state.room.toUpperCase()+'</b>';
$('#conn').textContent = 'gotowe';

/* === API (Netlify Functions) === */
async function apiGetMessages(room, before){
  const url = '/api/messages?room=' + encodeURIComponent(room) + (before ? '&before=' + encodeURIComponent(before) : '');
  const r = await fetch(url, { cache:'no-store' });
  if(!r.ok) throw new Error('GET /api/messages HTTP ' + r.status);
  return r.json(); // { items, oldest }
}
async function apiSendMessage(payload){
  const r = await fetch('/api/messages', {
    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('POST /api/messages HTTP ' + r.status);
  return r.json(); // { ok, item }
}
async function apiPatch(payload){
  const r = await fetch('/api/messages', {
    method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error('PATCH /api/messages HTTP ' + r.status);
}
async function apiDelete(id){
  const r = await fetch('/api/messages?id='+encodeURIComponent(id), { method:'DELETE' });
  if(!r.ok) throw new Error('DELETE /api/messages HTTP ' + r.status);
}
async function apiUploadFile(file){
  // opcjonalne: je≈õli nie masz funkcji upload.js, zwr√≥ƒá null
  try{
    const fd = new FormData(); fd.append('file', file);
    const r = await fetch('/api/upload', { method:'POST', body: fd });
    if(!r.ok) throw new Error('POST /api/upload HTTP ' + r.status);
    const j = await r.json();
    return j.url || null;
  }catch(e){
    console.warn('Upload funkcjƒÖ nieudany, pomijam:', e);
    return null;
  }
}

/* === RENDER === */
function reactionBadge(emoji, count, id){
  const span = document.createElement('span');
  span.className = 'react';
  span.textContent = emoji + ' ' + count;
  span.title = 'Dodaj reakcjƒô ' + emoji;
  span.addEventListener('click', ()=>react(id, emoji));
  return span;
}
function fileChip(url){
  const a = document.createElement('a');
  a.className = 'file'; a.href = url; a.target = '_blank'; a.rel='noopener';
  const name = (url||'').split('/').pop();
  a.textContent = 'üìé ' + (name || url);
  return a;
}
function bubbleNode(m, children){
  const wrap = document.createElement('div');
  wrap.className = 'msg'; wrap.id = 'm-' + m.id;

  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = (m.author===state.me ? 'Ja' : (m.author||'‚Äî'));
  wrap.appendChild(meta);

  const bubble = document.createElement('div');
  bubble.className = 'bubble' + (m.author===state.me ? ' me' : '');
  const body = document.createElement('div');
  body.innerHTML = m.deleted_at ? '<i class="meta">[wiadomo≈õƒá usuniƒôta]</i>' : linkify(m.body||'');
  bubble.appendChild(body);

  if(m.file_url){
    bubble.appendChild(fileChip(m.file_url));
  }

  const tools = document.createElement('div');
  tools.className = 'tools';

  const btnReply = el('button',{ className:'btn-icon', textContent:'üí¨ Odpowiedz' });
  btnReply.addEventListener('click', ()=>startReply(m.id));
  tools.appendChild(btnReply);

  ['üëç','‚ù§','üî•'].forEach(emo=>{
    const b = el('button',{ className:'btn-icon', textContent:emo });
    b.addEventListener('click', ()=>react(m.id, emo));
    tools.appendChild(b);
  });

  const when = el('span',{ className:'meta' });
  let tail = INT.format(new Date(m.created_at));
  if(m.author===state.me) tail += ' ‚úì‚úì';
  if(m.edited_at) tail += ' ‚Ä¢ ed.';
  when.style.marginLeft = 'auto';
  when.textContent = tail;
  tools.appendChild(when);

  if(m.author===state.me && !m.deleted_at){
    const be = el('button',{ className:'btn-icon', textContent:'‚úé Edytuj' });
    be.addEventListener('click', ()=>editMsg(m.id));
    const bd = el('button',{ className:'btn-icon', textContent:'üóë Usu≈Ñ' });
    bd.addEventListener('click', ()=>delMsg(m.id));
    tools.appendChild(be); tools.appendChild(bd);
  }

  bubble.appendChild(tools);

  if(m.reactions && typeof m.reactions==='object'){
    const entries = Object.entries(m.reactions).filter(([,v])=>v>0);
    if(entries.length){
      const box = el('div',{ className:'reactions' });
      entries.forEach(([emo,c])=> box.appendChild(reactionBadge(emo,c,m.id)));
      bubble.appendChild(box);
    }
  }

  if(children && children.length){
    const kids = el('div',{ className:'children' });
    children.forEach(c=> kids.appendChild(bubbleNode(c, [])));
    bubble.appendChild(kids);
  }

  wrap.appendChild(bubble);
  return wrap;
}
function indexByParent(list){
  const byId=new Map(), children=new Map();
  list.forEach(m=>{
    byId.set(m.id, m);
    if(m.parent_id){
      if(!children.has(m.parent_id)) children.set(m.parent_id, []);
      children.get(m.parent_id).push(m);
    }
  });
  return { byId, children };
}
function renderMessages(scrollToBottom){
  const box = $('#msgs');
  const { children } = indexByParent(state.list);
  const frag = document.createDocumentFragment();

  // day dividers
  let lastDay = '';
  state.list.filter(m=>!m.parent_id).forEach(m=>{
    const d = dayLabel(m.created_at);
    if(d && d !== lastDay){
      const day = el('div', { className:'day' });
      day.appendChild(document.createTextNode(d));
      frag.appendChild(day); lastDay = d;
    }
    frag.appendChild(bubbleNode(m, children.get(m.id)||[]));
  });

  const prevScroll = box.scrollHeight - box.scrollTop;
  box.innerHTML = '';
  box.appendChild(frag);
  if(scrollToBottom){
    box.scrollTop = box.scrollHeight;
  }else{
    // zachowaj wzglƒôdnƒÖ pozycjƒô przy do≈Çadowaniu starszych
    box.scrollTop = box.scrollHeight - prevScroll;
  }
}

/* === LOGIKA === */
let replyTo = null;
function startReply(id){
  replyTo = id;
  const m = state.cache.get(id);
  const preview = ‚Ü™ Odp: ${(m?.author||'‚Äî')}: ${(m?.body||'').slice(0,80)};
  const t = $('#txt');
  t.value = (preview + '\n' + t.value).trim() + ' ';
  t.focus();
}

async function react(id, emo){
  try{
    await apiPatch({ id, reaction: emo });
    // lokalne podbicie licznika (bez czekania)
    const m = state.cache.get(id);
    if(m){
      m.reactions = m.reactions || {};
      m.reactions[emo] = (m.reactions[emo]||0) + 1;
      renderMessages(false);
    }
  }catch(e){ console.error(e); }
}
async function editMsg(id){
  const m = state.cache.get(id);
  if(!m || m.author!==state.me || m.deleted_at) return;
  const t = prompt('Edytuj wiadomo≈õƒá:', m.body||''); if(t==null) return;
  try{
    await apiPatch({ id, body: t });
    m.body = t; m.edited_at = new Date().toISOString();
    renderMessages(false);
  }catch(e){ alert('B≈ÇƒÖd edycji: '+e.message); }
}
async function delMsg(id){
  const m = state.cache.get(id);
  if(!m || m.author!==state.me || m.deleted_at) return;
  if(!confirm('UsunƒÖƒá wiadomo≈õƒá?')) return;
  try{
    await apiDelete(id);
    m.deleted_at = new Date().toISOString();
    m.body = '[usuniƒôto]';
    renderMessages(false);
  }catch(e){ alert('B≈ÇƒÖd usuwania: '+e.message); }
}

async function send(text, fileUrl){
  text = (text||'').trim();
  if(!text && !fileUrl) return;
  try{
    const { item } = await apiSendMessage({
      room: state.room,
      author: state.me,
      body: text,
      parentId: replyTo,
      fileUrl: fileUrl || null
    });
    replyTo = null;
    $('#txt').value = '';
    if(item){
      state.list.push(item);
      state.cache.set(item.id, item);
      renderMessages(true);
    }else{
      // fallback: prze≈Çaduj ca≈Ço≈õƒá
      await loadInitial();
    }
  }catch(e){
    alert('B≈ÇƒÖd wysy≈Çania: ' + e.message);
  }
}

/* === ≈ÅADOWANIE === */
async function loadInitial(){
  try{
    const { items, oldest } = await apiGetMessages(state.room, null);
    state.list = Array.isArray(items) ? items : [];
    state.cache.clear();
    state.list.forEach(m=>state.cache.set(m.id, m));
    state.oldest = oldest || null;
    renderMessages(true);
  }catch(e){
    console.error(e);
    $('#conn').textContent = 'b≈ÇƒÖd pobierania';
  }
}
async function loadOlder(){
  if(!state.oldest) return;
  try{
    const { items, oldest } = await apiGetMessages(state.room, state.oldest);
    const older = (items||[]);
    if(!older.length){
      $('#btnOlder').textContent = '‚Äî brak starszych ‚Äî';
      return;
    }
    state.list = older.concat(state.list);
    older.forEach(m=>state.cache.set(m.id, m));
    state.oldest = oldest || state.oldest;
    renderMessages(false);
  }catch(e){
    console.error(e);
  }
}
async function pollNewest(){
  // dla prostoty ‚Äî ≈õciƒÖgamy od nowa; przy ma≈Çej skali wystarczy
  try{
    const { items } = await apiGetMessages(state.room, null);
    const fresh = Array.isArray(items)? items : [];
    // proste por√≥wnanie d≈Çugo≈õci/ostatniego id
    if(fresh.length > state.list.length){
      state.list = fresh;
      state.cache.clear();
      state.list.forEach(m=>state.cache.set(m.id, m));
      renderMessages(true);
    }
  }catch(e){ /* cicho */ }
}

/* === UI: zdarzenia === */
document.querySelectorAll('[data-room]').forEach(b=>{
  b.addEventListener('click', async ()=>{
    const id = b.getAttribute('data-room');
    if(state.room === id) return;
    state.room = id; localStorage.setItem('chat_room', id);
    $('#roomTitle').innerHTML = '<b>'+id.toUpperCase()+'</b>';
    state.oldest = null; state.list = []; state.cache.clear();
    $('#msgs').innerHTML = '';
    $('#btnOlder').textContent = '‚ü≤ Za≈Çaduj starsze‚Ä¶';
    await loadInitial();
  });
});
$('#btnName').addEventListener('click', ()=>{
  const n = prompt('Tw√≥j podpis (imiƒô w czacie):', state.me) || state.me;
  state.me = n; localStorage.setItem('chat_me', n); $('#meName').textContent = n;
});
$('#btnOlder').addEventListener('click', loadOlder);

$('#btnSend').addEventListener('click', async ()=>{
  const t = $('#txt').value;
  await send(t, null);
});
$('#txt').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){
    e.preventDefault(); $('#btnSend').click();
  }
});

$('#btnAttach').addEventListener('click', ()=>$('#file').click());
$('#file').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; e.target.value='';
  if(!f) return;
  // spr√≥buj przez funkcjƒô upload
  const url = await apiUploadFile(f);
  if(url){
    await send('', url);
    return;
  }
  // fallback data:URL (ma≈Çe pliki)
  if(f.size <= 1024*1024){
    const reader = new FileReader();
    reader.onload = async ()=>{ await send('', reader.result); };
    reader.readAsDataURL(f);
  }else{
    alert('Brak funkcji upload lub b≈ÇƒÖd. Plik za du≈ºy na data:URL.');
  }
});

/* === START === */
(async function init(){
  try{
    $('#meName').textContent = state.me;
    await loadInitial();
    setInterval(pollNewest, 5000); // prosty polling
  }catch(e){
    console.error(e);
    $('#conn').textContent = 'b≈ÇƒÖd inicjalizacji';
  }
})();
</script>
</body>
</html>
