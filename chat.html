<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/*** KONFIG SUPABASE ***/
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';
const supa = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession: false } });

/*** UTIL ***/
const $ = s => document.querySelector(s);
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
const INT = new Intl.DateTimeFormat('pl-PL', { dateStyle:'short', timeStyle:'short' });
const linkify = t => (t||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
const EMOJI = '😀😁😂🤣😊😉😍😘😎🤩🥰😇🤓🤠🫶👍👏🔥✨🎉🎯🚀🔧💡📎📷🖨📁✅❗❌🤝📝💬🔗📌🕒'.split('');

/*** STAN ***/
let state = {
  room: localStorage.getItem('chat_room') || 'global',
  me:   localStorage.getItem('chat_me')   || 'Pracownik',
  sub:null, presChan:null,
  typingTimer:null, typingViewTimer:null,
  oldestCursor:null,
  search:{ q:'', author:'' },
  cache: new Map(),
};

$('#meName').textContent = state.me;
$('#roomTitle').innerHTML = '<b>'+state.room.toUpperCase()+'</b>';
$('#conn').textContent = 'łączę…';

/*** ROUTER ***/
function route(){
  const hash = location.hash || '#/chat';
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('href')===hash));
  ['chat','contracts','docs','tasks'].forEach(id=>{
    const el = $('#page-'+id);
    el.style.display = (hash==='#/'+id) ? (id==='chat' ? 'flex' : 'block') : 'none';
  });
}
window.addEventListener('hashchange', route); route();

/*** EMOJI PICKER ***/
let picker=null;
function toggleEmoji(){
  if(picker){ document.body.removeChild(picker); picker=null; return; }
  picker = el('div');
  Object.assign(picker.style,{position:'fixed',bottom:'120px',right:'40px',background:'#0e1740',border:'1px solid #2b3a77',padding:'8px',borderRadius:'10px',zIndex:10});
  picker.innerHTML = EMOJI.map(e=><span class="emoji" style="font-size:22px;padding:6px;cursor:pointer">${e}</span>).join('');
  picker.addEventListener('click', ev=>{
    if(ev.target.classList.contains('emoji')){
      $('#txt').value += ev.target.textContent;
      document.body.removeChild(picker); picker=null;
      $('#txt').focus(); sendTyping(true);
    }
  });
  document.body.appendChild(picker);
}

/*** PRESENCE + TYPING ***/
function typingLabel(names){
  if(!names.length) return '';
  if(names.length===1) return names[0]+' pisze…';
  if(names.length===2) return names.join(' i ')+' piszą…';
  return names.slice(0,2).join(', ')+' i inni piszą…';
}
async function joinPresence(){
  if(state.presChan){ try{ await supa.removeChannel(state.presChan);}catch{} }
  const chan = supa.channel('presence:'+state.room, { config:{ presence:{ key: state.me } } });
  state.presChan = chan;

  chan.on('presence', { event:'sync' }, ()=>{
    const p = chan.presenceState();
    const names = Object.keys(p).sort();
    $('#presence').innerHTML = names.map(n=><span class="pill"><span class="dot"></span>${n}</span>).join('');
  });

  chan.on('broadcast', { event:'typing' }, ({payload})=>{
    const set = window._typingSet || new Set(); window._typingSet = set;
    if(payload.on) set.add(payload.user); else set.delete(payload.user);
    $('#typing').textContent = typingLabel([...set].filter(n=>n!==state.me));
    clearTimeout(state.typingViewTimer);
    state.typingViewTimer = setTimeout(()=>{ set.clear(); $('#typing').textContent=''; }, 3000);
  });

  chan.subscribe(status=>{
    if(status==='SUBSCRIBED'){ chan.track({ user: state.me, at: Date.now() }); }
  });
}
function sendTyping(on){
  try{ state.presChan?.send({ type:'broadcast', event:'typing', payload:{ user: state.me, on } }); }catch{}
}

/*** HISTORIA + PAGINACJA ***/
let messages = [];
function dayDivider(ts){
  return <div class="day"><span>${INT.format(new Date(ts)).split(',')[0]}</span></div>;
}
function reactionBadge(emoji, count){ return <span class="react" data-r="${emoji}">${emoji} ${count}</span>; }
function fileChip(url){
  const name = (url||'').split('/').pop();
  const isImg = /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(name);
  return <a class="file" href="${url}" target="_blank" rel="noopener">📎 ${name}</a> +
         (isImg? <div style="margin-top:6px"><img src="${url}" alt="" style="max-width:280px;border:1px solid #2b3a77;border-radius:10px"></div>:'');
}
function bubbleHtml(m, children=[]){
  const me = m.author===state.me;
  const body = linkify(m.body||'');
  const when = INT.format(new Date(m.created_at));
  const reacts = (m.reactions && typeof m.reactions==='object') ? Object.entries(m.reactions).filter(([,v])=>v>0) : [];
  return `
  <div class="msg" id="m-${m.id}">
    <div class="meta">${me?'Ja':(m.author||'—')}</div>
    <div class="bubble ${me?'me':''}">
      ${m.deleted_at? '<i class="meta">[wiadomość usunięta]</i>' : body}
      ${m.file_url? fileChip(m.file_url):''}
      <div class="tools">
        <button class="btn-icon" onclick="startReply('${m.id}')">💬 Odpowiedz</button>
        <button class="btn-icon" onclick="react('${m.id}','👍')">👍</button>
        <button class="btn-icon" onclick="react('${m.id}','❤')">❤</button>
        <button class="btn-icon" onclick="react('${m.id}','🔥')">🔥</button>
        ${me && !m.deleted_at ? `<button class="btn-icon" onclick="editMsg('${m.id}')">✎ Edytuj</button>
        <button class="btn-icon" onclick="delMsg('${m.id}')">🗑 Usuń</button>`:''}
        <span class="meta" style="margin-left:auto">${when} ${me?'<span title="lokalne ✓✓">✓✓</span>':''}${m.edited_at?' • ed.':''}</span>
      </div>
      ${reacts.length? <div class="reactions">${reacts.map(([emo,c])=>reactionBadge(emo,c)).join(' ')}</div>:''}
      ${children.length? <div class="children">${children.map(c=>bubbleHtml(c,[])).join('')}</div>:''}
    </div>
  </div>`;
}
function indexByParent(list){
  const byId=new Map(), children=new Map();
  list.forEach(m=>{
    byId.set(m.id,m);
    if(m.parent_id){
      let arr = children.get(m.parent_id);
      if(!arr){ arr=[]; children.set(m.parent_id,arr); }
      arr.push(m);
    }
  });
  return { byId, children };
}
function renderMessages(scrollToBottom=true){
  const box = $('#msgs');
  const { children } = indexByParent(messages);
  let out=[], lastDay='';
  messages.filter(m=>!m.parent_id).forEach(m=>{
    const d=(m.created_at||'').slice(0,10);
    if(d && d!==lastDay){ out.push(dayDivider(m.created_at)); lastDay=d; }
    out.push(bubbleHtml(m, children.get(m.id)||[]));
  });
  const older = $('#older').outerHTML;
  box.innerHTML = older + out.join('');
  if(scrollToBottom) box.scrollTop=box.scrollHeight;
}
async function loadInitial(){
  const lim=60;
  const { data, error } = await supa.from('messages')
    .select('*').eq('room_id', state.room)
    .order('created_at',{ascending:true}).limit(lim);
  if(error){ console.error(error); return; }
  messages = data||[];
  if(messages.length) state.oldestCursor = messages[0].created_at;
  messages.forEach(m=>state.cache.set(m.id,m));
  renderMessages(true);
}
async function loadOlder(){
  if(!state.oldestCursor) return;
  const { data, error } = await supa.from('messages')
    .select('*').eq('room_id', state.room)
    .lt('created_at', state.oldestCursor)
    .order('created_at',{ascending:false})
    .limit(40);
  if(error){ console.error(error); return; }
  const older = (data||[]).reverse();
  if(!older.length) { $('#older').textContent='— brak starszych —'; return; }
  messages = older.concat(messages);
  state.oldestCursor = messages[0].created_at;
  older.forEach(m=>state.cache.set(m.id,m));
  const box = $('#msgs'); const prev = box.scrollHeight;
  renderMessages(false);
  const diff = $('#msgs').scrollHeight - prev;
  box.scrollTop = diff;
}

/*** SUBSKRYPCJE ***/
async function subscribeRoom(){
  if(state.sub){ try{ await supa.removeChannel(state.sub);}catch{} }
  state.sub = supa.channel('room:'+state.room)
    .on('postgres_changes',
        { event:'INSERT', schema:'public', table:'messages', filter:'room_id=eq.'+state.room },
        (p)=>{ messages.push(p.new); state.cache.set(p.new.id,p.new); renderMessages(true); ding(); })
    .on('postgres_changes',
        { event:'UPDATE', schema:'public', table:'messages', filter:'room_id=eq.'+state.room },
        (p)=>{ const m=p.new; const i=messages.findIndex(x=>x.id===m.id); if(i>-1){ messages[i]=m; state.cache.set(m.id,m); renderMessages(false); } })
    .subscribe((status)=>{ $('#conn').textContent = status==='SUBSCRIBED'?'podłączono':'…'+String(status).toLowerCase(); });
}

/*** WYSYŁANIE / ODP / REAKCJE / EDYCJA / KASOWANIE ***/
let replyTo=null;
function startReply(id){
  replyTo=id;
  const m=state.cache.get(id);
  const preview = ↪ Odp: ${m?.author||'—'}: ${(m?.body||'').slice(0,80)};
  $('#txt').value = (preview+'\n'+$('#txt').value).trim() + ' ';
  $('#txt').focus();
}
async function react(id, emo){
  try{
    const m = state.cache.get(id) || (await supa.from('messages').select('*').eq('id',id).single()).data;
    const r = m.reactions || {};
    r[emo] = (r[emo]||0)+1;
    await supa.from('messages').update({ reactions:r }).eq('id', id);
  }catch(e){ console.error(e); }
}
async function editMsg(id){
  const m = state.cache.get(id); if(!m || m.author!==state.me || m.deleted_at) return;
  const t = prompt('Edytuj wiadomość:', m.body||''); if(t==null) return;
  const { error } = await supa.from('messages').update({ body:t, edited_at: new Date().toISOString() }).eq('id', id);
  if(error) alert(error.message);
}
async function delMsg(id){
  const m = state.cache.get(id); if(!m || m.author!==state.me || m.deleted_at) return;
  if(!confirm('Usunąć wiadomość?')) return;
  const { error } = await supa.from('messages').update({ deleted_at: new Date().toISOString(), body:'[usunięto]' }).eq('id', id);
  if(error) alert(error.message);
}
async function sendMessage(text, fileUrl){
  text=(text||'').trim();
  if(!text && !fileUrl) return;
  const payload = { room_id: state.room, author: state.me, body: text, file_url: fileUrl||null, parent_id: replyTo };
  const { error } = await supa.from('messages').insert([payload]);
  if(error){ alert('Błąd wysyłania: '+error.message); return; }
  $('#txt').value=''; replyTo=null;
}

/*** ZAŁĄCZNIKI ***/
$('#file').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const safe = f.name.replace(/[^\w.-]+/g,'_');
    const path = ${state.room}/${Date.now()}_${safe};
    const up = await supa.storage.from('chat').upload(path, f, {
      cacheControl:'3600', upsert:false, contentType: f.type || 'application/octet-stream'
    });
    if(up.error) throw up.error;
    const { data:{ publicUrl } } = supa.storage.from('chat').getPublicUrl(path);
    await sendMessage('', publicUrl);
  }catch(err){
    console.error(err);
    if(f.size <= 1024*1024){
      const reader=new FileReader();
      reader.onload = async ()=>{ await sendMessage('', reader.result); };
      reader.readAsDataURL(f);
    }else{
      alert('Nie udało się zapisać pliku (i zbyt duży na dataURL).');
    }
  }
  e.target.value='';
});

/*** PISANIE ***/
$('#txt').addEventListener('input', ()=>{
  clearTimeout(state.typingTimer);
  sendTyping(true);
  state.typingTimer = setTimeout(()=>sendTyping(false), 1200);
});
$('#txt').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); $('#btnSend').click(); }
});
$('#btnSend').addEventListener('click', async ()=>{ await sendMessage($('#txt').value, null); });

/*** SZUKANIE + FILTRY ***/
async function searchMessages(){
  state.search.q = $('#q').value.trim();
  state.search.author = $('#authorFilter').value.trim();
  const q=state.search.q, a=state.search.author;
  let req = supa.from('messages').select('*').eq('room_id', state.room).order('created_at',{ascending:true}).limit(400);
  if(a) req = req.eq('author', a);
  const { data, error } = await req;
  if(error){ console.error(error); return; }
  let arr = data||[];
  if(q){
    const rx = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i');
    arr = arr.filter(m=> rx.test(m.body||'') || rx.test(m.file_url||'') );
  }
  messages = arr;
  renderMessages(true);
}
function clearSearch(){
  $('#q').value=''; $('#authorFilter').value='';
  state.search={q:'',author:''};
  loadInitial();
}

/*** EKSPORT ***/
function exportCSV(){
  const rows=[['id','author','body','file','time','parent','edited','deleted']].concat(messages.map(m=>[
    m.id, m.author, m.body||'', m.file_url||'', m.created_at, m.parent_id||'', m.edited_at||'', m.deleted_at||''
  ]));
  const csv = rows.map(r=>r.map(s=>{s=(s??'').toString(); return /[;"\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}).join(';')).join('\n');
  const a=el('a',{href:URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})), download:'chat.csv'}); a.click();
}
function exportJSON(){
  const a=el('a',{href:URL.createObjectURL(new Blob([JSON.stringify(messages,null,2)],{type:'application/json'})), download:'chat.json'}); a.click();
}

/*** DŹWIĘK ***/
function ding(){ try{ new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAAAAA').play(); }catch{} }

/*** ROOM SWITCH ***/
async function setRoom(id){
  if(state.room===id) return;
  state.room=id; localStorage.setItem('chat_room', id);
  $('#roomTitle').innerHTML = '<b>'+id.toUpperCase()+'</b>';
  $('#msgs').scrollTop=0; messages=[]; state.oldestCursor=null; renderMessages(false);
  await loadInitial(); await subscribeRoom(); await joinPresence();
}

/*** JA (podpis) ***/
$('#btnName').addEventListener('click', ()=>{
  const n = prompt('Twój podpis (imię w czacie):', state.me) || state.me;
  state.me=n; localStorage.setItem('chat_me', n); $('#meName').textContent=n; joinPresence();
});

/*** START ***/
(async function init(){
  try{
    await loadInitial();
    await subscribeRoom();
    await joinPresence();
    $('#conn').textContent='gotowe';
  }catch(e){
    console.error(e); $('#conn').textContent='błąd inicjalizacji';
  }
})();
</script>
