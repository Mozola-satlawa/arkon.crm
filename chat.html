<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ARKON ‚Ä¢ Chat (Netlify)</title>
<style>
  :root{--bg:#0b1020;--p1:#101736;--p2:#0f1a44;--ink:#e8edff;--line:#253166;--muted:#aeb8da;--ok:#2b8a57;--bad:#ff6b6b}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:#0a0f1e;color:var(--ink);font:15px/1.5 system-ui}
  header{background:#11183a;border-bottom:1px solid var(--line);padding:10px 12px;position:sticky;top:0;z-index:2}
  .wrap{max-width:1200px;margin:auto;padding:12px;display:grid;gap:12px;grid-template-columns:300px 1fr}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .section{padding:10px;border-bottom:1px solid var(--line)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:transparent;border-style:dashed}
  input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;color:var(--ink);border-radius:10px;padding:8px}
  .msg-wrap{height:60vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:12px}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px}
  .bubble{background:#0f1a44;border:1px solid #2a3a75;border-radius:12px;padding:8px 10px}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .meta{color:var(--muted);font-size:12px}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .reactions{display:flex;gap:6px;margin-top:6px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px dashed #3a4ca3;border-radius:8px;padding:2px 6px}
  .load{margin:8px 12px;padding:8px;border:1px dashed #3a4ca3;border-radius:10px;text-align:center;cursor:pointer}
  @media(max-width:980px){.wrap{grid-template-columns:1fr} .msg-wrap{height:52vh}}
</style>
</head>
<body>
<header>
  <div class="row">
    <strong>ARKON ‚Ä¢ Chat (Netlify)</strong>
    <span id="status" class="meta">‚Äì</span>
  </div>
</header>

<div class="wrap">
  <!-- LEWA -->
  <aside class="panel">
    <div class="section">
      <div class="meta">Pok√≥j</div>
      <div class="row" style="margin-top:6px">
        <select id="roomSel" style="flex:1">
          <option value="global">global</option>
          <option value="krolowa">krolowa</option>
          <option value="adrian">adrian</option>
          <option value="emil">emil</option>
        </select>
        <button class="btn" id="saveRoom">Zapisz</button>
      </div>
    </div>
    <div class="section">
      <div class="meta">Ja (podpis)</div>
      <div class="row" style="margin-top:6px">
        <input id="me" placeholder="Twoje imiƒô" />
        <button class="btn" id="saveMe">Zapisz</button>
      </div>
    </div>
    <div class="section">
      <div class="meta">Za≈ÇƒÖcznik</div>
      <div class="row" style="margin-top:6px">
        <input type="file" id="file" />
        <button class="btn ghost" id="sendFile">Wy≈õlij plik</button>
      </div>
      <div id="lastFile" class="meta" style="margin-top:6px"></div>
    </div>
    <div class="section">
      <div class="meta">Akcje</div>
      <div class="row" style="margin-top:6px">
        <button class="btn ghost" id="reload">Od≈õwie≈º</button>
        <button class="btn ghost" id="loadOlder">Starsze‚Ä¶</button>
      </div>
    </div>
  </aside>

  <!-- PRAWA -->
  <main class="panel" style="display:flex;flex-direction:column">
    <div class="section">
      <div class="row">
        <strong>Pok√≥j: <span id="roomTitle">global</span></strong>
      </div>
    </div>

    <div id="msgs" class="msg-wrap" aria-live="polite"></div>

    <div class="composer">
      <textarea id="txt" rows="2" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Ctrl+Enter wysy≈Ça)"></textarea>
      <div class="row">
        <button class="btn" id="send">Wy≈õlij ‚ñ∂</button>
      </div>
    </div>
  </main>
</div>

<script>
'use strict';

/* ====== PROSTE USTAWIENIA ====== */
const API = {
  list:  (room, cursor) => /api/messages?room=${encodeURIComponent(room)}${cursor ? '&before=' + encodeURIComponent(cursor) : ''},
  add:   /api/messages,
  patch: /api/messages,
  del:   (id) => /api/messages?id=${encodeURIComponent(id)},
  upload: /api/upload
};

const $ = sel => document.querySelector(sel);
const INT = new Intl.DateTimeFormat('pl-PL',{dateStyle:'short', timeStyle:'short'});

/* ====== STAN ====== */
const state = {
  room: localStorage.getItem('room') || 'global',
  me:   localStorage.getItem('me')   || 'Pracownik',
  oldest: null,     // znacznik do paginacji ‚Äûstarsze‚Äù
  cache: new Map(), // id -> message
  replyTo: null
};

$('#roomSel').value = state.room;
$('#roomTitle').textContent = state.room;
$('#me').value = state.me;

/* ====== RENDER ====== */
function bubble(m){
  const me = m.author === state.me;
  const when = INT.format(new Date(m.created_at || Date.now()));
  const file = m.file_url ? <div class="chip">üìé <a href="${m.file_url}" target="_blank">${m.file_url.split('/').pop()}</a></div> : '';
  const reacts = m.reactions ? Object.entries(m.reactions).map(([k,v])=><button class="btn ghost" onclick="react('${m.id}','${k}')">${k} ${v}</button>).join(' ') : '';
  return `
    <div class="msg" id="m-${m.id}">
      <div class="meta">${me?'Ja':(m.author||'‚Äî')}</div>
      <div class="bubble ${me?'me':''}">
        ${m.deleted_at ? <i class="meta">[usuniƒôto]</i> : (m.body||'')}
        ${file}
        <div class="reactions" style="margin-top:6px">
          <button class="btn ghost" onclick="startReply('${m.id}')">üí¨ Odp</button>
          <button class="btn ghost" onclick="react('${m.id}','üëç')">üëç</button>
          <button class="btn ghost" onclick="react('${m.id}','‚ù§')">‚ù§</button>
          <button class="btn ghost" onclick="react('${m.id}','üî•')">üî•</button>
          ${me && !m.deleted_at ? `<button class="btn ghost" onclick="editMsg('${m.id}')">‚úé</button>
          <button class="btn ghost" onclick="delMsg('${m.id}')">üóë</button>` : ''}
          <span class="meta" style="margin-left:auto">${when}${m.edited_at?' ‚Ä¢ ed.':''}</span>
        </div>
      </div>
    </div>
  `;
}
function render(list, append=false){
  const box = $('#msgs');
  if(!append) box.innerHTML = '';
  const frag = document.createElement('div');
  list.forEach(m => {
    state.cache.set(m.id, m);
    frag.insertAdjacentHTML('beforeend', bubble(m));
  });
  box.appendChild(frag);
  if(!append) box.scrollTop = box.scrollHeight;
}

/* ====== API HELPERS ====== */
async function apiGet(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(${r.status} ${r.statusText});
  return r.json();
}
async function apiSend(url, method, body, isForm=false){
  const r = await fetch(url, {
    method,
    headers: isForm ? undefined : { 'Content-Type': 'application/json' },
    body: isForm ? body : JSON.stringify(body)
  });
  if(!r.ok) throw new Error(${method} ${url} -> ${r.status});
  return r.json();
}

/* ====== OPERACJE ====== */
async function load(initial=false){
  setStatus('≈Åadowanie‚Ä¶');
  try{
    const data = await apiGet(API.list(state.room, initial ? null : state.oldest));
    // Oczekujemy { items:[...], oldest:"ISO" }
    const items = Array.isArray(data) ? data : (data.items || []);
    if(initial){
      state.oldest = (items[0] && items[0].created_at) || null;
      render(items);
    }else{
      if(!items.length){ alert('Brak starszych.'); return; }
      state.oldest = items[0].created_at || state.oldest;
      render(items, true);
    }
    setStatus('OK');
  }catch(e){
    setStatus('B≈ÅƒÑD: '+e.message);
    showError('GET /api/messages ' + e.message);
  }
}
async function sendMsg(){
  const body = $('#txt').value.trim();
  if(!body) return;
  try{
    await apiSend(API.add, 'POST', { room: state.room, author: state.me, body, parentId: state.replyTo || null });
    $('#txt').value = '';
    state.replyTo = null;
    await load(true);
  }catch(e){
    showError('POST /api/messages ' + e.message);
  }
}
async function react(id, emoji){
  try{
    await apiSend(API.patch, 'PATCH', { id, reaction: emoji });
  }catch(e){
    showError('PATCH /api/messages ' + e.message);
  }
}
async function editMsg(id){
  const m = state.cache.get(id); if(!m) return;
  const t = prompt('Edytuj:', m.body||''); if(t==null) return;
  try{
    await apiSend(API.patch, 'PATCH', { id, body: t });
    await load(true);
  }catch(e){ showError('PATCH /api/messages ' + e.message); }
}
async function delMsg(id){
  if(!confirm('UsunƒÖƒá wiadomo≈õƒá?')) return;
  try{
    await apiSend(API.del(id), 'DELETE');
    await load(true);
  }catch(e){ showError('DELETE /api/messages ' + e.message); }
}
function startReply(id){
  const m = state.cache.get(id);
  state.replyTo = id;
  $('#txt').value = ‚Ü™ ${m?.author||'‚Äî'}: ${(m?.body||'').slice(0,80)}\n + $('#txt').value;
  $('#txt').focus();
}
async function sendFile(){
  const inp = $('#file'); const f = inp.files[0];
  if(!f){ alert('Wybierz plik'); return; }
  const fd = new FormData(); fd.append('file', f);
  try{
    const { url } = await apiSend(API.upload, 'POST', fd, true);
    $('#lastFile').textContent = 'Wys≈Çano: ' + url;
    // Wy≈õlij wiadomo≈õƒá z linkiem
    await apiSend(API.add, 'POST', { room: state.room, author: state.me, body: '', parentId: null, fileUrl: url });
    inp.value = '';
    await load(true);
  }catch(e){
    showError('POST /api/upload ' + e.message);
  }
}

/* ====== UI BINDINGS ====== */
$('#send').addEventListener('click', sendMsg);
$('#txt').addEventListener('keydown', e=>{
  if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMsg(); }
});
$('#reload').addEventListener('click', ()=>load(true));
$('#loadOlder').addEventListener('click', ()=>load(false));
$('#saveRoom').addEventListener('click', ()=>{
  state.room = $('#roomSel').value || 'global';
  localStorage.setItem('room', state.room);
  $('#roomTitle').textContent = state.room;
  state.oldest = null;
  load(true);
});
$('#saveMe').addEventListener('click', ()=>{
  state.me = $('#me').value.trim() || 'Pracownik';
  localStorage.setItem('me', state.me);
});
$('#sendFile').addEventListener('click', sendFile);

/* ====== INFO/ERROR ====== */
function setStatus(t){ $('#status').textContent = ' ' + t; }
function showError(t){
  const box = $('#msgs');
  const div = document.createElement('div');
  div.className = 'load';
  div.style.borderColor = '#7b3341';
  div.style.color = '#ffb3b3';
  div.textContent = t;
  box.prepend(div);
}

/* ====== START ====== */
load(true);
</script>
</body>
</html>
