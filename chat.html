
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Ä¢ Komunikator (Supabase)</title>
<meta name="description" content="Czat ARKON oparty o Supabase: pokoje, realtime, za≈ÇƒÖczniki do bucketa 'crm'.">
<style>
  :root{
    --bg:#0b1020; --p1:#0f1533; --p2:#111a3a; --ink:#e8edff; --muted:#aeb8da; --line:#223066;
    --accent:#4cc9f0; --ok:#2fbf71; --bad:#ff6b6b; --chip:#152056; --hover:#172152;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:20px}
  .wrap{display:grid;grid-template-columns:300px 1fr;gap:12px;height:calc(100% - 58px);padding:12px;max-width:1500px;margin:auto}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .left{display:flex;flex-direction:column}
  .section{padding:10px;border-bottom:1px solid var(--line)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2e925e}
  .btn.bad{background:#42202a;border-color:#7b3341}
  input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:var(--ink);font:inherit}
  .tab{padding:6px 10px;border:1px solid #2a3a75;border-radius:999px;cursor:pointer;font-size:12px}
  .tab.active{background:#14225a}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .msg-wrap{height:calc(100% - 200px);overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .day{display:flex;align-items:center;gap:10px;margin:2px 0}
  .day::before,.day::after{content:"";height:1px;background:#223160;flex:1}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bubble{background:linear-gradient(180deg,#111a3c,#0f1a44);border:1px solid #2a3a75;border-radius:12px;padding:8px 10px;max-width:980px;word-break:break-word}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .bubble .meta{font-size:12px;color:#aeb8da;opacity:.9;margin-bottom:4px}
  .bubble .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px;margin-top:4px}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .hoverable:hover{background:var(--hover)}
  .load{padding:8px 10px;text-align:center;border:1px dashed #2b3a77;border-radius:10px;background:#0d1530;cursor:pointer}
  @media(max-width:1060px){ .wrap{grid-template-columns:1fr} .msg-wrap{height:52vh} }
</style>
</head>
<body>
<!--
  SUPABASE ‚Äì szybki setup:
  1) Bucket 'crm' (publiczny) ‚Äì u Ciebie ju≈º jest.
  2) Tabela:
     create table if not exists messages (
       id uuid primary key default gen_random_uuid(),
       room text not null,
       author text not null,
       body text,
       file_url text,
       file_name text,
       created_at timestamptz default now()
     );
     create index on messages (room, created_at);

  3) Je≈õli RLS w≈ÇƒÖczone ‚Äì minimalne polityki:
     alter table messages enable row level security;
     create policy "read all"  on messages for select using (true);
     create policy "write all" on messages for insert with check (true);
-->
<header>
  <h1 style="display:flex;align-items:center;gap:10px">Komunikator ‚Ä¢ ARKON <span class="pill">Supabase</span></h1>
</header>

<div class="wrap">
  <!-- LEWY PANEL -->
  <aside class="panel left">
    <div class="section">
      <div class="row">
        <span class="pill">Pok√≥j:</span>
        <button class="btn ghost" data-room="krolowa">üëë Kr√≥lowa</button>
        <button class="btn ghost" data-room="adrian">üë§ Adrian</button>
        <button class="btn ghost" data-room="emil">üë§ Emil</button>
        <button class="btn ghost" data-room="global">üåç Wsp√≥lny</button>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="pill">Ja: <b id="meLabel">‚Äî</b></span>
        <button class="btn ghost" id="btnMe">Zmie≈Ñ podpis</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="btnReload">Od≈õwie≈º</button>
        <span id="status" class="pill">inicjalizacja‚Ä¶</span>
      </div>
    </div>

    <div class="section">
      <div>Szukaj</div>
      <div class="row" style="margin-top:6px">
        <input id="q" placeholder="fraza‚Ä¶" />
        <select id="qa">
          <option value="">‚Äî autor ‚Äî</option>
          <option>Kr√≥lowa</option><option>Adrian</option><option>Emil</option><option>Pracownik</option>
        </select>
        <button class="btn ghost" id="btnSearch">Szukaj</button>
        <button class="btn ghost" id="btnClearSearch">Wyczy≈õƒá</button>
      </div>
    </div>

    <div class="section">
      <div>Za≈ÇƒÖcznik (do bucketa <code>crm</code>)</div>
      <div class="row" style="margin-top:6px">
        <input id="file" type="file">
        <button class="btn" id="btnSendFile">Wy≈õlij plik</button>
      </div>
      <div class="small" id="uploadInfo" style="margin-top:6px;color:#aeb8da"></div>
    </div>
  </aside>

  <!-- PRAWY PANEL -->
  <main class="panel" style="display:flex;flex-direction:column">
    <div class="topbar">
      <div class="row"><b>Pok√≥j:</b> <span id="roomTitle">‚Äî</span></div>
      <div class="row"><button class="btn ghost" id="btnPrint">Drukuj</button></div>
    </div>

    <div id="msgs" class="msg-wrap" aria-live="polite">
      <div id="older" class="load hoverable">‚ü≤ Za≈Çaduj starsze‚Ä¶</div>
    </div>

    <div class="composer">
      <textarea id="txt" rows="2" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Ctrl/Cmd+Enter wysy≈Ça)"></textarea>
      <div class="row">
        <button class="btn ok" id="btnSend">Wy≈õlij ‚ñ∂</button>
      </div>
    </div>
  </main>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/* ====== KONFIG SUPABASE (te same dane co w dzia≈ÇajƒÖcej stronie z dokumentami) ====== */
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';
const BUCKET = 'crm';                     // pliki idƒÖ do bucketa 'crm'
const supa = supabase.createClient(SB_URL, SB_KEY, { auth:{ persistSession:false } });

/* ====== STAN / HELPERS ====== */
const $ = s => document.querySelector(s);
const INT = new Intl.DateTimeFormat('pl-PL',{dateStyle:'short', timeStyle:'short'});
const isImg = n => /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(n||'');
const esc = s => (s??'').toString().replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
const tidy = n => String(n).normalize('NFKD').replace(/[^\w.\-]+/g,'_').toLowerCase();
const rnd = () => Math.random().toString(36).slice(2,8);

let state = {
  room: localStorage.getItem('chat_room') || 'global',
  me:   localStorage.getItem('chat_me')   || 'Pracownik',
  realtime: null,
  newestTs: null,
  oldestTs: null,
  messages: []
};
$('#meLabel').textContent = state.me;
$('#roomTitle').textContent = state.room;

/* ====== RENDER ====== */
const linkify = t => String(t||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
function dayLine(ts){ return '<div class="day"><span>'+INT.format(new Date(ts)).split(',')[0]+'</span></div>'; }
function fileChip(url,name){
  const u = esc(url), n = esc(name||url.split('/').pop());
  const img = isImg(n) ? <div style="margin-top:6px"><img src="${u}" alt="" style="max-width:280px;border:1px solid #2a3a75;border-radius:10px"></div> : '';
  return <a class="file" href="${u}" target="_blank" rel="noopener">üìé ${n}</a>${img};
}
function render(list, toBottom){
  const box = $('#msgs');
  let out = [ $('#older').outerHTML ], lastDay='';
  (list||[]).forEach(m=>{
    const d = (m.created_at||'').slice(0,10);
    if(d && d!==lastDay){ out.push(dayLine(m.created_at)); lastDay=d; }
    const me = m.author === state.me;
    out.push(
      `<div class="msg">
        <div class="bubble ${me?'me':''}">
          <div class="meta"><b>${me?'Ja':esc(m.author||'‚Äî')}</b> ‚Ä¢ ${INT.format(new Date(m.created_at||Date.now()))}</div>
          <div>${linkify(esc(m.body||''))}</div>
          ${m.file_url ? <div style="margin-top:6px">${fileChip(m.file_url, m.file_name)}</div> : ''}
        </div>
      </div>`
    );
  });
  box.innerHTML = out.join('');
  if(toBottom) box.scrollTop = box.scrollHeight;
}

/* ====== API: list/send/upload ====== */
async function listMessages({room, limit=100, before=null}){
  let q = supa.from('messages').select('*').eq('room', room).order('created_at', { ascending: true }).limit(limit);
  if(before) q = q.lt('created_at', before);
  const { data, error } = await q;
  if(error) throw error;
  return data || [];
}
async function sendMessage({room, author, body, file_url=null, file_name=null}){
  const { error } = await supa.from('messages').insert({ room, author, body, file_url, file_name });
  if(error) throw error;
}
async function uploadFile(file){
  const path = chat/${tidy(state.room)}/${Date.now()}_${rnd()}_${tidy(file.name)};
  const up = await supa.storage.from(BUCKET).upload(path, file, { upsert:false, cacheControl:'3600', contentType: file.type||'application/octet-stream' });
  if(up.error) throw up.error;
  const pub = supa.storage.from(BUCKET).getPublicUrl(up.data.path);
  return { url: pub.data.publicUrl, name: file.name };
}

/* ====== REALTIME ====== */
function stopRealtime(){ if(state.realtime){ supa.removeChannel(state.realtime); state.realtime=null; } }
function startRealtime(){
  stopRealtime();
  state.realtime = supa
    .channel('room:'+state.room)
    .on('postgres_changes',
      { event:'INSERT', schema:'public', table:'messages', filter:room=eq.${state.room} },
      payload => {
        const m = payload.new;
        state.messages.push(m);
        state.newestTs = m.created_at;
        render(state.messages, true);
      }
    )
    .subscribe(status => {
      $('#status').textContent = 'realtime: '+status;
    });
}

/* ====== ≈ÅADOWANIE / STRONA ====== */
async function loadInitial(){
  $('#status').textContent = 'pobieram‚Ä¶';
  const rows = await listMessages({ room: state.room, limit: 200 });
  state.messages = rows;
  state.oldestTs = rows[0]?.created_at || null;
  state.newestTs = rows.at(-1)?.created_at || null;
  render(state.messages, true);
  $('#status').textContent = 'gotowe';
}
async function loadOlder(){
  if(!state.oldestTs){ $('#status').textContent='brak starszych'; return; }
  $('#status').textContent='starsze‚Ä¶';
  const older = await listMessages({ room: state.room, limit: 200, before: state.oldestTs });
  state.messages = [...older, ...state.messages];
  state.oldestTs = state.messages[0]?.created_at || state.oldestTs;
  render(state.messages, false);
  $('#status').textContent='gotowe';
}

/* ====== UI BINDINGS ====== */
$('#btnSend').addEventListener('click', async ()=>{
  const t = $('#txt'); const text = (t.value||'').trim();
  if(!text) return;
  try{
    await sendMessage({ room: state.room, author: state.me, body: text });
    t.value='';
    // realtime do≈õle wpis; dla pewno≈õci dorysuj od razu
  }catch(e){
    alert('B≈ÇƒÖd wysy≈Çki: '+(e.message||e));
  }
});
$('#txt').addEventListener('keydown', e=>{
  if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); $('#btnSend').click(); }
});
$('#btnReload').addEventListener('click', loadInitial);
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#older').addEventListener('click', loadOlder);

document.querySelectorAll('[data-room]').forEach(b=>{
  b.addEventListener('click', async ()=>{
    const r=b.getAttribute('data-room');
    if(r===state.room) return;
    state.room=r; localStorage.setItem('chat_room', r);
    $('#roomTitle').textContent=r;
    state.messages=[]; state.oldestTs=null; state.newestTs=null;
    render([], false);
    startRealtime();
    await loadInitial();
  });
});

$('#btnMe').addEventListener('click', ()=>{
  const n = prompt('Tw√≥j podpis:', state.me) || state.me;
  state.me=n; localStorage.setItem('chat_me', n); $('#meLabel').textContent=n;
});

$('#btnSendFile').addEventListener('click', async ()=>{
  const f = $('#file').files[0];
  if(!f){ alert('Wybierz plik.'); return; }
  $('#uploadInfo').textContent = 'Wysy≈Çanie‚Ä¶';
  try{
    const up = await uploadFile(f);
    await sendMessage({ room: state.room, author: state.me, body: '', file_url: up.url, file_name: f.name });
    $('#file').value='';
    $('#uploadInfo').textContent = 'Za≈ÇƒÖcznik wys≈Çany ‚úì';
  }catch(e){
    $('#uploadInfo').textContent = 'B≈ÇƒÖd: '+(e.message||e);
  }
});

$('#btnSearch').addEventListener('click', ()=>{
  const q=($('#q').value||'').trim(); const a=($('#qa').value||'').trim();
  const rx = q ? new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'i') : null;
  let arr = state.messages.slice();
  if(a) arr = arr.filter(m=>m.author===a);
  if(rx) arr = arr.filter(m=> rx.test(m.body||'') || rx.test(m.file_name||'') || rx.test(m.file_url||'') );
  render(arr, false);
  setTimeout(()=>render(state.messages,false), 8000);
});
$('#btnClearSearch').addEventListener('click', ()=>{ $('#q').value=''; $('#qa').value=''; render(state.messages,false); });

/* ====== START ====== */
(async function init(){
  $('#status').textContent='≈ÇƒÖczƒô‚Ä¶';
  startRealtime();
  await loadInitial();
})();
</script>
</body>
</html>
