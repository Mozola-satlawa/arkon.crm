
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON â€¢ Komunikator (Netlify Blobs)</title>
<meta name="description" content="Chat ARKON: pokoje, emoji, zaÅ‚Ä…czniki. Netlify Blobs bez funkcji upload.">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  body{margin:0;background:#0a0f1e;color:#e8edff;font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;background:#11183a;position:sticky;top:0;border-bottom:1px solid #223160}
  h1{margin:0;font-size:20px}
  .wrap{display:flex;gap:12px;padding:12px;height:calc(100% - 58px)}
  .panel{flex:1;display:flex;flex-direction:column;background:#0f1533;border:1px solid #223160;border-radius:12px}
  .msg-wrap{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px}
  .bubble{background:#101736;border:1px solid #2a3a75;border-radius:12px;padding:8px 10px}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .composer{border-top:1px solid #223160;padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:#e8edff}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .file{display:inline-block;margin-top:4px;padding:4px 6px;border:1px dashed #3a4ca3;border-radius:6px}
</style>
</head>
<body>
<header><h1>Komunikator â€¢ ARKON</h1></header>

<div class="wrap">
  <main class="panel">
    <div id="msgs" class="msg-wrap"></div>
    <div class="composer">
      <textarea id="txt" placeholder="WiadomoÅ›Ä‡â€¦"></textarea>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button id="btnSend" class="btn">WyÅ›lij â–¶</button>
        <label class="btn" style="text-align:center">ðŸ“Ž
          <input type="file" id="file" hidden>
        </label>
      </div>
    </div>
  </main>
</div>

<!-- Netlify Blobs client -->
<script src="https://cdn.jsdelivr.net/npm/@netlify/blobs@6.5.0/dist/netlify-blobs.js"></script>
<script>
'use strict';

// Blobs client â€“ uÅ¼yj tego samego store co w funkcji messages.js
const blobs = new netlifyBlobs.NetlifyBlobsClient({ 
  siteID: '<TWOJE_SITE_ID>', 
  token: '<NETLIFY_API_TOKEN>', 
  store: 'chat-blobs' 
});

// Funkcja do listowania wiadomoÅ›ci (Blobs JSON)
async function loadMessages(){
  const { blobs: list } = await blobs.list({ limit:100 });
  const msgs = [];
  for(const it of list){
    const obj = await blobs.get(it.key, { type:'json' });
    msgs.push({ id:it.key, ...obj });
  }
  msgs.sort((a,b)=>new Date(a.created_at)-new Date(b.created_at));
  render(msgs);
}

function render(list){
  const box=document.getElementById('msgs');
  box.innerHTML='';
  list.forEach(m=>{
    const div=document.createElement('div');
    div.className='msg';
    div.innerHTML=`
      <div style="font-size:12px;color:#aeb8da">${m.author||'Anon'}</div>
      <div class="bubble ${m.author===me?'me':''}">
        ${m.body||''}
        ${m.file_url? <div><a class="file" href="${m.file_url}" target="_blank">ðŸ“Ž ${m.file_name||'plik'}</a></div>:''}
      </div>`;
    box.appendChild(div);
  });
  box.scrollTop=box.scrollHeight;
}

async function sendMessage(text,fileUrl,fileName){
  const obj={
    author: me,
    body: text||'',
    file_url:fileUrl||null,
    file_name:fileName||null,
    created_at:new Date().toISOString()
  };
  const key='msg-'+Date.now()+'-'+Math.random().toString(36).slice(2);
  await blobs.setJSON(key,obj);
  loadMessages();
}

// Upload pliku bezpoÅ›rednio do Blobs
async function uploadFile(file){
  const key='upload-'+Date.now()+'-'+file.name.replace(/\s+/g,'_');
  await blobs.set(key,file,{ contentType:file.type||'application/octet-stream' });
  // generujemy URL publiczny
  const url = blobs.getPublicUrl(key);
  return { url, name:file.name };
}

// UI
let me=localStorage.getItem('me')||prompt('Twoje imiÄ™?','Pracownik');
localStorage.setItem('me',me);

document.getElementById('btnSend').addEventListener('click',async()=>{
  const t=document.getElementById('txt');
  const txt=t.value.trim(); if(!txt) return;
  await sendMessage(txt,null,null);
  t.value='';
});
document.getElementById('file').addEventListener('change',async e=>{
  const f=e.target.files[0]; if(!f) return;
  const up=await uploadFile(f);
  await sendMessage('',up.url,up.name);
  e.target.value='';
});

// start
loadMessages();
setInterval(loadMessages,4000);
</script>
</body>
</html>
