<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Ä¢ Chat (Netlify Functions)</title>
<style>
  :root{--bg:#0b1020;--p1:#101736;--p2:#0f1a44;--ink:#e8edff;--muted:#aeb8da;--line:#253166}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a}
  h1{margin:0;font-size:20px}
  .wrap{max-width:980px;margin:12px auto;padding:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  button{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  button.ghost{background:transparent;border:1px dashed #3a4ca3}
  textarea,input{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:var(--ink)}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:12px}
  #msgs{height:52vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:10px;background:#0e1536;border:1px solid #26306a;border-radius:12px}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bub{background:#111b3f;border:1px solid #2a3a75;border-radius:12px;padding:8px 10px}
  .msg.me .bub{background:#16204d;border-color:#3d58c1}
  .meta{font-size:11px;color:#aeb8da}
  .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px}
  img.preview{max-width:300px;border:1px solid #2a3a75;border-radius:8px;margin-top:6px}
</style>
</head>
<body>
<header>
  <h1>ARKON ‚Ä¢ Chat</h1>
</header>

<div class="wrap">
  <div class="panel">
    <div class="row" style="margin-bottom:8px">
      <span class="pill">Pok√≥j: <b id="roomLbl">global</b></span>
      <span class="pill">Ja: <b id="meLbl">Pracownik</b></span>
      <button id="btnReload" class="ghost" type="button">‚ü≥ Od≈õwie≈º</button>
      <label class="pill" style="cursor:pointer">Za≈Çaduj plik‚Ä¶ <input id="file" type="file" hidden></label>
    </div>

    <div id="msgs" aria-live="polite"></div>

    <div class="row" style="margin-top:10px">
      <textarea id="txt" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Ctrl+Enter wysy≈Ça)" rows="2"></textarea>
      <button id="btnSend" type="button">Wy≈õlij ‚ñ∂</button>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";

  // ===== USTAWIENIA U≈ªYTKOWNIKA =====
  const ROOM = localStorage.getItem('chat_room') || 'global';
  const ME   = localStorage.getItem('chat_me')   || 'Pracownik';

  // ===== DOM =====
  const $ = s => document.querySelector(s);
  const msgsBox   = $('#msgs');
  const txt       = $('#txt');
  const fileInput = $('#file');
  $('#roomLbl').textContent = ROOM;
  $('#meLbl').textContent   = ME;

  // ===== HELPERS =====
  const INT = new Intl.DateTimeFormat('pl-PL', { dateStyle:'short', timeStyle:'short' });
  const esc = s => (s==null?'':String(s)).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));
  const linkify = t => String(t||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');

  function fileChip(url) {
    const name = (url||'').split('/').pop();
    const isImg = /^data:image\//.test(url) || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(name);
    return (
      '<a class="file" href="'+esc(url)+'" target="_blank" rel="noopener">üìé '+esc(name||'plik')+'</a>' +
      (isImg ? '<div><img class="preview" src="'+esc(url)+'" alt=""></div>' : '')
    );
  }

  function render(messages) {
    const out = [];
    let lastDay = '';
    (messages || []).forEach(m => {
      const day = (m.created_at||'').slice(0,10);
      if (day && day !== lastDay) {
        out.push('<div class="meta" style="text-align:center;margin:6px 0">'+
          esc(INT.format(new Date(m.created_at)).split(',')[0])+'</div>');
        lastDay = day;
      }
      const me = m.author === ME;
      out.push(
        '<div class="msg '+(me ? 'me' : '')+'">'+
          '<div class="meta" style="min-width:90px">'+(me ? 'Ja' : esc(m.author||'‚Äî'))+'</div>'+
          '<div class="bub">'+
            (m.deleted_at ? '<i class="meta">[usuniƒôto]</i>' : linkify(esc(m.body||'')))+
            (m.file_url ? fileChip(m.file_url) : '')+
            '<div class="meta" style="margin-top:4px">'+INT.format(new Date(m.created_at))+(m.edited_at ? ' ‚Ä¢ ed.' : '')+'</div>'+
          '</div>'+
        '</div>'
      );
    });
    msgsBox.innerHTML = out.join('');
    msgsBox.scrollTop = msgsBox.scrollHeight;
  }

  // ===== API =====
  async function apiGetMessages() {
    const res = await fetch('/api/messages?room=' + encodeURIComponent(ROOM));
    if (!res.ok) throw new Error('GET /api/messages HTTP '+res.status);
    return res.json(); // { room, items }
  }

  async function apiSend({ body = '', file_url = null }) {
    const res = await fetch('/api/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ room: ROOM, author: ME, body, file_url })
    });
    if (!res.ok) throw new Error('POST /api/messages HTTP '+res.status);
    return res.json();
  }

  // ===== AKCJE =====
  async function load() {
    try {
      const data = await apiGetMessages();
      render(data.items || []);
    } catch (e) {
      console.error(e);
      alert('B≈ÇƒÖd pobierania wiadomo≈õci');
    }
  }

  async function sendMsg() {
    const text = (txt.value || '').trim();
    if (!text) return;
    try {
      await apiSend({ body: text, file_url: null });
      txt.value = '';
      await load();
    } catch (e) {
      console.error(e);
      alert('B≈ÇƒÖd wysy≈Çania wiadomo≈õci');
    }
  }

  async function sendFileFromBrowser(file) {
    // Testowo: wysy≈Çamy jako data:URL (dzia≈Ça od razu, bez backendu do storage)
    const reader = new FileReader();
    reader.onload = async () => {
      try {
        const dataUrl = reader.result; // data:<mime>;base64,...
        await apiSend({ body: '', file_url: String(dataUrl) });
        await load();
      } catch (e) {
        console.error(e);
        alert('B≈ÇƒÖd wysy≈Çania pliku');
      }
    };
    reader.onerror = () => alert('B≈ÇƒÖd odczytu pliku');
    reader.readAsDataURL(file);
  }

  // ===== ZDARZENIA =====
  const btnReload = $('#btnReload');
  if (btnReload) btnReload.addEventListener('click', load);

  const btnSend = $('#btnSend');
  if (btnSend) btnSend.addEventListener('click', sendMsg);

  if (txt) {
    txt.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
        e.preventDefault();
        sendMsg();
      }
    });
  }

  if (fileInput) {
    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) sendFileFromBrowser(f);
      e.target.value = '';
    });
  }

  // START
  load();
})();
</script>
</body>
</html>
