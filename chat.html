<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Komunikator (Supabase)</title>
<meta name="description" content="Lekki komunikator ARKON z Supabase: pokoje, konta, wiadomo≈õci, realtime, presence, za≈ÇƒÖczniki, emoji, eksport.">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1020; --p1:#101736; --p2:#0f1a44; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0;
    --ok:#2b8a57; --bad:#ff6b6b; --line:#253166; --chip:#162357; --card:#0f1533;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a}
  h1{margin:0;font-size:20px}
  .wrap{display:grid;grid-template-columns:280px 1fr;gap:12px;height:calc(100% - 58px);padding:12px;max-width:1400px;margin:auto}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;overflow:hidden}
  .left{display:flex;flex-direction:column}
  .section{padding:10px;border-bottom:1px solid var(--line)}
  .list{overflow:auto;min-height:150px;max-height:40vh}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{font:500 14px/1.2 system-ui,Segoe UI,Roboto,Arial;color:var(--ink)}
  input,select,textarea{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px}
  button{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:9px 12px;cursor:pointer}
  button.ghost{background:transparent;border:1px dashed #3a4ca3}
  button.ok{background:#194d34;border-color:var(--ok)}
  button.bad{background:#42202a;border-color:#7b3341}
  .msg-wrap{height:calc(100% - 170px);overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bubble{background:linear-gradient(180deg,#111a3c,#0f1a44);border:1px solid #2a3a75;border-radius:12px;padding:8px 10px;max-width:920px;word-break:break-word}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .meta{font-size:11px;color:#aeb8da}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .emoji{cursor:pointer}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .online{display:flex;gap:6px;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;margin-right:6px}
  .system{opacity:.7;font-style:italic}
  .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px}
  .divider{display:flex;align-items:center;gap:10px;margin:12px 0}
  .divider span{font-size:12px;color:#aeb8da}
  .divider::before,.divider::after{content:"";height:1px;background:#223160;flex:1}
  .badge{display:inline-block;padding:1px 6px;border:1px solid #5672d1;border-radius:999px;font-size:10px;background:#0e184a;color:#cfe1ff}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  @media(max-width:980px){ .wrap{grid-template-columns:1fr} .msg-wrap{height:50vh} }
</style>
</head>
<body>
<header>
  <h1>Komunikator ‚Ä¢ ARKON</h1>
  <div class="row" style="margin-top:4px">
    <span class="pill">Realtime + Presence</span>
    <span class="pill">Emoji & Za≈ÇƒÖczniki</span>
    <span class="pill">Eksport/Druk</span>
  </div>
</header>

<div class="wrap">
  <!-- LEWY PANEL: konta, pokoje, ustawienia -->
  <aside class="panel left">
    <div class="topbar">
      <div class="row">
        <span class="badge">Supabase</span>
        <span id="conn" class="meta">≈ÇƒÖczenie‚Ä¶</span>
      </div>
      <div class="row">
        <button id="btnReload" class="ghost" title="Od≈õwie≈º listy">‚ü≥</button>
      </div>
    </div>

    <div class="section">
      <div class="meta">Konto (workspace)</div>
      <div class="row" style="margin-top:6px">
        <select id="selAccount"></select>
        <button id="btnAddAcc" class="ghost">+ Konto</button>
      </div>
      <div id="accList" class="list"></div>
    </div>

    <div class="section">
      <div class="meta">Pokoje</div>
      <div class="row" style="margin-top:6px">
        <select id="selRoom"></select>
        <button id="btnAddRoom" class="ghost">+ Pok√≥j</button>
      </div>
      <div id="roomList" class="list"></div>
    </div>

    <div class="section">
      <div class="meta">Online w pokoju</div>
      <div id="presence" class="online" style="margin-top:6px"></div>
    </div>

    <div class="section">
      <div class="meta">Eksport</div>
      <div class="row" style="margin-top:6px">
        <button id="btnCSV" class="ghost">CSV</button>
        <button id="btnJSON" class="ghost">JSON</button>
        <button id="btnPrint" class="ghost">Drukuj</button>
      </div>
    </div>
  </aside>

  <!-- PRAWO: chat -->
  <main class="panel" style="display:flex;flex-direction:column">
    <div class="topbar">
      <div class="row">
        <div id="roomTitle"><b>‚Äî</b></div>
        <div id="roomHint" class="meta" style="margin-left:8px"></div>
      </div>
      <div class="toolbar">
        <span class="pill">M√≥j podpis: <b id="meName">‚Äî</b></span>
        <button id="btnName" class="ghost">‚úé Zmie≈Ñ</button>
        <span id="readBadge" class="badge" title="Lokalne potwierdzenia odczytu">‚úì‚úì</span>
      </div>
    </div>

    <div id="msgs" class="msg-wrap" aria-live="polite"></div>

    <div class="composer">
      <div class="row" style="width:100%">
        <button id="btnEmoji" title="Wstaw emoji">üòä</button>
        <textarea id="txt" placeholder="Napisz wiadomo≈õƒá‚Ä¶ (Ctrl+Enter wysy≈Ça)" rows="2" style="flex:1"></textarea>
        <input id="file" type="file" hidden>
        <button id="btnFile" class="ghost" title="Dodaj za≈ÇƒÖcznik">üìé</button>
      </div>
      <div class="row">
        <button id="btnSend" class="ok">Wy≈õlij ‚ñ∂</button>
      </div>
    </div>
  </main>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/*** KONFIG SUPABASE (Twoje dane) ***/
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';

/*** INICJALIZACJA ***/
const supa = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession: false } });
const $ = s => document.querySelector(s);
const INT = new Intl.DateTimeFormat('pl-PL', { dateStyle:'short', timeStyle:'short' });

let state = {
  account: localStorage.getItem('chat_acc') || 'arkon-crm',
  room:    localStorage.getItem('chat_room')|| 'global',
  me:      localStorage.getItem('chat_me')  || 'Pracownik',
  sub: null, presChan: null, presenceIds: new Set(),
  cursor: null, // do stronicowania w d√≥≈Ç (opcjonalnie)
};

$('#meName').textContent = state.me;
$('#conn').textContent = '≈ÇƒÖczƒô‚Ä¶';

/*** UI: listy kont i pokoi ***/
async function loadAccounts(){
  const { data, error } = await supa.from('accounts').select('id').order('id');
  if(error){ console.error(error); $('#conn').textContent='b≈ÇƒÖd kont'; return; }
  const sel = $('#selAccount'); sel.innerHTML='';
  (data||[]).forEach(a=>{
    const o=document.createElement('option'); o.value=a.id; o.textContent=a.id; if(a.id===state.account) o.selected=true; sel.appendChild(o);
  });
  $('#accList').innerHTML = (data||[]).map(a=>`<div class="pill">${a.id}</div>`).join('');
}
async function loadRooms(){
  const { data, error } = await supa.from('rooms').select('id,label').order('id');
  if(error){ console.error(error); $('#conn').textContent='b≈ÇƒÖd pokoi'; return; }
  const sel = $('#selRoom'); sel.innerHTML='';
  (data||[]).forEach(r=>{
    const o=document.createElement('option'); o.value=r.id; o.textContent=r.label||r.id; if(r.id===state.room) o.selected=true; sel.appendChild(o);
  });
  $('#roomList').innerHTML = (data||[]).map(r=>`<div class="pill">${r.label||r.id}</div>`).join('');
  const curr = (data||[]).find(r=>r.id===state.room);
  $('#roomTitle').innerHTML = '<b>'+ (curr?.label || state.room) +'</b>';
  $('#roomHint').textContent = 'Pok√≥j ID: '+state.room+' ‚Ä¢ Konto: '+state.account;
}

/*** ≈ÅADOWANIE WIADOMO≈öCI ***/
let messages = [];
function bubbleHtml(m){
  const me = m.author === state.me;
  const body = (m.body||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank">$1</a>');
  let filePart='';
  if(m.file_url){
    const fn = m.file_url.split('/').pop();
    filePart = ` <a class="file" href="${m.file_url}" target="_blank" rel="noopener">üìé <span>${fn}</span></a>`;
  }
  return `<div class="msg ${m.system?'system':''}">
    <div class="meta">${me? 'Ja' : (m.author||'‚Äî')}</div>
    <div class="bubble ${me?'me':''}">${body}${filePart}
      <div class="meta">${INT.format(new Date(m.created_at))} ${me?'<span title="Lokalny znacznik odczytu">‚úì‚úì</span>':''}</div>
    </div>
  </div>`;
}
function renderMessages(scroll=true){
  const box = $('#msgs');
  let out = [];
  let lastDay = '';
  messages.forEach(m=>{
    const d = (m.created_at||'').slice(0,10);
    if(d && d!==lastDay){ out.push(`<div class="divider"><span>${INT.format(new Date(m.created_at)).split(',')[0]}</span></div>`); lastDay = d; }
    out.push(bubbleHtml(m));
  });
  box.innerHTML = out.join('');
  if(scroll) box.scrollTop = box.scrollHeight;
}
async function loadHistory(){
  const { data, error } = await supa
    .from('messages')
    .select('*')
    .eq('account_id', state.account)
    .eq('room_id', state.room)
    .order('created_at', { ascending:true })
    .limit(200);
  if(error){ console.error(error); return; }
  messages = data || [];
  renderMessages(true);
}

/*** REALTIME: nowe wiadomo≈õci ***/
async function subscribeChannel(){
  if(state.sub) { try{ await supa.removeChannel(state.sub) }catch{} }
  state.sub = supa.channel('room-'+state.account+'-'+state.room)
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'messages', filter:`account_id=eq.${state.account}` }, (payload)=>{
      const m = payload.new;
      if(m.room_id !== state.room) return;
      messages.push(m);
      renderMessages(true);
      ding();
    })
    .subscribe((status)=>{ $('#conn').textContent = status==='SUBSCRIBED'?'pod≈ÇƒÖczono':'‚Ä¶'+status.toLowerCase(); });
}

/*** PRESENCE ***/
async function joinPresence(){
  if(state.presChan){ try{ await supa.removeChannel(state.presChan); }catch{} }
  const key = 'presence:'+state.account+':'+state.room;
  const chan = supa.channel(key, { config: { presence: { key: state.me } } });
  state.presChan = chan;
  chan.on('presence', { event: 'sync' }, ()=>{
    const stateP = chan.presenceState();
    const names = Object.keys(stateP).sort();
    $('#presence').innerHTML = names.map(n=>`<span class="pill"><span class="dot"></span>${n}</span>`).join('');
  });
  chan.subscribe(async (s)=>{
    if(s==='SUBSCRIBED'){
      await chan.track({ user: state.me, at: Date.now() });
    }
  });
}

/*** WYSY≈ÅANIE ***/
async function sendMessage(text, fileUrl){
  text = (text||'').trim();
  if(!text && !fileUrl) return;
  const { error } = await supa.from('messages').insert([{
    account_id: state.account, room_id: state.room, author: state.me, body: text, file_url: fileUrl || null
  }]);
  if(error){ alert('B≈ÇƒÖd wysy≈Çania: '+error.message); return; }
  $('#txt').value='';
}
function ding(){
  try{ new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAAAAA').play(); }catch{}
}

/*** PLIK / ZA≈ÅƒÑCZNIK ***/
$('#btnFile').addEventListener('click', ()=>$('#file').click());
$('#file').addEventListener('change', async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  // Preferuj Storage bucket "chat". Je≈õli nie istnieje / brak uprawnie≈Ñ ‚Äì fallback jako dataURL (do 1MB)
  let url = '';
  try{
    const path = `${state.account}/${state.room}/${Date.now()}_${f.name}`;
    const up = await supa.storage.from('chat').upload(path, f, { upsert:false });
    if(up.error) throw up.error;
    const pub = supa.storage.from('chat').getPublicUrl(path);
    url = pub.data.publicUrl;
  }catch(err){
    if(f.size <= 1024*1024){
      const reader = new FileReader();
      reader.onload = async ()=>{ await sendMessage('', reader.result); };
      reader.readAsDataURL(f);
      return;
    }else{
      alert('Nie uda≈Ço siƒô zapisaƒá pliku do Storage, a plik jest zbyt du≈ºy na wklejkƒô.');
      return;
    }
  }
  await sendMessage('', url);
  e.target.value='';
});

/*** EMOJI ***/
const EMOJI = 'üòÄüòÅüòÇü§£üòäüòâüòçüòòüòéü§©ü•∞üòáü§ìü§†ü´∂üëçüëèüî•‚ú®üéâüéØüöÄüîßüí°üìéüì∑üñ®Ô∏èüìÅ‚úÖ‚ùó‚ùå'.split('');
$('#btnEmoji').addEventListener('click', ()=>{
  const picker = document.createElement('div');
  picker.style.position='absolute'; picker.style.bottom='100px'; picker.style.left='20px';
  picker.style.background='#0e1740'; picker.style.border='1px solid #2b3a77'; picker.style.padding='8px'; picker.style.borderRadius='10px';
  picker.innerHTML = EMOJI.map(e=>`<span class="emoji" style="font-size:22px;padding:4px">${e}</span>`).join('');
  picker.addEventListener('click', (ev)=>{
    if(ev.target.classList.contains('emoji')){ $('#txt').value += ev.target.textContent; document.body.removeChild(picker); $('#txt').focus(); }
  });
  document.body.appendChild(picker);
});

/*** EKSPORT / DRUK ***/
$('#btnCSV').addEventListener('click', ()=>{
  const rows=[['autor','tre≈õƒá','plik','czas']].concat(messages.map(m=>[m.author,m.body||'',m.file_url||'',m.created_at]));
  const csv = rows.map(r=>r.map(s=>{s=(s??'').toString(); return /[;"\n]/.test(s)?'"'+s.replace(/"/g,'""')+'"':s}).join(';')).join('\n');
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'})); a.download='chat.csv'; a.click();
});
$('#btnJSON').addEventListener('click', ()=>{
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(messages,null,2)],{type:'application/json'})); a.download='chat.json'; a.click();
});
$('#btnPrint').addEventListener('click', ()=>window.print());

/*** ZDARZENIA UI ***/
$('#btnAddAcc').addEventListener('click', async ()=>{
  const id = prompt('Nazwa konta (bez spacji):','nowe-konto'); if(!id) return;
  const { error } = await supa.from('accounts').insert([{id}]); if(error) return alert(error.message);
  await loadAccounts();
});
$('#btnAddRoom').addEventListener('click', async ()=>{
  const id = prompt('ID pokoju:','pokoj'); if(!id) return;
  const label = prompt('Etykieta:','Nowy pok√≥j')||id;
  const { error } = await supa.from('rooms').insert([{id,label}]); if(error) return alert(error.message);
  await loadRooms();
});
$('#selAccount').addEventListener('change', async (e)=>{
  state.account = e.target.value; localStorage.setItem('chat_acc', state.account);
  await loadRooms(); await loadHistory(); await subscribeChannel(); await joinPresence();
});
$('#selRoom').addEventListener('change', async (e)=>{
  state.room = e.target.value; localStorage.setItem('chat_room', state.room);
  await loadRooms(); await loadHistory(); await subscribeChannel(); await joinPresence();
});
$('#btnName').addEventListener('click', ()=>{
  const n = prompt('Tw√≥j podpis (imiƒô w czacie):', state.me)||state.me;
  state.me = n; localStorage.setItem('chat_me', n); $('#meName').textContent = n;
  joinPresence();
});
$('#btnReload').addEventListener('click', ()=>{ loadAccounts(); loadRooms(); loadHistory(); });

/*** WYSY≈ÅANIE ‚Äî textarea ***/
$('#txt').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (e.ctrlKey || e.metaKey)){ e.preventDefault(); $('#btnSend').click(); }
});
$('#btnSend').addEventListener('click', async ()=>{
  const t = $('#txt').value;
  await sendMessage(t, null);
});

/*** START ***/
(async function init(){
  try{
    await loadAccounts();
    await loadRooms();
    await loadHistory();
    await subscribeChannel();
    await joinPresence();
    $('#conn').textContent = 'gotowe';
  }catch(e){
    console.error(e); $('#conn').textContent = 'b≈ÇƒÖd inicjalizacji';
  }
})();
</script>
</body>
</html>
