<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON • Multi-Chat (Supabase)</title>
<meta name="description" content="Rozbudowany multi-chat na Supabase: 3 prywatne okna (Królowa, Adrian, Emil) + wspólny, realtime, presence, typing, emoji, załączniki, reakcje, wątki.">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1020; --p1:#101736; --p2:#0f1a44; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0;
    --ok:#2b8a57; --bad:#ff6b6b; --line:#253166; --chip:#162357; --card:#0f1533; --hover:#172152;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a;position:sticky;top:0;z-index:5}
  h1{margin:0;font-size:20px}
  .toprow{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .tabbar{display:flex;gap:8px;margin-top:8px}
  .tab{padding:6px 10px;border:1px solid #2b3a77;border-radius:999px;cursor:pointer;font-size:12px;text-decoration:none;color:#cfe1ff}
  .tab.active{background:#14225a}
  .wrap{padding:12px;max-width:1600px;margin:auto}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:360px}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .meta{font-size:11px;color:#aeb8da}
  .presence{display:flex;gap:6px;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block}
  .typing{font-size:12px;color:#9cc3ff}
  .msgwrap{height:300px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .day{display:flex;align-items:center;gap:10px;margin:2px 0}
  .day::before,.day::after{content:"";height:1px;background:#223160;flex:1}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bubble{background:linear-gradient(180deg,#111a3c,#0f1a44);border:1px solid #2a3a75;border-radius:12px;padding:8px 10px;max-width:900px;word-break:break-word}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .bubble .tools{display:flex;gap:6px;opacity:.9;margin-top:4px;flex-wrap:wrap}
  .bubble .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px;margin-top:4px}
  .reactions{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
  .react{background:#0e184a;border:1px solid #3f57c1;border-radius:999px;padding:2px 6px;font-size:12px;cursor:pointer}
  .children{margin-left:22px;margin-top:6px;border-left:1px dashed #2b3a77;padding-left:10px}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  textarea,input[type="text"]{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:var(--ink)}
  .hoverable:hover{background:var(--hover)}
  @media (max-width:1200px){ .grid{grid-template-columns:1fr} .msgwrap{height:40vh} }
</style>
</head>
<body>
<header>
  <h1>Komunikator • ARKON</h1>
  <div class="toprow">
    <span class="pill">Realtime + Presence + Typing</span>
    <span class="pill">Emoji • Reakcje • Wątki</span>
    <span class="pill">Załączniki (Supabase Storage)</span>
    <span class="pill">Edycja/Usuń swoje</span>
    <span class="pill">Eksport</span>
    <span class="pill">Jestem:
      <select id="meSelect">
        <option>Królowa</option>
        <option>Adrian</option>
        <option>Emil</option>
      </select>
    </span>
    <button class="btn ghost" id="btnExport">Eksport JSON</button>
  </div>
  <nav class="tabbar">
    <a class="tab" href="#/chat">💬 Czat</a>
    <a class="tab" href="#/contracts">📄 Umowy</a>
    <a class="tab" href="#/docs">📂 Dokumenty</a>
    <a class="tab" href="#/tasks">✅ Zadania</a>
  </nav>
</header>

<div class="wrap">
  <!-- STRONA: CHAT -->
  <section id="page-chat">
    <div class="grid">
      <!-- Panel: Królowa -->
      <div class="panel" id="panel-krolowa">
        <div class="topbar">
          <div class="row"><b>👑 Królowa</b> <span class="meta">pokój: krolowa</span></div>
          <div class="row">
            <div class="presence" id="p-krolowa"></div>
          </div>
        </div>
        <div class="meta" style="padding: 4px 12px" id="t-krolowa"></div>
        <div class="msgwrap" id="m-krolowa"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('krolowa')">😊</button>
            <textarea id="i-krolowa" placeholder="Napisz wiadomość… (Ctrl+Enter)"></textarea>
            <input type="file" id="f-krolowa" hidden>
            <button class="btn ghost" onclick="browseFile('krolowa')">📎</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('krolowa')">Wyślij ▶</button>
          </div>
        </div>
      </div>

      <!-- Panel: Adrian -->
      <div class="panel" id="panel-adrian">
        <div class="topbar">
          <div class="row"><b>👤 Adrian</b> <span class="meta">pokój: adrian</span></div>
          <div class="row"><div class="presence" id="p-adrian"></div></div>
        </div>
        <div class="meta" style="padding: 4px 12px" id="t-adrian"></div>
        <div class="msgwrap" id="m-adrian"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('adrian')">😊</button>
            <textarea id="i-adrian" placeholder="Napisz wiadomość… (Ctrl+Enter)"></textarea>
            <input type="file" id="f-adrian" hidden>
            <button class="btn ghost" onclick="browseFile('adrian')">📎</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('adrian')">Wyślij ▶</button>
          </div>
        </div>
      </div>

      <!-- Panel: Emil -->
      <div class="panel" id="panel-emil">
        <div class="topbar">
          <div class="row"><b>👤 Emil</b> <span class="meta">pokój: emil</span></div>
          <div class="row"><div class="presence" id="p-emil"></div></div>
        </div>
        <div class="meta" style="padding: 4px 12px" id="t-emil"></div>
        <div class="msgwrap" id="m-emil"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('emil')">😊</button>
            <textarea id="i-emil" placeholder="Napisz wiadomość… (Ctrl+Enter)"></textarea>
            <input type="file" id="f-emil" hidden>
            <button class="btn ghost" onclick="browseFile('emil')">📎</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('emil')">Wyślij ▶</button>
          </div>
        </div>
      </div>

      <!-- Panel: Wspólny -->
      <div class="panel" id="panel-global">
        <div class="topbar">
          <div class="row"><b>🌍 Wspólny</b> <span class="meta">pokój: global</span></div>
          <div class="row"><div class="presence" id="p-global"></div></div>
        </div>
        <div class="meta" style="padding: 4px 12px" id="t-global"></div>
        <div class="msgwrap" id="m-global"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('global')">😊</button>
            <textarea id="i-global" placeholder="Napisz wiadomość… (Ctrl+Enter)"></textarea>
            <input type="file" id="f-global" hidden>
            <button class="btn ghost" onclick="browseFile('global')">📎</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('global')">Wyślij ▶</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STRONY: placeholdery bez backendu (możesz podpiąć później) -->
  <section id="page-contracts" style="display:none" class="panel">
    <div class="topbar"><b>📄 Umowy</b></div>
    <div style="padding:16px">
      <p class="meta">Tu wpięte zostaną widoki umów (Supabase / funkcje).</p>
    </div>
  </section>
  <section id="page-docs" style="display:none" class="panel">
    <div class="topbar"><b>📂 Dokumenty</b></div>
    <div style="padding:16px">
      <p class="meta">Tu wpięta będzie lista dokumentów/browse (Supabase Storage).</p>
    </div>
  </section>
  <section id="page-tasks" style="display:none" class="panel">
    <div class="topbar"><b>✅ Zadania</b></div>
    <div style="padding:16px">
      <p class="meta">Tu wpięty zostanie prosty TODO (Supabase).</p>
    </div>
  </section>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/*** KONFIG SUPABASE — WSTAW SWOJE ***/
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';
const supa = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession:false } });

/*** UTIL ***/
const $ = s => document.querySelector(s);
const el = (tag, attrs={}) => Object.assign(document.createElement(tag), attrs);
const INT = new Intl.DateTimeFormat('pl-PL', { dateStyle:'short', timeStyle:'short' });
const linkify = t => (t||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
const EMOJI = '😀😁😂🤣😊😉😍😘😎🤩🥰😇🤓🤠🫶👍👏🔥✨🎉🎯🚀🔧💡📎📷🖨📁✅❗❌🤝📝💬🔗📌🕒'.split('');

/*** ROUTING (górne zakładki) ***/
function route(){
  const hash = location.hash || '#/chat';
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('href')===hash));
  ['chat','contracts','docs','tasks'].forEach(id=>{
    $('#page-'+id).style.display = (hash==='#/'+id) ? 'block' : 'none';
  });
}
window.addEventListener('hashchange', route); route();

/*** GLOBAL „Jestem” ***/
const meSelect = $('#meSelect');
meSelect.value = localStorage.getItem('me_name') || meSelect.value;
meSelect.addEventListener('change', ()=>localStorage.setItem('me_name', meSelect.value));

/*** MODEL: 4 pokoje */
const ROOMS = ['krolowa','adrian','emil','global'];

/*** Stan per pokój */
const state = {};
ROOMS.forEach(r=>{
  state[r] = {
    me: ()=> localStorage.getItem('me_name') || 'Królowa',
    msgs: [],
    cache: new Map(),
    oldestCursor: null,
    sub: null,
    presChan: null,
    typingSet: new Set(),
    typingTimer: null,
    typingViewTimer: null
  };
});

/*** Render jednej wiadomości (z wątkami/reakcjami) ***/
function fileChip(url){
  if(!url) return '';
  const name = url.split('/').pop();
  const isImg = /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(name);
  return <a class="file" href="${url}" target="_blank">📎 ${name}</a>${isImg?<div style="margin-top:6px"><img src="${url}" alt="" style="max-width:260px;border:1px solid #2b3a77;border-radius:10px"></div>:''};
}
function reactBadge(emo,count){ return <span class="react" data-emo="${emo}">${emo} ${count}</span>; }
function bubbleHtml(room, m, children=[]){
  const me = (m.author === state[room].me());
  const reacts = (m.reactions && typeof m.reactions==='object') ? Object.entries(m.reactions).filter(([,v])=>v>0) : [];
  return `
  <div class="msg" id="${room}-m-${m.id}">
    <div class="meta">${me? 'Ja' : (m.author||'—')}</div>
    <div class="bubble ${me?'me':''}">
      ${m.deleted_at? <i class="meta">[wiadomość usunięta]</i> : linkify(m.body||'')}
      ${fileChip(m.file_url)}
      <div class="tools">
        <button class="btn ghost" onclick="startReply('${room}','${m.id}')">💬 Odpowiedz</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','👍')">👍</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','❤')">❤</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','🔥')">🔥</button>
        ${me && !m.deleted_at ? `<button class="btn ghost" onclick="editMsg('${room}','${m.id}')">✎ Edytuj</button>
        <button class="btn ghost" onclick="deleteMsg('${room}','${m.id}')">🗑 Usuń</button>`:''}
        <span class="meta" style="margin-left:auto">${INT.format(new Date(m.created_at))} ${me?'<span title="lokalne ✓✓">✓✓</span>':''}${m.edited_at?' • ed.':''}</span>
      </div>
      ${reacts.length? <div class="reactions">${reacts.map(([e,c])=>reactBadge(e,c)).join(' ')}</div>:''}
      ${children.length? <div class="children">${children.map(ch=>bubbleHtml(room,ch,[])).join('')}</div>:''}
    </div>
  </div>`;
}

/*** Render listy (z dzieleniem na dni) ***/
function renderRoom(room, scrollBottom=true){
  const box = $('#m-'+room);
  const arr = state[room].msgs;
  // indeks dzieci
  const kids = new Map();
  arr.forEach(m=>{ if(m.parent_id){ (kids.get(m.parent_id)||kids.set(m.parent_id,[]).get(m.parent_id)).push(m); } });
  let out=[], lastDay='';
  arr.filter(m=>!m.parent_id).forEach(m=>{
    const d=(m.created_at||'').slice(0,10);
    if(d && d!==lastDay){ out.push(<div class="day"><span>${INT.format(new Date(m.created_at)).split(',')[0]}</span></div>); lastDay=d; }
    out.push(bubbleHtml(room,m, kids.get(m.id)||[]));
  });
  box.innerHTML = out.join('');
  if(scrollBottom) box.scrollTop = box.scrollHeight;
}

/*** Ładowanie historii ***/
async function loadInitial(room){
  const { data, error } = await supa.from('messages')
    .select('*')
    .eq('room_id', room)
    .order('created_at',{ascending:true})
    .limit(80);
  if(error){ console.error(room, error); return; }
  state[room].msgs = data||[];
  if(state[room].msgs.length) state[room].oldestCursor = state[room].msgs[0].created_at;
  state[room].msgs.forEach(m=>state[room].cache.set(m.id,m));
  renderRoom(room, true);
}

/*** SUB: realtime + updates ***/
async function subscribeRoom(room){
  if(state[room].sub){ try{ await supa.removeChannel(state[room].sub);}catch{} }
  state[room].sub = supa.channel('room:'+room)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:room_id=eq.${room}}, (p)=>{
      state[room].msgs.push(p.new);
      state[room].cache.set(p.new.id,p.new);
      renderRoom(room,true); ding();
    })
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'messages',filter:room_id=eq.${room}}, (p)=>{
      const m=p.new; const idx=state[room].msgs.findIndex(x=>x.id===m.id);
      if(idx>-1){ state[room].msgs[idx]=m; state[room].cache.set(m.id,m); renderRoom(room,false); }
    })
    .subscribe((status)=>{
      $('#t-'+room).textContent = (status==='SUBSCRIBED') ? 'podłączono' : '…'+status.toLowerCase();
    });
}

/*** PRESENCE + TYPING ***/
async function joinPresence(room){
  if(state[room].presChan){ try{ await supa.removeChannel(state[room].presChan);}catch{} }
  const chan = supa.channel('presence:'+room, { config:{ presence:{ key: state[room].me() } } });
  state[room].presChan = chan;

  chan.on('presence',{event:'sync'}, ()=>{
    const names = Object.keys(chan.presenceState());
    $('#p-'+room).innerHTML = names.map(n=><span class="pill"><span class="dot"></span>${n}</span>).join('');
  });
  chan.on('broadcast',{event:'typing'}, ({payload})=>{
    const set = state[room].typingSet;
    if(payload.on) set.add(payload.user); else set.delete(payload.user);
    const list=[...set].filter(n=>n!==state[room].me());
    $('#t-'+room).textContent = list.length ? (list.join(', ')+' pisze…') : '';
    clearTimeout(state[room].typingViewTimer);
    state[room].typingViewTimer = setTimeout(()=>{ set.clear(); $('#t-'+room).textContent=''; }, 2500);
  });

  chan.subscribe(s=>{
    if(s==='SUBSCRIBED') chan.track({ user: state[room].me(), at: Date.now() });
  });
}
function sendTyping(room, on){
  try{
    state[room].presChan?.send({ type:'broadcast', event:'typing', payload:{ user: state[room].me(), on } });
  }catch{}
}

/*** Wysyłanie, odpowiedzi, reakcje, edycja, usuwanie ***/
const replyTo = { krolowa:null, adrian:null, emil:null, global:null };

async function sendMsg(room){
  const ta = $('#i-'+room);
  let text = (ta.value||'').trim();
  if(!text && !ta.dataset.fileurl) return;
  const payload = {
    room_id: room,
    author: state[room].me(),
    body: text || '',
    file_url: ta.dataset.fileurl || null,
    parent_id: replyTo[room]
  };
  const { error } = await supa.from('messages').insert([payload]);
  if(error){ alert(error.message); return; }
  ta.value=''; ta.dataset.fileurl=''; replyTo[room]=null;
  sendTyping(room,false);
}

function startReply(room, id){
  replyTo[room] = id;
  const m = state[room].cache.get(id);
  const ta = $('#i-'+room);
  const prev = ↪ ${m?.author||'—'}: ${(m?.body||'').slice(0,60)};
  ta.value = (prev+'\n'+ta.value).trim() + ' ';
  ta.focus();
}

async function reactMsg(room, id, emo){
  try{
    const m = state[room].cache.get(id) || (await supa.from('messages').select('*').eq('id',id).single()).data;
    const r = m.reactions || {}; r[emo]=(r[emo]||0)+1;
    await supa.from('messages').update({ reactions:r }).eq('id', id);
  }catch(e){ console.error(e); }
}

async function editMsg(room, id){
  const m = state[room].cache.get(id); if(!m || m.author!==state[room].me() || m.deleted_at) return;
  const t = prompt('Edytuj:', m.body||''); if(t==null) return;
  const { error } = await supa.from('messages').update({ body:t, edited_at:new Date().toISOString() }).eq('id', id);
  if(error) alert(error.message);
}

async function deleteMsg(room, id){
  const m = state[room].cache.get(id); if(!m || m.author!==state[room].me() || m.deleted_at) return;
  if(!confirm('Usunąć wiadomość?')) return;
  const { error } = await supa.from('messages').update({ deleted_at:new Date().toISOString(), body:'[usunięto]' }).eq('id', id);
  if(error) alert(error.message);
}

/*** Emoji picker per pokój ***/
let pickers = {};
function toggleEmoji(room){
  if(pickers[room]){ document.body.removeChild(pickers[room]); delete pickers[room]; return; }
  const p = el('div'); p.style.position='fixed'; p.style.right='24px'; p.style.bottom='120px'; p.style.zIndex=10;
  p.style.background='#0e1740'; p.style.border='1px solid #2b3a77'; p.style.padding='8px'; p.style.borderRadius='10px';
  p.innerHTML = EMOJI.map(e=><span style="font-size:22px;padding:6px;cursor:pointer">${e}</span>).join('');
  p.addEventListener('click', ev=>{
    if(ev.target.textContent){ const ta=$('#i-'+room); ta.value += ev.target.textContent; ta.focus(); sendTyping(room,true); }
  });
  document.body.appendChild(p); pickers[room]=p;
}

/*** Załączniki (Supabase Storage) ***/
function browseFile(room){ $('#f-'+room).click(); }
ROOMS.forEach(room=>{
  $('#f-'+room).addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const path = ${room}/${Date.now()}_${f.name};
      const up = await supa.storage.from('chat').upload(path, f, { upsert:false });
      if(up.error) throw up.error;
      const pub = supa.storage.from('chat').getPublicUrl(path);
      $('#i-'+room).dataset.fileurl = pub.data.publicUrl;
      const name = f.name;
      const ta = $('#i-'+room);
      ta.value = (ta.value? ta.value+'\n' : '') + `[załącznik: ${name}] `;
      ta.focus();
    }catch(err){
      if(f.size <= 1024*1024){
        const reader = new FileReader();
        reader.onload = ()=>{ $('#i-'+room).dataset.fileurl = reader.result; };
        reader.readAsDataURL(f);
      }else{
        alert('Nie udało się zapisać pliku (i zbyt duży na dataURL).');
      }
    }
    e.target.value='';
  });
});

/*** Input zdarzenia (Enter, typing) ***/
ROOMS.forEach(room=>{
  const ta = $('#i-'+room);
  ta.addEventListener('input', ()=>{
    clearTimeout(state[room].typingTimer);
    sendTyping(room,true);
    state[room].typingTimer = setTimeout(()=>sendTyping(room,false), 1200);
  });
  ta.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMsg(room); }
  });
});

/*** Eksport (wszystko) ***/
$('#btnExport').addEventListener('click', async ()=>{
  const all = {};
  for(const r of ROOMS){
    const { data } = await supa.from('messages').select('*').eq('room_id', r).order('created_at',{ascending:true}).limit(1000);
    all[r] = data||[];
  }
  const a=el('a',{href:URL.createObjectURL(new Blob([JSON.stringify(all,null,2)],{type:'application/json'})),download:'chat-export.json'}); a.click();
});

/*** Dźwięk ***/
function ding(){ try{ new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAAAAA').play(); }catch{} }

/*** INIT: dla 4 pokoi równolegle ***/
(async function init(){
  for(const r of ROOMS){
    await loadInitial(r);
    await subscribeRoom(r);
    await joinPresence(r);
  }
})();
</script>
</body>
</html>
