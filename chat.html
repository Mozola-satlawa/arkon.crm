<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON â€¢ Chat + ModuÅ‚y (Supabase)</title>
<meta name="description" content="Wielookienkowy czat + moduÅ‚y (Umowy, Dokumenty, Zadania, Kalkulator) na Supabase.">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#0b1020; --p1:#101736; --p2:#0f1a44; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0;
    --ok:#2b8a57; --bad:#ff6b6b; --line:#253166; --chip:#162357; --card:#0f1533; --hover:#172152;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid var(--line);background:#11183a;position:sticky;top:0;z-index:10}
  h1{margin:0;font-size:20px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#42202a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .tabbar{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .tab{padding:6px 10px;border:1px solid #2b3a77;border-radius:999px;cursor:pointer;font-size:12px;text-decoration:none;color:#cfe1ff}
  .tab.active{background:#14225a}
  .wrap{padding:12px;max-width:1700px;margin:auto}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .panel{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;overflow:hidden;display:flex;flex-direction:column;min-height:360px}
  .topbar{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .meta{font-size:11px;color:#aeb8da}
  .presence{display:flex;gap:6px;flex-wrap:wrap}
  .dot{width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block}
  .typing{font-size:12px;color:#9cc3ff}
  .msgwrap{height:300px;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .day{display:flex;align-items:center;gap:10px;margin:2px 0}
  .day::before,.day::after{content:"";height:1px;background:#223160;flex:1}
  .msg{display:grid;grid-template-columns:auto 1fr;gap:8px;align-items:flex-start}
  .bubble{background:linear-gradient(180deg,#111a3c,#0f1a44);border:1px solid #2a3a75;border-radius:12px;padding:8px 10px;max-width:900px;word-break:break-word}
  .bubble.me{background:#16204d;border-color:#3d58c1}
  .bubble .tools{display:flex;gap:6px;opacity:.9;margin-top:4px;flex-wrap:wrap}
  .bubble .file{display:inline-flex;gap:6px;align-items:center;padding:3px 6px;border:1px dashed #3a4ca3;border-radius:8px;margin-top:4px}
  .reactions{display:flex;gap:4px;margin-top:4px;flex-wrap:wrap}
  .react{background:#0e184a;border:1px solid #3f57c1;border-radius:999px;padding:2px 6px;font-size:12px;cursor:pointer}
  .children{margin-left:22px;margin-top:6px;border-left:1px dashed #2b3a77;padding-left:10px}
  .composer{border-top:1px solid var(--line);padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px}
  textarea,input[type="text"],input[type="number"],select{width:100%;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:9px;color:var(--ink)}
  .card{background:#0e1740;border:1px solid #2b3a77;border-radius:12px;padding:12px}
  .table{width:100%;border-collapse:separate;border-spacing:0 6px}
  .table th{font-size:12px;color:#aeb8da;text-align:left;padding:4px 8px}
  .tr{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:center;background:#0d1530;border:1px solid #2b3a77;border-radius:10px;padding:6px 8px;margin:6px 0}
  .fadepage{opacity:0;transform:translateY(8px);transition:.25s}
  .fadepage.active{opacity:1;transform:none}
  @media (max-width:1200px){ .grid{grid-template-columns:1fr} .msgwrap{height:40vh} .tr{grid-template-columns:1fr 1fr 1fr 1fr auto} }
</style>
</head>
<body>
<header>
  <h1>Komunikator â€¢ ARKON</h1>
  <div class="row" style="margin-top:6px">
    <span class="pill">Realtime + Presence + Typing</span>
    <span class="pill">Emoji â€¢ Reakcje â€¢ WÄ…tki â€¢ ZaÅ‚Ä…czniki</span>
    <span class="pill">Supabase</span>
    <span class="pill">Jestem:
      <select id="meSelect">
        <option>KrÃ³lowa</option>
        <option>Adrian</option>
        <option>Emil</option>
      </select>
    </span>
  </div>
  <nav class="tabbar">
    <a class="tab" href="#/chat">ğŸ’¬ Czat</a>
    <a class="tab" href="#/contracts">ğŸ“„ Umowy</a>
    <a class="tab" href="#/docs">ğŸ“‚ Dokumenty</a>
    <a class="tab" href="#/tasks">âœ… Zadania</a>
    <a class="tab" href="#/calc">ğŸ§® Kalkulator</a>
  </nav>
</header>

<div class="wrap">
  <!-- CHAT -->
  <section id="page-chat" class="fadepage">
    <div class="grid">
      <!-- Panel: KrÃ³lowa -->
      <div class="panel" id="panel-krolowa">
        <div class="topbar">
          <div class="row"><b>ğŸ‘‘ KrÃ³lowa</b> <span class="meta">pokÃ³j: krolowa</span></div>
          <div class="row"><div class="presence" id="p-krolowa"></div></div>
        </div>
        <div class="meta" style="padding:4px 12px" id="t-krolowa"></div>
        <div class="msgwrap" id="m-krolowa"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('krolowa')">ğŸ˜Š</button>
            <textarea id="i-krolowa" placeholder="Napisz wiadomoÅ›Ä‡â€¦ (Ctrl+Enter)"></textarea>
            <input type="file" id="f-krolowa" hidden>
            <button class="btn ghost" onclick="browseFile('krolowa')">ğŸ“</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('krolowa')">WyÅ›lij â–¶</button>
          </div>
        </div>
      </div>

      <!-- Panel: Adrian -->
      <div class="panel" id="panel-adrian">
        <div class="topbar">
          <div class="row"><b>ğŸ‘¤ Adrian</b> <span class="meta">pokÃ³j: adrian</span></div>
          <div class="row"><div class="presence" id="p-adrian"></div></div>
        </div>
        <div class="meta" style="padding:4px 12px" id="t-adrian"></div>
        <div class="msgwrap" id="m-adrian"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('adrian')">ğŸ˜Š</button>
            <textarea id="i-adrian" placeholder="Napisz wiadomoÅ›Ä‡â€¦ (Ctrl+Enter)"></textarea>
            <input type="file" id="f-adrian" hidden>
            <button class="btn ghost" onclick="browseFile('adrian')">ğŸ“</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('adrian')">WyÅ›lij â–¶</button>
          </div>
        </div>
      </div>

      <!-- Panel: Emil -->
      <div class="panel" id="panel-emil">
        <div class="topbar">
          <div class="row"><b>ğŸ‘¤ Emil</b> <span class="meta">pokÃ³j: emil</span></div>
          <div class="row"><div class="presence" id="p-emil"></div></div>
        </div>
        <div class="meta" style="padding:4px 12px" id="t-emil"></div>
        <div class="msgwrap" id="m-emil"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('emil')">ğŸ˜Š</button>
            <textarea id="i-emil" placeholder="Napisz wiadomoÅ›Ä‡â€¦ (Ctrl+Enter)"></textarea>
            <input type="file" id="f-emil" hidden>
            <button class="btn ghost" onclick="browseFile('emil')">ğŸ“</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('emil')">WyÅ›lij â–¶</button>
          </div>
        </div>
      </div>

      <!-- Panel: WspÃ³lny -->
      <div class="panel" id="panel-global">
        <div class="topbar">
          <div class="row"><b>ğŸŒ WspÃ³lny</b> <span class="meta">pokÃ³j: global</span></div>
          <div class="row"><div class="presence" id="p-global"></div></div>
        </div>
        <div class="meta" style="padding:4px 12px" id="t-global"></div>
        <div class="msgwrap" id="m-global"></div>
        <div class="composer">
          <div class="row" style="width:100%">
            <button class="btn ghost" onclick="toggleEmoji('global')">ğŸ˜Š</button>
            <textarea id="i-global" placeholder="Napisz wiadomoÅ›Ä‡â€¦ (Ctrl+Enter)"></textarea>
            <input type="file" id="f-global" hidden>
            <button class="btn ghost" onclick="browseFile('global')">ğŸ“</button>
          </div>
          <div class="row">
            <button class="btn ok" onclick="sendMsg('global')">WyÅ›lij â–¶</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- UMOWY -->
  <section id="page-contracts" class="fadepage" style="display:none">
    <div class="panel">
      <div class="topbar"><b>ğŸ“„ Umowy</b><span class="meta">CRUD w Supabase</span></div>
      <div style="padding:12px" class="card">
        <div class="row" style="margin-bottom:8px">
          <input id="cTitle" placeholder="TytuÅ‚ umowyâ€¦">
          <input id="cAmount" type="number" placeholder="Kwota (PLN)">
          <select id="cStatus">
            <option>draft</option><option>sent</option><option>signed</option><option>rejected</option>
          </select>
          <button class="btn ok" id="btnAddC">Dodaj</button>
          <button class="btn ghost" id="btnReloadC">OdÅ›wieÅ¼</button>
        </div>
        <div id="contractsList"></div>
      </div>
    </div>
  </section>

  <!-- DOKUMENTY -->
  <section id="page-docs" class="fadepage" style="display:none">
    <div class="panel">
      <div class="topbar"><b>ğŸ“‚ Dokumenty</b><span class="meta">Supabase Storage (bucket: docs)</span></div>
      <div style="padding:12px" class="card">
        <div class="row" style="margin-bottom:8px">
          <input type="file" id="docFile">
          <button class="btn" id="btnUpDoc">WyÅ›lij</button>
          <button class="btn ghost" id="btnReloadDocs">OdÅ›wieÅ¼</button>
        </div>
        <div id="docsList"></div>
      </div>
    </div>
  </section>

  <!-- ZADANIA -->
  <section id="page-tasks" class="fadepage" style="display:none">
    <div class="panel">
      <div class="topbar"><b>âœ… Zadania</b><span class="meta">Lista zadaÅ„ w Supabase</span></div>
      <div style="padding:12px" class="card">
        <div class="row" style="margin-bottom:8px">
          <input id="tTitle" placeholder="Nowe zadanieâ€¦">
          <button class="btn ok" id="btnAddT">Dodaj</button>
          <button class="btn ghost" id="btnReloadT">OdÅ›wieÅ¼</button>
        </div>
        <div id="tasksList"></div>
      </div>
    </div>
  </section>

  <!-- KALKULATOR -->
  <section id="page-calc" class="fadepage" style="display:none">
    <div class="panel">
      <div class="topbar"><b>ğŸ§® Kalkulator</b><span class="meta">Raty â€¢ VAT â€¢ Procent</span></div>
      <div style="padding:12px" class="card">
        <h3>Raty (annuitet)</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="kKwota" type="number" placeholder="Kwota (PLN)" value="10000">
          <input id="kOprocent" type="number" placeholder="Oprocentowanie roczne (%)" value="9">
          <input id="kOkres" type="number" placeholder="Okres (miesiÄ™cy)" value="24">
          <button class="btn" id="btnRat">Oblicz</button>
        </div>
        <div id="ratOut" class="meta"></div>
      </div>

      <div style="padding:12px" class="card">
        <h3>VAT netto â†” brutto</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="vKwota" type="number" placeholder="Kwota" value="1230">
          <select id="vStawka"><option value="23">23%</option><option value="8">8%</option><option value="5">5%</option><option value="0">0%</option></select>
          <select id="vTryb"><option value="nb">netto â†’ brutto</option><option value="bn">brutto â†’ netto</option></select>
          <button class="btn" id="btnVat">Policz</button>
        </div>
        <div id="vatOut" class="meta"></div>
      </div>

      <div style="padding:12px" class="card">
        <h3>Szybki procent</h3>
        <div class="row" style="margin-bottom:8px">
          <input id="pBase" type="number" placeholder="Podstawa" value="5000">
          <input id="pPct" type="number" placeholder="% (np. 12)" value="12">
          <button class="btn" id="btnPct">Policz</button>
        </div>
        <div id="pctOut" class="meta"></div>
      </div>
    </div>
  </section>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/*** KONFIG SUPABASE â€” USTAW SWOJE ***/
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';
const supa = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession:false } });

/*** UTIL ***/
const $ = s => document.querySelector(s);
const el = (t,a={}) => Object.assign(document.createElement(t), a);
const INT = new Intl.DateTimeFormat('pl-PL',{dateStyle:'short', timeStyle:'short'});
const linkify = t => (t||'').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
const EMOJI = 'ğŸ˜€ğŸ˜ğŸ˜‚ğŸ¤£ğŸ˜ŠğŸ˜‰ğŸ˜ğŸ˜˜ğŸ˜ğŸ¤©ğŸ¥°ğŸ˜‡ğŸ¤“ğŸ¤ ğŸ«¶ğŸ‘ğŸ‘ğŸ”¥âœ¨ğŸ‰ğŸ¯ğŸš€ğŸ”§ğŸ’¡ğŸ“ğŸ“·ğŸ–¨ğŸ“âœ…â—âŒğŸ¤ğŸ“ğŸ’¬ğŸ”—ğŸ“ŒğŸ•’'.split('');

/*** ROUTER (hash) + animacje ***/
function route(){
  const hash = location.hash || '#/chat';
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('href')===hash));
  const pages = ['chat','contracts','docs','tasks','calc'];
  pages.forEach(id=>{
    const pg = $('#page-'+id);
    const show = (hash==='#/'+id);
    if(show){ pg.style.display='block'; requestAnimationFrame(()=>pg.classList.add('active')); }
    else{ pg.classList.remove('active'); pg.style.display='none'; }
  });
}
window.addEventListener('hashchange', route); route();

/*** â€Jestemâ€ ***/
const meSelect = $('#meSelect');
meSelect.value = localStorage.getItem('me_name') || meSelect.value;
meSelect.addEventListener('change', ()=>localStorage.setItem('me_name', meSelect.value));

/*** POKOJE ***/
const ROOMS = ['krolowa','adrian','emil','global'];
const state = {};
ROOMS.forEach(r=>{
  state[r] = {
    me: ()=> localStorage.getItem('me_name') || 'KrÃ³lowa',
    msgs: [],
    cache: new Map(),
    sub: null, presChan: null,
    typingSet: new Set(), typingTimer:null, typingViewTimer:null,
    oldestCursor: null
  };
});

/*** WIDOKI WIADOMOÅšCI ***/
function fileChip(url){
  if(!url) return '';
  const name = url.split('/').pop();
  const isImg = /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(name);
  return <a class="file" href="${url}" target="_blank">ğŸ“ ${name}</a>${isImg?<div style="margin-top:6px"><img src="${url}" alt="" style="max-width:260px;border:1px solid #2b3a77;border-radius:10px"></div>:''};
}
function reactBadge(emo,c){ return <span class="react" data-emo="${emo}">${emo} ${c}</span>; }
function bubbleHtml(room, m, children=[]){
  const me = (m.author === state[room].me());
  const reacts = (m.reactions && typeof m.reactions==='object') ? Object.entries(m.reactions).filter(([,v])=>v>0) : [];
  return `
  <div class="msg" id="${room}-m-${m.id}">
    <div class="meta">${me? 'Ja' : (m.author||'â€”')}</div>
    <div class="bubble ${me?'me':''}">
      ${m.deleted_at? <i class="meta">[wiadomoÅ›Ä‡ usuniÄ™ta]</i> : linkify(m.body||'')}
      ${fileChip(m.file_url)}
      <div class="tools">
        <button class="btn ghost" onclick="startReply('${room}','${m.id}')">ğŸ’¬ Odpowiedz</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','ğŸ‘')">ğŸ‘</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','â¤')">â¤</button>
        <button class="btn ghost" onclick="reactMsg('${room}','${m.id}','ğŸ”¥')">ğŸ”¥</button>
        ${me && !m.deleted_at ? `<button class="btn ghost" onclick="editMsg('${room}','${m.id}')">âœ</button>
        <button class="btn ghost bad" onclick="deleteMsg('${room}','${m.id}')">ğŸ—‘</button>`:''}
        <span class="meta" style="margin-left:auto">${INT.format(new Date(m.created_at))} ${me?'<span title="lokalne âœ“âœ“">âœ“âœ“</span>':''}${m.edited_at?' â€¢ ed.':''}</span>
      </div>
      ${reacts.length? <div class="reactions">${reacts.map(([e,c])=>reactBadge(e,c)).join(' ')}</div>:''}
      ${children.length? <div class="children">${children.map(ch=>bubbleHtml(room,ch,[])).join('')}</div>:''}
    </div>
  </div>`;
}
function renderRoom(room, scrollBottom=true){
  const box = $('#m-'+room);
  const arr = state[room].msgs;
  const kids = new Map();
  arr.forEach(m=>{ if(m.parent_id){ (kids.get(m.parent_id)||kids.set(m.parent_id,[]).get(m.parent_id)).push(m); } });
  let out=[], lastDay='';
  arr.filter(m=>!m.parent_id).forEach(m=>{
    const d=(m.created_at||'').slice(0,10);
    if(d && d!==lastDay){ out.push(<div class="day"><span>${INT.format(new Date(m.created_at)).split(',')[0]}</span></div>); lastDay=d; }
    out.push(bubbleHtml(room,m, kids.get(m.id)||[]));
  });
  box.innerHTML = out.join('');
  if(scrollBottom) box.scrollTop = box.scrollHeight;
}

/*** HISTORIA / SUBSKRYPCJE ***/
async function loadInitial(room){
  const { data, error } = await supa.from('messages')
    .select('*').eq('room_id', room)
    .order('created_at',{ascending:true})
    .limit(100);
  if(error){ console.error(room, error); return; }
  state[room].msgs = data||[];
  if(state[room].msgs.length) state[room].oldestCursor = state[room].msgs[0].created_at;
  state[room].msgs.forEach(m=>state[room].cache.set(m.id,m));
  renderRoom(room,true);
}
async function subscribeRoom(room){
  if(state[room].sub){ try{ await supa.removeChannel(state[room].sub);}catch{} }
  state[room].sub = supa.channel('room:'+room)
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:room_id=eq.${room}}, p=>{
      state[room].msgs.push(p.new); state[room].cache.set(p.new.id,p.new); renderRoom(room,true); ding();
    })
    .on('postgres_changes',{event:'UPDATE',schema:'public',table:'messages',filter:room_id=eq.${room}}, p=>{
      const m=p.new; const idx=state[room].msgs.findIndex(x=>x.id===m.id);
      if(idx>-1){ state[room].msgs[idx]=m; state[room].cache.set(m.id,m); renderRoom(room,false); }
    })
    .subscribe(s=>{ $('#t-'+room).textContent = (s==='SUBSCRIBED') ? 'podÅ‚Ä…czono' : 'â€¦'+s.toLowerCase(); });
}
async function joinPresence(room){
  if(state[room].presChan){ try{ await supa.removeChannel(state[room].presChan);}catch{} }
  const chan = supa.channel('presence:'+room, { config:{ presence:{ key: state[room].me() } } });
  state[room].presChan = chan;
  chan.on('presence',{event:'sync'}, ()=>{
    const names = Object.keys(chan.presenceState());
    $('#p-'+room).innerHTML = names.map(n=><span class="pill"><span class="dot"></span>${n}</span>).join('');
  });
  chan.on('broadcast',{event:'typing'}, ({payload})=>{
    const set = state[room].typingSet; if(payload.on) set.add(payload.user); else set.delete(payload.user);
    const list=[...set].filter(n=>n!==state[room].me());
    $('#t-'+room).textContent = list.length ? (list.join(', ')+' piszeâ€¦') : '';
    clearTimeout(state[room].typingViewTimer);
    state[room].typingViewTimer = setTimeout(()=>{ set.clear(); $('#t-'+room).textContent=''; }, 2500);
  });
  chan.subscribe(s=>{ if(s==='SUBSCRIBED') chan.track({ user: state[room].me(), at: Date.now() }); });
}
function sendTyping(room,on){
  try{ state[room].presChan?.send({ type:'broadcast', event:'typing', payload:{ user: state[room].me(), on } }); }catch{}
}

/*** AKCJE WIADOMOÅšCI ***/
const replyTo = { krolowa:null, adrian:null, emil:null, global:null };
async function sendMsg(room){
  const ta = $('#i-'+room);
  let text = (ta.value||'').trim();
  const fileUrl = ta.dataset.fileurl || null;
  if(!text && !fileUrl) return;
  const payload = { room_id:room, author:state[room].me(), body:text, file_url:fileUrl, parent_id:replyTo[room] };
  const { error } = await supa.from('messages').insert([payload]);
  if(error){ alert(error.message); return; }
  ta.value=''; ta.dataset.fileurl=''; replyTo[room]=null; sendTyping(room,false);
}
function startReply(room,id){
  replyTo[room]=id;
  const m = state[room].cache.get(id);
  const ta = $('#i-'+room);
  const prev = â†ª ${m?.author||'â€”'}: ${(m?.body||'').slice(0,60)};
  ta.value = (prev+'\n'+ta.value).trim() + ' '; ta.focus();
}
async function reactMsg(room,id,emo){
  try{
    const m = state[room].cache.get(id) || (await supa.from('messages').select('*').eq('id',id).single()).data;
    const r = m.reactions || {}; r[emo]=(r[emo]||0)+1;
    await supa.from('messages').update({ reactions:r }).eq('id', id);
  }catch(e){ console.error(e); }
}
async function editMsg(room,id){
  const m = state[room].cache.get(id); if(!m || m.author!==state[room].me() || m.deleted_at) return;
  const t = prompt('Edytuj:', m.body||''); if(t==null) return;
  const { error } = await supa.from('messages').update({ body:t, edited_at:new Date().toISOString() }).eq('id', id);
  if(error) alert(error.message);
}
async function deleteMsg(room,id){
  const m = state[room].cache.get(id); if(!m || m.author!==state[room].me() || m.deleted_at) return;
  if(!confirm('UsunÄ…Ä‡ wiadomoÅ›Ä‡?')) return;
  const { error } = await supa.from('messages').update({ deleted_at:new Date().toISOString(), body:'[usuniÄ™to]' }).eq('id', id);
  if(error) alert(error.message);
}

/*** EMOJI + ZAÅÄ„CZNIKI ***/
const pickers = {};
function toggleEmoji(room){
  if(pickers[room]){ document.body.removeChild(pickers[room]); delete pickers[room]; return; }
  const p = el('div'); p.style.position='fixed'; p.style.right='24px'; p.style.bottom='120px'; p.style.zIndex=10;
  p.style.background='#0e1740'; p.style.border='1px solid #2b3a77'; p.style.padding='8px'; p.style.borderRadius='10px';
  p.innerHTML = EMOJI.map(e=><span style="font-size:22px;padding:6px;cursor:pointer">${e}</span>).join('');
  p.addEventListener('click', ev=>{
    if(ev.target.textContent){ const ta=$('#i-'+room); ta.value += ev.target.textContent; ta.focus(); sendTyping(room,true); }
  });
  document.body.appendChild(p); pickers[room]=p;
}
function browseFile(room){ $('#f-'+room).click(); }
ROOMS.forEach(room=>{
  $('#f-'+room).addEventListener('change', async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      // Storage: chat (public)
      const path = ${room}/${Date.now()}_${f.name};
      const up = await supa.storage.from('chat').upload(path, f, { upsert:false });
      if(up.error) throw up.error;
      const pub = supa.storage.from('chat').getPublicUrl(path);
      $('#i-'+room).dataset.fileurl = pub.data.publicUrl;
      const ta = $('#i-'+room);
      ta.value = (ta.value? ta.value+'\n' : '') + `[zaÅ‚Ä…cznik: ${f.name}] `;
      ta.focus();
    }catch(err){
      if(f.size <= 1024*1024){
        const reader = new FileReader();
        reader.onload = ()=>{ $('#i-'+room).dataset.fileurl = reader.result; };
        reader.readAsDataURL(f);
      }else{
        alert('Nie udaÅ‚o siÄ™ zapisaÄ‡ pliku (i zbyt duÅ¼y na dataURL).');
      }
    }
    e.target.value='';
  });
});
ROOMS.forEach(room=>{
  const ta=$('#i-'+room);
  ta.addEventListener('input', ()=>{ clearTimeout(state[room].typingTimer); sendTyping(room,true); state[room].typingTimer=setTimeout(()=>sendTyping(room,false),1200); });
  ta.addEventListener('keydown', e=>{ if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); sendMsg(room); } });
});

/*** DÅ¹WIÄ˜K ***/
function ding(){ try{ new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAACAgICAAAAA').play(); }catch{} }

/*** UMOWY (Supabase) ***/
async function loadContracts(){
  const { data, error } = await supa.from('contracts').select('*').order('created_at',{ascending:false}).limit(200);
  if(error){ alert(error.message); return; }
  const box = $('#contractsList');
  box.innerHTML = '';
  const hdr = <div class="tr" style="opacity:.7"><div><b>TytuÅ‚</b></div><div><b>Kwota</b></div><div><b>Status</b></div><div><b>Data</b></div><div></div></div>;
  box.insertAdjacentHTML('beforeend', hdr);
  (data||[]).forEach(c=>{
    const row = el('div',{className:'tr'});
    row.innerHTML = `
      <div>${c.title}</div>
      <div>${c.amount ?? 'â€”'}</div>
      <div>${c.status}</div>
      <div>${INT.format(new Date(c.created_at))}</div>
      <div class="row">
        <button class="btn ghost" onclick="updContract('${c.id}','signed')">âœ”</button>
        <button class="btn ghost" onclick="updContract('${c.id}','rejected')">âœ–</button>
        <button class="btn ghost bad" onclick="delContract('${c.id}')">ğŸ—‘</button>
      </div>`;
    box.appendChild(row);
  });
}
async function addContract(){
  const title = ($('#cTitle').value||'').trim(); if(!title) return;
  const amount = parseFloat($('#cAmount').value||'') || null;
  const status = $('#cStatus').value || 'draft';
  const { error } = await supa.from('contracts').insert([{ title, amount, status }]);
  if(error){ alert(error.message); return; }
  $('#cTitle').value=''; $('#cAmount').value='';
  await loadContracts();
}
async function updContract(id,status){
  const { error } = await supa.from('contracts').update({ status }).eq('id', id);
  if(error) alert(error.message); else loadContracts();
}
async function delContract(id){
  if(!confirm('UsunÄ…Ä‡ umowÄ™?')) return;
  const { error } = await supa.from('contracts').delete().eq('id', id);
  if(error) alert(error.message); else loadContracts();
}
$('#btnAddC').addEventListener('click', addContract);
$('#btnReloadC').addEventListener('click', loadContracts);

/*** DOKUMENTY (Storage bucket: docs) ***/
async function loadDocs(){
  const { data, error } = await supa.storage.from('docs').list('', { limit: 100, offset: 0, sortBy: { column:'name', order:'asc' } });
  if(error){ alert(error.message); return; }
  const box=$('#docsList'); box.innerHTML='';
  (data||[]).forEach(it=>{
    const url = supa.storage.from('docs').getPublicUrl(it.name).data.publicUrl;
    const row = el('div',{className:'row', style:'margin:6px 0'});
    row.innerHTML = `<a class="pill" href="${url}" target="_blank">ğŸ“„ ${it.name}</a>
      <button class="btn ghost bad" onclick="delDoc('${it.name}')">ğŸ—‘</button>`;
    box.appendChild(row);
  });
}
async function uploadDoc(){
  const f = $('#docFile').files[0]; if(!f) return;
  const path = ${Date.now()}_${f.name};
  const up = await supa.storage.from('docs').upload(path, f, { upsert:false });
  if(up.error){ alert(up.error.message); return; }
  $('#docFile').value=''; loadDocs();
}
async function delDoc(name){
  if(!confirm('UsunÄ…Ä‡ dokument?')) return;
  const { error } = await supa.storage.from('docs').remove([name]);
  if(error) alert(error.message); else loadDocs();
}
$('#btnUpDoc').addEventListener('click', uploadDoc);
$('#btnReloadDocs').addEventListener('click', loadDocs);

/*** ZADANIA (Supabase) ***/
async function loadTasks(){
  const { data, error } = await supa.from('tasks').select('*').order('created_at',{ascending:false}).limit(200);
  if(error){ alert(error.message); return; }
  const box=$('#tasksList'); box.innerHTML='';
  (data||[]).forEach(t=>{
    const row = el('div',{className:'row', style:'margin:6px 0'});
    row.innerHTML = `
      <label class="pill" style="cursor:pointer">
        <input type="checkbox" ${t.done?'checked':''} onchange="toggleTask('${t.id}', this.checked)" style="margin-right:8px">
        ${t.title}
      </label>
      <span class="meta">${INT.format(new Date(t.created_at))}</span>
      <button class="btn ghost bad" onclick="delTask('${t.id}')">ğŸ—‘</button>`;
    box.appendChild(row);
  });
}
async function addTask(){
  const title = ($('#tTitle').value||'').trim(); if(!title) return;
  const { error } = await supa.from('tasks').insert([{ title }]);
  if(error){ alert(error.message); return; }
  $('#tTitle').value=''; loadTasks();
}
async function toggleTask(id,done){
  const { error } = await supa.from('tasks').update({ done }).eq('id', id);
  if(error) alert(error.message);
}
async function delTask(id){
  if(!confirm('UsunÄ…Ä‡ zadanie?')) return;
  const { error } = await supa.from('tasks').delete().eq('id', id);
  if(error) alert(error.message); else loadTasks();
}
$('#btnAddT').addEventListener('click', addTask);
$('#btnReloadT').addEventListener('click', loadTasks);

/*** KALKULATORY ***/
function obliczRaty(){
  const K = parseFloat($('#kKwota').value||0);
  const r = (parseFloat($('#kOprocent').value||0) / 100) / 12;
  const n = parseInt($('#kOkres').value||0,10);
  if(K<=0 || n<=0){ $('#ratOut').textContent='Podaj kwotÄ™ i okres'; return; }
  const R = r>0 ? (K * r) / (1 - Math.pow(1+r, -n)) : (K / n);
  $('#ratOut').textContent = Rata: ${R.toFixed(2)} PLN â€¢ ÅÄ…cznie: ${(R*n).toFixed(2)} PLN;
}
function obliczVAT(){
  const kw = parseFloat($('#vKwota').value||0);
  const st = parseFloat($('#vStawka').value||0)/100;
  const tryb = $('#vTryb').value;
  if(kw<=0){ $('#vatOut').textContent='Podaj kwotÄ™'; return; }
  if(tryb==='nb'){
    const brutto = kw*(1+st);
    $('#vatOut').textContent = Brutto: ${brutto.toFixed(2)} PLN (VAT ${(brutto-kw).toFixed(2)});
  }else{
    const netto = kw/(1+st);
    $('#vatOut').textContent = Netto: ${netto.toFixed(2)} PLN (VAT ${(kw-netto).toFixed(2)});
  }
}
function obliczPct(){
  const base = parseFloat($('#pBase').value||0);
  const pct  = parseFloat($('#pPct').value||0)/100;
  if(base<=0){ $('#pctOut').textContent='Podaj podstawÄ™'; return; }
  $('#pctOut').textContent = ${(pct*100).toFixed(2)}% z ${base.toFixed(2)} = ${(base*pct).toFixed(2)} PLN;
}
$('#btnRat').addEventListener('click', obliczRaty);
$('#btnVat').addEventListener('click', obliczVAT);
$('#btnPct').addEventListener('click', obliczPct);

/*** INIT: odpal 4 pokoje + wczytaj moduÅ‚y przy wejÅ›ciu na stronÄ™ ***/
(async function init(){
  for(const r of ROOMS){
    await loadInitial(r);
    await subscribeRoom(r);
    await joinPresence(r);
  }
  // wczytaj dane list przy wejÅ›ciu w zakÅ‚adkÄ™
  if(location.hash==='#/contracts') loadContracts();
  if(location.hash==='#/docs') loadDocs();
  if(location.hash==='#/tasks') loadTasks();
})();
window.addEventListener('hashchange', ()=>{
  if(location.hash==='#/contracts') loadContracts();
  if(location.hash==='#/docs') loadDocs();
  if(location.hash==='#/tasks') loadTasks();
});
</script>
</body>
</html>
