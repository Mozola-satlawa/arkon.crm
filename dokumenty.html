<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Dokumenty (og√≥lne / prefinansowanie / dofinansowanie)</title>
<meta name="description" content="Lista dokument√≥w ARKON z podzia≈Çem na og√≥lne, prefinansowanie i dofinansowanie.">
<style>
  :root{
    --bg:#0a0f1e; --p1:#0f1533cc; --p2:#0c1230cc; --ink:#e9eeff; --muted:#aeb8da; --accent:#4cc9f0;
    --ok:#2b8a57; --bad:#ff6b6b; --warn:#ffb84d; --line:#27336a; --grid:#22305f;
    --btn:#253772; --btnb:#3c54ad; --card:#0f1533;
    --shadow: 0 10px 30px rgba(10,15,30,.35), inset 0 1px 0 rgba(255,255,255,.03);
    --radius: 16px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f8ff; --p1:#ffffffcc; --p2:#f7f9ffcc; --ink:#0e1533; --muted:#536191;
      --line:#dae2ff; --grid:#e8edff; --btn:#254a90; --btnb:#3f6ad6;
    }
    body{background:#eef2ff}
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{
    background:
      radial-gradient(1200px 600px at 10% -10%, #1a2250 0%, transparent 60%),
      radial-gradient(1200px 600px at 110% 10%, #13224a 0%, transparent 55%),
      linear-gradient(180deg,#0a0f1e,#0c1230 55%,#0a0f1e);
    color:var(--ink);
    font:15px/1.55 system-ui, Segoe UI, Roboto, Arial;
    letter-spacing: .2px;
  }
  a{color:#d5e4ff;text-decoration:none;transition:.2s ease color}
  a:hover{color:#ffffff}
  header{
    padding:18px 16px;
    background:linear-gradient(180deg,#11183a,#0f1533);
    border-bottom:1px solid var(--line);
    position:sticky;top:0;z-index:20;
    backdrop-filter:saturate(120%) blur(8px);
  }
  header h1{margin:0;font-size:22px;letter-spacing:.3px}
  .small{font-size:12px;color:var(--muted)}
  nav{
    background:linear-gradient(180deg,#151d44,#121a3b);
    display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;
    border-bottom:1px solid var(--line);position:sticky;top:62px;z-index:19;
    backdrop-filter:saturate(120%) blur(8px);
  }
  nav a, nav button{
    color:#d5e4ff;padding:8px 14px;border-radius:999px;border:1px solid #2a3a75;
    background:linear-gradient(180deg,#19255a,#14214e);
    cursor:pointer;transition:.2s ease transform,.2s ease background,.2s ease border-color,.2s ease box-shadow;
    box-shadow: 0 2px 0 rgba(0,0,0,.25);
  }
  nav a[aria-current="page"]{border-color:#5a73ff;box-shadow:0 0 0 2px #5a73ff33 inset}
  nav a:hover, nav button:hover{background:#223160; transform:translateY(-1px)}
  nav a:focus-visible, nav button:focus-visible{outline:3px solid #7bb8ff88; outline-offset:2px}
  .wrap{max-width:1360px;margin:auto;padding:16px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:12px 0}
  .btn{
    background:linear-gradient(180deg,#26407c,#21356a);
    border:1px solid var(--btnb);color:#fff;border-radius:12px;padding:9px 14px;cursor:pointer;
    transition:.2s ease transform,.2s ease box-shadow,.2s ease background;
    box-shadow: var(--shadow);
  }
  .btn:hover{transform:translateY(-1px)}
  .btn:active{transform:translateY(0)}
  .btn.ghost{
    background:linear-gradient(180deg,#101b44,#0c1537);
    border:1px dashed var(--btnb);box-shadow:none;color:#d5e4ff
  }
  .btn.bad{background:linear-gradient(180deg,#4a2331,#3a1f2a);border-color:#7b3341}
  .btn.ok{background:linear-gradient(180deg,#1b5b3a,#12442a);border-color:var(--ok)}
  input,select,textarea{
    background:#0d1530;border:1px solid #2b3a77;border-radius:12px;padding:9px 12px;color:var(--ink);font:inherit;
    transition:.2s ease border-color,.2s ease box-shadow; min-height:38px
  }
  input::placeholder{color:#aeb8da99}
  input:focus-visible, select:focus-visible, textarea:focus-visible{outline:none;border-color:#7bb8ff; box-shadow:0 0 0 3px #7bb8ff33}
  textarea{min-height:74px;resize:vertical}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .tag{display:inline-block;margin:4px 8px 0 0;padding:6px 10px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px;cursor:pointer}
  .tag:hover{background:#1a2a66;border-color:#5a73ff}
  .grid{display:grid;gap:14px}
  @media(min-width:1200px){ .cols-2{grid-template-columns:2fr 1fr} }
  .card{
    background:linear-gradient(180deg,var(--p1),var(--p2));
    border:1px solid var(--line);border-radius:var(--radius);padding:14px;
    box-shadow: var(--shadow);
  }
  table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border-radius:12px}
  thead th{
    position:sticky; top:0; background:#121a3f; color:#c6d0ff; text-transform:uppercase; letter-spacing:.05em; font-size:12px;
    border-bottom:1px solid var(--grid);
  }
  th,td{padding:11px 10px;border-bottom:1px solid var(--grid);text-align:left;vertical-align:top}
  tbody tr:nth-child(odd){background:#0e1431}
  tbody tr:hover{background:#121a3f}
  th:first-child, td:first-child{padding-left:14px}
  th:last-child, td:last-child{padding-right:14px}
  td .name{display:flex;gap:10px;align-items:center;min-width:240px}
  .ico{width:28px;height:28px;border-radius:8px;background:#0e1538;border:1px solid #293a80;display:grid;place-items:center;font-size:16px;box-shadow:inset 0 1px 0 #ffffff14}
  .ico.pdf{background:#2a1830;border-color:#6b2d55}
  .ico.doc{background:#16233f;border-color:#3950a5}
  .ico.xls{background:#0f2f28;border-color:#1f6b57}
  .ico.zip{background:#2c2512;border-color:#7a5f1a}
  .ico.txt{background:#1f1f2e;border-color:#53537a}
  .star{cursor:pointer;font-size:18px;line-height:1;transition:.15s ease transform}
  .star.on{color:#ffd86b;text-shadow:0 0 10px #ffd86b66}
  .star:hover{transform:scale(1.1)}
  .right{display:flex;gap:6px;justify-content:flex-end;flex-wrap:wrap}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .muted{color:var(--muted)}
  .list-reset{list-style:none;margin:0;padding:0}
  .hint{font-size:12px;color:#aeb8da}
  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:60}
  .modal.open{display:flex}
  .modal .box{
    width:1100px;max-width:95vw;max-height:92vh;display:flex;flex-direction:column;
    background:linear-gradient(180deg,#10173c,#111b48);border:1px solid #2b3a77;border-radius:14px; box-shadow: var(--shadow)
  }
  .modal .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #2b3a77}
  .modal .bd{padding:0;height:80vh}
  .modal iframe{width:100%;height:100%;border:0;background:#0b1022;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  @media print{ nav,.toolbar,.modal{display:none!important} .card{box-shadow:none;border-color:#dde5ff} body{background:#fff} }
</style>
</head>
<body>

<header>
  <h1>Dokumenty ‚Ä¢ ARKON CRM</h1>
  <div class="small">Lista um√≥w i o≈õwiadcze≈Ñ. Opisy, tagi, ulubione, podglƒÖd PDF (inline). Dane pomocnicze zapisujƒÖ siƒô lokalnie w przeglƒÖdarce.</div>
</header>

<nav>
  <a href="pulpit.html">Pulpit</a>
  <a href="dokumenty.html" aria-current="page">Dokumenty</a>
  <button id="btnAll" type="button">Wszystkie</button>
  <button id="btnGen" type="button">Og√≥lne</button>
  <button id="btnPref" type="button">Prefinansowanie</button>
  <button id="btnDofi" type="button">Dofinansowanie</button>
</nav>

<div class="wrap grid cols-2">
  <section class="card">
    <div class="toolbar">
      <input id="q" placeholder="üîé Szukaj po nazwie, opisie lub tagu‚Ä¶" style="min-width:260px" aria-label="Szukaj dokument√≥w">
      <select id="fType" title="Typ pliku" aria-label="Filtr typu pliku">
        <option value="">Typ: wszystkie</option>
        <option value="pdf">PDF</option>
        <option value="doc">DOC/DOCX</option>
        <option value="xls">XLS/XLSX</option>
        <option value="txt">TXT</option>
        <option value="zip">ZIP</option>
      </select>
      <select id="sort" aria-label="Sortowanie">
        <option value="name.asc">Sort: nazwa ‚Üë</option>
        <option value="name.desc">Sort: nazwa ‚Üì</option>
        <option value="fav.desc">Sort: ulubione ‚Üí</option>
        <option value="mod.desc">Sort: ostatnio modyfikowane</option>
      </select>
      <span class="pill" aria-live="polite">Widocznych: <b id="countVis">0</b></span>
      <div class="right" style="margin-left:auto">
        <button id="btnExportCSV" class="btn ghost" type="button">CSV (lista)</button>
        <label class="btn ghost" title="Wczytaj lokalne pliki ≈ºeby pobraƒá ich datƒô modyfikacji (bez wysy≈Çania)">
          Wczytaj metadane<input id="pickMeta" type="file" multiple hidden>
        </label>
        <button id="btnReset" class="btn bad" type="button" title="Czy≈õci tylko opisy/tagi/ulubione w przeglƒÖdarce">Wyczy≈õƒá notatki</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table id="tblDocs" role="grid" aria-label="Tabela dokument√≥w">
        <thead>
          <tr>
            <th scope="col">‚òÖ</th>
            <th scope="col">Nazwa</th>
            <th scope="col">Opis (edytowalny)</th>
            <th scope="col">Tagi</th>
            <th scope="col">Ost. modyfikacja</th>
            <th scope="col">Akcje</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <aside class="grid">
    <div class="card">
      <b>Szybkie filtry (tagi)</b>
      <div style="margin-top:8px" class="small">
        <div class="list-reset" id="quickTags"></div>
      </div>
      <div class="hint" style="margin-top:8px">Kliknij tag, aby filtrowaƒá. Ponowne klikniƒôcie usuwa filtr.</div>
    </div>

    <div class="card small">
      <b>Uwagi, gdy plik ‚Äûnie wczytuje siƒô‚Äù:</b>
      <ol>
        <li>Sprawd≈∫ <i>dok≈ÇadnƒÖ</i> nazwƒô (w tym polskie znaki i my≈õlniki).</li>
        <li>Upewnij siƒô, ≈ºe plik le≈ºy w tym samym katalogu co ta strona.</li>
        <li>Diakrytyki (np. ≈ö, ƒÑ) mogƒÖ mieƒá r√≥≈ºne formy Unicode (NFC/NFD). Je≈õli serwer nie dopasowuje, rozwa≈º zmianƒô nazwy na ASCII (np. <code>OSWIADCZENIE_WSPOLMAZONKA.docx</code>).</li>
      </ol>
    </div>
  </aside>
</div>

<!-- MODAL PREVIEW -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <div class="hd">
      <div id="mTitle"><b>PodglƒÖd</b></div>
      <div class="right">
        <a id="mOpen" class="btn ghost" href="#" target="_blank" rel="noopener">Otw√≥rz w nowej karcie</a>
        <button id="mClose" class="btn" type="button">Zamknij</button>
      </div>
    </div>
    <div class="bd"><iframe id="mFrame" src="about:blank" title="PodglƒÖd dokumentu"></iframe></div>
  </div>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmtDate = ts => ts ? new Date(ts).toLocaleString('pl-PL') : '‚Äî';
const fileExt = n => (n.split('.').pop()||'').toLowerCase();
const sl = (s) => (s||'').toString().toLowerCase();
const CSVesc = v => {
  let s = String(v==null?'':v);
  return /[\";\n]/.test(s) ? '"' + s.replace(/\"/g,'""') + '"' : s;
};

/* ===== local storage for notes ===== */
const LS_KEY = 'arkon_docs_notes_v1'; // { [fileName]: {desc, tags:string[], fav:boolean, mod?:number}}
let notes = load(LS_KEY, {});

function load(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); }catch{ return fallback; }
}
function saveNotes(){
  localStorage.setItem(LS_KEY, JSON.stringify(notes));
  buildQuickTags();
}

/* ===== Twoje pliki z podzia≈Çem na dzia≈Çy ===== */
const FILES = [
  /* OG√ìLNE */
  { name:'UMOWA Z WYKONAWCAÃ®  arkon.pdf', href:'UMOWA Z WYKONAWCAÃ®  arkon.pdf',
    desc:'Wz√≥r umowy z WykonawcƒÖ (PDF).', tags:['umowa','og√≥lne','prefinansowanie','dofinansowanie'] },
  { name:'PE≈ÅNOMOCNICTWO.docx', href:'PE≈ÅNOMOCNICTWO.docx',
    desc:'Pe≈Çnomocnictwo do reprezentowania w programie/urzƒôdzie.', tags:['pe≈Çnomocnictwo','og√≥lne','prefinansowanie','dofinansowanie'] },
  { name:'OSÃÅWIADCZENIE WSPOÃÅ≈ÅMA≈ÅZÃáONKA.docx', href:'OSÃÅWIADCZENIE WSPOÃÅ≈ÅMA≈ÅZÃáONKA.docx',
    desc:'Zgoda wsp√≥≈Çma≈Ç≈ºonka na wykonanie zakresu/zg≈Çoszenie.', tags:['o≈õwiadczenie','og√≥lne','prefinansowanie','dofinansowanie'] },
  { name:'OSÃÅWIADCZENIE WSPOÃÅ≈ÅW≈ÅASÃÅCICIELA.docx', href:'OSÃÅWIADCZENIE WSPOÃÅ≈ÅW≈ÅASÃÅCICIELA.docx',
    desc:'Zgoda wsp√≥≈Çw≈Ça≈õciciela nieruchomo≈õci na realizacjƒô inwestycji.', tags:['o≈õwiadczenie','og√≥lne','prefinansowanie','dofinansowanie'] },
  { name:'7188a6a8-7977-4e81-8ce6-7410c21c9b25.pdf', href:'7188a6a8-7977-4e81-8ce6-7410c21c9b25.pdf',
    desc:'Dokument PDF (identyfikator).', tags:['og√≥lne','pdf'] },

  /* PREFINANSOWANIE ‚Äî + zaliczka, protok√≥≈Ç */
  { name:'zalacznik_do_instrukcji_wniosku_o_dofinansowanie_wzor_dyspozycji_wyplaty_zaliczki-14-06-2024.pdf',
    href:'zalacznik_do_instrukcji_wniosku_o_dofinansowanie_wzor_dyspozycji_wyplaty_zaliczki-14-06-2024.pdf',
    desc:'Wz√≥r dyspozycji wyp≈Çaty zaliczki.', tags:['prefinansowanie','zaliczka','pdf'] },
  { name:'PROTOK√ì≈Å ODBIORU PRAC.docx', href:'PROTOK√ì≈Å ODBIORU PRAC.docx',
    desc:'Protok√≥≈Ç odbioru prac (DOCX).', tags:['prefinansowanie','protok√≥≈Ç'] },
  { name:'protokolu_odbioru_prac_wykonawcy.pdf', href:'protokolu_odbioru_prac_wykonawcy.pdf',
    desc:'Protok√≥≈Ç odbioru prac (PDF).', tags:['prefinansowanie','protok√≥≈Ç','pdf'] },

  /* DOFINANSOWANIE ‚Äî + zap≈Çata, PB-5 */
  { name:'OSÃÅWIADCZENIE O DOKONANIU ZAP≈ÅATY.docx', href:'OSÃÅWIADCZENIE O DOKONANIU ZAP≈ÅATY.docx',
    desc:'O≈õwiadczenie potwierdzajƒÖce dokonanie zap≈Çaty.', tags:['dofinansowanie','o≈õwiadczenie','p≈Çatno≈õƒá'] },
  { name:'oswiadczenie_o_posiadanym_prawie_do_dysponowania_nieruchomoscia_na_cele_budowlane_pb-5v11.docx',
    href:'oswiadczenie_o_posiadanym_prawie_do_dysponowania_nieruchomoscia_na_cele_budowlane_pb-5v11.docx',
    desc:'PB-5 v11: o≈õwiadczenie o prawie do dysponowania nieruchomo≈õciƒÖ.', tags:['dofinansowanie','o≈õwiadczenie'] }
];

/* ===== stan & UI ===== */
let filter = { q:'', type:'', sort:'name.asc', tag:'' };

/* wstƒôpne ustawienie tagu z URL (?tag=dofinansowanie) */
const usp = new URLSearchParams(location.search);
if(usp.get('tag')){ filter.tag = usp.get('tag'); }

$('#q').addEventListener('input', e=>{ filter.q=e.target.value; render(); });
$('#fType').addEventListener('change', e=>{ filter.type=e.target.value; render(); });
$('#sort').addEventListener('change', e=>{ filter.sort=e.target.value; render(); });
$('#btnReset').addEventListener('click', ()=>{ 
  if(!confirm('Wyczy≈õciƒá lokalne opisy, tagi i ulubione?')) return;
  notes = {}; saveNotes(); render();
});
$('#btnExportCSV').addEventListener('click', exportCSV);
$('#pickMeta').addEventListener('change', handlePickMeta);

/* skr√≥t klawiaturowy do wyszukiwania */
window.addEventListener('keydown', (e)=>{ if(e.key==='/' && !e.metaKey && !e.ctrlKey){ e.preventDefault(); $('#q').focus(); }});

/* szybkie filtry ‚Äî dzia≈Çy */
$('#btnAll').addEventListener('click', ()=>{ filter.tag=''; render(); });
$('#btnGen').addEventListener('click', ()=>{ filter.tag='og√≥lne'; render(); });
$('#btnPref').addEventListener('click', ()=>{ filter.tag='prefinansowanie'; render(); });
$('#btnDofi').addEventListener('click', ()=>{ filter.tag='dofinansowanie'; render(); });

/* ===== render ===== */
function applyFilters(rows){
  // scal notatki (desc/tags/fav/mod)
  rows = rows.map(r=>{
    const n = notes[r.name] || {};
    return Object.assign({}, r, { _desc: n.desc ?? r.desc ?? '', _tags: Array.isArray(n.tags)? n.tags : (r.tags||[]), _fav: !!n.fav, _mod: n.mod || 0 });
  });

  if(filter.q){
    const q = sl(filter.q);
    rows = rows.filter(r => sl(r.name).includes(q) || sl(r._desc).includes(q) || (r._tags||[]).some(t=>sl(t).includes(q)));
  }
  if(filter.type){
    rows = rows.filter(r=>{
      const ext = fileExt(r.name);
      if(filter.type==='doc') return ['doc','docx'].includes(ext);
      if(filter.type==='xls') return ['xls','xlsx'].includes(ext);
      return ext===filter.type;
    });
  }
  if(filter.tag){
    const t = sl(filter.tag);
    rows = rows.filter(r => (r._tags||[]).some(x=>sl(x)===t));
  }

  rows.sort((a,b)=>{
    switch(filter.sort){
      case 'name.asc':  return a.name.localeCompare(b.name,'pl',{sensitivity:'base'});
      case 'name.desc': return b.name.localeCompare(a.name,'pl',{sensitivity:'base'});
      case 'fav.desc':  return (b._fav?1:0) - (a._fav?1:0) || a.name.localeCompare(b.name,'pl');
      case 'mod.desc':  return (b._mod||0) - (a._mod||0) || a.name.localeCompare(b.name,'pl');
      default: return 0;
    }
  });
  return rows;
}

function render(){
  let rows = applyFilters(FILES.slice());
  $('#countVis').textContent = rows.length;
  const tb = $('#tbody'); tb.innerHTML='';

  if(!rows.length){
    tb.innerHTML = '<tr><td colspan="6" class="small">Brak wynik√≥w dla bie≈ºƒÖcych filtr√≥w.</td></tr>';
    return;
  }

  rows.forEach(file=>{
    const tr = document.createElement('tr');
    // ‚òÖ ulubione
    const tdFav = document.createElement('td');
    const star = document.createElement('span');
    star.className = 'star' + (file._fav?' on':'');
    star.setAttribute('role','button');
    star.setAttribute('aria-label', file._fav ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych');
    star.textContent = file._fav ? '‚òÖ' : '‚òÜ';
    star.title = file._fav ? 'Usu≈Ñ z ulubionych' : 'Dodaj do ulubionych';
    star.addEventListener('click', ()=>{
      const n = notes[file.name] || {};
      n.fav = !file._fav;
      notes[file.name] = n; saveNotes(); render();
    });
    tdFav.appendChild(star);

    // Nazwa + ikonka
    const tdName = document.createElement('td');
    const box = document.createElement('div'); box.className='name';
    const ico = document.createElement('div');
    const ext = fileExt(file.name);
    ico.className = 'ico ' + (ext==='pdf'?'pdf': (['doc','docx'].includes(ext)?'doc': (['xls','xlsx'].includes(ext)?'xls': (ext==='zip'?'zip': (ext==='txt'?'txt':'')))));
    ico.textContent = ext==='pdf'?'üìÑ': (['doc','docx'].includes(ext)?'üìù': (['xls','xlsx'].includes(ext)?'üìä': (ext==='zip'?'üóú':'üìÑ')));
    const a = document.createElement('a'); a.href=encodeURI(file.href); a.textContent=file.name; a.title='Otw√≥rz';
    a.addEventListener('click', (e)=>{
      // PDF podglƒÖd w modalu; inne ‚Äî standardowo
      if(fileExt(file.name)==='pdf'){
        e.preventDefault();
        openPreview(file);
      }
    });
    box.appendChild(ico); box.appendChild(a);
    tdName.appendChild(box);

    // Opis (edytowalny) + autosave
    const tdDesc = document.createElement('td');
    const ta = document.createElement('textarea'); ta.placeholder='Opis dokumentu‚Ä¶'; ta.value=file._desc||'';
    ta.addEventListener('input', debounce(()=>{ setNote(file.name, {desc:ta.value}); }, 200));
    tdDesc.appendChild(ta);

    // Tagi (edytowalne, po przecinku)
    const tdTags = document.createElement('td');
    const inpTags = document.createElement('input'); inpTags.placeholder='np. umowa, prawne'; inpTags.value=(file._tags||[]).join(', ');
    inpTags.addEventListener('input', debounce(()=>{
      const tags = inpTags.value.split(',').map(s=>s.trim()).filter(Boolean);
      setNote(file.name, {tags});
    }, 200));
    tdTags.appendChild(inpTags);

    // Ost. modyfikacja (z local metadanych je≈õli wczytane)
    const tdMod = document.createElement('td');
    tdMod.textContent = file._mod ? fmtDate(file._mod) : '‚Äî';

    // Akcje
    const tdAct = document.createElement('td');
    tdAct.className='right';
    const btnOpen = document.createElement('a');
    btnOpen.className='btn ghost'; btnOpen.href=encodeURI(file.href); btnOpen.target='_blank'; btnOpen.rel='noopener';
    btnOpen.textContent = 'Otw√≥rz';
    btnOpen.addEventListener('click', (e)=>{
      if(fileExt(file.name)==='pdf'){ e.preventDefault(); openPreview(file); }
    });
    const btnDl = document.createElement('a');
    btnDl.className='btn'; btnDl.href=encodeURI(file.href); btnDl.download=file.name; btnDl.textContent='Pobierz';

    tdAct.appendChild(btnOpen);
    tdAct.appendChild(btnDl);

    tr.appendChild(tdFav);
    tr.appendChild(tdName);
    tr.appendChild(tdDesc);
    tr.appendChild(tdTags);
    tr.appendChild(tdMod);
    tr.appendChild(tdAct);

    $('#tbody').appendChild(tr);
  });
}

/* ===== tag chmura ===== */
function buildQuickTags(){
  const box = $('#quickTags'); box.innerHTML='';
  const map = new Map();
  // zbierz z plik√≥w + z notes
  FILES.forEach(f=>{
    (f.tags||[]).forEach(t=> map.set(t, (map.get(t)||0)+1));
  });
  Object.values(notes).forEach(n=>{
    (n.tags||[]).forEach(t=> map.set(t, (map.get(t)||0)+1));
  });
  if(map.size===0){ box.innerHTML='<div class="muted">Brak tag√≥w. Dodaj w tabeli.</div>'; return; }

  const sorted = [...map.entries()].sort((a,b)=> b[1]-a[1]);
  sorted.slice(0,30).forEach(([tag,count])=>{
    const btn = document.createElement('button');
    btn.className='tag';
    btn.type='button';
    btn.textContent = tag + ' ('+count+')';
    btn.addEventListener('click', ()=>{
      filter.tag = (filter.tag===tag ? '' : tag);
      render();
    });
    if(filter.tag===tag){ btn.style.background='#1a2a66'; btn.style.borderColor='#4b65d2'; btn.style.color='#e9eeff'; }
    box.appendChild(btn);
  });
}

/* ===== notatki - merge partial ===== */
function setNote(name, part){
  const n = notes[name] || {};
  Object.assign(n, part);
  notes[name] = n;
  saveNotes();
}

/* ===== preview modal (PDF) ===== */
const modal = $('#modal'), mFrame = $('#mFrame'), mOpen = $('#mOpen'), mTitle = $('#mTitle');
$('#mClose').addEventListener('click', closePreview);
function openPreview(file){
  mTitle.textContent = file.name;
  mFrame.src = encodeURI(file.href);
  mOpen.href = encodeURI(file.href);
  modal.classList.add('open');
}
function closePreview(){
  mFrame.src = 'about:blank';
  modal.classList.remove('open');
}

/* ===== wczytaj metadane z lokalnych plik√≥w (tylko po nazwie) ===== */
async function handlePickMeta(e){
  const files = Array.from(e.target.files||[]);
  if(!files.length) return;
  let changed = 0;
  files.forEach(f=>{
    const match = FILES.find(x=>x.name===f.name);
    if(!match) return;
    const n = notes[match.name] || {};
    n.mod = f.lastModified || Date.now();
    notes[match.name] = n;
    changed++;
  });
  saveNotes();
  if(changed===0) alert('Nie dopasowano nazw ‚Äî upewnij siƒô, ≈ºe wybierasz te same pliki.');
  render();
  e.target.value = '';
}

/* ===== eksport CSV ===== */
function exportCSV(){
  const rows = applyFilters(FILES.slice());
  const out = [['Ulubione','Nazwa','Opis','Tagi','Ost. modyfikacja','≈öcie≈ºka']];
  rows.forEach(r=>{
    out.push([
      r._fav?'TAK':'NIE',
      r.name,
      (r._desc||'').replace(/\s+/g,' ').trim(),
      (r._tags||[]).join('|'),
      r._mod? new Date(r._mod).toISOString() : '',
      r.href
    ]);
  });
  const csv = out.map(line=>line.map(CSVesc).join(';')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_dokumenty.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ===== debounce util ===== */
function debounce(fn,ms){ let t; return function(){ const a=arguments; clearTimeout(t); t=setTimeout(()=>fn.apply(null,a), ms||180); }; }

/* ===== init ===== */
function init(){
  // zasiej domy≈õlne opisy/tagi je≈õli nie ma notatek
  FILES.forEach(f=>{
    if(!notes[f.name]){
      notes[f.name] = { desc:f.desc||'', tags:(f.tags||[]), fav:false };
    }
  });
  saveNotes();
  buildQuickTags();
  render();
}
init();
</script>
</body>
</html>
