<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Kalendarz Monta≈ºy</title>
<meta name="description" content="Kalendarz monta≈ºowy ARKON: planowanie, klienci, monterzy, statusy, eksport/import, ICS, druk. Dane w Neon przez Netlify Functions.">
<style>
  :root{
    --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da;
    --accent:#4cc9f0; --ok:#2fbf71; --warn:#ffb84d; --bad:#ff6b6b;
    --card:#0f1533; --line:#1c2750; --grid:#243059; --chip:#0d1530;
    --shadow:0 10px 40px #0007;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1300px;margin:auto;padding:16px}
  .grid{display:grid;gap:14px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:2fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  input,select,textarea{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder,textarea::placeholder{color:#aeb8da99}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .legend{display:flex;flex-wrap:wrap;gap:8px}
  .dot{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid #2a3a77;background:#0d1530}
  .dot .c{width:10px;height:10px;border-radius:50%}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}

  /* Status bar */
  .statusbar{display:flex;gap:8px;align-items:center;padding:8px 16px;border-bottom:1px solid var(--line);
             background:linear-gradient(180deg,#0f1740,#101a4a)}
  .chip{display:inline-flex;gap:8px;align-items:center;border:1px solid #2a3a77;background:#0d1530;border-radius:999px;padding:4px 10px;font-size:12px}
  .i{width:8px;height:8px;border-radius:50%}
  .i.online{background:var(--ok)}
  .i.offline{background:var(--bad)}
  .i.apiok{background:var(--ok)}
  .i.apibad{background:var(--warn)}

  /* Error banner */
  .err{
    position: sticky; top: 0; z-index: 60;
    background: #3a1d1d; color: #ffdede;
    border: 1px solid #7b3341; border-left: 6px solid #ff6b6b;
    padding: 10px 14px; font-size: 14px;
    box-shadow: 0 8px 24px #0007;
  }

  /* Calendar */
  .calendar{border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .cal-head{display:grid;grid-template-columns:repeat(7,1fr);background:#0f173a;border-bottom:1px solid var(--line)}
  .cal-head div{padding:8px 6px;text-align:center;color:#aeb8da}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);grid-auto-rows:140px}
  .cell{border-right:1px solid #1a244d;border-bottom:1px solid #1a244d;position:relative;background:#0e1435}
  .cell:nth-child(7n){border-right:0}
  .cell .d{position:absolute;top:6px;right:8px;font-size:12px;color:#aeb8da}
  .cell .today{background:#20306b;color:#fff;padding:2px 6px;border-radius:6px}
  .ev{display:block;margin:2px 6px 0;padding:3px 6px;border-radius:6px;border:1px solid #2a3a77;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:12px}
  .ev .bar{display:inline-block;width:6px;height:10px;border-radius:3px;margin-right:6px;vertical-align:middle}
  .ev:hover{outline:1px solid #67a1ff44}

  /* List */
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 6px;border-bottom:1px solid #1a244d;text-align:left;vertical-align:top}
  th{font-size:12px;color:var(--muted)}

  /* Drawer */
  .drawer{position:fixed;right:0;top:0;height:100%;width:520px;max-width:100%;background:linear-gradient(180deg,#0e1433,#0e173d);border-left:1px solid #2b3a77;box-shadow:-20px 0 60px #0008;transform:translateX(100%);transition:.25s;z-index:20;overflow:auto}
  .drawer.open{transform:none}
  .drawer .hd{position:sticky;top:0;background:#101a45;border-bottom:1px solid #2b3a77;padding:12px}
  .drawer .bd{padding:12px}
  .kv{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center}
  .kv label{font-size:13px;color:#aeb8da}
  .kv input,.kv select,.kv textarea{width:100%}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .status{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2a3a75;background:#0f1a44}
  .status.plan{background:#21305f}
  .status.conf{background:#24336b}
  .status.done{background:#1d3d2f}
  .status.canc{background:#4a1d1d}

  /* Loader overlay */
  .loader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#0006;z-index:50}
  .loader.show{display:flex}
  .spin{width:42px;height:42px;border:4px solid #2b3a77;border-top-color:#7aa2ff;border-radius:50%;animation:rot .9s linear infinite}
  @keyframes rot{to{transform:rotate(360deg)}}

  @media print{
    nav,.btn,.drawer,.statusbar{display:none!important}
    .wrap{max-width:none}
    .calendar .cell{min-height:120px}
  }
</style>
</head>
<body>

<header>
  <h1>Kalendarz Monta≈ºy ‚Ä¢ ARKON</h1>
  <div class="small">Planowanie ekip i termin√≥w. Dane: <code>API (Netlify ‚Üí Neon)</code> + cache offline. Eksport JSON/ICS, druk.</div>
</header>

<!-- Pasek statusu: online/offline + API + Sync -->
<div class="statusbar">
  <span id="netChip" class="chip"><span class="i offline" id="netDot"></span><span id="netTxt">Offline</span></span>
  <span id="apiChip" class="chip"><span class="i apibad" id="apiDot"></span><span id="apiTxt">API: brak po≈ÇƒÖczenia</span></span>
  <button id="btnSync" class="btn ghost" type="button" title="Pobierz aktualne dane z API">Synchronizuj teraz</button>
  <span class="small">Gdy API padnie, pracujesz na cache. Po powrocie online zsynchronizuj.</span>
</div>

<!-- Baner b≈Çƒôd√≥w -->
<div id="err" class="err" role="alert" hidden></div>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="klienci.html">Klienci</a>
  <a href="lidy.html">Lidy</a>
  <a href="komponenty.html">Komponenty</a>
  <a href="upload.html">Przesy≈Ç plik√≥w</a>
  <a href="chat.html">Komunikator</a>
  <a href="kalendarz-montaze.html" style="background:#223160">Kalendarz</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWY: kalendarz + lista -->
  <section class="grid">
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <button id="prev" class="btn">‚Üê</button>
          <button id="today" class="btn ghost">Dzi≈õ</button>
          <button id="next" class="btn">‚Üí</button>
          <input id="jump" type="month" title="Skocz do miesiƒÖca">
        </div>
        <div class="row">
          <select id="fInstaller"><option value="">Monter (wszyscy)</option></select>
          <select id="fStatus">
            <option value="">Status (wszystkie)</option>
            <option value="PLAN">PLAN</option>
            <option value="POTWIERDZONY">POTWIERDZONY</option>
            <option value="ZAKO≈ÉCZONY">ZAKO≈ÉCZONY</option>
            <option value="ANULOWANY">ANULOWANY</option>
          </select>
          <input id="q" placeholder="üîé Szukaj: klient/adres/uwagi">
          <button id="btnClear" class="btn ghost">Wyczy≈õƒá</button>
          <button id="btnNew" class="btn ok">+ Nowy monta≈º</button>
        </div>
      </div>

      <div id="cal" class="calendar" style="margin-top:10px">
        <div class="cal-head" id="calHead"></div>
        <div class="cal-grid" id="calGrid" aria-live="polite"></div>
      </div>
      <div class="small" style="margin-top:6px">Kliknij podw√≥jnie w dzie≈Ñ, aby dodaƒá. Kliknij w kafelek, aby edytowaƒá.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <b>Lista monta≈ºy (tabela)</b>
        <div class="right">
          <button id="btnExport" class="btn">Eksport JSON</button>
          <label class="btn ghost">Import JSON<input id="importJSON" type="file" accept="application/json" hidden></label>
          <button id="btnPrint" class="btn ghost">Drukuj / PDF</button>
        </div>
      </div>
      <div style="overflow:auto;margin-top:6px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Data</th><th>Godz.</th><th>Klient</th><th>Adres</th><th>Zakres</th><th>Monterzy</th><th>Status</th><th>Akcje</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRAWY: legendy, ob≈Ço≈ºenie, szybkie dodawanie -->
  <aside class="grid">
    <div class="card">
      <b>Monterzy ‚Ä¢ legenda</b>
      <div id="legend" class="legend" style="margin-top:8px"></div>
      <div class="row" style="margin-top:10px">
        <input id="newInstName" placeholder="Imiƒô i nazwisko">
        <input id="newInstColor" type="color" value="#7dd3fc" title="Kolor">
        <button id="btnAddInstaller" class="btn ok">+ Monter</button>
      </div>
    </div>

    <div class="card">
      <b>Ob≈Ço≈ºenie w miesiƒÖcu</b>
      <div id="load" class="small" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <b>Szybkie dodawanie</b>
      <div class="small">Wype≈Çnij i kliknij ‚ÄûDodaj‚Äù. Potem edytuj w panelu.</div>
      <div class="grid" style="margin-top:8px">
        <input id="qDate" type="date">
        <div class="row"><input id="qTime" type="time" style="flex:1"><input id="qDur" type="number" min="1" value="4" title="Czas [h]" style="width:100px"><span class="pill">Czas [h]</span></div>
        <input id="qClient" placeholder="Klient (nazwa)">
        <input id="qAddr" placeholder="Adres">
        <input id="qScope" placeholder="Zakres (np. PC 12 kW + bufor)">
        <select id="qStatus">
          <option>PLAN</option><option>POTWIERDZONY</option><option>ZAKO≈ÉCZONY</option><option>ANULOWANY</option>
        </select>
        <div>
          <label class="small">Monterzy (Ctrl/‚åò, aby wybraƒá kilku)</label>
          <select id="qInst" multiple size="4" style="width:100%"></select>
        </div>
        <textarea id="qNotes" placeholder="Uwagi (opcjonalnie)"></textarea>
        <button id="btnQuickAdd" class="btn ok">+ Dodaj monta≈º</button>
      </div>
    </div>
  </aside>
</div>

<!-- Drawer (edycja szczeg√≥≈Çowa) -->
<aside id="drawer" class="drawer" aria-label="Edycja monta≈ºu">
  <div class="hd row" style="justify-content:space-between">
    <b>Edycja monta≈ºu</b>
    <div class="right">
      <button id="btnIcs" class="btn ghost" type="button">Eksport ICS</button>
      <button id="btnDup" class="btn ghost" type="button">Duplikuj</button>
      <button id="btnDel" class="btn bad" type="button">Usu≈Ñ</button>
      <button id="btnClose" class="btn ghost" type="button">Zamknij</button>
    </div>
  </div>
  <div class="bd">
    <div class="kv">
      <label>Data</label><input id="e_date" type="date">
      <label>Godzina</label><input id="e_time" type="time">
      <label>Czas [h]</label><input id="e_dur" type="number" min="1">
      <label>Klient</label><input id="e_client">
      <label>Adres</label><input id="e_addr">
      <label>Zakres</label><input id="e_scope">
      <label>Status</label>
      <select id="e_status">
        <option>PLAN</option><option>POTWIERDZONY</option><option>ZAKO≈ÉCZONY</option><option>ANULOWANY</option>
      </select>
      <label>Monterzy</label>
      <div id="e_instBox" class="chips"></div>
      <label>Uwagi</label><textarea id="e_notes"></textarea>
      <label>PowiƒÖzany klient (z modu≈Çu Klienci)</label>
      <select id="e_clientId"><option value="">‚Äî niepowiƒÖzany ‚Äî</option></select>
    </div>
  </div>
</aside>

<!-- Loader -->
<div id="loader" class="loader"><div class="spin" role="progressbar" aria-label="≈Åadowanie"></div></div>

<script>
'use strict';

/* ====== Konfiguracja API / cache ====== */
const API = '/.netlify/functions/montaze';
const CACHE_KEY = 'arkon_montaze_cache_v2';
const CLIENTS_LS = 'arkon_clients_v1';       // z modu≈Çu Klienci
const INSTALLERS_LS = 'arkon_installers_v1'; // monterzy w localStorage

/* ====== Helpers ====== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const pad2 = n => String(n).padStart(2,'0');
const toLocalDateStr = d => d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
const fmtDate = ts => new Date(ts||Date.now()).toLocaleDateString('pl-PL');
function escapeHtml(s){return (s==null?'':String(s)).replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));}
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

/* ====== Stan ====== */
let events = [];                   // z API
let installers = [];               // z localStorage (legenda/wybory)
let view = {year: new Date().getFullYear(), month: new Date().getMonth()};
let filter = {q:'', installer:'', status:''};
let openId = null;

/* ====== UI refs ====== */
const calHead = $('#calHead');
const calGrid = $('#calGrid');
const drawer  = $('#drawer');
const loader  = $('#loader');
const netDot  = $('#netDot'), netTxt = $('#netTxt');
const apiDot  = $('#apiDot'), apiTxt = $('#apiTxt');
const btnSync = $('#btnSync');
const errBox  = $('#err');

/* ====== Status online/offline ====== */
function updateNetStatus(){
  const on = navigator.onLine;
  netDot.className = 'i ' + (on ? 'online' : 'offline');
  netTxt.textContent = on ? 'Online' : 'Offline';
}
window.addEventListener('online', () => { updateNetStatus(); loadEventsFromApi(true); });
window.addEventListener('offline', updateNetStatus);
updateNetStatus();

/* ====== Monterzy (localStorage) ====== */
function loadLS(key, fb){ try { return JSON.parse(localStorage.getItem(key)||JSON.stringify(fb)); } catch { return fb; } }
function saveInstallers(){
  localStorage.setItem(INSTALLERS_LS, JSON.stringify(installers));
  fillInstallerFilters(); renderLegend(); renderQuickInstallerSelect(); render(); renderLoad();
}
(function seedInstallers(){
  installers = loadLS(INSTALLERS_LS, []);
  if(!installers.length){
    installers = [
      {id:uid(), name:'Emil Trynda',   color:'#60a5fa'},
      {id:uid(), name:'Adrian Witka',  color:'#34d399'},
      {id:uid(), name:'Szefowa Gwiazda', color:'#fbbf24'},
    ];
    saveInstallers();
  } else {
    fillInstallerFilters(); renderLegend(); renderQuickInstallerSelect();
  }
})();

/* ====== Loader / status API / errors ====== */
async function withLoader(fn){ loader.classList.add('show'); try{ return await fn(); } finally{ loader.classList.remove('show'); } }
function setApiStatus(ok, msgOk='API: OK', msgBad='API: b≈ÇƒÖd'){
  apiDot.className = 'i ' + (ok ? 'apiok' : 'apibad');
  apiTxt.textContent = ok ? msgOk : msgBad;
}
function showError(msg, timeoutMs = 6000){
  if(!errBox) return;
  errBox.textContent = typeof msg === 'string' ? msg : 'WystƒÖpi≈Ç b≈ÇƒÖd.';
  errBox.hidden = false;
  if(timeoutMs){
    clearTimeout(showError._t);
    showError._t = setTimeout(() => { errBox.hidden = true; }, timeoutMs);
  }
}
function hideError(){
  if(!errBox) return;
  errBox.hidden = true;
}

/* ====== API: GET/UPSERT/DELETE ====== */
async function loadEventsFromApi(force = false){
  return withLoader(async ()=>{
    try{
      const r = await fetch(API, { cache: force ? 'reload' : 'no-store' });
      if(!r.ok) throw new Error(await r.text());
      events = await r.json();
      localStorage.setItem(CACHE_KEY, JSON.stringify(events));
      setApiStatus(true);
      hideError();
      console.log('‚úÖ Za≈Çadowano z API', events);
    }catch(err){
      console.warn('‚ö† API niedostƒôpne, u≈ºywam cache', err);
      events = loadLS(CACHE_KEY, []);
      setApiStatus(false, 'API: cache (offline)');
      showError('API niedostƒôpne ‚Äî pracujesz na pamiƒôci przeglƒÖdarki (cache).');
    }
    render();
  });
}
async function upsertEvent(ev){
  return withLoader(async ()=>{
    try{
      const r = await fetch(API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(ev)
      });
      if(!r.ok) throw new Error(await r.text());
      const saved = await r.json();
      const i = events.findIndex(x=>x.id===saved.id);
      if(i>=0) events[i]=saved; else events.push(saved);
      localStorage.setItem(CACHE_KEY, JSON.stringify(events));
      setApiStatus(true);
      hideError();
      render();
      return saved;
    }catch(err){
      console.error('‚ùå upsertEvent', err);
      setApiStatus(false, 'API: b≈ÇƒÖd zapisu');
      showError('Nie uda≈Ço siƒô zapisaƒá wydarzenia (API). Sprawd≈∫ po≈ÇƒÖczenie i spr√≥buj ponownie.');
    }
  });
}
async function removeEvent(id){
  return withLoader(async ()=>{
    try{
      const r = await fetch(API, {
        method:'DELETE',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({id})
      });
      if(!r.ok) throw new Error(await r.text());
      events = events.filter(x=>x.id!==id);
      localStorage.setItem(CACHE_KEY, JSON.stringify(events));
      setApiStatus(true);
      hideError();
      render();
    }catch(err){
      console.error('‚ùå removeEvent', err);
      setApiStatus(false, 'API: b≈ÇƒÖd usuwania');
      showError('Nie uda≈Ço siƒô usunƒÖƒá wydarzenia (API).');
    }
  });
}

/* ====== Toolbar ====== */
$('#prev').onclick = ()=> shiftMonth(-1);
$('#next').onclick = ()=> shiftMonth(+1);
$('#today').onclick = ()=> { const d=new Date(); view.year=d.getFullYear(); view.month=d.getMonth(); render(); };
$('#jump').onchange = e=>{ const [y,m]=e.target.value.split('-').map(Number); if(y){ view.year=y; view.month=(m||1)-1; render(); } };

$('#q').oninput = e=>{ filter.q=(e.target.value||'').trim().toLowerCase(); renderList(); renderCalendar(); };
$('#fInstaller').onchange = e=>{ filter.installer=e.target.value||''; renderList(); renderCalendar(); };
$('#fStatus').onchange    = e=>{ filter.status=e.target.value||''; renderList(); renderCalendar(); };
$('#btnClear').onclick    = ()=>{ filter={q:'',installer:'',status:''}; $('#q').value=''; $('#fInstaller').value=''; $('#fStatus').value=''; render(); };
$('#btnNew').onclick      = ()=> openEditorForNew();
btnSync?.addEventListener('click', () => loadEventsFromApi(true));

/* ====== Quick add ====== */
$('#btnAddInstaller').onclick = ()=>{
  const name=$('#newInstName').value.trim();
  const color=$('#newInstColor').value||'#7dd3fc';
  if(!name) return alert('Podaj imiƒô/nazwisko.');
  installers.push({id:uid(), name, color}); saveInstallers();
  $('#newInstName').value='';
};
$('#btnQuickAdd').onclick = async ()=>{
  const date=$('#qDate').value||toLocalDateStr(new Date());
  const time=$('#qTime').value||'08:00';
  const dur =Math.max(1, Number($('#qDur').value)||4);
  const client=$('#qClient').value.trim()||'Klient';
  const addr=$('#qAddr').value.trim();
  const scope=$('#qScope').value.trim();
  const status=$('#qStatus').value||'PLAN';
  const inst=Array.from($('#qInst').selectedOptions).map(o=>o.value);
  const notes=$('#qNotes').value.trim();
  const ev = {id:uid(), date,time,dur,client,addr,scope,status,installers:inst,notes};
  await upsertEvent(ev);
  const dt = new Date(date+'T00:00:00'); view.year=dt.getFullYear(); view.month=dt.getMonth(); render();
  ['#qClient','#qAddr','#qScope','#qNotes'].forEach(s=>$(s).value='');
};

/* ====== Drawer actions ====== */
$('#btnClose').onclick = ()=> closeDrawer();
$('#btnDel').onclick = async ()=>{
  if(!openId) return;
  if(confirm('UsunƒÖƒá monta≈º?')){
    await removeEvent(openId);
    closeDrawer();
  }
};
$('#btnDup').onclick = async ()=>{
  if(!openId) return;
  const src = events.find(x=>x.id===openId);
  if(!src) return;
  const cp = {...src, id:uid()};
  await upsertEvent(cp);
  alert('Zduplikowano.');
};
$('#btnIcs').onclick = ()=>{
  if(!openId) return;
  const ev = events.find(x=>x.id===openId);
  if(ev) exportICS(ev);
};

/* ====== Eksport/Import/Druk ====== */
$('#btnExport').onclick = ()=> exportJSON();
$('#importJSON').onchange = async (e)=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const dump=JSON.parse(await f.text());
    if(!Array.isArray(dump)) throw new Error('Format nieobs≈Çugiwany');
    for(const ev of dump){ if(!ev.id) ev.id=uid(); await upsertEvent(ev); }
    alert('Zaimportowano.');
  }catch(err){
    showError('B≈Çƒôdny plik JSON (import nieudany).');
  }
  e.target.value='';
};
$('#btnPrint').onclick = ()=> window.print();

/* ====== Klawiatura ====== */
window.addEventListener('keydown',(e)=>{
  if(e.key==='ArrowLeft' && (e.altKey||e.metaKey)) shiftMonth(-1);
  if(e.key==='ArrowRight'&& (e.altKey||e.metaKey)) shiftMonth(+1);
  if(e.key==='n' && e.altKey){ e.preventDefault(); openEditorForNew(); }
});

/* ====== Render ====== */
function render(){
  const days=['Pon','Wt','≈ör','Czw','Pt','Sob','Ndz'];
  calHead.innerHTML = days.map(d => <div>${d}</div>).join('');
  $('#jump').value = ${view.year}-${pad2(view.month+1)};
  renderCalendar();
  renderList();
  renderLegend();
  renderLoad();
  fillClientSelect();
  renderQuickInstallerSelect();
}
function renderCalendar(){
  const first = new Date(view.year, view.month, 1);
  const start = new Date(first);
  const wd = (first.getDay()+6) % 7; // 0 = Pon
  start.setDate(first.getDate() - wd);

  const todayStr = toLocalDateStr(new Date());
  let html = '';
  for(let i=0;i<42;i++){
    const d = new Date(start.getFullYear(), start.getMonth(), start.getDate()+i);
    const ds = toLocalDateStr(d);
    html += `
      <div class="cell" data-date="${ds}" aria-label="${fmtDate(d)}" tabindex="0">
        <div class="d">${d.getDate()} ${ds===todayStr?'<span class="today">dzi≈õ</span>':''}</div>
        <div class="list"></div>
      </div>`;
  }
  calGrid.innerHTML = html;

  const filtered = filterEvents(events);
  for(const ev of filtered){
    const listEl = calGrid.querySelector(.cell[data-date="${ev.date}"] .list);
    if(!listEl) continue;
    const clr = colorFor(ev);
    const label = escapeHtml(shortEventText(ev));
    const a = document.createElement('a');
    a.href = '#'; a.className='ev';
    a.innerHTML = <span class="bar" style="background:${clr}"></span>${label};
    a.title = ${ev.time||''} ‚Ä¢ ${ev.client||''} ‚Ä¢ ${ev.scope||''};
    a.addEventListener('click', e=>{ e.preventDefault(); openDrawer(ev.id); });
    listEl.appendChild(a);
  }

  $$('.cell').forEach(c=>{
    c.addEventListener('dblclick', ()=> openEditorForNew(c.dataset.date));
  });
}
function renderList(){
  const tb = $('#tbody'); tb.innerHTML='';
  const rows = filterEvents(events).slice().sort((a,b)=>{
    const da = (a.date||'') + (a.time||'00:00');
    const db = (b.date||'') + (b.time||'00:00');
    return da.localeCompare(db);
  });
  if(!rows.length){
    tb.innerHTML = '<tr><td colspan="8" class="small">Brak pozycji dla aktualnych filtr√≥w.</td></tr>';
    return;
  }
  for(const ev of rows){
    const instHtml = (ev.installers||[]).map(id=>{
      const ins=installers.find(x=>x.id===id); if(!ins) return '';
      return <span class="dot"><span class="c" style="background:${ins.color}"></span>${escapeHtml(ins.name)}</span>;
    }).join(' ');
    const stCl = statusClass(ev.status);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${ev.date||''}</td>
      <td>${ev.time||''} ${ev.dur?(${ev.dur}h):''}</td>
      <td>${escapeHtml(ev.client||'')}</td>
      <td>${escapeHtml(ev.addr||'')}</td>
      <td>${escapeHtml(ev.scope||'')}</td>
      <td>${instHtml}</td>
      <td><span class="status ${stCl}">${escapeHtml(ev.status||'PLAN')}</span></td>
      <td class="row"><button class="btn ghost ed">Edytuj</button></td>
    `;
    tr.querySelector('.ed').onclick = ()=> openDrawer(ev.id);
    tb.appendChild(tr);
  }
}
function renderLegend(){
  const box = $('#legend'); box.innerHTML='';
  for(const i of installers){
    const div = document.createElement('span');
    div.className='dot';
    div.innerHTML = <span class="c" style="background:${i.color}"></span>${escapeHtml(i.name)};
    box.appendChild(div);
  }
}
function renderLoad(){
  const ym = ${view.year}-${pad2(view.month+1)};
  const counts = {}; installers.forEach(i=>counts[i.id]=0);
  events.forEach(ev=>{
    if((ev.date||'').startsWith(ym)){ (ev.installers||[]).forEach(id=>{ if(counts[id]!=null) counts[id]++; }); }
  });
  const html = installers.map(i=>{
    return `<div class="row" style="justify-content:space-between;border-bottom:1px dashed #28356c;padding:4px 0">
      <span class="dot"><span class="c" style="background:${i.color}"></span>${escapeHtml(i.name)}</span>
      <b>${counts[i.id]||0}</b>
    </div>`;
  }).join('');
  $('#load').innerHTML = html || '<div class="small">Brak monter√≥w.</div>';
}
function renderQuickInstallerSelect(){
  const sel = $('#qInst'); sel.innerHTML='';
  for(const i of installers){
    const opt=document.createElement('option');
    opt.value=i.id; opt.textContent=i.name;
    sel.appendChild(opt);
  }
}

/* ====== Filtrowanie / kolory ====== */
function filterEvents(arr){
  return arr.filter(ev=>{
    if(filter.q){
      const hay = [ev.client, ev.addr, ev.scope, ev.notes].join(' ').toLowerCase();
      if(!hay.includes(filter.q)) return false;
    }
    if(filter.status && (ev.status||'')!==filter.status) return false;
    if(filter.installer && !(ev.installers||[]).includes(filter.installer)) return false;
    return true;
  });
}
function colorFor(ev){
  const id=(ev.installers||[])[0];
  const ins = installers.find(x=>x.id===id);
  return ins ? ins.color : '#67a1ff';
}
function statusClass(s){
  switch((s||'').toUpperCase()){
    case 'PLAN': return 'plan';
    case 'POTWIERDZONY': return 'conf';
    case 'ZAKO≈ÉCZONY': return 'done';
    case 'ANULOWANY': return 'canc';
    default: return '';
  }
}
function shortEventText(ev){
  const insCount = (ev.installers||[]).length;
  const who = insCount ? ` ‚Ä¢ ${insCount} os.` : '';
  const time = ev.time? ev.time+' ' : '';
  return ${time}${ev.client||''}${who};
}

/* ====== Nawigacja miesiƒÖca ====== */
function shiftMonth(delta){
  let y=view.year, m=view.month+delta;
  if(m<0){ m=11; y--; }
  if(m>11){ m=0; y++; }
  view.year=y; view.month=m; render();
}

/* ====== Drawer (edycja) ====== */
function openDrawer(id){
  openId=id; drawer.classList.add('open');
  const ev = events.find(x=>x.id===id);
  if(!ev) return;
  $('#e_date').value = ev.date||'';
  $('#e_time').value = ev.time||'';
  $('#e_dur').value  = ev.dur||4;
  $('#e_client').value=ev.client||'';
  $('#e_addr').value = ev.addr||'';
  $('#e_scope').value= ev.scope||'';
  $('#e_status').value= ev.status||'PLAN';
  $('#e_notes').value = ev.notes||'';
  drawInstallerChips(ev.installers||[]);
  fillClientSelect(ev.clientId||'');
}
function drawInstallerChips(list){
  const box=$('#e_instBox'); box.innerHTML='';
  const set=new Set(list||[]);
  (list||[]).forEach(id=>{
    const ins = installers.find(x=>x.id===id); if(!ins) return;
    const chip=document.createElement('span');
    chip.className='dot';
    chip.innerHTML = <span class="c" style="background:${ins.color}"></span>${escapeHtml(ins.name)} <a href="#" data-id="${ins.id}" title="Usu≈Ñ" style="color:#ffb4b4;margin-left:6px">√ó</a>;
    chip.querySelector('a').onclick = async (e)=>{
      e.preventDefault(); set.delete(ins.id);
      await saveFromEditor({installers:[...set]});
      drawInstallerChips([...set]);
    };
    box.appendChild(chip);
  });
  const sel=document.createElement('select');
  sel.innerHTML = '<option value="">+ Dodaj montera‚Ä¶</option>' + installers.map(i=><option value="${i.id}">${escapeHtml(i.name)}</option>).join('');
  sel.onchange = async ()=>{
    if(sel.value){ set.add(sel.value); await saveFromEditor({installers:[...set]}); sel.value=''; drawInstallerChips([...set]); }
  };
  box.appendChild(sel);
}
function closeDrawer(){ drawer.classList.remove('open'); openId=null; }

/* ====== Autosave z edytora ====== */
['#e_date','#e_time','#e_dur','#e_client','#e_addr','#e_scope','#e_status','#e_notes','#e_clientId'].forEach(sel=>{
  const el=$(sel);
  const evType = el.tagName==='SELECT' ? 'change' : 'input';
  el.addEventListener(evType, async ()=>{
    const patch={};
    if(sel==='#e_date') patch.date=el.value;
    if(sel==='#e_time') patch.time=el.value;
    if(sel==='#e_dur') patch.dur=Math.max(1,Number(el.value)||4);
    if(sel==='#e_client') patch.client=el.value;
    if(sel==='#e_addr') patch.addr=el.value;
    if(sel==='#e_scope') patch.scope=el.value;
    if(sel==='#e_status') patch.status=el.value;
    if(sel==='#e_notes') patch.notes=el.value;
    if(sel==='#e_clientId') patch.clientId=el.value||'';
    await saveFromEditor(patch);
  });
});
async function saveFromEditor(patch){
  if(!openId) return;
  const i = events.findIndex(x=>x.id===openId); if(i<0) return;
  const merged = {...events[i], ...patch};
  const saved  = await upsertEvent(merged);
  if(saved && openId===saved.id) drawInstallerChips(saved.installers||[]);
}

/* ====== Klienci / Monterzy w UI ====== */
function fillInstallerFilters(){
  const sel=$('#fInstaller'); const v=sel.value;
  sel.innerHTML='<option value="">Monter (wszyscy)</option>'+installers.map(i=><option value="${i.id}">${escapeHtml(i.name)}</option>).join('');
  sel.value=v||'';
}
function fillClientSelect(selected){
  const sel=$('#e_clientId'); const v=selected||sel.value;
  const data = loadLS(CLIENTS_LS, []);
  sel.innerHTML='<option value="">‚Äî niepowiƒÖzany ‚Äî</option>'+data.map(c=><option value="${c.id}">${escapeHtml(c.name||'Klient')}</option>).join('');
  sel.value=v||'';
}

/* ====== Eksporty ====== */
function exportJSON(){
  const blob = new Blob([JSON.stringify(events,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'arkon_montaze.json';
  a.click(); URL.revokeObjectURL(a.href);
}
function exportICS(ev){
  const start = new Date(ev.date+'T'+(ev.time||'00:00')+':00');
  const end = new Date(start); end.setHours(end.getHours()+Math.max(1, +ev.dur||1));
  const dtStart = ev.date.replace(/-/g,'') + 'T' + (ev.time? ev.time.replace(':','')+'00' : '000000');
  const dtEnd   = toLocalDateStr(end).replace(/-/g,'') + 'T' + pad2(end.getHours()) + pad2(end.getMinutes()) + '00';
  const uidStr = ev.id+'@arkon';
  const sum = (ev.client||'Monta≈º')+' ‚Äî '+(ev.scope||'');
  const montery = (ev.installers||[])
      .map(id=>installers.find(x=>x.id===id)?.name||'')
      .filter(Boolean).join(', ');
  const desc = Adres: ${ev.addr||''}\\nMonterzy: ${montery}\\nStatus: ${ev.status||''}\\nUwagi: ${ev.notes||''};
  const ics = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//ARKON//Kalendarz Monta≈ºy//PL
BEGIN:VEVENT
UID:${uidStr}
DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').replace(/\.\d+Z/,'Z')}
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${sum}
DESCRIPTION:${desc}
LOCATION:${ev.addr||''}
END:VEVENT
END:VCALENDAR`;
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([ics],{type:'text/calendar'}));
  a.download = montaz_${(ev.client||'klient').replace(/\s+/g,'_')}.ics;
  a.click(); URL.revokeObjectURL(a.href);
}

/* ====== Shortcuts i New ====== */
function renderQuickInstallerSelect(){
  const sel = $('#qInst'); sel.innerHTML='';
  for(const i of installers){
    const opt=document.createElement('option');
    opt.value=i.id; opt.textContent=i.name;
    sel.appendChild(opt);
  }
}
function initShortcuts(){
  calGrid.addEventListener('keydown',(e)=>{
    if(e.key==='Enter' && e.target.classList.contains('cell')){
      openEditorForNew(e.target.dataset.date);
    }
  });
}
function openEditorForNew(dateStr){
  const d = dateStr || toLocalDateStr(new Date(view.year,view.month,1));
  const tmp = {id:uid(), date:d, time:'08:00', dur:4, client:'Nowy klient', addr:'', scope:'', installers:[], status:'PLAN', notes:''};
  upsertEvent(tmp).then(()=> openDrawer(tmp.id));
}

/* ====== Start ====== */
initShortcuts();
loadEventsFromApi();
</script>
</body>
</html>
