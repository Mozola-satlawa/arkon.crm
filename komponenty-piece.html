<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON â€” Katalog piecÃ³w i kotÅ‚Ã³w</title>
<meta name="description" content="Katalog komponentÃ³w: kotÅ‚y gazowe, piece na pellet, drewno, ogrzewanie elektryczne, podÅ‚Ä…czenie do sieci. Edycja, warianty, import/eksport, wspÃ³lny storage z komponenty.html.">
<style>
  :root{ --bg:#0b1020; --p1:#121a34; --p2:#172142; --ink:#e8edff; --muted:#aeb8da; --accent:#4cc9f0; --ok:#2b8a57; --warn:#ffb84d; --bad:#ff6b6b; --grid:#243059; --line:#1c2750; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}

  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:10px 0}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:var(--ok)}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .muted{color:var(--muted);font-size:13px}
  input,select{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
  table{width:100%;border-collapse:separate;border-spacing:0}
  th,td{padding:8px 10px;border-bottom:1px solid #203063;text-align:left;vertical-align:middle}
  th{font-size:12px;color:#aeb8da}
  td.edit{background:#0d1530;border:1px solid #28356c;border-radius:6px}
  td .cell{min-width:60px}
  .num{text-align:right;font-variant-numeric:tabular-nums}
  .status{padding:2px 8px;border-radius:999px;border:1px solid #2a3a75;background:#0f1a44;font-size:12px}
  .status.ok{background:#1d3d2f}
  .status.na{background:#4a1d1d}
  .status.o{background:#24336b}

  .aside{position:sticky;top:10px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:2fr 1fr} }

  .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;z-index:50}
  .modal.open{display:flex}
  .box{width:900px;max-width:95vw;background:linear-gradient(180deg,#10173c,#111b48);border:1px solid #2b3a77;border-radius:12px;padding:14px}
  .box h3{margin:0 0 10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
  .small{font-size:12px;color:#aeb8da}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
</style>
</head>
<body>

<header>
  <h1>Katalog komponentÃ³w â€¢ Piece i kotÅ‚y</h1>
  <div class="muted">WspÃ³Å‚dzielony storage z <b>komponenty.html</b> (klucz: <code>arkon_components_v1</code>).</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="kalkulator.html">Kalkulator</a>
  <a href="komponenty.html">Komponenty</a>
  <a href="komponenty-piece.html">Katalog piecÃ³w</a>
  <a href="komponenty-pompy.html">Katalog pomp</a>
  <a href="upload.html">PrzesyÅ‚ plikÃ³w</a>
  <a href="klienci.html">Klienci</a>
  <a href="lidy.html">Lidy</a>
  <a href="ustawienia.html">Ustawienia</a>
  <a href="baza.html">Baza (JSON)</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWA: LISTA -->
  <section class="card">
    <div class="toolbar">
      <button id="btnAdd" class="btn ok">+ Dodaj pozycjÄ™</button>
      <button id="btnVariants" class="btn">âž• Warianty serii</button>
      <button id="btnMargin" class="btn">ðŸ’¹ MarÅ¼a/Narzut</button>
      <button id="btnVat" class="btn">ðŸ§¾ VAT â†’ NETTO/BRUTTO</button>
      <button id="btnCSV" class="btn ghost">CSV</button>
      <button id="btnExport" class="btn ghost">Eksport JSON</button>
      <label class="btn ghost">Import JSON<input id="fileImport" type="file" accept="application/json" hidden></label>
      <span class="pill">Pozycji: <b id="countAll">0</b></span>
      <span class="pill">Widocznych: <b id="countVis">0</b></span>
    </div>

    <!-- FILTRY -->
    <div class="card" style="margin:8px 0">
      <div class="row">
        <input id="q" placeholder="ðŸ”Ž nazwa / marka / model / opisâ€¦" style="min-width:240px">
        <select id="fFuel">
          <option value="">Paliwo (wszystkie)</option>
          <option>gaz</option>
          <option>pellet</option>
          <option>drewno</option>
          <option>energia elektryczna</option>
          <option>sieÄ‡ ciepÅ‚ownicza</option>
        </select>
        <select id="fType">
          <option value="">Typ (wszystkie)</option>
          <option>KocioÅ‚ gazowy</option>
          <option>KocioÅ‚ na pellet</option>
          <option>KocioÅ‚ zgazowujÄ…cy drewno</option>
          <option>Ogrzewanie elektryczne</option>
          <option>PodÅ‚Ä…czenie do sieci</option>
          <option>Inne</option>
        </select>
        <select id="fBrand"><option value="">Marka (wszystkie)</option></select>
        <select id="fStatus">
          <option value="">DostÄ™pnoÅ›Ä‡</option>
          <option value="OK">DostÄ™pny</option>
          <option value="OUT">Brak</option>
          <option value="ORDER">Na zamÃ³wienie</option>
        </select>
        <input id="fKwMin" type="number" placeholder="kW â‰¥" style="width:120px">
        <input id="fKwMax" type="number" placeholder="kW â‰¤" style="width:120px">
        <input id="fPriceMin" type="number" placeholder="Cena â‰¥" style="width:120px">
        <input id="fPriceMax" type="number" placeholder="Cena â‰¤" style="width:120px">
        <select id="sort">
          <option value="name.asc">Sort: Nazwa â†‘</option>
          <option value="name.desc">Sort: Nazwa â†“</option>
          <option value="price.asc">Cena â†‘</option>
          <option value="price.desc">Cena â†“</option>
          <option value="kw.asc">Moc kW â†‘</option>
          <option value="kw.desc">Moc kW â†“</option>
          <option value="eff.desc">SprawnoÅ›Ä‡/COP â†‘</option>
          <option value="eff.asc">SprawnoÅ›Ä‡/COP â†“</option>
          <option value="created.desc">Najnowsze</option>
          <option value="created.asc">Najstarsze</option>
        </select>
        <button id="btnClear" class="btn ghost">WyczyÅ›Ä‡</button>
      </div>
    </div>

    <div style="overflow:auto">
      <table id="tbl">
        <thead>
          <tr>
            <th>Akcje</th>
            <th>Nazwa / Model</th>
            <th>Typ</th>
            <th>Marka</th>
            <th>Paliwo</th>
            <th>Komora</th>
            <th>Spalin</th>
            <th class="num">Moc [kW]</th>
            <th class="num">SprawnoÅ›Ä‡/COP</th>
            <th class="num">Cena NETTO</th>
            <th class="num">VAT %</th>
            <th class="num">Cena BRUTTO</th>
            <th>Klasa/Norma</th>
            <th>Status</th>
            <th>Tagi</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <!-- PRAWA: PANEL SZCZEGÃ“ÅÃ“W / MARKI -->
  <aside class="card aside">
    <h3 style="margin:0 0 8px">Panel pomocniczy</h3>
    <div class="muted">ZarzÄ…dzanie markami i szybkie podpowiedzi.</div>

    <div class="card">
      <h4 style="margin:0 0 6px">Marki</h4>
      <div class="row">
        <input id="brandNew" placeholder="np. Viessmann">
        <button id="btnBrandAdd" class="btn ok">+ Dodaj</button>
      </div>
      <div id="brandList" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h4 style="margin:0 0 6px">Szybkie podpowiedzi</h4>
      <div class="small">Typy: <span class="tag">KocioÅ‚ gazowy</span> <span class="tag">KocioÅ‚ na pellet</span> <span class="tag">KocioÅ‚ zgazowujÄ…cy drewno</span> <span class="tag">Ogrzewanie elektryczne</span> <span class="tag">PodÅ‚Ä…czenie do sieci</span></div>
      <div class="small" style="margin-top:6px">Paliwo: <span class="tag">gaz</span> <span class="tag">pellet</span> <span class="tag">drewno</span> <span class="tag">energia elektryczna</span> <span class="tag">sieÄ‡ ciepÅ‚ownicza</span></div>
      <div class="small" style="margin-top:6px">Komora: <span class="tag">zamkniÄ™ta</span> <span class="tag">otwarta</span> â€” Spalin: <span class="tag">turbo</span> <span class="tag">kondensacyjny</span> <span class="tag">grawitacyjny</span></div>
    </div>
  </aside>
</div>

<!-- MODAL: WARIANTY SERII -->
<div id="modalVar" class="modal" aria-modal="true" role="dialog" aria-labelledby="varTitle">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h3 id="varTitle" style="margin:0">Generator wariantÃ³w serii</h3>
      <button id="btnVarClose" class="btn ghost">Zamknij</button>
    </div>
    <div class="grid-3">
      <div><label>Nazwa serii</label><input id="v_name" placeholder="np. Vitodens 100-W"></div>
      <div><label>Marka</label><input id="v_brand" placeholder="np. Viessmann"></div>
      <div><label>Typ</label><select id="v_type"><option>KocioÅ‚ gazowy</option><option>KocioÅ‚ na pellet</option><option>KocioÅ‚ zgazowujÄ…cy drewno</option><option>Ogrzewanie elektryczne</option><option>PodÅ‚Ä…czenie do sieci</option><option>Inne</option></select></div>
      <div><label>Paliwo</label><select id="v_fuel"><option>gaz</option><option>pellet</option><option>drewno</option><option>energia elektryczna</option><option>sieÄ‡ ciepÅ‚ownicza</option></select></div>
      <div><label>Komora</label><select id="v_chamber"><option>zamkniÄ™ta</option><option>otwarta</option></select></div>
      <div><label>Spalin</label><select id="v_flue"><option>kondensacyjny</option><option>turbo</option><option>grawitacyjny</option></select></div>
      <div><label>VAT</label><input id="v_vat" type="number" value="8"></div>
      <div><label>Klasa/Norma</label><input id="v_class" placeholder="np. Ecodesign 5"></div>
      <div><label>Tagi domyÅ›lne</label><input id="v_tags" placeholder="np. dwufunkcyjny, kompakt"></div>
    </div>
    <div class="card">
      <div class="muted">Warianty (jedna linia = kW;sprawnoÅ›Ä‡/COP;NETTO;model)</div>
      <textarea id="v_lines" style="width:100%;min-height:160px;background:#0d1530;color:#e8edff;border:1px solid #28356c;border-radius:10px;padding:8px" placeholder="20;0.98;6200;B1KF 20 kW
25;0.98;6600;B1KF 25 kW
30;0.98;7200;B1KF 30 kW"></textarea>
      <div class="row" style="margin-top:8px">
        <button id="btnVarGenerate" class="btn ok">+ Dodaj warianty</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: MARÅ»A/NARZUT -->
<div id="modalMargin" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h3 id="mTitle" style="margin:0">Hurtowa zmiana cen</h3>
      <button id="btnMarginClose" class="btn ghost">Zamknij</button>
    </div>
    <div class="grid-3">
      <div><label>Tryb</label><select id="m_mode"><option value="margin">MarÅ¼a %</option><option value="markup">Narzut %</option><option value="abs">+ Kwota [zÅ‚]</option></select></div>
      <div><label>WartoÅ›Ä‡</label><input id="m_value" type="number" placeholder="np. 15"></div>
      <div><label>Filtr typ (opcjonalnie)</label><input id="m_type" placeholder="np. KocioÅ‚ gazowy"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnMarginApply" class="btn ok">Zastosuj</button>
      <span class="muted">Zmiana dotyczy ceny NETTO.</span>
    </div>
  </div>
</div>

<!-- MODAL: VAT KONWERSJA -->
<div id="modalVat" class="modal" role="dialog" aria-modal="true" aria-labelledby="vatTitle">
  <div class="box">
    <div class="row" style="justify-content:space-between">
      <h3 id="vatTitle" style="margin:0">Konwersja VAT</h3>
      <button id="btnVatClose" class="btn ghost">Zamknij</button>
    </div>
    <div class="grid-3">
      <div><label>Nowy VAT [%]</label><input id="vat_new" type="number" value="8"></div>
      <div><label>Tryb</label><select id="vat_mode"><option value="recalc">Przelicz BRUTTO z NETTO</option><option value="net_from_gross">Wylicz NETTO z BRUTTO</option></select></div>
      <div><label>Filtr typ (opcjonalnie)</label><input id="vat_type" placeholder="np. KocioÅ‚ gazowy"></div>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnVatApply" class="btn ok">Zastosuj</button>
    </div>
  </div>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const INT = new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const fmt = n => isFinite(n)? INT.format(Math.round(n)) : 'â€”';
function toNum(v){ if(typeof v!=='string') return Number(v)||0; const s=v.replace(/\u00A0/g,' ').replace(/\s+/g,'').replace(/\./g,'').replace(',','.'); const n=parseFloat(s); return isFinite(n)?n:0; }
function esc(s){ return (s??'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
const escCsv = v => { let s=(v==null?'':String(v)); if(/[;\n"]/.test(s)) s='"'+s.replace(/"/g,'""')+'"'; return s; };

/* ===== storage ===== */
const LS_KEY = 'arkon_components_v1';     // WSPÃ“LNY z komponenty.html i katalogami
const LS_BRANDS = 'arkon_brands_v1';
let items = loadItems();
let brands = loadBrands();
let filter = { q:'', fuel:'', type:'', brand:'', status:'', kwMin:'', kwMax:'', pMin:'', pMax:'', sort:'name.asc' };

function loadItems(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch{return[];} }
function saveItems(){ localStorage.setItem(LS_KEY, JSON.stringify(items)); render(); }
function loadBrands(){ try{ return JSON.parse(localStorage.getItem(LS_BRANDS)||'[]'); }catch{return[];} }
function saveBrands(){ localStorage.setItem(LS_BRANDS, JSON.stringify(brands)); fillBrands(); }

/* ===== seed (jeÅ›li pusto brak piecÃ³w â€“ nie nadpisujemy pomp) ===== */
const hasBoilers = (items||[]).some(x => /kocioÅ‚|piec|elektryczne|sieÄ‡/i.test(x.type||'') || /gaz|pellet|drewno|elektryczn|sieÄ‡/i.test(x.fuel||''));
if(!hasBoilers){
  items = [
    // gaz kondensacyjne
    {id:uid(), created:Date.now()-500000, name:'Vitodens 100-W', model:'B1KF 20 kW', type:'KocioÅ‚ gazowy', brand:'Viessmann', fuel:'gaz', chamber:'zamkniÄ™ta', flue:'kondensacyjny', kw:20, eff:0.98, net:6200, vat:8, gross:6696, class:'ErP A', status:'OK', tags:['dwufunkcyjny']},
    {id:uid(), created:Date.now()-400000, name:'Vitodens 100-W', model:'B1KF 25 kW', type:'KocioÅ‚ gazowy', brand:'Viessmann', fuel:'gaz', chamber:'zamkniÄ™ta', flue:'kondensacyjny', kw:25, eff:0.98, net:6600, vat:8, gross:7128, class:'ErP A', status:'OK', tags:['dwufunkcyjny']},
    // pellet
    {id:uid(), created:Date.now()-300000, name:'BioPellet 20', model:'BP-20', type:'KocioÅ‚ na pellet', brand:'Kostrzewa', fuel:'pellet', chamber:'zamkniÄ™ta', flue:'grawitacyjny', kw:20, eff:0.90, net:11000, vat:8, gross:11880, class:'Ecodesign 5', status:'ORDER', tags:['podajnik']},
    // drewno (zgazowujÄ…cy)
    {id:uid(), created:Date.now()-250000, name:'DC25GS', model:'Atmos DC25GS', type:'KocioÅ‚ zgazowujÄ…cy drewno', brand:'Atmos', fuel:'drewno', chamber:'zamkniÄ™ta', flue:'grawitacyjny', kw:25, eff:0.88, net:8200, vat:8, gross:8856, class:'Ecodesign 5', status:'OK', tags:['zgazowujÄ…cy']},
    // elektryczne
    {id:uid(), created:Date.now()-200000, name:'EKCO.L2 12kW', model:'EKCO.L2-12', type:'Ogrzewanie elektryczne', brand:'Kospel', fuel:'energia elektryczna', chamber:'â€”', flue:'â€”', kw:12, eff:0.99, net:3500, vat:8, gross:3780, class:'â€”', status:'OK', tags:['kocioÅ‚ elektryczny']},
    // sieÄ‡
    {id:uid(), created:Date.now()-150000, name:'PrzyÅ‚Ä…cze + wymiennik', model:'SET-HE-25', type:'PodÅ‚Ä…czenie do sieci', brand:'TERMEX', fuel:'sieÄ‡ ciepÅ‚ownicza', chamber:'â€”', flue:'â€”', kw:25, eff:0.95, net:9800, vat:8, gross:10584, class:'â€”', status:'OK', tags:['z przyÅ‚Ä…czem']}
  ].concat(items); // dokÅ‚adamy na poczÄ…tek
  saveItems();
}
if(!brands.length){
  brands = ['Viessmann','Vaillant','Saunier Duval','Junkers','De Dietrich','Immergas','Kospel','Kostrzewa','Defro','Tekla','Atmos','TERMEX'];
  saveBrands();
}

/* ===== UI init ===== */
function fillBrands(){
  const sel = $('#fBrand');
  const curr = sel.value;
  sel.innerHTML = '<option value="">Marka (wszystkie)</option>' + brands.map(b=><option>${esc(b)}</option>).join('');
  if(curr) sel.value=curr;
  const list = $('#brandList');
  list.innerHTML = brands.map(b=><div class="row"><span class="tag">${esc(b)}</span><button class="btn ghost delBrand" data-b="${esc(b)}">UsuÅ„</button></div>).join('');
  list.querySelectorAll('.delBrand').forEach(btn=>btn.onclick=()=>{ const b=btn.dataset.b; brands=brands.filter(x=>x!==b); saveBrands(); });
}
fillBrands();

/* ===== filtry ===== */
$('#q').oninput = e=>{ filter.q = e.target.value.trim().toLowerCase(); render(); };
$('#fFuel').onchange = e=>{ filter.fuel=e.target.value; render(); };
$('#fType').onchange = e=>{ filter.type=e.target.value; render(); };
$('#fBrand').onchange = e=>{ filter.brand=e.target.value; render(); };
$('#fStatus').onchange = e=>{ filter.status=e.target.value; render(); };
$('#fKwMin').oninput = e=>{ filter.kwMin=e.target.value; render(); };
$('#fKwMax').oninput = e=>{ filter.kwMax=e.target.value; render(); };
$('#fPriceMin').oninput = e=>{ filter.pMin=e.target.value; render(); };
$('#fPriceMax').oninput = e=>{ filter.pMax=e.target.value; render(); };
$('#sort').onchange = e=>{ filter.sort=e.target.value; render(); };
$('#btnClear').onclick = ()=>{ filter={ q:'',fuel:'',type:'',brand:'',status:'',kwMin:'',kwMax:'',pMin:'',pMax:'',sort:'name.asc'}; 
  $('#q').value=''; $('#fFuel').value=''; $('#fType').value=''; $('#fBrand').value=''; $('#fStatus').value='';
  $('#fKwMin').value=''; $('#fKwMax').value=''; $('#fPriceMin').value=''; $('#fPriceMax').value=''; $('#sort').value='name.asc'; render();
};

/* ===== CRUD ===== */
$('#btnAdd').onclick = ()=>{
  items.unshift({
    id:uid(), created:Date.now(),
    name:'Nowy kocioÅ‚', model:'', type:'KocioÅ‚ gazowy', brand:'', fuel:'gaz',
    chamber:'zamkniÄ™ta', flue:'kondensacyjny',
    kw:0, eff:0.95, net:0, vat:8, gross:0, class:'', status:'OK', tags:[]
  });
  saveItems();
};
function delItem(id){ items = items.filter(x=>x.id!==id); saveItems(); }

/* ===== render ===== */
function matchText(hay, needle){ return (hay??'').toString().toLowerCase().includes(needle); }
function inRange(v,min,max){ v=Number(v)||0; if(min!=='' && v<Number(min)) return false; if(max!=='' && v>Number(max)) return false; return true; }
function calcGross(net,vat){ net=Number(net)||0; vat=Number(vat)||0; return net*(1+vat/100); }

function render(){
  let rows = items.slice();

  // filtr
  if(filter.q){
    rows = rows.filter(r => matchText(r.name,filter.q) || matchText(r.model,filter.q) || matchText(r.brand,filter.q) || matchText(r.type,filter.q) || (r.tags||[]).some(t=>matchText(t,filter.q)));
  }
  if(filter.fuel) rows = rows.filter(r=> (r.fuel||'')===filter.fuel );
  if(filter.type) rows = rows.filter(r=> (r.type||'')===filter.type );
  if(filter.brand) rows = rows.filter(r=> r.brand===filter.brand );
  if(filter.status) rows = rows.filter(r=> r.status===filter.status );

  rows = rows.filter(r=> inRange(r.kw, filter.kwMin, filter.kwMax) );
  rows = rows.filter(r=> inRange(r.net, filter.pMin, filter.pMax) );

  // sort
  rows.sort((a,b)=>{
    switch(filter.sort){
      case 'name.asc': return (a.name||'').localeCompare(b.name||'', 'pl', {sensitivity:'base'});
      case 'name.desc': return (b.name||'').localeCompare(a.name||'', 'pl', {sensitivity:'base'});
      case 'price.asc': return (a.net||0) - (b.net||0);
      case 'price.desc': return (b.net||0) - (a.net||0);
      case 'kw.asc': return (a.kw||0) - (b.kw||0);
      case 'kw.desc': return (b.kw||0) - (a.kw||0);
      case 'eff.asc': return (a.eff||0) - (b.eff||0);
      case 'eff.desc': return (b.eff||0) - (a.eff||0);
      case 'created.desc': return (b.created||0) - (a.created||0);
      case 'created.asc': return (a.created||0) - (b.created||0);
      default: return 0;
    }
  });

  $('#countAll').textContent = items.length;
  $('#countVis').textContent = rows.length;

  const tb = $('#tbody'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <button class="btn ghost" data-act="dup" data-id="${r.id}">Duplikuj</button>
        <button class="btn bad" data-act="del" data-id="${r.id}">UsuÅ„</button>
      </td>
      <td class="edit"><div class="cell" contenteditable data-k="name">${esc(r.name)}</div><div class="small">${new Date(r.created||Date.now()).toLocaleDateString('pl-PL')}</div><div class="small">Model: <span class="cell" contenteditable data-k="model">${esc(r.model||'')}</span></div></td>
      <td class="edit"><div class="cell" contenteditable data-k="type">${esc(r.type||'')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="brand">${esc(r.brand||'')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="fuel">${esc(r.fuel||'')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="chamber">${esc(r.chamber||'')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="flue">${esc(r.flue||'')}</div></td>
      <td class="edit num"><div class="cell" contenteditable data-k="kw">${r.kw??0}</div></td>
      <td class="edit num"><div class="cell" contenteditable data-k="eff">${r.eff??0}</div></td>
      <td class="edit num"><div class="cell" contenteditable data-k="net">${r.net??0}</div></td>
      <td class="edit num"><div class="cell" contenteditable data-k="vat">${r.vat??8}</div></td>
      <td class="num">${fmt(calcGross(r.net,r.vat))}</td>
      <td class="edit"><div class="cell" contenteditable data-k="class">${esc(r.class||'')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="status">${esc(r.status||'OK')}</div></td>
      <td class="edit"><div class="cell" contenteditable data-k="tags">${esc((r.tags||[]).join(', '))}</div></td>
    `;
    tr.querySelectorAll('[data-act]').forEach(b=>{
      const id=b.dataset.id;
      if(b.dataset.act==='del'){ b.onclick=()=>{ if(confirm('UsunÄ…Ä‡?')) delItem(id); }; }
      if(b.dataset.act==='dup'){ b.onclick=()=>{ const src=items.find(x=>x.id===id); if(!src) return; const copy=JSON.parse(JSON.stringify(src)); copy.id=uid(); copy.created=Date.now(); items.unshift(copy); saveItems(); }; }
    });
    tr.querySelectorAll('[contenteditable][data-k]').forEach(el=>{
      el.addEventListener('blur', ()=> saveCell(r.id, el.dataset.k, el.textContent.trim()) );
      el.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); el.blur(); }});
    });
    tb.appendChild(tr);
  });
}
function saveCell(id,key,val){
  const it = items.find(x=>x.id===id); if(!it) return;
  switch(key){
    case 'kw': case 'eff': case 'net': case 'vat': it[key]=toNum(val); break;
    case 'tags': it.tags = val? val.split(',').map(s=>s.trim()).filter(Boolean) : []; break;
    default: it[key]=val;
  }
  it.gross = calcGross(it.net,it.vat);
  saveItems();
}
render();

/* ===== warianty ===== */
$('#btnVariants').onclick = ()=> $('#modalVar').classList.add('open');
$('#btnVarClose').onclick = ()=> $('#modalVar').classList.remove('open');
$('#btnVarGenerate').onclick = ()=>{
  const base = {
    name: $('#v_name').value.trim(),
    brand: $('#v_brand').value.trim(),
    type: $('#v_type').value,
    fuel: $('#v_fuel').value,
    chamber: $('#v_chamber').value,
    flue: $('#v_flue').value,
    vat: Number($('#v_vat').value)||8,
    class: $('#v_class').value.trim(),
    tags: ($('#v_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean)
  };
  if(!base.name || !base.brand) return alert('Podaj nazwÄ™ i markÄ™.');
  const lines = $('#v_lines').value.split('\n').map(s=>s.trim()).filter(Boolean);
  const created = Date.now();
  lines.forEach(line=>{
    const [kw,eff,net,model] = line.split(';').map(s=>s.trim());
    items.unshift({
      id:uid(), created,
      name:base.name, model:model||'', type:base.type, brand:base.brand,
      fuel:base.fuel, chamber:base.chamber, flue:base.flue,
      kw: Number(kw)||0, eff:Number(eff)||0, net:Number(net)||0, vat:base.vat,
      gross: calcGross(Number(net)||0, base.vat),
      class: base.class, status:'OK', tags: base.tags.slice()
    });
  });
  saveItems();
  $('#modalVar').classList.remove('open');
};

/* ===== marÅ¼a/narzut ===== */
$('#btnMargin').onclick = ()=> $('#modalMargin').classList.add('open');
$('#btnMarginClose').onclick = ()=> $('#modalMargin').classList.remove('open');
$('#btnMarginApply').onclick = ()=>{
  const mode = $('#m_mode').value;
  const val  = Number($('#m_value').value)||0;
  const tflt = $('#m_type').value.trim();
  items.forEach(it=>{
    if(tflt && it.type!==tflt) return;
    let net = Number(it.net)||0;
    if(mode==='margin'){ const m = val/100; if(m>=1) return; net = net/(1-m); }
    else if(mode==='markup'){ net = net*(1+val/100); }
    else{ net = net + val; }
    it.net = Math.max(0, Math.round(net));
    it.gross = calcGross(it.net, it.vat);
  });
  saveItems();
  $('#modalMargin').classList.remove('open');
};

/* ===== VAT konwersja ===== */
$('#btnVat').onclick = ()=> $('#modalVat').classList.add('open');
$('#btnVatClose').onclick = ()=> $('#modalVat').classList.remove('open');
$('#btnVatApply').onclick = ()=>{
  const newVat = Number($('#vat_new').value)||8;
  const mode = $('#vat_mode').value;
  const tflt = $('#vat_type').value.trim();
  items.forEach(it=>{
    if(tflt && it.type!==tflt) return;
    if(mode==='recalc'){ it.vat=newVat; it.gross = calcGross(it.net,newVat); }
    else{ const gross = calcGross(it.net, it.vat); it.vat=newVat; it.net = Math.round(gross / (1 + newVat/100)); it.gross = calcGross(it.net, it.vat); }
  });
  saveItems();
  $('#modalVat').classList.remove('open');
};

/* ===== eksport/import ===== */
$('#btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(items,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'arkon_piece.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('#fileImport').onchange = async e=>{
  const f=e.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const data = JSON.parse(txt);
    if(!Array.isArray(data)) throw new Error('Spodziewana tablica obiektÃ³w.');
    items = data.map(x=>({
      id: x.id||uid(),
      created: x.created||Date.now(),
      name: x.name||'',
      model: x.model||'',
      type: x.type||'Inne',
      brand:x.brand||'',
      fuel: x.fuel||'',
      chamber: x.chamber||'',
      flue: x.flue||'',
      kw: Number(x.kw)||0,
      eff:Number(x.eff)||0,
      net:Number(x.net)||0,
      vat:Number(x.vat??8),
      gross: calcGross(Number(x.net)||0, Number(x.vat??8)),
      class: x.class||'',
      status: x.status||'OK',
      tags: Array.isArray(x.tags)? x.tags : (x.tags? String(x.tags).split(',').map(s=>s.trim()).filter(Boolean):[])
    }));
    saveItems(); alert('Zaimportowano.');
  }catch(err){ alert('BÅ‚Ä…d importu: '+err.message); }
  e.target.value='';
};

/* ===== CSV ===== */
$('#btnCSV').onclick = ()=>{
  const cols = ['id','created','name','model','type','brand','fuel','chamber','flue','kw','eff','net','vat','gross','class','status','tags'];
  const lines = [cols.join(';')];
  items.forEach(it=>{
    const row = [
      it.id, new Date(it.created).toISOString(), escCsv(it.name), escCsv(it.model), escCsv(it.type), escCsv(it.brand),
      escCsv(it.fuel), escCsv(it.chamber), escCsv(it.flue), it.kw, it.eff, it.net, it.vat, Math.round(it.gross||calcGross(it.net,it.vat)),
      escCsv(it.class), escCsv(it.status), escCsv((it.tags||[]).join('|'))
    ].join(';');
    lines.push(row);
  });
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='arkon_piece.csv';
  a.click(); URL.revokeObjectURL(a.href);
};

/* ===== marki ===== */
$('#btnBrandAdd').onclick = ()=>{
  const b = $('#brandNew').value.trim();
  if(!b) return;
  if(!brands.includes(b)) brands.push(b);
  $('#brandNew').value='';
  saveBrands();
};
</script>
</body>
</html>