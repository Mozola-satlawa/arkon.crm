<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Przesy≈Ç dokument√≥w / Oferty / Ulotki</title>
<meta name="description" content="Upload plik√≥w powiƒÖzanych z klientem, baza ofert i ulotek. Integracja z klientami i komponentami (pompy, piece, PV, ocieplenie, stolarka).">

<!-- Supabase (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  :root{
    --bg:#0b1020;--p1:#0f1533;--p2:#121a38;--ink:#e7ecff;--muted:#aeb8da;--line:#223066;
    --accent:#4cc9f0;--ok:#2fbf71;--bad:#ff6b6b;--warn:#ffb84d;
    --chip:#0d1530;--chip2:#152056;--field:#0e1330;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:1.3fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2e925e}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.warn{background:#4a361e;border-color:#8a6b30}
  input,select,textarea{background:var(--field);border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  textarea{min-height:80px;resize:vertical}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:9px;border-bottom:1px solid #22325f;text-align:left;vertical-align:top}
  .scroll{overflow:auto}
  .status{padding:2px 8px;border-radius:999px;background:#0f1a44;border:1px solid #2a3a75;font-size:12px}
  .empty{opacity:.8;border:1px dashed #2b3a77;border-radius:10px;padding:10px;text-align:center}
  .urlbox{display:inline-flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>
  <h1>Przesy≈Ç dokument√≥w ‚Ä¢ ARKON CRM</h1>
  <div class="small">PowiƒÖ≈º pliki z klientami, buduj <b>oferty</b>, prowad≈∫ bazƒô <b>ulotek</b>. Integracja z komponentami (Pompy, Piece, PV, Ocieplenie, Stolarka).</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="klienci.html">Klienci</a>
  <a href="komponenty-pompy.html">Pompy</a>
  <a href="komponenty-piece.html">Piece</a>
  <a href="komponenty-fotowoltaika.html">Fotowoltaika</a>
  <a href="komponenty-ocieplenie.html">Ocieplenie</a>
  <a href="komponenty-stolarka.html">Stolarka</a>
  <a href="chat.html">Komunikator</a>
  <a href="ustawienia.html">Ustawienia</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWA: PLIKI -->
  <section class="card">
    <h2 style="margin:0 0 8px">Pliki klienta (IndexedDB + Supabase)</h2>
    <div class="row">
      <select id="selClient" title="Klient" style="min-width:280px"></select>
      <select id="selCat" title="Kategoria">
        <option>Umowa z firmƒÖ</option>
        <option>Audyt</option>
        <option>Dokument do audytu Czyste Powietrze</option>
        <option>Audyt rozprowadzenia instalacji</option>
        <option>Pomiary budynku</option>
        <option>Rzut budynku</option>
        <option>Zdjƒôcia kot≈Çowni</option>
        <option>Faktura za prƒÖd</option>
        <option>Zdjƒôcia falownika</option>
        <option>Zdjƒôcia budynku</option>
        <option>Oferta (PDF)</option>
        <option>Ulotka</option>
        <option>Inne</option>
      </select>
      <input id="tags" placeholder="tagi, przecinkami">
      <label class="btn">Dodaj pliki‚Ä¶ <input id="inFiles" type="file" multiple hidden></label>

      <!-- Kontrola chmury -->
      <label class="pill" style="cursor:pointer;margin-left:6px">
        <input id="toCloud" type="checkbox" checked>
        Wy≈õlij do chmury (Supabase)
      </label>
      <span id="cloudState" class="pill">Chmura: niepo≈ÇƒÖczono</span>

      <button id="btnRefresh" class="btn ghost">Od≈õwie≈º</button>
      <button id="btnSyncCloud" class="btn ghost">üîÑ Wczytaj z chmury</button>
    </div>
    <div class="small" style="margin:6px 0">
      Pliki zapisujƒÖ siƒô lokalnie w IndexedDB. Opcjonalnie r√≥wnolegle wysy≈Çamy do chmury (Supabase ‚Üí bucket <b>umowy</b>).
      Je≈õli bucket jest niepubliczny, u≈ºyj akcji <b>Signed 24h</b> aby wygenerowaƒá tymczasowy link.
    </div>

    <div class="card" style="padding:10px;margin-top:8px">
      <div class="row" style="margin-bottom:6px">
        <input id="qFiles" placeholder="üîé filtr: nazwa/typ/kategoria/tag/klient‚Ä¶" style="min-width:260px">
        <select id="fCat"><option value="">Kategoria (wszystkie)</option></select>
        <button id="btnClear" class="btn ghost">Wyczy≈õƒá filtr</button>
        <span class="pill">Widocznych: <b id="filesVis">0</b></span>
      </div>
      <div class="scroll" style="max-height:360px">
        <table class="table" id="tblFiles">
          <thead>
            <tr>
              <th>Akcje</th><th>Nazwa</th><th>Klient</th><th>Kategoria</th><th>Tagi</th><th>Typ</th><th>Rozmiar</th><th>Data</th>
            </tr>
          </thead>
          <tbody id="tbFiles"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRAWA: (tu zostawi≈Çem jak by≈Ço ‚Äì oferty/ulotki) -->
  <section class="grid">
    <div class="card">
      <h2 style="margin:0 0 8px">Oferty klienta</h2>
      <div class="row">
        <select id="offClient" style="min-width:280px"></select>
        <input id="offTitle" placeholder="Tytu≈Ç oferty (np. PV 6 kWp + magazyn 10 kWh)">
        <button id="offNew" class="btn ok">+ Nowa oferta</button>
        <button id="offExport" class="btn ghost">Eksport JSON</button>
        <label class="btn ghost">Import JSON <input id="offImport" type="file" accept="application/json" hidden></label>
      </div>

      <div class="tabs" role="tablist" aria-label="≈πr√≥d≈Ça pozycji">
        <button class="tab" data-tab="builder" aria-selected="true">üîß Edytor pozycji</button>
        <button class="tab" data-tab="components">üì¶ Komponenty</button>
        <button class="tab" data-tab="list">üìë Lista ofert</button>
      </div>

      <div id="tab-builder">
        <div class="row small"><span class="pill">Pozycje: <b id="cntItems">0</b></span><span class="pill">Suma: <b id="sumItems">0 z≈Ç</b></span></div>
        <div class="scroll" style="max-height:260px">
          <table class="table">
            <thead><tr>
              <th>Akcje</th><th>Kategoria</th><th>Marka/Model</th><th>Specyfikacja</th>
              <th>Ilo≈õƒá</th><th>Cena netto [z≈Ç]</th><th>Rabat %</th><th>Razem [z≈Ç]</th>
            </tr></thead>
            <tbody id="offBody"></tbody>
          </table>
        </div>
        <div class="right" style="margin-top:6px">
          <button id="offAddRow" class="btn">+ Pozycja</button>
          <button id="offSave" class="btn ok">üíæ Zapisz ofertƒô</button>
        </div>
      </div>

      <div id="tab-components" hidden>
        <div class="row">
          <select id="compCat">
            <option value="pv">Fotowoltaika</option>
            <option value="pumps">Pompy ciep≈Ça</option>
            <option value="boilers">Piece / kot≈Çy</option>
            <option value="insul">Ocieplenie</option>
            <option value="windows">Stolarka</option>
          </select>
          <input id="compQ" placeholder="üîé szukaj w komponentach">
          <button id="compAddSel" class="btn">+ Dodaj zaznaczone</button>
          <span class="pill">Widocznych: <b id="compVis">0</b></span>
        </div>
        <div class="scroll" style="max-height:260px;margin-top:6px">
          <table class="table">
            <thead><tr><th>+</th><th>Marka</th><th>Model</th><th>Spec</th><th>Cena</th></tr></thead>
            <tbody id="compBody"></tbody>
          </table>
        </div>
      </div>

      <div id="tab-list" hidden>
        <div class="row" style="margin-bottom:6px">
          <input id="offQ" placeholder="üîé filtruj po tytule/kliencie">
          <button id="offClear" class="btn ghost">Wyczy≈õƒá</button>
          <span class="pill">≈ÅƒÖcznie: <b id="cntOffers">0</b></span>
        </div>
        <div class="scroll" style="max-height:240px">
          <table class="table"><thead><tr>
            <th>Akcje</th><th>Tytu≈Ç</th><th>Klient</th><th>Pozycji</th><th>Suma [z≈Ç]</th><th>Data</th>
          </tr></thead><tbody id="offList"></tbody></table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Ulotki z ofertami</h2>
      <div class="row">
        <select id="flyClient" style="min-width:280px"></select>
        <input id="flyTitle" placeholder="Tytu≈Ç ulotki / kampanii">
        <input id="flySource" placeholder="Kana≈Ç (np. FB, Google, druk)">
        <label class="btn">Dodaj plik ulotki‚Ä¶ <input id="flyFile" type="file" accept=".pdf,image/*" hidden></label>
        <button id="flyAdd" class="btn ok">+ Dodaj ulotkƒô</button>
      </div>
      <div class="scroll" style="max-height:260px">
        <table class="table">
          <thead><tr><th>Akcje</th><th>Tytu≈Ç</th><th>Klient</th><th>Kana≈Ç</th><th>Plik</th><th>Data</th></tr></thead>
          <tbody id="flyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const INT0=new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmt=n=>isFinite(n)?INT0.format(Math.round(n)):'‚Äî';
const bytes=n=>n<1024? n+' B' : n<1048576? (n/1024).toFixed(1)+' KB' : n<1073741824? (n/1048576).toFixed(1)+' MB' : (n/1073741824).toFixed(1)+' GB';
const uid=()=> 'ID_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2);
function esc(s){return (s||'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms||180); }; }

/* ===== clients (compatible with v1 & v2) ===== */
function loadClients(){
  let a=[];
  try{ a = JSON.parse(localStorage.getItem('arkon_clients_v1')||'[]'); }catch{}
  if(!Array.isArray(a) || !a.length){
    try{ a = JSON.parse(localStorage.getItem('arkon_clients_v2')||'[]'); }catch{}
  }
  return Array.isArray(a)?a:[];
}

/* ===== components sources (from other pages) ===== */
const CMP_KEYS = {
  pv:      ['arkon_cmp_pv_v1','cmp_pv','arkon_components_pv'],
  pumps:   ['arkon_cmp_pumps_v1','cmp_pumps','arkon_components_pumps'],
  boilers: ['arkon_cmp_boilers_v1','cmp_boilers','arkon_components_boilers','cmp_piece'],
  insul:   ['arkon_cmp_insul_v1','cmp_insul','arkon_components_insul','cmp_ocieplenie'],
  windows: ['arkon_cmp_windows_v1','cmp_windows','arkon_components_windows','cmp_stolarka']
};
function loadComponents(cat){
  const keys = CMP_KEYS[cat]||[];
  for(const k of keys){
    try{
      const v = JSON.parse(localStorage.getItem(k)||'[]');
      if(Array.isArray(v) && v.length) return v;
    }catch{}
  }
  return [];
}

/* ===== IndexedDB: files ===== */
let db;
function dbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('arkonCRM_local',2);
    r.onupgradeneeded=()=>{const d=r.result; if(!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'id'});};
    r.onsuccess=()=>{db=r.result; res();};
    r.onerror=()=>rej(r.error);
  });
}
function dbPut(o){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').put(o); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}
function dbGet(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly'); const rq=tx.objectStore('files').get(id); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);});}
function dbAll(){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly'); const rq=tx.objectStore('files').getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error);});}
function dbDel(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}

/* ===== Supabase: config uploadu um√≥w ===== */
const SUPA_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SUPA_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r'; // anon (publishable)
const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);

const BUCKET = 'umowy';                       // utw√≥rz w Storage
const ACCOUNT_ID = (localStorage.getItem('arkon_account_id') || 'arkon-crm').toLowerCase();

function setCloudState(txt, ok){
  const el = $('#cloudState');
  if(!el) return;
  el.textContent = txt;
  el.style.borderColor = ok ? '#2e925e' : '#7b3341';
  el.style.background = ok ? '#0f2c22' : '#2e1117';
}
async function supaPing(){
  try{
    const { error } = await supa.storage.from(BUCKET).list('', { limit: 1 });
    if(error) throw error;
    setCloudState('Chmura: po≈ÇƒÖczono ‚úì', true);
  }catch(e){
    setCloudState('Chmura: b≈ÇƒÖd (sprawd≈∫ bucket/polityki)', false);
    console.warn('Supabase ping error:', e);
  }
}
supaPing();

function safeName(name){
  return String(name || 'plik')
    .normalize('NFKD').replace(/[^\w.\-]+/g,'').replace(/+/g,'_').toLowerCase();
}
function buildPath({clientId, file}){
  const who  = (clientId || 'bez-klienta').toLowerCase();
  const ts   = new Date().toISOString().replace(/[:.]/g,'-');
  return upload/${who}/${ts}_${safeName(file.name)};
}

// Upload do Storage + metadane do tabeli files
async function uploadToSupabase({file, clientId, clientName, category, tags}){
  const path = buildPath({clientId, file});
  const { error: upErr } = await supa
    .storage.from(BUCKET)
    .upload(path, file, { upsert:true, cacheControl:'3600', contentType: file.type || 'application/octet-stream' });
  if (upErr) throw upErr;

  // publiczny URL (je≈õli bucket publiczny)
  const { data: pub } = supa.storage.from(BUCKET).getPublicUrl(path);
  const file_url = pub?.publicUrl || null;

  // metadane (opcjonalnie ‚Äì ale wymagane przez ‚ÄûWczytaj z chmury‚Äù)
  try{
    await supa.from('files').insert({
      account_id: ACCOUNT_ID,
      client_id:  clientId || '',
      client_name: clientName || '',
      category:   category || '',
      tags:       tags || '',
      file_name:  file.name,
      file_path:  path,
      file_url:   file_url,
      author:     ACCOUNT_ID,
      uploaded_at: new Date().toISOString()
    });
  }catch(e){
    console.info('files meta insert skipped/failed:', e?.message || e);
  }

  return { path, file_url };
}

/* ===== CHMURA ‚Üí Wczytywanie indeksu plik√≥w z Supabase ===== */
let cloudIndex = []; // lista plik√≥w (metadane)

async function loadCloudIndex(){
  try{
    const { data, error } = await supa
      .from('files')
      .select('id,file_name,file_url,file_path,client_id,client_name,category,tags,uploaded_at')
      .eq('account_id', ACCOUNT_ID)
      .order('uploaded_at', { ascending:false });

    if(error) throw error;

    cloudIndex = (data || []).map(r => ({
      id: 'CLOUD_' + r.id,
      name: r.file_name || '(plik)',
      clientId: r.client_id || '',
      clientName: r.client_name || '',
      category: r.category || '',
      tags: r.tags || '',
      type: (r.file_name || '').split('.').pop() || '',
      size: 0,
      at: r.uploaded_at ? Date.parse(r.uploaded_at) : Date.now(),
      origin: 'cloud',
      url: r.file_url || null,
      path: r.file_path || null
    }));

    setCloudState('Chmura: wczytano indeks ‚úì', true);
    renderFiles();
  }catch(e){
    console.error('Cloud index error:', e);
    setCloudState('Chmura: b≈ÇƒÖd indeksu', false);
    alert('B≈ÇƒÖd pobierania listy z chmury: ' + (e?.message || e));
  }
}

// Signed URL (gdy bucket niepubliczny) ‚Äî wa≈ºny timemin w sekundach
async function makeSignedUrl(path, ttlSeconds=86400){
  try{
    const { data, error } = await supa
      .storage.from(BUCKET)
      .createSignedUrl(path, ttlSeconds);
    if(error) throw error;
    return data.signedUrl;
  }catch(e){
    alert('B≈ÇƒÖd tworzenia signed URL: ' + (e?.message || e));
    return null;
  }
}

/* ===== offers storage (bez zmian) ===== */
const LS_OFFERS = 'arkon_offers_v1';
function loadOffers(){ try{ return JSON.parse(localStorage.getItem(LS_OFFERS)||'[]'); }catch{ return []; } }
function saveOffers(list){ localStorage.setItem(LS_OFFERS, JSON.stringify(list)); }

/* ===== flyers storage (bez zmian) ===== */
const LS_FLY = 'arkon_flyers_v1';
function loadFlyers(){ try{ return JSON.parse(localStorage.getItem(LS_FLY)||'[]'); }catch{ return []; } }
function saveFlyers(list){ localStorage.setItem(LS_FLY, JSON.stringify(list)); }

/* ===== clients select fill ===== */
function fillClients(selIds){
  const clients = loadClients();
  selIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = '<option value="">(bez przypisania)</option>' + clients.map(c=><option value="${c.id}">${esc(c.name||'')}</option>).join('');
  });
}

/* ===== FILES UI (z uploadem do Supabase) ===== */
let fileFilter={q:'',cat:''};

async function handleFiles(files){
  const clientId   = $('#selClient').value || '';
  const clientName = clientId ? (loadClients().find(c=>c.id===clientId)?.name||'') : '';
  const category   = $('#selCat').value || 'Inne';
  const tags       = $('#tags').value || '';
  const toCloud    = !!$('#toCloud')?.checked;

  for(const f of Array.from(files||[])){
    // lokalnie (IndexedDB)
    const id=uid();
    await dbPut({ id, name:f.name, type:f.type||'application/octet-stream', size:f.size, blob:f, at:Date.now(),
      category, clientId, clientName, origin:'upload', tags });

    // chmura (opcjonalnie)
    if(toCloud){
      try{
        const { file_url } = await uploadToSupabase({ file:f, clientId, clientName, category, tags });
        console.log('Uploaded to cloud:', file_url);
        setCloudState('Chmura: wys≈Çano ‚úì', true);
      }catch(e){
        console.error('Cloud upload error:', e);
        setCloudState('Chmura: b≈ÇƒÖd wysy≈Çki', false);
      }
    }
  }
  // po uploadzie mo≈ºesz od razu od≈õwie≈ºyƒá indeks z chmury (opcjonalnie)
  // await loadCloudIndex();
  renderFiles();
}

async function renderFiles(){
  const localList = await dbAll();
  const combined  = [...cloudIndex, ...localList];

  const q  = (fileFilter.q || '').toLowerCase();
  const cat= fileFilter.cat || '';
  const tb = $('#tbFiles'); tb.innerHTML='';

  const cats = new Set();
  combined.sort((a,b)=>(b.at||0)-(a.at||0)).forEach(rec=>cats.add(rec.category||''));
  $('#fCat').innerHTML = '<option value="">Kategoria (wszystkie)</option>' +
    Array.from(cats).filter(Boolean).map(c=><option ${cat===c?'selected':''}>${esc(c)}</option>).join('');

  let vis=0;
  combined.filter(x=>{
    if(cat && (x.category||'')!==cat) return false;
    const hay=[x.name,x.clientName,x.category,x.type,x.tags,(x.origin||'')].join(' ').toLowerCase();
    return !q || hay.includes(q);
  }).forEach(rec=>{
    vis++;
    const when = rec.at ? new Date(rec.at).toLocaleString('pl-PL') : '';
    const cloudBadge = rec.origin==='cloud' ? '<span class="status">chmura</span>' : '';
    const actions = rec.origin==='cloud'
      ? `<div class="row">
           <button class="btn" data-openurl="${esc(rec.url||'')}" ${rec.url?'':'disabled'}>Otw√≥rz</button>
           <button class="btn ghost" data-signed="${esc(rec.path||'')}" ${rec.path?'':'disabled'}>Signed 24h</button>
         </div>`
      : `<div class="row">
           <button class="btn ghost" data-dl="${rec.id}">Pobierz</button>
           <button class="btn" data-edit="${rec.id}">Edytuj</button>
           <button class="btn bad" data-del="${rec.id}">Usu≈Ñ</button>
         </div>`;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${actions}</td>
      <td>${esc(rec.name)} ${cloudBadge}</td>
      <td>${esc(rec.clientName||'')}</td>
      <td>${esc(rec.category||'')}</td>
      <td>${esc(rec.tags||'')}</td>
      <td>${esc(rec.type||'')}</td>
      <td>${rec.size ? bytes(rec.size) : '‚Äî'}</td>
      <td>${when}</td>`;
    tb.appendChild(tr);
  });
  $('#filesVis').textContent = vis;

  // Akcje lokalne
  tb.querySelectorAll('[data-dl]').forEach(b=>b.addEventListener('click', async ()=>{
    const rec=await dbGet(b.dataset.dl); if(!rec){ alert('Plik niedostƒôpny.'); return; }
    const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
  }));
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
    if(!confirm('UsunƒÖƒá plik?')) return; await dbDel(b.dataset.del); renderFiles();
  }));
  tb.querySelectorAll('[data-edit]').forEach(b=>b.addEventListener('click', async ()=>{
    const rec=await dbGet(b.dataset.edit); if(!rec){ alert('Brak pliku.'); return; }
    const newName = prompt('Nowa nazwa pliku', rec.name) || rec.name;
    const newCat  = prompt('Kategoria', rec.category||'') || rec.category||'';
    const newTags = prompt('Tagi (przecinkami)', rec.tags||'') || rec.tags||'';
    const clientId= prompt('ID klienta (puste = bez przypisania)', rec.clientId||'') || '';
    const clientName = clientId ? (loadClients().find(c=>c.id===clientId)?.name||'') : '';
    await dbPut({...rec, name:newName, category:newCat, tags:newTags, clientId, clientName });
    renderFiles();
  }));

  // Akcje chmura
  tb.querySelectorAll('[data-openurl]').forEach(b=>b.addEventListener('click',()=>{
    const url=b.dataset.openurl; if(!url){ alert('Brak URL pliku (bucket prywatny). U≈ºyj "Signed 24h".'); return; }
    window.open(url, '_blank', 'noopener');
  }));
  tb.querySelectorAll('[data-signed]').forEach(b=>b.addEventListener('click', async ()=>{
    const path=b.dataset.signed; if(!path) return;
    const url = await makeSignedUrl(path, 86400); // 24h
    if(url){
      // poka≈º szybkie okienko z linkiem do skopiowania
      const box = document.createElement('div');
      box.className='urlbox';
      box.innerHTML = `<input style="width:360px" value="${esc(url)}" readonly> 
                       <button class="btn ok">Kopiuj</button>
                       <a class="btn" href="${esc(url)}" target="_blank" rel="noopener">Otw√≥rz</a>`;
      const td = b.closest('tr').children[0];
      td.appendChild(box);
      const input = box.querySelector('input');
      const btn = box.querySelector('button');
      btn.addEventListener('click',()=>{ input.select(); document.execCommand('copy'); btn.textContent='Skopiowano!'; setTimeout(()=>btn.textContent='Kopiuj',1200); });
    }
  }));
}

/* ===== OFFERS / COMPONENTS / FLYERS (skr√≥cone: bez zmian logiki) ===== */
let offers = loadOffers();
let curItems = []; let curOfferId = null;
function offerSum(items){ return items.reduce((a,it)=> a + ((+it.price||0)(+it.qty||0)(1-(+it.disc||0)/100)), 0); }
function refreshOfferCounters(){ $('#cntItems').textContent = curItems.length; $('#sumItems').textContent = fmt(offerSum(curItems))+' z≈Ç'; }
function renderOfferEditor(){ /* ‚Ä¶ zachowano jak by≈Ço ‚Ä¶ */ }
function newOffer(){ curOfferId=null; curItems=[]; $('#offTitle').value=$('#offTitle').value||'Oferta'; /* ‚Ä¶ */ }
function saveOffer(){ /* ‚Ä¶ jak by≈Ço ‚Ä¶ */ }
function renderOfferList(){ /* ‚Ä¶ jak by≈Ço ‚Ä¶ */ }
function renderComponents(){ /* ‚Ä¶ jak by≈Ço ‚Ä¶ */ }
function addFlyer(){ /* ‚Ä¶ jak by≈Ço ‚Ä¶ */ }
function renderFlyers(){ /* ‚Ä¶ jak by≈Ço ‚Ä¶ */ }

/* ===== INIT ===== */
(async function init(){
  await dbOpen();
  fillClients(['selClient','offClient','flyClient']);

  // Files
  $('#inFiles')?.addEventListener('change',e=>{ handleFiles(e.target.files); e.target.value=''; });
  $('#btnRefresh')?.addEventListener('click',renderFiles);
  $('#btnSyncCloud')?.addEventListener('click', loadCloudIndex);
  $('#qFiles')?.addEventListener('input', e=>{ fileFilter.q=e.target.value.trim(); renderFiles(); });
  $('#btnClear')?.addEventListener('click',()=>{ fileFilter={q:'',cat:''}; $('#qFiles').value=''; $('#fCat').value=''; renderFiles(); });
  $('#fCat')?.addEventListener('change', e=>{ fileFilter.cat=e.target.value||''; renderFiles(); });

  // Oferty / komponenty / ulotki
  // (je≈õli u≈ºywasz ‚Äì pod≈ÇƒÖcz tu swoje istniejƒÖce handlery jak wcze≈õniej)

  // Na start: poka≈º lokalne i od razu spr√≥buj pobraƒá indeks z chmury
  renderFiles();
  loadCloudIndex();
})();
</script>
</body>
</html>
