<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON — Przesył dokumentów</title>
<meta name="description" content="Wysyłka plików powiązanych z klientem do chmury (Netlify Blobs).">
<style>
  :root{
    --bg:#0b1020;--p1:#0f1533;--p2:#121a38;--ink:#e7ecff;--muted:#aeb8da;--line:#223066;
    --ok:#2fbf71;--bad:#ff6b6b;--chip:#0d1530;--field:#0e1330;
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  .wrap{max-width:1100px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  input,select{background:var(--field);border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:9px;border-bottom:1px solid #22325f;text-align:left;vertical-align:top}
  .small{font-size:12px;color:#aeb8da}
  .ok{color:#8EF6C2} .bad{color:#ff9ba0}
</style>
</head>
<body>
<header>
  <h1>Przesył dokumentów • ARKON (Netlify Blobs)</h1>
  <div class="small">Wybierz klienta, dodaj pliki → leci do chmury Netlify (foldery <code>upload/&lt;klient&gt;/</code>).</div>
</header>

<div class="wrap">
  <section class="card">
    <h2 style="margin:0 0 8px">Wysyłka plików</h2>
    <div class="row" style="margin-bottom:8px">
      <select id="selClient" title="Klient" style="min-width:260px">
        <option value="">(bez przypisania)</option>
        <option value="jan-kowalski">Jan Kowalski</option>
        <option value="anna-nowak">Anna Nowak</option>
      </select>
      <select id="selCat">
        <option>Umowa z firmą</option>
        <option>Audyt</option>
        <option>Pomiary budynku</option>
        <option>Oferta (PDF)</option>
        <option>Ulotka</option>
        <option>Inne</option>
      </select>
      <input id="tags" placeholder="tagi, przecinkami">
      <label class="btn">Dodaj pliki… <input id="inFiles" type="file" multiple hidden></label>
      <button id="btnSend" class="btn ok">Wyślij teraz</button>
      <span id="cloudState" class="pill">Chmura: gotowe</span>
    </div>
    <div class="small">Nie potrzebujesz żadnych kluczy ani zewnętrznych usług — Netlify Blobs działa wprost z tej funkcji.</div>
  </section>

  <section class="card">
    <h2 style="margin:0 0 8px">Podgląd ostatniego wysyłania</h2>
    <div class="small">Linki publiczne prosto z Blobs. Nazwy plików i foldery: <code>upload/&lt;klient|bez-klienta&gt;/&lt;ISO&gt;_nazwa</code></div>
    <table class="table" id="tblLog">
      <thead><tr><th>Plik</th><th>Rozmiar</th><th>Typ</th><th>URL</th></tr></thead>
      <tbody id="tbLog"><tr><td colspan="4" class="small">Brak (jeszcze nic nie wysyłano)</td></tr></tbody>
    </table>
  </section>
</div>

<script>
'use strict';

// ===== helpers =====
const $ = s => document.querySelector(s);
const fmtBytes = n => n<1024? n+' B' : n<1048576? (n/1024).toFixed(1)+' KB' : n<1073741824? (n/1048576).toFixed(1)+' MB' : (n/1073741824).toFixed(1)+' GB';
const safeName = (name) => String(name||'plik').normalize('NFKD').replace(/[^\w.\-]+/g,'').replace(/+/g,'_').toLowerCase();

// ===== state =====
let pendingFiles = [];

// ===== UI binds =====
$('#inFiles').addEventListener('change', e => {
  pendingFiles = Array.from(e.target.files || []);
  $('#cloudState').textContent = Wybrane: ${pendingFiles.length} plik(i);
});

$('#btnSend').addEventListener('click', async () => {
  if (!pendingFiles.length) { alert('Najpierw dodaj pliki.'); return; }

  const clientId = ($('#selClient').value || '').trim() || 'bez-klienta';
  const category = ($('#selCat').value || 'Inne').trim();
  const tags     = ($('#tags').value || '').trim();

  const fd = new FormData();
  pendingFiles.forEach(f => fd.append('files', f, safeName(f.name)));
  fd.append('clientId', clientId);
  fd.append('category', category);
  fd.append('tags', tags);

  $('#cloudState').textContent = 'Wysyłanie…';
  try{
    const r = await fetch('/.netlify/functions/upload', { method:'POST', body: fd });
    const data = await r.json();
    if(!r.ok || !data.ok){ throw new Error(data.error || r.status); }
    $('#cloudState').textContent = OK: wysłano ${data.count} plik(i);
    renderLog(data.files || []);
    pendingFiles = [];
  }catch(err){
    console.error(err);
    $('#cloudState').textContent = 'Błąd wysyłki';
    alert('Błąd wysyłki: '+err.message);
  }
});

function renderLog(arr){
  const tb = $('#tbLog');
  tb.innerHTML = '';
  if(!arr.length){ tb.innerHTML = '<tr><td colspan="4" class="small">Brak</td></tr>'; return; }
  arr.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${x.originalName||''}</td>
      <td>${fmtBytes(x.bytes||0)}</td>
      <td>${x.mime||''}</td>
      <td><a href="${x.url}" target="_blank" rel="noopener">otwórz</a></td>
    `;
    tb.appendChild(tr);
  });
}
</script>
</body>
</html>