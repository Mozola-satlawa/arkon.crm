
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON ‚Äî Przesy≈Ç dokument√≥w / Oferty / Ulotki</title>
<meta name="description" content="Upload plik√≥w powiƒÖzanych z klientem, oferty i ulotki. Per-klient: w≈Çasny zestaw dokument√≥w. Supabase Storage.">
<style>
  :root{
    --bg:#0b1020;--p1:#0f1533;--p2:#121a38;--ink:#e7ecff;--muted:#aeb8da;--line:#223066;
    --accent:#4cc9f0;--ok:#2fbf71;--bad:#ff6b6b;--warn:#ffb84d;
    --chip:#0d1530;--chip2:#152056;--field:#0e1330;
  }
  *{box-sizing:border-box} html,body{margin:0;height:100%}
  body{background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:1.3fr 1fr} .cols-3{grid-template-columns:1fr 1fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2e925e}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.warn{background:#4a361e;border-color:#8a6b30}
  input,select,textarea{background:var(--field);border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  textarea{min-height:80px;resize:vertical}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:9px;border-bottom:1px solid #22325f;text-align:left;vertical-align:top}
  .scroll{overflow:auto}
  .drop{border:2px dashed #2a3777;border-radius:10px;padding:14px;text-align:center;cursor:pointer;background:#0c1230}
  .drop.drag{background:#10183b}
  .bar{height:6px;border-radius:999px;background:#12204f;border:1px solid #2b3f86;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#4583ff,#4cc9f0)}
  .empty{opacity:.8;border:1px dashed #2b3a77;border-radius:10px;padding:10px;text-align:center}
  @media print{ nav,.btn,.drop,.right{display:none!important} .wrap{padding:0} }
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
</style>
</head>
<body>
<header>
  <h1>Przesy≈Ç dokument√≥w ‚Ä¢ ARKON CRM</h1>
  <div class="small">Ka≈ºdy klient ma w≈Çasny zestaw dokument√≥w (IndexedDB + Supabase). Wgrywaj umowy, zdjƒôcia falownika, oferty i ulotki.</div>
</header>

<nav>
  <a href="index.html">Pulpit</a>
  <a href="baza.html">Baza klient√≥w</a>
  <a href="edytor-umowy.html">Edytor um√≥w</a>
  <a href="dokumenty.html">Wzory dokument√≥w</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWA: PLIKI -->
  <section class="card">
    <h2 style="margin:0 0 8px">Pliki klienta</h2>
    <div class="row">
      <select id="selClient" title="Klient" style="min-width:300px"></select>
      <select id="selCat" title="Kategoria">
        <optgroup label="Umowy i formalne">
          <option>Umowa z firmƒÖ</option>
          <option>O≈õwiadczenie</option>
          <option>Dokument CP</option>
        </optgroup>
        <optgroup label="Instalacja">
          <option>Zdjƒôcia falownika</option>
          <option>Zdjƒôcia kot≈Çowni</option>
          <option>Pomiary</option>
          <option>Rzut</option>
        </optgroup>
        <optgroup label="Handlowe">
          <option>Oferta (PDF)</option>
          <option>Ulotka</option>
        </optgroup>
        <option>Inne</option>
      </select>
      <input id="tags" placeholder="tagi, przecinkami (np. umowa,pv)">
      <label class="btn">Dodaj pliki‚Ä¶ <input id="inFiles" type="file" multiple hidden></label>
      <label class="pill" style="cursor:pointer"><input id="toCloud" type="checkbox" checked> Do chmury</label>
      <label class="pill" style="cursor:pointer"><input id="allowOverwrite" type="checkbox"> Nadpisuj</label>
      <span id="cloudState" class="pill">Chmura: sprawdzanie‚Ä¶</span>
      <button id="btnRefresh" class="btn ghost">Od≈õwie≈º</button>
    </div>

    <div id="drop" class="drop" style="margin-top:10px">PrzeciƒÖgnij pliki tutaj lub kliknij ‚ÄûDodaj pliki‚Ä¶‚Äù</div>

    <div class="card" style="padding:10px;margin-top:12px">
      <div class="row" style="margin-bottom:6px">
        <input id="qFiles" placeholder="üîé filtr: nazwa/kategoria/tag" style="min-width:260px">
        <select id="fCat"><option value="">Kategoria (wszystkie)</option></select>
        <span class="pill">Widocznych: <b id="filesVis">0</b></span>
      </div>
      <div class="scroll" style="max-height:360px">
        <table class="table" id="tblFiles">
          <thead><tr>
            <th>Akcje</th><th>Nazwa</th><th>Kategoria</th><th>Tagi</th>
            <th>Typ</th><th>Rozmiar</th><th>Data</th><th>Chmura</th>
          </tr></thead>
          <tbody id="tbFiles"></tbody>
        </table>
      </div>
    </div>

    <!-- CHMURA -->
    <div class="card" style="padding:10px;margin-top:12px">
      <div class="row" style="margin-bottom:6px">
        <b>Pliki w chmurze (Supabase Storage)</b>
        <input id="cloudPrefix" placeholder="Dodatkowy prefiks (np. 2025-08)">
        <button id="btnCloudList" class="btn">Od≈õwie≈º chmurƒô</button>
        <span class="pill">Znalezionych: <b id="cloudCount">0</b></span>
      </div>
      <div class="scroll" style="max-height:260px">
        <table class="table">
          <thead><tr><th>Akcje</th><th>≈öcie≈ºka</th><th>Rozmiar</th><th>Zmodyfikowano</th></tr></thead>
          <tbody id="cloudBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRAWA: OFERTY + ULOTKI -->
  <section class="grid">
    <div class="card">
      <h2 style="margin:0 0 8px">Oferty klienta</h2>
      <div class="row">
        <select id="offClient" style="min-width:280px"></select>
        <input id="offTitle" placeholder="Tytu≈Ç oferty (np. PV 6 kWp + magazyn 10 kWh)">
        <button id="offNew" class="btn ok">+ Nowa oferta</button>
        <button id="offSave" class="btn">üíæ Zapisz</button>
        <button id="offExport" class="btn ghost">Eksport JSON</button>
        <label class="btn ghost">Import JSON <input id="offImport" type="file" accept="application/json" hidden></label>
      </div>
      <div class="row small" style="margin-top:6px"><span class="pill">Pozycje: <b id="cntItems">0</b></span><span class="pill">Suma: <b id="sumItems">0 z≈Ç</b></span></div>
      <div class="scroll" style="max-height:260px;margin-top:6px">
        <table class="table">
          <thead><tr><th>Akcje</th><th>Kategoria</th><th>Marka/Model</th><th>Specyfikacja</th><th>Ilo≈õƒá</th><th>Cena netto [z≈Ç]</th><th>Rabat %</th><th>Razem [z≈Ç]</th></tr></thead>
          <tbody id="offBody"></tbody>
        </table>
      </div>
      <div class="right" style="margin-top:6px">
        <button id="offAddRow" class="btn">+ Pozycja</button>
      </div>

      <div class="card" style="margin-top:10px">
        <div class="row" style="margin-bottom:6px">
          <b>Lista zapisanych ofert</b>
          <input id="offQ" placeholder="üîé filtruj po tytule/kliencie">
          <button id="offClear" class="btn ghost">Wyczy≈õƒá</button>
          <span class="pill">≈ÅƒÖcznie: <b id="cntOffers">0</b></span>
        </div>
        <div class="scroll" style="max-height:220px">
          <table class="table"><thead><tr><th>Akcje</th><th>Tytu≈Ç</th><th>Klient</th><th>Pozycji</th><th>Suma [z≈Ç]</th><th>Data</th></tr></thead><tbody id="offList"></tbody></table>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Ulotki z ofertami</h2>
      <div class="row">
        <select id="flyClient" style="min-width:280px"></select>
        <input id="flyTitle" placeholder="Tytu≈Ç ulotki / kampanii">
        <input id="flySource" placeholder="Kana≈Ç (np. FB, Google, druk)">
        <label class="btn">Dodaj plik ulotki‚Ä¶ <input id="flyFile" type="file" accept=".pdf,image/*" hidden></label>
        <button id="flyAdd" class="btn ok">+ Dodaj ulotkƒô</button>
      </div>
      <div class="small" style="margin:6px 0">Ulotka zapisuje siƒô lokalnie i (je≈õli chmura aktywna) trafia do bucketa <b>crm</b>.</div>
      <div class="scroll" style="max-height:260px">
        <table class="table">
          <thead><tr><th>Akcje</th><th>Ulotka</th><th>Klient</th><th>Kana≈Ç</th><th>Plik</th><th>Chmura</th><th>Data</th></tr></thead>
          <tbody id="flyBody"></tbody>
        </table>
      </div>
    </div>
  </section>
</div>

<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script>
'use strict';

/* ===== SUPABASE ===== */
const SB_URL = 'https://phxxjirqlktzcwnygaha.supabase.co';
const SB_KEY = 'sb_publishable_iOXdu9fUGGko3MqPmltAag_ZbPUxp4r';
const supa = supabase.createClient(SB_URL, SB_KEY, { auth: { persistSession:false } });
const CLOUD = { ok:false, bucket:'crm' };

function setCloudState(txt, ok){
  const el = document.getElementById('cloudState');
  el.textContent = txt;
  el.style.borderColor = ok ? '#2e925e' : '#7b3341';
  el.style.background = ok ? '#0f2c22' : '#2e1117';
}
async function supaPing(){
  try{
    const { error } = await supa.storage.from(CLOUD.bucket).list('', { limit: 1 });
    if(error) throw error; CLOUD.ok = true; setCloudState('Chmura: gotowe ‚úì', true);
  }catch{ CLOUD.ok = false; setCloudState('Chmura: niedostƒôpna', false); }
}
const safeName = (name='plik') => String(name).normalize('NFKD').replace(/[^\w.\-]+/g,'_').toLowerCase();
const ymPrefix = () => { const d=new Date(),y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'); return `${y}-${m}`; };
function buildRemotePath({clientId, file, kind='file'}){
  const ts=new Date().toISOString().replace(/[:.]/g,'-');
  const base = kind==='flyer' ? 'flyers' : kind==='offer' ? 'offers' : 'clients';
  return `${base}/${clientId||'bez-klienta'}/${ymPrefix()}/${ts}_${safeName(file.name)}`;
}
async function uploadToSupabase({file, clientId, meta={}, upsert=false}){
  const path = buildRemotePath({clientId, file, kind: meta.kind||'file'});
  const { error } = await supa.storage.from(CLOUD.bucket).upload(path, file, {
    upsert, contentType: file.type || 'application/octet-stream', cacheControl: '3600', metadata: meta
  });
  if(error) throw error;
  const pub = supa.storage.from(CLOUD.bucket).getPublicUrl(path).data.publicUrl;
  return { path, url: pub };
}

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const INT0=new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const fmt=n=>isFinite(n)?INT0.format(Math.round(n)):'‚Äî';
const bytes=n=>n<1024? n+' B' : n<1048576? (n/1024).toFixed(1)+' KB' : n<1073741824? (n/1048576).toFixed(1)+' MB' : (n/1073741824).toFixed(1)+' GB';
const uid=()=> 'ID_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2);
function esc(s){return (s||'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms||180); }; }

/* ===== clients ===== */
function loadClients(){
  try{ const a=JSON.parse(localStorage.getItem('arkon_clients_v1')||'[]'); return Array.isArray(a)?a:[]; }catch{ return []; }
}

/* ===== IndexedDB: files ===== */
let db;
function dbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('arkonCRM_local',3);
    r.onupgradeneeded=()=>{const d=r.result;
      let store;
      if(!d.objectStoreNames.contains('files')){
        store=d.createObjectStore('files',{keyPath:'id'});
      }else{
        store=r.transaction.objectStore('files');
      }
      if(!store.indexNames.contains('byClient')) store.createIndex('byClient','clientId',{unique:false});
      if(!store.indexNames.contains('byDate'))   store.createIndex('byDate','at',{unique:false});
    };
    r.onsuccess=()=>{db=r.result; res();};
    r.onerror=()=>rej(r.error);
  });
}
function dbPut(o){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').put(o); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}
function dbGet(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly'); const rq=tx.objectStore('files').get(id); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);});}
function dbAllForClient(clientId){
  return new Promise((res,rej)=>{
    const tx=db.transaction('files','readonly'); const st=tx.objectStore('files'); const idx=st.index('byClient');
    const rq=idx.getAll(IDBKeyRange.only(clientId||'')); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error);
  });
}
function dbDel(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}

/* ===== state ===== */
let currentClientId = '';
let fileFilter={q:'',cat:''};

/* ===== UI fill ===== */
function fillClients(){
  const list=loadClients();
  const opts = '<option value="">(wybierz klienta)</option>' + list.map(c=>`<option value="${esc(c.id)}">${esc(c.name||'')}</option>`).join('');
  ['selClient','offClient','flyClient'].forEach(id=>{ const el=document.getElementById(id); if(el) el.innerHTML=opts; });
}

/* ===== handle files ===== */
async function handleFiles(files){
  if(!currentClientId){ alert('Wybierz najpierw klienta.'); return; }
  const client = loadClients().find(c=>c.id===currentClientId);
  const clientName = client?.name || '';
  const category = $('#selCat').value||'Inne';
  const tags = $('#tags').value||'';
  const toCloud = !!$('#toCloud')?.checked;
  const allowOverwrite = !!$('#allowOverwrite')?.checked;

  for(const f of Array.from(files||[])){
    const id=uid();
    await dbPut({
      id, clientId: currentClientId, clientName,
      name:f.name, type:f.type||'application/octet-stream', size:f.size,
      blob:f, at: Date.now(), category, tags
    });

    if(toCloud && CLOUD.ok){
      try{
        const up = await uploadToSupabase({
          file: f, clientId: currentClientId,
          meta: { category, tags, kind: (category==='Ulotka'?'flyer':'file') }, upsert: allowOverwrite
        });
        const rec = await dbGet(id);
        await dbPut({...rec, cloudUrl: up.url, cloudPath: up.path});
      }catch(e){ console.warn('Upload do chmury nieudany:', e); }
    }
  }
  renderFiles();
}

/* ===== render list (by client) ===== */
async function renderFiles(){
  const tb=$('#tbFiles');
  if(!currentClientId){ tb.innerHTML='<tr><td colspan="8" class="empty">Wybierz klienta</td></tr>'; $('#filesVis').textContent='0'; $('#fCat').innerHTML='<option value="">Kategoria (wszystkie)</option>'; return; }
  const list = await dbAllForClient(currentClientId);
  const q=(fileFilter.q||'').toLowerCase(); const cat=fileFilter.cat||'';
  tb.innerHTML='';

  const cats = [...new Set(list.map(r=>r.category||'').filter(Boolean))];
  $('#fCat').innerHTML = '<option value="">Kategoria (wszystkie)</option>' + cats.map(c=>`<option ${c===cat?'selected':''}>${esc(c)}</option>`).join('');

  let vis=0;
  list.sort((a,b)=>(b.at||0)-(a.at||0))
    .filter(x=>{
      if(cat && x.category!==cat) return false;
      const hay=[x.name,x.category,x.tags].join(' ').toLowerCase();
      return !q || hay.includes(q);
    })
    .forEach(rec=>{
      vis++;
      const when=rec.at? new Date(rec.at).toLocaleString('pl-PL') : '';
      const cloud = rec.cloudUrl ? `<a class="btn ghost" href="${esc(rec.cloudUrl)}" target="_blank" rel="noopener">Link</a>` : '<span class="small">‚Äî</span>';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="row">
          <button class="btn ghost" data-dl="${rec.id}">Pobierz</button>
          <button class="btn bad" data-del="${rec.id}">Usu≈Ñ</button>
        </td>
        <td>${esc(rec.name)}</td>
        <td>${esc(rec.category||'')}</td>
        <td>${esc(rec.tags||'')}</td>
        <td>${esc(rec.type||'')}</td>
        <td>${bytes(rec.size||0)}</td>
        <td>${when}</td>
        <td>${cloud}</td>`;
      tb.appendChild(tr);
    });

  if(!vis){ tb.innerHTML='<tr><td colspan="8" class="empty">Brak plik√≥w. Dodaj z g√≥ry lub przeciƒÖgnij tutaj.</td></tr>'; }
  $('#filesVis').textContent=String(vis);

  tb.querySelectorAll('[data-dl]').forEach(b=>b.addEventListener('click',async ()=>{
    const rec=await dbGet(b.dataset.dl); if(!rec){ alert('Plik niedostƒôpny.'); return; }
    const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1200);
  }));
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',async ()=>{
    if(!confirm('UsunƒÖƒá plik z bazy lokalnej?')) return; await dbDel(b.dataset.del); renderFiles();
  }));
}

/* ===== Cloud list for selected client ===== */
function currentPrefix(){
  const extraPref  = ($('#cloudPrefix').value||'').trim().replace(/^\/+|\/+$/g,'');
  let prefix = currentClientId ? `clients/${currentClientId}/` : '';
  if(extraPref){ prefix += extraPref.endsWith('/') ? extraPref : (extraPref + '/'); }
  return prefix;
}
async function renderCloudList(){
  const body = $('#cloudBody'); body.innerHTML='';
  if(!CLOUD.ok){ body.innerHTML='<tr><td colspan="4">Chmura niedostƒôpna</td></tr>'; $('#cloudCount').textContent='0'; return; }
  const prefix = currentPrefix();
  const { data, error } = await supa.storage.from(CLOUD.bucket).list(prefix, { limit: 1000, offset: 0, sortBy:{ column:'name', order:'asc' } });
  if(error){ body.innerHTML=`<tr><td colspan="4">B≈ÇƒÖd: ${esc(error.message||String(error))}</td></tr>`; $('#cloudCount').textContent='0'; return; }
  let count=0;
  for(const it of (data||[])){
    if(it.id){
      count++;
      const fullPath = (prefix||'') + it.name;
      const url = supa.storage.from(CLOUD.bucket).getPublicUrl(fullPath).data.publicUrl + '?v=' + Date.now();
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="row"><a class="btn ghost" href="${url}" target="_blank" rel="noopener">Link</a>
          <button class="btn bad" data-cloud-del="${esc(fullPath)}">Usu≈Ñ</button></td>
        <td>${esc(fullPath)}</td>
        <td>${bytes(it.metadata?.size || 0)}</td>
        <td>${new Date(it.updated_at || Date.now()).toLocaleString('pl-PL')}</td>`;
      body.appendChild(tr);
    }
  }
  if(count===0){ body.innerHTML = `<tr><td colspan="4">Brak plik√≥w dla prefixu: <code>${esc(prefix||'/')}</code></td></tr>`; }
  $('#cloudCount').textContent = String(count);
  body.querySelectorAll('[data-cloud-del]').forEach(b=>b.addEventListener('click', async ()=>{
    const p=b.dataset.cloudDel;
    if(!confirm(`UsunƒÖƒá z chmury?\n${p}`)) return;
    const { error } = await supa.storage.from(CLOUD.bucket).remove([p]);
    if(error) alert('B≈ÇƒÖd: '+(error.message||String(error)));
    renderCloudList();
  }));
}

/* ===== OFFERS ===== */
const LS_OFFERS = 'arkon_offers_v1';
function loadOffers(){ try{ return JSON.parse(localStorage.getItem(LS_OFFERS)||'[]'); }catch{ return []; } }
function saveOffers(list){ localStorage.setItem(LS_OFFERS, JSON.stringify(list)); }
let offers = loadOffers();
let curItems = []; let curOfferId = null;
function offerSum(items){ return items.reduce((a,it)=> a + ((+it.price||0) * (+it.qty||0) * (1 - (+it.disc||0)/100)), 0); }
function refreshOfferCounters(){ $('#cntItems').textContent = curItems.length; $('#sumItems').textContent = fmt(offerSum(curItems))+' z≈Ç'; }
function renderOfferEditor(){
  const tb = $('#offBody'); tb.innerHTML='';
  curItems.forEach((it,i)=>{
    const lineTotal = ( (+it.price||0) * (+it.qty||0) * (1-(+it.disc||0)/100) );
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="row">
        <button class="btn ghost" data-up="${i}">‚Üë</button>
        <button class="btn ghost" data-down="${i}">‚Üì</button>
        <button class="btn bad" data-del="${i}">Usu≈Ñ</button>
      </td>
      <td><select data-k="cat" data-i="${i}">
        ${['PV','Pompa','Piec','Ocieplenie','Stolarka','Inne'].map(x=>`<option ${it.cat===x?'selected':''}>${x}</option>`).join('')}
      </select></td>
      <td><input data-k="mm" data-i="${i}" placeholder="Marka/Model" value="${esc(it.mm||'')}"></td>
      <td><input data-k="spec" data-i="${i}" placeholder="Specyfikacja" value="${esc(it.spec||'')}"></td>
      <td><input data-k="qty" data-i="${i}" type="number" step="1" min="0" value="${it.qty||1}"></td>
      <td><input data-k="price" data-i="${i}" type="number" step="1" min="0" value="${it.price||0}"></td>
      <td><input data-k="disc" data-i="${i}" type="number" step="0.1" min="0" value="${it.disc||0}"></td>
      <td>${fmt(lineTotal)} z≈Ç</td>`;
    tb.appendChild(tr);
  });
  refreshOfferCounters();
  tb.querySelectorAll('input,select').forEach(el=>{
    const i=+el.dataset.i, k=el.dataset.k;
    el.addEventListener('input', debounce(()=>{
      let v=el.value; if(['qty','price','disc'].includes(k)) v=Number(v)||0;
      if(k==='mm'){ curItems[i].mm=v; }
      else if(k==='spec'){ curItems[i].spec=v; }
      else curItems[i][k]=v;
      renderOfferEditor();
    },120));
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{ curItems.splice(+b.dataset.del,1); renderOfferEditor(); }));
  tb.querySelectorAll('[data-up]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.up; if(i>0){[curItems[i-1],curItems[i]]=[curItems[i],curItems[i-1]]; renderOfferEditor(); }}));
  tb.querySelectorAll('[data-down]').forEach(b=>b.addEventListener('click',()=>{ const i=+b.dataset.down; if(i<curItems.length-1){[curItems[i+1],curItems[i]]=[curItems[i],curItems[i+1]]; renderOfferEditor(); }}));
}
function newOffer(){ curOfferId = null; curItems = []; $('#offTitle').value = $('#offTitle').value || 'Oferta'; renderOfferEditor(); }
function saveOffer(){
  const clientId = $('#offClient').value || '';
  const title = $('#offTitle').value.trim() || 'Oferta';
  if(!clientId){ alert('Wybierz klienta.'); return; }
  const rec = { id: curOfferId || uid(), clientId, title, at: Date.now(), items: curItems.slice() };
  const i = offers.findIndex(o=>o.id===rec.id);
  if(i>=0) offers[i]=rec; else offers.unshift(rec);
  saveOffers(offers);
  curOfferId = rec.id;
  renderOfferList();
  alert('Zapisano ofertƒô.');
}
function renderOfferList(){
  const q=($('#offQ')?.value||'').toLowerCase();
  const tb=$('#offList'); tb.innerHTML='';
  const clients=loadClients();
  const clientName = id => clients.find(c=>c.id===id)?.name||'';
  $('#cntOffers').textContent = offers.length;
  offers
    .filter(o=> !q || (o.title||'').toLowerCase().includes(q) || clientName(o.clientId).toLowerCase().includes(q) )
    .sort((a,b)=>(b.at||0)-(a.at||0))
    .forEach(o=>{
      const sum = offerSum(o.items||[]);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="row">
          <button class="btn" data-open="${o.id}">Otw√≥rz</button>
          <button class="btn ghost" data-json="${o.id}">JSON</button>
          <button class="btn bad" data-del="${o.id}">Usu≈Ñ</button>
        </td>
        <td>${esc(o.title||'Oferta')}</td>
        <td>${esc(clientName(o.clientId))}</td>
        <td>${(o.items||[]).length}</td>
        <td>${fmt(sum)} z≈Ç</td>
        <td>${new Date(o.at||Date.now()).toLocaleString('pl-PL')}</td>`;
      tb.appendChild(tr);
    });
  tb.querySelectorAll('[data-open]').forEach(b=>b.addEventListener('click',()=>{
    const o=offers.find(x=>x.id===b.dataset.open); if(!o) return;
    curOfferId=o.id; $('#offClient').value=o.clientId; $('#offTitle').value=o.title||'Oferta'; curItems = (o.items||[]).map(x=>({...x})); renderOfferEditor();
  }));
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
    if(!confirm('UsunƒÖƒá ofertƒô?')) return; offers=offers.filter(x=>x.id!==b.dataset.del); saveOffers(offers); renderOfferList();
  }));
  tb.querySelectorAll('[data-json]').forEach(b=>b.addEventListener('click',()=>{
    const o=offers.find(x=>x.id===b.dataset.json); if(!o) return;
    const a=document.createElement('a'); const blob=new Blob([JSON.stringify(o,null,2)],{type:'application/json'});
    a.href=URL.createObjectURL(blob); a.download=(o.title||'oferta')+'.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  }));
}

/* ===== Flyers (ulotki) ===== */
const LS_FLY = 'arkon_flyers_v1';
function loadFlyers(){ try{ return JSON.parse(localStorage.getItem(LS_FLY)||'[]'); }catch{ return []; } }
function saveFlyers(list){ localStorage.setItem(LS_FLY, JSON.stringify(list)); }
let flyers = loadFlyers();
let flyerPendingFile = null;
$('#flyFile')?.addEventListener('change',e=>{
  const f=e.target.files[0]; flyerPendingFile = f || null;
});
async function addFlyer(){
  const clientId = $('#flyClient').value || '';
  const title = $('#flyTitle').value.trim() || 'Ulotka';
  const source = $('#flySource').value.trim() || '';
  let fileId='', fileName='', cloudUrl='', cloudPath='';
  if(flyerPendingFile){
    fileId = uid();
    fileName = flyerPendingFile.name;
    await dbPut({ id:fileId, name:fileName, type: flyerPendingFile.type||'application/octet-stream', size: flyerPendingFile.size, blob: flyerPendingFile, at: Date.now(), category:'Ulotka', clientId, clientName: clientId? (loadClients().find(c=>c.id===clientId)?.name||'') : '', origin:'flyer', tags:'ulotka' });
    if(CLOUD.ok){
      try{
        const up = await uploadToSupabase({ file: flyerPendingFile, clientId, meta:{ category:'Ulotka', tags:'ulotka', kind:'flyer' }, upsert:false });
        cloudUrl = up.url; cloudPath = up.path;
      }catch(e){ console.warn('Upload ulotki do chmury nieudany:', e); }
    }
    flyerPendingFile = null; $('#flyFile').value='';
  }
  const rec = { id:uid(), clientId, title, source, at:Date.now(), fileId, fileName, cloudUrl, cloudPath };
  flyers.unshift(rec); saveFlyers(flyers); renderFlyers();
  $('#flyTitle').value=''; $('#flySource').value='';
}
function renderFlyers(){
  const tb=$('#flyBody'); tb.innerHTML='';
  const clients=loadClients();
  const name=id=> clients.find(c=>c.id===id)?.name||'';
  flyers.forEach(f=>{
    const urlBusted = f.cloudUrl ? f.cloudUrl + '?v=' + Date.now() : '';
    const cloudLink = f.cloudUrl ? `<a class="btn ghost" href="${esc(urlBusted)}" target="_blank" rel="noopener">Link</a>` : '';
    const cloudDel  = f.cloudPath ? `<button class="btn bad" data-fly-delcloud="${esc(f.cloudPath)}">Usu≈Ñ z chmury</button>` : '';
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="row">
        <button class="btn ghost" data-dl="${f.fileId||''}" ${f.fileId?'':'disabled'}>Pobierz lokalnie</button>
        ${cloudDel}
        <button class="btn bad" data-del="${f.id}">Usu≈Ñ rekord</button>
      </td>
      <td>${esc(f.title)}</td>
      <td>${esc(name(f.clientId))}</td>
      <td>${esc(f.source||'')}</td>
      <td>${esc(f.fileName||'‚Äî')}</td>
      <td class="row">${cloudLink}</td>
      <td>${new Date(f.at||Date.now()).toLocaleString('pl-PL')}</td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click',()=>{
    if(!confirm('UsunƒÖƒá wpis ulotki?')) return;
    flyers = flyers.filter(x=>x.id!==b.dataset.del);
    saveFlyers(flyers); renderFlyers();
  }));
  tb.querySelectorAll('[data-dl]').forEach(b=>b.addEventListener('click', async ()=>{
    const id=b.dataset.dl; if(!id) return;
    const rec=await dbGet(id); if(!rec){ alert('Plik lokalny niedostƒôpny.'); return; }
    const url=URL.createObjectURL(rec.blob); const a=document.createElement('a'); a.href=url; a.download=rec.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1500);
  }));
  tb.querySelectorAll('[data-fly-delcloud]').forEach(b=>b.addEventListener('click', async ()=>{
    const path=b.dataset.flyDelcloud;
    if(!confirm(`UsunƒÖƒá ulotkƒô z chmury?\n${path}`)) return;
    try{ await supa.storage.from(CLOUD.bucket).remove([path]); alert('Ulotka usuniƒôta z chmury.'); }catch(e){ alert('B≈ÇƒÖd: '+(e?.message||e)); }
    renderCloudList();
  }));
}
$('#flyAdd')?.addEventListener('click', addFlyer);

/* ===== INIT ===== */
(async function init(){
  await dbOpen();
  fillClients();

  const sp=new URLSearchParams(location.search);
  const cid=sp.get('client'); if(cid){ $('#selClient').value=cid; currentClientId=cid; }

  $('#selClient').addEventListener('change', e=>{ currentClientId = e.target.value||''; renderFiles(); renderCloudList(); });
  $('#btnRefresh').addEventListener('click',()=>{ renderFiles(); renderCloudList(); });

  const dz=$('#drop');
  dz.addEventListener('click',()=>$('#inFiles').click());
  dz.addEventListener('dragover',e=>{e.preventDefault(); dz.classList.add('drag')});
  dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
  dz.addEventListener('drop',e=>{e.preventDefault(); dz.classList.remove('drag'); handleFiles(e.dataTransfer.files);});
  $('#inFiles').addEventListener('change',e=>{ handleFiles(e.target.files); e.target.value=''; });

  $('#qFiles').addEventListener('input', e=>{ fileFilter.q=e.target.value.trim(); renderFiles(); });
  $('#fCat').addEventListener('change', e=>{ fileFilter.cat=e.target.value||''; renderFiles(); });

  // Oferty
  $('#offAddRow')?.addEventListener('click', ()=>{ curItems.push({cat:'Inne',mm:'',spec:'',qty:1,price:0,disc:0}); renderOfferEditor(); });
  $('#offSave')?.addEventListener('click', saveOffer);
  $('#offNew')?.addEventListener('click', newOffer);
  $('#offExport')?.addEventListener('click', ()=>{ const a=document.createElement('a'); const blob=new Blob([JSON.stringify(offers,null,2)],{type:'application/json'}); a.href=URL.createObjectURL(blob); a.download='offers.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); });
  $('#offImport')?.addEventListener('change', async (e)=>{ const f=e.target.files[0]; if(!f) return; const txt=await f.text(); try{ const arr=JSON.parse(txt); if(Array.isArray(arr)){ offers=arr; saveOffers(offers); renderOfferList(); } }catch{} e.target.value=''; });
  renderOfferEditor(); renderOfferList();

  // Chmura
  await supaPing();
  renderFiles(); renderCloudList();

  // Ulotki
  renderFlyers();

  // Szybkie skr√≥ty
  document.addEventListener('keydown',e=>{
    if(e.key==='/' && !/input|textarea|select/i.test(e.target.tagName)){ e.preventDefault(); $('#qFiles')?.focus(); }
  });
})();
</script>
</body>
</html>
