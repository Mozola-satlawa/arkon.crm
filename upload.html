<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Przesy≈Ç dokument√≥w ¬∑ ARKON (Netlify Blobs)</title>
<meta name="description" content="Wysy≈Çanie dokument√≥w do magazynu Netlify Blobs.">
<style>
  :root{
    --bg:#0b1020;--p1:#101735;--p2:#121a38;--ink:#e7ecff;--muted:#aeb8da;--line:#223066;
    --ok:#2fbf71;--bad:#ff6b6b;--warn:#ffb84d;--chip:#0d1530;--field:#0e1330;--accent:#67a1ff;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  header{padding:18px 16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  .wrap{max-width:1200px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px;margin:0 0 16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2e925e}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  input,select{background:var(--field);border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:9px;border-bottom:1px solid #22325f;text-align:left;vertical-align:top}
  .small{font-size:12px;color:var(--muted)}
  .bar{height:8px;border-radius:6px;background:#16224b;overflow:hidden}
  .bar>i{display:block;height:100%;background:linear-gradient(90deg,#3d67ff,#4effd4)}
  .tag{display:inline-block;margin:2px 6px 0 0;padding:3px 8px;border:1px solid #3a4ca3;border-radius:999px;font-size:12px}
  .hl{outline:2px solid #67a1ff55}
</style>
</head>
<body>
<header>
  <h1>Przesy≈Ç dokument√≥w ¬∑ <span style="opacity:.8">ARKON (Netlify Blobs)</span></h1>
  <div class="small">Pliki ‚Üí idƒÖ do chmury Netlify (foldery <code>upload/&lt;klient&gt;</code>). Bez kluczy, bez konfiguracji serwer√≥w.</div>
</header>

<div class="wrap">
  <!-- PANEL WYSY≈ÅKI -->
  <section class="card">
    <h2 style="margin:0 0 10px">Wysy≈Çka plik√≥w</h2>
    <div class="row" style="margin-bottom:8px">
      <select id="selClient" title="Klient" style="min-width:240px"></select>
      <select id="selCat">
        <option>Umowa z firmƒÖ</option>
        <option>Audyt</option>
        <option>Dokument do audytu Czyste Powietrze</option>
        <option>Audyt rozprowadzenia instalacji</option>
        <option>Pomiary budynku</option>
        <option>Rzut budynku</option>
        <option>Zdjƒôcia kot≈Çowni</option>
        <option>Faktura za prƒÖd</option>
        <option>Zdjƒôcia falownika</option>
        <option>Zdjƒôcia budynku</option>
        <option>Oferta (PDF)</option>
        <option>Ulotka</option>
        <option>Inne</option>
      </select>
      <input id="tags" placeholder="tagi, przecinkami" style="min-width:220px">
      <label class="btn">Dodaj pliki‚Ä¶ <input id="inFiles" type="file" multiple hidden></label>
      <button id="btnSend" class="btn ok">Wy≈õlij teraz</button>
      <span id="cloud" class="pill">Chmura: <b id="cloudState">gotowe</b></span>
    </div>

    <div id="drop" class="card" style="padding:12px;border-style:dashed">
      PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij ‚ÄûDodaj pliki‚Ä¶‚Äù
      <div class="small" style="margin-top:6px">Gotowe do wysy≈Çania.</div>
    </div>

    <div id="prog" class="card" style="display:none">
      <div class="row"><span class="pill">Trwa wysy≈Çka‚Ä¶</span><span id="pTxt" class="small"></span></div>
      <div class="bar" style="margin-top:8px"><i id="pBar" style="width:0%"></i></div>
    </div>
  </section>

  <!-- PODGLƒÑD OSTATNIEGO WYSY≈ÅANIA -->
  <section class="card">
    <h2 style="margin:0 0 8px">PodglƒÖd ostatniego wysy≈Çania</h2>
    <div class="small" style="margin:6px 0">Linki publiczne idƒÖ przez funkcjƒô, np. <code>/.netlify/functions/upload?get=1&amp;key=...</code></div>
    <div class="scroll">
      <table class="table">
        <thead><tr><th>Plik</th><th>Rozmiar</th><th>Typ</th><th>URL</th></tr></thead>
        <tbody id="last"></tbody>
      </table>
    </div>
  </section>

  <!-- MAGAZYN: LISTA WSZYSTKICH -->
  <section class="card">
    <h2 style="margin:0 0 8px">Magazyn (wszystkie przes≈Çane)</h2>
    <div class="row" style="margin-bottom:8px">
      <input id="q" placeholder="üîé filtr: nazwa/typ/klient/kategoria/tag" style="min-width:280px">
      <button id="btnReload" class="btn ghost">Od≈õwie≈º</button>
      <span class="pill">Widocznych: <b id="vis">0</b></span>
    </div>
    <div class="scroll" style="max-height:380px">
      <table class="table">
        <thead>
          <tr>
            <th>Plik</th><th>Klient</th><th>Kategoria</th><th>Tagi</th>
            <th>Typ</th><th>Rozmiar</th><th>Data</th><th>Akcja</th>
          </tr>
        </thead>
        <tbody id="store"></tbody>
      </table>
    </div>
  </section>
</div>

<script>
'use strict';

/* ===== helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const INT0=new Intl.NumberFormat('pl-PL',{maximumFractionDigits:0});
const bytes=n=>n<1024? n+' B' : n<1048576? (n/1024).toFixed(1)+' KB' : n<1073741824? (n/1048576).toFixed(1)+' MB' : (n/1073741824).toFixed(1)+' GB';
const fmtDate=ms=> new Date(ms).toLocaleString('pl-PL');
const esc=s=>(s||'').toString().replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

/* ===== przyk≈Çadowi klienci z localStorage (je≈õli nie masz strony ‚Äûklienci.html‚Äù) ===== */
function loadClients(){
  try{ const a=JSON.parse(localStorage.getItem('arkon_clients_v2')||'[]'); if(Array.isArray(a)&&a.length) return a; }catch{}
  try{ const a=JSON.parse(localStorage.getItem('arkon_clients_v1')||'[]'); if(Array.isArray(a)&&a.length) return a; }catch{}
  // fallback demo:
  return [
    {id:'KLIENT_001', name:'Firma Kowalski'},
    {id:'KLIENT_002', name:'Pani Anna'},
    {id:'KLIENT_003', name:'Sp√≥≈Çka XYZ'}
  ];
}
function fillClients(){
  const sel=$('#selClient');
  const list=loadClients();
  sel.innerHTML = '<option value="">(bez przypisania)</option>' +
    list.map(c=><option value="${esc(c.id)}">${esc(c.name)}</option>).join('');
}

/* ===== stan wysy≈Çki ===== */
let pendingFiles = [];

function setCloudState(txt, ok=null){
  $('#cloudState').textContent = txt;
  const pill = $('#cloud');
  if(ok===true){ pill.style.borderColor='#2e925e'; pill.style.background='#0f2c22'; }
  else if(ok===false){ pill.style.borderColor='#7b3341'; pill.style.background='#2e1117'; }
  else { pill.style.borderColor='#2a3a77'; pill.style.background='#0d1530'; }
}
function showProg(ratio, txt){
  $('#prog').style.display='block';
  $('#pBar').style.width = Math.max(0, Math.min(100, ratio*100)) + '%';
  $('#pTxt').textContent = txt || '';
  if(ratio>=1) setTimeout(()=>$('#prog').style.display='none', 600);
}

/* ===== upload jednego pliku ===== */
async function uploadOne(file,{clientId,clientName,category,tags}){
  const res = await fetch('/.netlify/functions/upload', {
    method:'POST',
    headers:{
      'Content-Type': file.type || 'application/octet-stream',
      'x-file-name': encodeURIComponent(file.name),
      'x-client-id': encodeURIComponent(clientId||''),
      'x-client-name': encodeURIComponent(clientName||''),
      'x-category': encodeURIComponent(category||''),
      'x-tags': encodeURIComponent(tags||'')
    },
    body:file
  });
  if(!res.ok){
    const t = await res.text().catch(()=>res.statusText);
    throw new Error('Upload HTTP '+res.status+': '+t);
  }
  return await res.json();
}

/* ===== wysy≈Çka wielu plik√≥w ===== */
async function sendAll(){
  const clientId = $('#selClient').value || '';
  const clientName = clientId ? (loadClients().find(c=>c.id===clientId)?.name||'') : '';
  const category = $('#selCat').value || 'Inne';
  const tags = $('#tags').value || '';

  if(!pendingFiles.length){ alert('Najpierw dodaj pliki.'); return; }

  setCloudState('wysy≈Çanie‚Ä¶');
  let done=0, okCount=0, lastRows=[];
  for(const f of pendingFiles){
    try{
      const out = await uploadOne(f,{clientId,clientName,category,tags});
      okCount++;
      lastRows.push(out);
      done++;
      showProg(done/pendingFiles.length, Wys≈Çano ${done}/${pendingFiles.length}‚Ä¶);
    }catch(e){
      console.error('B≈ÇƒÖd wysy≈Çki:', e);
      done++;
      showProg(done/pendingFiles.length, B≈ÇƒÖd: ${e.message});
      setCloudState('b≈ÇƒÖd', false);
    }
  }
  setCloudState(okCount ? 'gotowe ‚úì' : 'b≈ÇƒÖd', !!okCount);
  renderLast(lastRows);
  pendingFiles = [];
  $('#inFiles').value='';
}

/* ===== render tabeli ‚Äûostatnie wysy≈Çanie‚Äù ===== */
function renderLast(rows){
  const tb=$('#last'); tb.innerHTML='';
  if(!rows?.length){
    tb.innerHTML = <tr><td colspan="4" class="small">Brak (jeszcze nic nie wys≈Çano)</td></tr>;
    return;
  }
  rows.forEach(r=>{
    const a = document.createElement('tr');
    a.innerHTML = `
      <td>${esc(r.key.split('/').slice(-1)[0])}</td>
      <td>${bytes(r.size||0)}</td>
      <td>${esc(r.contentType||'')}</td>
      <td><a href="${esc(r.viewUrl)}" target="_blank" rel="noopener">otw√≥rz</a></td>`;
    tb.appendChild(a);
  });
}

/* ===== ‚Äûmagazyn‚Äù ‚Äì lista z indexu ===== */
async function reloadStore(){
  const res = await fetch('/.netlify/functions/upload?list=1');
  const js = await res.json();
  const list = Array.isArray(js.rows)? js.rows : [];
  const q = ($('#q').value||'').toLowerCase();
  const tb=$('#store'); tb.innerHTML='';
  let vis=0;
  list.forEach(r=>{
    const hay = [r.key, r.clientName, r.category, r.tags, r.contentType].join(' ').toLowerCase();
    if(q && !hay.includes(q)) return;
    vis++;
    const name = r.key.split('/').slice(-1)[0];
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(name)}</td>
      <td>${esc(r.clientName||'')}</td>
      <td>${esc(r.category||'')}</td>
      <td>${(r.tags||'').split(',').filter(Boolean).map(t=><span class="tag">${esc(t.trim())}</span>).join('')}</td>
      <td>${esc(r.contentType||'')}</td>
      <td>${bytes(r.size||0)}</td>
      <td>${fmtDate(r.at||Date.now())}</td>
      <td><a href="/.netlify/functions/upload?get=1&key=${encodeURIComponent(r.key)}" target="_blank" rel="noopener">otw√≥rz</a></td>`;
    tb.appendChild(tr);
  });
  $('#vis').textContent = vis;
}

/* ===== init ===== */
(function init(){
  fillClients();

  $('#inFiles').addEventListener('change', e=>{
    pendingFiles = Array.from(e.target.files||[]);
    $('#drop').classList.add('hl');
    setTimeout(()=>$('#drop').classList.remove('hl'),400);
  });
  $('#btnSend').addEventListener('click', sendAll);

  // Drag & Drop
  const box = $('#drop');
  ;['dragenter','dragover'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.classList.add('hl'); }));
  ;['dragleave','drop'].forEach(ev=> box.addEventListener(ev, e=>{ e.preventDefault(); box.classList.remove('hl'); }));
  box.addEventListener('drop', e=>{
    const files = Array.from(e.dataTransfer?.files||[]);
    pendingFiles = pendingFiles.concat(files);
  });

  $('#btnReload').addEventListener('click', reloadStore);
  $('#q').addEventListener('input', ()=>reloadStore());

  // test funkcji (opcjonalnie)
  fetch('/.netlify/functions/upload?ping=1').then(r=>r.ok? setCloudState('gotowe') : setCloudState('b≈ÇƒÖd',false)).catch(()=>setCloudState('b≈ÇƒÖd',false));

  renderLast([]); // pusty start
  reloadStore();
})();
</script>
</body>
</html>
