<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>Test upload (IndexedDB)</title>
<style>
body{font-family:sans-serif;background:#0b1020;color:#eee;padding:20px}
.card{background:#121a38;padding:14px;border-radius:10px}
.btn{padding:6px 12px;border:1px solid #3a4ca3;background:#233261;color:#fff;border-radius:6px;cursor:pointer}
.table{width:100%;border-collapse:collapse;margin-top:12px}
.table th,.table td{border:1px solid #334;padding:6px}
</style>
</head>
<body>
<h1>Test zapisu plików w IndexedDB</h1>

<div class="card">
  <label class="btn">Dodaj plik<input id="inFile" type="file" hidden></label>
  <button class="btn" onclick="renderFiles()">Odśwież listę</button>

  <table class="table">
    <thead><tr><th>Akcje</th><th>Nazwa</th><th>Typ</th><th>Rozmiar</th><th>Data</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>

<script>
let db;
const uid=()=> 'ID_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2);
const bytes=n=>n<1024? n+' B':n<1048576?(n/1024).toFixed(1)+' KB':(n/1048576).toFixed(1)+' MB';

function dbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('arkonCRM_test',1);
    r.onupgradeneeded=()=>{const d=r.result;
      if(!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'id'});
    };
    r.onsuccess=()=>{db=r.result;res();};
    r.onerror=()=>rej(r.error);
  });
}
function dbPut(o){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite');tx.objectStore('files').put(o);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}
function dbGetAll(){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly');const rq=tx.objectStore('files').getAll();rq.onsuccess=()=>res(rq.result||[]);rq.onerror=()=>rej(rq.error);});}
function dbGet(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly');const rq=tx.objectStore('files').get(id);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>rej(rq.error);});}
function dbDel(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite');tx.objectStore('files').delete(id);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error);});}

async function handleFile(file){
  const rec={id:uid(),name:file.name,type:file.type,size:file.size,blob:file,at:Date.now()};
  await dbPut(rec);
  renderFiles();
}

async function renderFiles(){
  const list=await dbGetAll();
  const tb=document.getElementById('tb'); tb.innerHTML='';
  list.sort((a,b)=>b.at-a.at).forEach(rec=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>
        <button onclick="downloadFile('${rec.id}')">⬇</button>
        <button onclick="deleteFile('${rec.id}')">❌</button>
      </td>
      <td>${rec.name}</td>
      <td>${rec.type}</td>
      <td>${bytes(rec.size)}</td>
      <td>${new Date(rec.at).toLocaleString()}</td>`;
    tb.appendChild(tr);
  });
}

async function downloadFile(id){
  const rec=await dbGet(id); if(!rec) return alert('Brak pliku');
  const url=URL.createObjectURL(rec.blob);
  const a=document.createElement('a');
  a.href=url; a.download=rec.name; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),1500);
}
async function deleteFile(id){
  await dbDel(id); renderFiles();
}

document.getElementById('inFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(f) handleFile(f);
  e.target.value='';
});

(async()=>{ await dbOpen(); renderFiles(); })();
</script>
</body>
</html>
