<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON CRM — Oferty</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- DOCX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.3.2/docx.umd.min.js"></script>

<style>
  :root{--bg:#0b1020;--p1:#0f1533;--p2:#121a38;--ink:#e7ecff;--line:#223066;--accent:#4cc9f0;--ok:#2fbf71;}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui;overflow-x:hidden}
  header{padding:16px;background:var(--p1);border-bottom:1px solid var(--line)}
  nav{display:flex;gap:8px;padding:10px;background:var(--p2);border-bottom:1px solid var(--line)}
  nav a{padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer;text-decoration:none}
  nav a.active{background:var(--accent);color:#fff}
  .page{display:none;opacity:0;transition:opacity .5s}
  .page.active{display:block;opacity:1}
  .wrap{max-width:1280px;margin:auto;padding:16px}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .btn{background:var(--accent);border:none;color:#fff;border-radius:10px;padding:8px 14px;cursor:pointer}
  .btn.ok{background:var(--ok)}.btn.bad{background:#e33}.btn.ghost{background:transparent;border:1px dashed var(--accent);color:var(--accent)}
  table{width:100%;border-collapse:collapse}td,th{padding:6px;border:1px solid var(--line)}
  th{background:#223066;color:#fff}
  .scroll{overflow:auto;max-height:260px}
  canvas{border:2px solid var(--line);border-radius:8px;background:#fff}
</style>
</head>
<body>
<header><h1>ARKON CRM — Oferty Premium</h1></header>
<nav>
  <a data-page="offers" class="active">📑 Oferty</a>
  <a data-page="logo">🏷 Logo</a>
  <a data-page="signClient">✍ Podpis Klienta</a>
  <a data-page="signRep">✍ Podpis Przedstawiciela</a>
</nav>

<div id="offers" class="page active wrap">
  <section class="card">
    <h2>📑 Oferty</h2>
    <div class="row">
      <input id="clientName" placeholder="Nazwa klienta">
      <input id="offTitle" placeholder="Tytuł oferty">
      <button id="offAdd" class="btn">+ Pozycja</button>
      <button id="offPdf" class="btn">⬇ PDF</button>
      <button id="offDocx" class="btn ghost">⬇ Word</button>
    </div>
    <div class="scroll"><table><thead><tr><th>Pozycja</th><th>Ilość</th><th>Cena</th><th>Razem</th></tr></thead><tbody id="tblOffer"></tbody></table></div>
  </section>
</div>

<div id="logo" class="page wrap">
  <section class="card">
    <h2>🏷 Logo firmy</h2>
    <div class="row">
      <input type="file" id="logoFile" accept="image/*">
      <button id="saveLogo" class="btn ok">💾 Zapisz logo</button>
    </div>
    <p>Aktualne logo:</p>
    <img id="logoPreview" src="" alt="brak" style="max-height:100px;background:#fff;padding:6px;border-radius:8px">
  </section>
</div>

<div id="signClient" class="page wrap">
  <section class="card">
    <h2>✍ Podpis Klienta</h2>
    <canvas id="signPadClient" width="400" height="150"></canvas>
    <div class="row">
      <button class="btn bad" onclick="clearPad('Client')">🗑 Wyczyść</button>
      <button class="btn ok" onclick="savePad('Client')">💾 Zapisz podpis</button>
    </div>
    <img id="signPreviewClient" src="" style="max-height:100px;background:#fff;padding:6px;border-radius:8px">
  </section>
</div>

<div id="signRep" class="page wrap">
  <section class="card">
    <h2>✍ Podpis Przedstawiciela</h2>
    <canvas id="signPadRep" width="400" height="150"></canvas>
    <div class="row">
      <button class="btn bad" onclick="clearPad('Rep')">🗑 Wyczyść</button>
      <button class="btn ok" onclick="savePad('Rep')">💾 Zapisz podpis</button>
    </div>
    <img id="signPreviewRep" src="" style="max-height:100px;background:#fff;padding:6px;border-radius:8px">
  </section>
</div>

<script>
'use strict';
const $=s=>document.querySelector(s);

/* === SPA: zmiana stron === */
document.querySelectorAll("nav a").forEach(a=>{
  a.onclick=()=>{document.querySelectorAll("nav a").forEach(x=>x.classList.remove("active"));a.classList.add("active");
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  $("#"+a.dataset.page).classList.add("active");};
});

/* === IndexedDB (logo + podpisy) === */
let db;
function dbOpen(){return new Promise(res=>{const r=indexedDB.open("arkonCRM_data",1);r.onupgradeneeded=()=>{const d=r.result;if(!d.objectStoreNames.contains("logo"))d.createObjectStore("logo");if(!d.objectStoreNames.contains("sign"))d.createObjectStore("sign");};r.onsuccess=()=>{db=r.result;res();};});}
function dbPut(store,key,val){return new Promise(res=>{const tx=db.transaction(store,"readwrite");tx.objectStore(store).put(val,key);tx.oncomplete=res;});}
function dbGet(store,key){return new Promise(res=>{const tx=db.transaction(store,"readonly");const rq=tx.objectStore(store).get(key);rq.onsuccess=()=>res(rq.result);});}

/* === Oferty === */
let curItems=[];
function renderOffer(){const tb=$("#tblOffer");tb.innerHTML="";let sum=0;curItems.forEach((it,i)=>{const rowSum=it.qty*it.price;sum+=rowSum;tb.innerHTML+=<tr><td contenteditable oninput="curItems[${i}].name=this.innerText">${it.name}</td><td><input type=number step=1 value=${it.qty} onchange="curItems[${i}].qty=this.value;renderOffer()"></td><td><input type=number step=0.01 value=${it.price} onchange="curItems[${i}].price=this.value;renderOffer()"></td><td>${rowSum.toFixed(2)}</td></tr>});tb.innerHTML+=<tr><th colspan=3>Suma</th><th>${sum.toFixed(2)}</th></tr>;localStorage.setItem("offer_autosave",JSON.stringify({client:$("#clientName").value,title:$("#offTitle").value,items:curItems}));}
$("#offAdd").onclick=()=>{curItems.push({name:"Pozycja",qty:1,price:0});renderOffer();};
window.addEventListener("load",async()=>{await dbOpen();const rec=JSON.parse(localStorage.getItem("offer_autosave")||"{}");if(rec.items){curItems=rec.items;$("#clientName").value=rec.client||"";$("#offTitle").value=rec.title||"";renderOffer();}const logo=await dbGet("logo","main");if(logo)$("#logoPreview").src=logo;const sc=await dbGet("sign","Client");if(sc)$("#signPreviewClient").src=sc;const sr=await dbGet("sign","Rep");if(sr)$("#signPreviewRep").src=sr;});

/* === Logo upload === */
$("#saveLogo").onclick=async()=>{const f=$("#logoFile").files[0];if(!f)return alert("Wybierz plik");const reader=new FileReader();reader.onload=async()=>{await dbPut("logo","main",reader.result);$("#logoPreview").src=reader.result;alert("Logo zapisane!");};reader.readAsDataURL(f);};

/* === Podpisy === */
function initPad(id){const pad=$("#signPad"+id),ctx=pad.getContext("2d");let drawing=false;pad.addEventListener("mousedown",e=>{drawing=true;ctx.moveTo(e.offsetX,e.offsetY);});pad.addEventListener("mousemove",e=>{if(drawing){ctx.lineTo(e.offsetX,e.offsetY);ctx.stroke();}});pad.addEventListener("mouseup",()=>drawing=false);}
function clearPad(id){const pad=$("#signPad"+id),ctx=pad.getContext("2d");ctx.clearRect(0,0,pad.width,pad.height);}
function savePad(id){const pad=$("#signPad"+id);const data=pad.toDataURL("image/png");dbPut("sign",id,data);$("#signPreview"+id).src=data;alert("Podpis "+id+" zapisany!");}
initPad("Client");initPad("Rep");

/* === PDF premium eksport === */
async function exportPDF(){const {jsPDF}=window.jspdf;const doc=new jsPDF();const logo=await dbGet("logo","main");if(logo){doc.addImage(logo,"PNG",15,10,25,25);doc.setFontSize(60);doc.setTextColor(200,200,200);doc.text("ARKON",60,150,{angle:45});doc.setTextColor(0);}doc.setFontSize(16);doc.text($("#offTitle").value||"Oferta",50,20);doc.setFontSize(11);doc.text("Klient: "+($("#clientName").value||"—"),50,28);doc.text("Data: "+new Date().toLocaleDateString("pl-PL"),50,34);let y=50,sum=0;doc.setFontSize(10);doc.setFillColor(34,48,102);doc.setTextColor(255);doc.rect(20,y-5,170,8,"F");doc.text("Pozycja",22,y);doc.text("Ilość",90,y);doc.text("Cena",120,y);doc.text("Razem",160,y);doc.setTextColor(0);y+=8;curItems.forEach(it=>{const r=it.qty*it.price;sum+=r;if(y>260){doc.addPage();y=20;doc.setFillColor(34,48,102);doc.setTextColor(255);doc.rect(20,y-5,170,8,"F");doc.text("Pozycja",22,y);doc.text("Ilość",90,y);doc.text("Cena",120,y);doc.text("Razem",160,y);doc.setTextColor(0);y+=8;}doc.text(it.name,22,y);doc.text(String(it.qty),90,y);doc.text(it.price.toFixed(2),120,y);doc.text(r.toFixed(2),160,y);y+=6;});doc.setFontSize(12);doc.text("SUMA: "+sum.toFixed(2)+" PLN",120,y+10);const sc=await dbGet("sign","Client");if(sc){doc.text("Podpis klienta:",20,y+30);doc.addImage(sc,"PNG",60,y+20,50,30);}const sr=await dbGet("sign","Rep");if(sr){doc.text("Podpis przedstawiciela:",20,y+70);doc.addImage(sr,"PNG",80,y+60,50,30);}doc.setFontSize(9);doc.text("ARKON Sp. z o.o. • kontakt@arkon.pl • +48 123 456 789",20,290);doc.save(($("#offTitle").value||"oferta")+".pdf");}
$("#offPdf").onclick=exportPDF;

/* === Word eksport === */
async function exportDocx(){const {Document,Packer,Paragraph,TextRun,Table,TableRow,TableCell}=window.docx;const rows=[new TableRow({children:["Pozycja","Ilość","Cena","Razem"].map(h=>new TableCell({children:[new Paragraph(h)]}))})];let sum=0;curItems.forEach(it=>{const r=it.qty*it.price;sum+=r;rows.push(new TableRow({children:[it.name,it.qty.toString(),it.price.toFixed(2),r.toFixed(2)].map(t=>new TableCell({children:[new Paragraph(t)]}))}));});rows.push(new TableRow({children:[new TableCell({children:[new Paragraph("SUMA")],columnSpan:3}),new TableCell({children:[new Paragraph(sum.toFixed(2))]})]}));const doc=new Document({sections:[{children:[new Paragraph({children:[new TextRun({text:$("#offTitle").value||"Oferta",bold:true,size:32})]}),new Paragraph("Klient: "+($("#clientName").value||"—")),new Paragraph("Data: "+new Date().toLocaleDateString("pl-PL")),new Table({rows}),new Paragraph("Podpis Klienta: _______________"),new Paragraph("Podpis Przedstawiciela: _______________")]}]});const blob=await Packer.toBlob(doc);const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=($("#offTitle").value||"oferta")+".docx";a.click();}
$("#offDocx").onclick=exportDocx;
</script>
</body>
</html>
