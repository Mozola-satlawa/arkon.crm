<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Przesy≈Ç dokument√≥w ‚Ä¢ ARKON CRM (Cloudinary)</title>
<meta name="description" content="Wysy≈Çanie dokument√≥w do chmury Cloudinary (unsigned preset) + lokalna lista w IndexedDB.">
<style>
  :root{
    --bg:#0b1020;--p1:#0f1533;--p2:#121a38;--ink:#e7ecff;--muted:#aeb8da;--line:#223066;
    --accent:#4cc9f0;--ok:#2fbf71;--bad:#ff6b6b;--warn:#ffb84d;
    --chip:#0d1530;--chip2:#152056;--field:#0e1330;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{background:linear-gradient(180deg,#0a0f1e,#0c1230 60%,#0a0f1e);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  header{padding:16px;background:#11183a;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:22px}
  nav{background:#172142;display:flex;gap:10px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--line)}
  nav a{color:#cfe1ff;text-decoration:none;padding:8px 12px;border-radius:999px;border:1px solid #2a3a75}
  nav a:hover{background:#223160}
  .wrap{max-width:1280px;margin:auto;padding:16px}
  .grid{display:grid;gap:12px}
  @media(min-width:1100px){ .cols-2{grid-template-columns:1.3fr 1fr} }
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .small{font-size:12px;color:var(--muted)}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:13px}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  .btn.ok{background:#194d34;border-color:#2e925e}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  input,select,textarea{background:var(--field);border:1px solid #28356c;border-radius:10px;padding:8px 10px;color:var(--ink);font:inherit}
  input::placeholder{color:#aeb8da99}
  .table{width:100%;border-collapse:separate;border-spacing:0}
  .table th,.table td{padding:9px;border-bottom:1px solid #22325f;text-align:left;vertical-align:top}
  .scroll{overflow:auto}
  .drop{border:2px dashed #2a3777;border-radius:10px;padding:18px;text-align:center;cursor:pointer;background:#0c1230}
  .drop.drag{background:#10183b}
  .progress{height:8px;background:#0f1a44;border:1px solid #2a3a75;border-radius:6px;overflow:hidden}
  .bar{height:100%;width:0%;background:#4d79ff;transition:width .15s linear}
  .bar.ok{background:#2fbf71}
  .bar.bad{background:#ff6b6b}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #2a3777;border-radius:999px;background:#0d1530;color:#cfe0ff}
  @media print{ nav,.btn,.drop,.right{display:none!important} .wrap{padding:0} }
</style>
</head>
<body>
<header>
  <h1>Przesy≈Ç dokument√≥w ‚Ä¢ ARKON CRM</h1>
  <div class="small">Wysy≈Çka do chmury <b>Cloudinary</b> (unsigned preset, folder: <b>upload</b>) + lokalna lista w IndexedDB.</div>
</header>

<nav>
  <a href="/">Pulpit</a>
  <a href="/upload.html">Przesy≈Ç dokument√≥w</a>
</nav>

<div class="wrap grid cols-2">
  <!-- LEWA: Przesy≈Ç + lista -->
  <section class="card">
    <h2 style="margin:0 0 8px">Wysy≈Çka</h2>
    <div class="row" style="margin-bottom:6px">
      <select id="selCat" title="Kategoria">
        <option>Umowa z firmƒÖ</option>
        <option>Audyt</option>
        <option>Dokument do audytu Czyste Powietrze</option>
        <option>Audyt rozprowadzenia instalacji</option>
        <option>Pomiary budynku</option>
        <option>Rzut budynku</option>
        <option>Zdjƒôcia kot≈Çowni</option>
        <option>Faktura za prƒÖd</option>
        <option>Zdjƒôcia falownika</option>
        <option>Zdjƒôcia budynku</option>
        <option>Oferta (PDF)</option>
        <option>Ulotka</option>
        <option>Inne</option>
      </select>
      <input id="tags" placeholder="tagi, przecinkami">
      <label class="btn">Dodaj pliki‚Ä¶ <input id="inFiles" type="file" multiple hidden></label>
      <label class="pill" style="cursor:pointer"><input id="keepLocal" type="checkbox" checked> Zapisz kopiƒô lokalnie</label>
      <label class="pill" style="cursor:pointer"><input id="showLink" type="checkbox"> Po wysy≈Çce poka≈º link</label>
      <span id="cloudState" class="pill">Chmura: sprawdzanie‚Ä¶</span>
      <button id="btnRefresh" class="btn ghost">Od≈õwie≈º</button>
    </div>

    <div id="drop" class="drop">PrzeciƒÖgnij i upu≈õƒá pliki tutaj lub kliknij ‚ÄûDodaj pliki‚Ä¶‚Äù</div>

    <div class="card" style="padding:10px;margin-top:12px">
      <div class="row" style="margin-bottom:6px">
        <input id="qFiles" placeholder="üîé filtr: nazwa/typ/kategoria/tag" style="min-width:260px">
        <select id="fCat"><option value="">Kategoria (wszystkie)</option></select>
        <button id="btnClear" class="btn ghost">Wyczy≈õƒá filtr</button>
        <span class="pill">Widocznych: <b id="filesVis">0</b></span>
        <button id="btnExport" class="btn ghost">Eksport JSON</button>
        <label class="btn ghost">Import JSON <input id="btnImport" type="file" accept="application/json" hidden></label>
      </div>
      <div class="scroll" style="max-height:360px">
        <table class="table">
          <thead><tr>
            <th>Akcje</th><th>Nazwa</th><th>Kategoria</th><th>Tagi</th><th>Typ</th><th>Rozmiar</th><th>Data</th>
          </tr></thead>
          <tbody id="tbFiles"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- PRAWA: Ustawienia + postƒôp -->
  <section class="grid">
    <div class="card">
      <h2 style="margin:0 0 8px">Ustawienia Cloudinary</h2>
      <div class="row">
        <span class="pill">Cloud name: <b id="cn">(brak)</b></span>
        <span class="pill">Upload preset: <b id="pr">(brak)</b></span>
        <span class="pill">Folder: <b id="fo">upload</b></span>
        <button id="btnTest" class="btn">Test po≈ÇƒÖczenia</button>
        <button id="btnOpenLib" class="btn ghost">Otw√≥rz Media Library</button>
      </div>
      <div id="testArea" class="small" style="margin-top:6px">Kliknij ‚ÄûTest po≈ÇƒÖczenia‚Äù, aby sprawdziƒá preset i endpoint.</div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Postƒôp bie≈ºƒÖcej wysy≈Çki</h2>
      <div id="jobs" class="grid" style="gap:8px"></div>
      <div class="small" style="margin-top:8px">
        Wskaz√≥wki: <span class="pill">/</span> ‚Äì fokus na filtr, <span class="pill">Alt+S</span> ‚Äì zapis oferty (kompat),  
        zaznacz ‚ÄûZapisz kopiƒô lokalnie‚Äù, je≈õli chcesz ponawiaƒá wysy≈Çkƒô bez ponownego wyboru.
      </div>
    </div>
  </section>
</div>

<!-- === KONFIG ‚Äì USTAW TUTAJ === -->
<script>
  // Ustaw sw√≥j cloud name i preset (unsigned)
  window.CLOUDINARY_CLOUD_NAME = "drht5dh6y";   // <- zmie≈Ñ na sw√≥j (je≈õli inny)
  window.CLOUDINARY_UPLOAD_PRESET = "arkon_crm"; // <- dok≈Çadnie jak w Cloudinary
  window.CLOUDINARY_FOLDER = "upload";          // docelowy folder
</script>

<script>
'use strict';

/* ======= KONFIG (z okienka powy≈ºej) ======= */
const CLOUD = String(window.CLOUDINARY_CLOUD_NAME || '').trim();
const PRESET = String(window.CLOUDINARY_UPLOAD_PRESET || '').trim();
const FOLDER = String(window.CLOUDINARY_FOLDER || 'upload').trim();
const ENDPOINT = CLOUD ? https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUD)}/auto/upload : '';

/* ======= Helpers ======= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const fmtBytes=n=>n<1024? n+' B' : n<1048576? (n/1024).toFixed(1)+' KB'
  : n<1073741824? (n/1048576).toFixed(1)+' MB' : (n/1073741824).toFixed(1)+' GB';
const uid=()=> 'ID_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2);

/* ======= IndexedDB (kopia lokalna ‚Äì opcjonalna) ======= */
let db;
function dbOpen(){
  return new Promise((res,rej)=>{
    const r=indexedDB.open('arkonCRM_local',2);
    r.onupgradeneeded=()=>{const d=r.result; if(!d.objectStoreNames.contains('files')) d.createObjectStore('files',{keyPath:'id'});};
    r.onsuccess=()=>{db=r.result; res();};
    r.onerror=()=>rej(r.error);
  });
}
function dbPut(o){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').put(o); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}
function dbAll(){return new Promise((res,rej)=>{const tx=db.transaction('files','readonly'); const rq=tx.objectStore('files').getAll(); rq.onsuccess=()=>res(rq.result||[]); rq.onerror=()=>rej(rq.error);});}
function dbDel(id){return new Promise((res,rej)=>{const tx=db.transaction('files','readwrite'); tx.objectStore('files').delete(id); tx.oncomplete=()=>res(); tx.onerror=()=>rej(tx.error);});}

/* ======= UI ======= */
function setCloudState(text, ok){
  const el = $('#cloudState'); if(!el) return;
  el.textContent = text;
  el.style.borderColor = ok ? '#2e925e' : '#7b3341';
  el.style.background = ok ? '#0f2c22' : '#2e1117';
}
function addJobRow(name){
  const host = $('#jobs');
  const id = uid();
  const row = document.createElement('div');
  row.className='row';
  row.innerHTML = `
    <span class="chip" style="min-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</span>
    <div class="progress" style="flex:1;min-width:180px"><div class="bar" id="bar_${id}"></div></div>
    <span class="pill" id="stat_${id}">0%</span>`;
  host.prepend(row);
  return id;
}
function jobProgress(id, pct, ok){
  const bar = document.getElementById('bar_'+id);
  const st = document.getElementById('stat_'+id);
  if(bar){ bar.style.width=Math.max(0, Math.min(100, pct))+'%'; bar.className='bar '+(ok===false?'bad':'ok'); }
  if(st){ st.textContent = (pct|0)+'%'; }
}
function jobDone(id, url){
  const st = document.getElementById('stat_'+id);
  if(st){ st.innerHTML = url ? <a href="${url}" target="_blank">otw√≥rz</a> : 'OK'; }
}

/* ======= Upload do Cloudinary (XHR z postƒôpem) ======= */
function uploadToCloudinary(file, extra){
  return new Promise((resolve, reject)=>{
    if(!ENDPOINT) return reject(new Error('Brak Cloud Name / endpointu.'));
    const xhr = new XMLHttpRequest();
    xhr.open('POST', ENDPOINT);

    xhr.upload.onprogress = (e)=>{
      if(e.lengthComputable && extra?.onProgress){
        extra.onProgress( Math.round((e.loaded/e.total)*100) );
      }
    };

    xhr.onload = ()=>{
      try{
        const data = JSON.parse(xhr.responseText);
        if(xhr.status>=200 && xhr.status<300){
          resolve(data);
        }else{
          reject(new Error(data?.error?.message || 'Upload error'));
        }
      }catch(err){
        reject(new Error('Z≈Ça odpowied≈∫ serwera (endpoint/preset?).'));
      }
    };
    xhr.onerror = ()=> reject(new Error('B≈ÇƒÖd sieci podczas uploadu'));

    const form = new FormData();
    form.append('file', file);
    form.append('upload_preset', PRESET);
    if(FOLDER) form.append('folder', FOLDER);
    if(extra?.tags) form.append('tags', extra.tags);
    if(extra?.context){
      Object.entries(extra.context).forEach(([k,v])=>{
        form.append('context', ${k}=${v});
      });
    }
    xhr.send(form);
  });
}

/* ======= Lista lokalna ======= */
let filter={q:'',cat:''};
async function renderFiles(){
  const list = await dbAll();
  const q=(filter.q||'').toLowerCase(); const cat=filter.cat||'';
  const tb=$('#tbFiles'); tb.innerHTML='';
  const cats=new Set(); list.forEach(r=>cats.add(r.category||''));
  $('#fCat').innerHTML='<option value="">Kategoria (wszystkie)</option>' + Array.from(cats).filter(Boolean).map(c=><option ${cat===c?'selected':''}>${c}</option>).join('');
  let vis=0;
  list.sort((a,b)=>(b.at||0)-(a.at||0)).forEach(rec=>{
    if(cat && (rec.category||'')!==cat) return;
    const hay=[rec.name,rec.category,rec.tags,rec.type].join(' ').toLowerCase();
    if(q && !hay.includes(q)) return;
    vis++;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="row">
        <button class="btn ghost" data-open="${rec.url||''}" ${rec.url?'':'disabled'}>Link</button>
        <button class="btn bad" data-del="${rec.id}">Usu≈Ñ</button>
      </td>
      <td>${rec.name}</td>
      <td>${rec.category||''}</td>
      <td>${rec.tags||''}</td>
      <td>${rec.type||''}</td>
      <td>${fmtBytes(rec.size||0)}</td>
      <td>${new Date(rec.at||Date.now()).toLocaleString('pl-PL')}</td>`;
    tb.appendChild(tr);
  });
  $('#filesVis').textContent=vis;

  tb.querySelectorAll('[data-open]').forEach(b=>b.addEventListener('click',()=>{
    const u=b.dataset.open; if(u) window.open(u,'_blank');
  }));
  tb.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click', async ()=>{
    if(!confirm('UsunƒÖƒá wpis lokalny?')) return;
    await dbDel(b.dataset.del); renderFiles();
  }));
}

/* ======= Obs≈Çuga plik√≥w ======= */
async function handleFiles(files){
  if(!CLOUD || !PRESET){ alert('Brak CLOUD NAME lub UPLOAD PRESET. Uzupe≈Çnij w sekcji KONFIG.'); return; }
  const category = $('#selCat').value || 'Inne';
  const tags = ($('#tags').value||'').trim();
  const keepLocal = !!$('#keepLocal')?.checked;

  for(const f of Array.from(files||[])){
    const jobId = addJobRow(f.name);
    try{
      const res = await uploadToCloudinary(f, {
        tags,
        context: { category },
        onProgress: (p)=> jobProgress(jobId, p, true)
      });
      const publicUrl = res.secure_url || res.url || '';
      jobDone(jobId, publicUrl);
      setCloudState('Chmura: po≈ÇƒÖczono ‚úì', true);

      if(keepLocal){
        await dbPut({
          id: uid(),
          name: f.name,
          size: f.size,
          type: f.type || 'application/octet-stream',
          at: Date.now(),
          category, tags,
          url: publicUrl
        });
        renderFiles();
      }
      if($('#showLink')?.checked && publicUrl) window.open(publicUrl,'_blank');
    }catch(err){
      console.error('Upload error:', err);
      jobProgress(jobId, 100, false);
      setCloudState('Chmura: b≈ÇƒÖd uploadu', false);
      alert(B≈ÇƒÖd uploadu dla "${f.name}": ${err.message||err});
    }
  }
}

/* ======= Test po≈ÇƒÖczenia ======= */
async function testCloud(){
  if(!CLOUD || !PRESET){ alert('Ustaw CLOUD NAME i PRESET w sekcji KONFIG.'); return; }
  $('#testArea').textContent='Testujƒô‚Ä¶';
  try{
    const blob=new Blob([new Uint8Array([0])],{type:'application/octet-stream'});
    const res = await uploadToCloudinary(new File([blob],'ping.bin'), { tags:'ping,arkon', context:{category:'Ping'} });
    $('#testArea').innerHTML = ‚úÖ OK ‚Äî <a href="${res.secure_url}" target="_blank">zobacz plik testowy</a>;
    setCloudState('Chmura: po≈ÇƒÖczono ‚úì', true);
  }catch(e){
    $('#testArea').textContent = '‚ùå B≈ÇƒÖd: '+(e.message||e);
    setCloudState('Chmura: b≈ÇƒÖd (preset/endpoint?)', false);
  }
}

/* ======= Init ======= */
(async function init(){
  await dbOpen();

  // nag≈Ç√≥wki statusu
  $('#cn').textContent = CLOUD || '(brak)';
  $('#pr').textContent = PRESET || '(brak)';
  $('#fo').textContent = FOLDER || '(brak)';
  setCloudState( CLOUD && PRESET ? 'Chmura: gotowe' : 'Chmura: uzupe≈Çnij konfiguracjƒô', !!(CLOUD && PRESET));

  // Drag&drop
  const drop = $('#drop');
  const input = $('#inFiles');
  drop.addEventListener('dragover',e=>{e.preventDefault(); drop.classList.add('drag');});
  drop.addEventListener('dragleave',()=>drop.classList.remove('drag'));
  drop.addEventListener('drop',e=>{e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files);});
  input.addEventListener('change',e=>{ handleFiles(e.target.files); input.value=''; });

  // Filtry listy
  $('#qFiles').addEventListener('input',e=>{ filter.q=e.target.value.trim(); renderFiles(); });
  $('#fCat').addEventListener('change',e=>{ filter.cat=e.target.value||''; renderFiles(); });
  $('#btnClear').addEventListener('click',()=>{ filter={q:'',cat:''}; $('#qFiles').value=''; $('#fCat').value=''; renderFiles(); });
  $('#btnRefresh').addEventListener('click',renderFiles);

  // Export/Import metadanych
  $('#btnExport').addEventListener('click', async ()=>{
    const list = await dbAll();
    const a=document.createElement('a');
    const blob=new Blob([JSON.stringify(list,null,2)],{type:'application/json'});
    a.href=URL.createObjectURL(blob); a.download='arkon_files.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1500);
  });
  $('#btnImport').addEventListener('change', async e=>{
    const f=e.target.files[0]; if(!f) return;
    try{
      const arr=JSON.parse(await f.text());
      if(!Array.isArray(arr)) throw new Error('Z≈Çy JSON');
      for(const r of arr){ if(r?.id) await dbPut(r); }
      renderFiles(); alert('Zaimportowano.');
    }catch{ alert('Nieprawid≈Çowy plik JSON.'); }
    e.target.value='';
  });

  // Test & Media Library
  $('#btnTest').addEventListener('click', testCloud);
  $('#btnOpenLib').addEventListener('click', ()=>{
    if(!CLOUD){ alert('Brak cloud name.'); return; }
    window.open(https://console.cloudinary.com/console/media_library/asset-management/library?cloud_name=${encodeURIComponent(CLOUD)},'_blank');
  });

  renderFiles();
})();
</script>
</body>
</html>
