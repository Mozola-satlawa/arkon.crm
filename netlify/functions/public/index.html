<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ARKON â€¢ Chat (Netlify)</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, Arial, sans-serif;
      background: #0b1020; color: #e8eefc;
      display: grid; grid-template-rows: auto 1fr auto;
      height: 100svh;
    }
    header, footer { padding: 10px 14px; background: #0f1530; border-bottom: 1px solid #1c2448; }
    header { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    select, input, button, textarea {
      background: #131a3a; color: #e8eefc; border: 1px solid #2b3567; border-radius: 8px;
      padding: 8px 10px; font-size: 14px;
    }
    button { cursor: pointer; }
    main { overflow: auto; padding: 14px; }
    .msg {
      background: #12193a; border: 1px solid #263068; border-radius: 10px;
      padding: 10px; margin: 8px 0;
    }
    .meta { font-size: 12px; opacity: .7; margin-bottom: 6px; }
    .body { white-space: pre-wrap; word-break: break-word; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .row .shrink { flex: 0 0 auto; }
    .file { margin-top: 6px; display: inline-block; }
    .logs { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; opacity: .7; }
  </style>
</head>
<body>
  <header class="row">
    <strong>ARKON â€¢ Chat</strong>
    <select id="room" class="shrink">
      <option value="global">global</option>
      <option value="pokÃ³j">pokÃ³j</option>
      <option value="biuro">biuro</option>
    </select>
    <input id="author" placeholder="Podpis (np. Michalina)" />
    <input id="token" placeholder="Bearer token (CHAT_POST_TOKEN)" />
    <button id="save" class="shrink">Zapisz</button>
  </header>

  <main id="list"></main>

  <footer>
    <div class="row" style="margin-bottom:8px;">
      <textarea id="body" rows="3" placeholder="Napisz wiadomoÅ›Ä‡..."></textarea>
    </div>
    <div class="row">
      <input type="file" id="file" class="shrink" />
      <button id="send" class="shrink">WyÅ›lij</button>
      <span id="status" class="logs"></span>
    </div>
  </footer>

  <script>
    const els = {
      room: document.getElementById('room'),
      author: document.getElementById('author'),
      token: document.getElementById('token'),
      save: document.getElementById('save'),
      list: document.getElementById('list'),
      body: document.getElementById('body'),
      file: document.getElementById('file'),
      send: document.getElementById('send'),
      status: document.getElementById('status'),
    };

    // Local storage
    (function initForm(){
      els.room.value = localStorage.getItem('room') || 'global';
      els.author.value = localStorage.getItem('author') || '';
      els.token.value = localStorage.getItem('token') || '';
    })();

    els.save.onclick = () => {
      localStorage.setItem('room', els.room.value);
      localStorage.setItem('author', els.author.value.trim());
      localStorage.setItem('token', els.token.value.trim());
      log('Zapisano ustawienia.');
      refresh(true);
    };

    function log(t){ els.status.textContent = t; setTimeout(()=> els.status.textContent='', 3000); }

    let lastTs = 0;
    let poller = null;

    async function apiGetMessages(since = 0) {
      const url = /api/messages?room=${encodeURIComponent(els.room.value)}&since=${since};
      const res = await fetch(url, { headers: { "Accept": "application/json" }});
      if(!res.ok) throw new Error(await res.text());
      return res.json();
    }

    function renderMessages(items) {
      if (!items || !items.length) return;
      const frag = document.createDocumentFragment();
      for (const m of items) {
        const div = document.createElement('div');
        div.className = 'msg';
        const dt = new Date(m.ts).toLocaleString();
        div.innerHTML = `
          <div class="meta"><b>${escapeHtml(m.author)}</b> â€¢ ${dt}</div>
          <div class="body">${escapeHtml(m.body || '')}</div>
          ${m.fileUrl ? <div class="file"><a target="_blank" href="${m.fileUrl}">ðŸ“Ž zaÅ‚Ä…cznik</a></div> : ''}
        `;
        frag.appendChild(div);
        lastTs = Math.max(lastTs, m.ts || 0);
      }
      els.list.appendChild(frag);
      els.list.scrollTop = els.list.scrollHeight;
    }

    async function refresh(reset=false){
      try{
        const since = reset ? 0 : (lastTs || 0);
        const data = await apiGetMessages(since);
        if (reset) els.list.innerHTML = '';
        renderMessages(data.messages);
      }catch(e){
        log('BÅ‚Ä…d pobierania: ' + e.message);
      }
    }

    function startPolling(){
      if (poller) clearInterval(poller);
      poller = setInterval(() => refresh(false), 2000);
    }

    els.room.onchange = () => { lastTs = 0; refresh(true); };
    refresh(true); startPolling();

    // WysyÅ‚ka
    els.send.onclick = async () => {
      try {
        const token = els.token.value.trim();
        if (!token) { log('Podaj token (CHAT_POST_TOKEN)'); return; }

        let fileUrl = null;
        const file = els.file.files[0];
        if (file) {
          const fd = new FormData();
          fd.append('file', file, file.name);
          const ures = await fetch('/api/upload', {
            method: 'POST',
            headers: { Authorization: Bearer ${token} },
            body: fd
          });
          const uj = await ures.json();
          if (!ures.ok || !uj.ok) throw new Error(uj.error || 'upload fail');
          fileUrl = uj.url;
        }

        const body = els.body.value.trim();
        const payload = {
          room: els.room.value,
          author: els.author.value.trim() || 'Anon',
          body,
          fileUrl
        };

        const res = await fetch('/api/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: Bearer ${token}
          },
          body: JSON.stringify(payload)
        });
        const j = await res.json();
        if (!res.ok || !j.ok) throw new Error(j.error || 'send fail');

        els.body.value = '';
        els.file.value = '';
        renderMessages([j.message]);
        log('WysÅ‚ano âœ…');
      } catch (e) {
        log('BÅ‚Ä…d wysyÅ‚ki: ' + e.message);
      }
    };

    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  </script>
</body>
</html>
