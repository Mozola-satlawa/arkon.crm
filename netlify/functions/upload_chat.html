<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON â€¢ Chat (Netlify + Neon + Blobs)</title>
<style>
  body{margin:0;background:#0b1020;color:#e8edff;font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  header{padding:12px 16px;border-bottom:1px solid #253166;background:#11183a}
  h1{margin:0;font-size:20px}
  .wrap{max-width:1100px;margin:10px auto;padding:0 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;font-size:12px;color:#aeb8da}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px dashed #3a4ca3}
  input,textarea,select{background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:8px;color:#e8edff;font:inherit}
  .msglist{margin-top:10px;border:1px solid #253166;border-radius:14px;max-height:65vh;overflow:auto;background:linear-gradient(180deg,#101736,#0f1a44);padding:10px}
  .msg{border:1px solid #2a3a75;border-radius:10px;padding:8px;margin:8px 0}
  .meta{font-size:11px;color:#aeb8da}
  .file{display:inline-block;border:1px dashed #3a4ca3;border-radius:8px;padding:3px 6px;margin-top:6px}
</style>
</head>
<body>
<header><h1>ARKON â€¢ Chat (Neon + Netlify Blobs)</h1></header>
<div class="wrap">
  <div class="row" style="margin:8px 0">
    <label class="pill">PokÃ³j:
      <select id="room" style="margin-left:6px">
        <option value="global">global</option>
        <option value="krolowa">krolowa</option>
        <option value="adrian">adrian</option>
        <option value="emil">emil</option>
      </select>
    </label>
    <span class="pill">Ja: <b id="meLabel">â€”</b></span>
    <button class="btn ghost" id="btnMe">âœŽ zmieÅ„</button>
    <button class="btn ghost" id="btnReload">âŸ² odÅ›wieÅ¼</button>
  </div>

  <div class="msglist" id="msgs"></div>

  <div style="margin-top:10px" class="row">
    <textarea id="txt" rows="2" style="flex:1" placeholder="WiadomoÅ›Ä‡â€¦"></textarea>
    <input id="file" type="file">
    <button class="btn" id="send">WyÅ›lij â–¶</button>
  </div>
</div>

<script>
const API_MESSAGES = '/api/messages'; // przez export config.path => /.netlify/functions/messages
const API_UPLOAD   = '/api/upload';   // => /.netlify/functions/upload

const $ = s => document.querySelector(s);
const me = { name: localStorage.getItem('chat_me') || 'Pracownik' };
$('#meLabel').textContent = me.name;
$('#btnMe').onclick = () => {
  const n = prompt('Podpis (imiÄ™):', me.name) || me.name;
  me.name = n; localStorage.setItem('chat_me', n); $('#meLabel').textContent = n;
};

$('#room').value = localStorage.getItem('chat_room') || 'global';
$('#room').onchange = async () => { localStorage.setItem('chat_room', $('#room').value); await load(); };
$('#btnReload').onclick = load;

function fmt(ts){ try{ return new Date(ts).toLocaleString('pl-PL'); }catch{ return ts; } }

function render(arr){
  const box = $('#msgs'); box.innerHTML='';
  arr.forEach(m=>{
    const div = document.createElement('div'); div.className='msg';
    div.innerHTML = `
      <div class="meta"><b>${escapeHtml(m.author||'â€”')}</b> â€¢ ${fmt(m.created_at)}</div>
      <div>${linkify(escapeHtml(m.body||''))}</div>
      ${ m.file_url ? <div><a class="file" href="${m.file_url}" target="_blank" rel="noopener">ðŸ“Ž zaÅ‚Ä…cznik</a></div> : '' }
    `;
    box.appendChild(div);
  });
  box.scrollTop = box.scrollHeight;
}

function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function linkify(t=''){ return t.replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>'); }

async function load(){
  const room = $('#room').value;
  const r = await fetch(API_MESSAGES + '?room=' + encodeURIComponent(room));
  const data = await r.json();
  render(data);
}

$('#send').onclick = async () => {
  const room = $('#room').value;
  const text = ($('#txt').value||'').trim();
  const file = $('#file').files[0];

  let fileUrl = null;
  if (file) {
    const fd = new FormData();
    fd.append('file', file);
    fd.append('room', room);
    const up = await fetch(API_UPLOAD, { method:'POST', body: fd });
    const uj = await up.json();
    if (!up.ok) {
      alert('Upload bÅ‚Ä…d: '+(uj.error||up.status));
      return;
    }
    fileUrl = uj.url;
  }

  const r = await fetch(API_MESSAGES, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ room, author: me.name, text, file_url: fileUrl })
  });
  const j = await r.json();
  if (!r.ok) { alert('BÅ‚Ä…d wysyÅ‚ania: '+(j.error||r.status)); return; }

  $('#txt').value=''; $('#file').value='';
  await load();
};

load();
</script>
</body>
</html>
