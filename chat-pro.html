<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ARKON • Komunikator (Supabase)</title>
<meta name="description" content="Rozbudowany czat z Supabase: pokoje, obecność, status pisania, reakcje, odczyty, załączniki, wyszukiwarka, eksport.">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{
    --bg:#0b1020; --p1:#0f1636; --p2:#121d4a; --ink:#e8edff; --muted:#aeb8da; --line:#203067;
    --card:#0e173d; --chip:#13255a; --brand:#4cc9f0; --ok:#2fbf71; --bad:#ff6b6b; --warn:#ffb84d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0a1028,#0a122f 55%,#0a0f21);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Arial}
  a{color:#cfe1ff;text-decoration:none}
  .app{display:grid;grid-template-columns:280px 1fr 320px;gap:10px;height:100vh}
  @media(max-width:1100px){ .app{grid-template-columns:260px 1fr} .rightbar{display:none} }
  header{grid-column:1/-1;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line);background:#0e1538;position:sticky;top:0;z-index:10}
  header .brand{display:flex;gap:10px;align-items:center}
  .tag{display:inline-block;padding:4px 8px;border:1px solid #32479d;border-radius:999px;font-size:12px;color:#cfe1ff;background:#0e1742}
  .btn{background:#233261;border:1px solid #3a4ca3;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer}
  .btn.ghost{background:transparent;border-style:dashed}
  .btn.bad{background:#3a1f2a;border-color:#7b3341}
  .btn.ok{background:#194d34;border-color:#2f9762}
  .pane{display:flex;flex-direction:column;min-height:0}
  .card{background:linear-gradient(180deg,var(--p1),var(--p2));border:1px solid var(--line);border-radius:14px}
  .leftbar{padding:10px}
  .rooms{display:flex;flex-direction:column;gap:8px}
  .room{padding:10px;border:1px solid #2a3a77;border-radius:10px;background:#0e173d;display:flex;justify-content:space-between;align-items:center}
  .room.active{outline:2px solid #67a1ff66;background:#101e52}
  .room small{color:var(--muted)}
  .center{display:grid;grid-template-rows:auto 1fr auto;gap:10px;padding:10px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search{flex:1}
  .middle{min-height:0;overflow:auto;padding:8px;border:1px solid #22306a;border-radius:12px;background:linear-gradient(180deg,#0d1436,#0d183f)}
  .msg{display:grid;grid-template-columns:42px 1fr;gap:8px;padding:10px 8px;border-bottom:1px dashed #1a295e}
  .msg:hover{background:#0e1b44}
  .avatar{width:38px;height:38px;border-radius:50%;display:grid;place-items:center;background:#13294f;border:1px solid #2a3a77;font-weight:700}
  .bubble{background:#0c1642;border:1px solid #2a3a77;border-radius:12px;padding:8px}
  .meta{display:flex;gap:8px;align-items:center;color:#9db0ef;font-size:12px;margin-bottom:4px}
  .text{white-space:pre-wrap}
  .actions{display:flex;gap:6px;margin-top:6px}
  .reaction{display:inline-flex;align-items:center;gap:4px;background:#13265a;border:1px solid #2a3a77;padding:2px 6px;border-radius:999px;font-size:12px}
  .composer{display:grid;grid-template-columns:1fr auto;gap:8px}
  textarea{width:100%;min-height:70px;resize:vertical;background:#0d1530;border:1px solid #28356c;border-radius:10px;padding:10px;color:var(--ink);outline:0}
  textarea:focus{border-color:#3e61cc;box-shadow:0 0 0 3px #3e61cc33}
  .rightbar{padding:10px}
  .list{list-style:none;margin:0;padding:0}
  .li{display:flex;justify-content:space-between;padding:8px;border-bottom:1px dashed #22306a}
  .muted{color:var(--muted)}
  .kbd{font:12px/1.2 ui-monospace,Menlo,Consolas,monospace;background:#101735;border:1px solid #2a3777;padding:2px 6px;border-radius:6px;color:#cfe0ff}
  .hint{background:#0e1c48;border:1px dashed #3850a6;border-radius:10px;padding:8px;color:#b9c8ff}
  .pill{display:inline-block;background:#0d1530;border:1px dashed #2b3a77;border-radius:999px;padding:6px 10px;color:#aeb8da;font-size:12px}
  .me .bubble{background:#102259}
  .me .avatar{background:#194d34;border-color:#2f9762}
  .drop{outline:2px dashed #3a4ca3;padding:6px;border-radius:8px;text-align:center}
  .badge{display:inline-block;padding:2px 8px;border:1px solid #2a3a77;border-radius:999px;font-size:11px;background:#0d1741;color:#cfe0ff}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="tag">ARKON • Komunikator</div>
    <span class="pill" id="envInfo">konto: <b id="accountName">arkon-crm</b> • pokój: <b id="roomName">global</b></span>
  </div>
  <div class="toolbar">
    <button id="btnSQL" class="btn ghost" title="Kopiuj SQL (tabele + RLS + realtime)">📄 SQL</button>
    <button id="btnExport" class="btn ghost" title="Eksportuj bieżący pokój do JSON">⬇️ Eksport</button>
    <button id="btnClearMine" class="btn bad" title="Usuń moje wiadomości z pokoju (soft-delete)">🧹 Wyczyść moje</button>
  </div>
</header>

<div class="app">
  <!-- LEFT -->
  <aside class="pane leftbar">
    <div class="card" style="padding:10px">
      <div class="toolbar" style="justify-content:space-between">
        <b>Pokoje</b>
        <button id="btnNewRoom" class="btn ghost">+ Nowy</button>
      </div>
      <div id="rooms" class="rooms" aria-live="polite"></div>
    </div>

    <div class="card" style="padding:10px;margin-top:8px">
      <b>Ustawienia</b>
      <div style="display:grid;gap:8px;margin-top:8px">
        <label class="muted">Konto (namespace)</label>
        <input id="inAccount" placeholder="arkon-crm">
        <label class="muted">Nazwa (czat)</label>
        <input id="inUser" placeholder="Anna">
        <label class="muted">Mój identyfikator</label>
        <input id="inUserId" placeholder="anna01">
        <label class="muted">Supabase ANON KEY</label>
        <input id="inKey" placeholder="wklej klucz anon">
        <button id="btnApply" class="btn ok">Zapisz / Połącz</button>
        <div class="muted">URL Supabase jest ustawiony na: <code id="sbUrlTxt">https://phxgjrqiltkzcwnygaha.supabase.co</code></div>
      </div>
    </div>
  </aside>

  <!-- CENTER -->
  <main class="pane center">
    <div class="card" style="padding:10px">
      <div class="toolbar">
        <input id="q" class="search" placeholder="🔎 Szukaj w pokoju (treść, autor, emoji)…">
        <span class="badge">Obecni: <span id="present">0</span></span>
        <span class="badge" id="typing" aria-live="polite">—</span>
      </div>
    </div>

    <div id="feed" class="middle card" role="log" aria-live="polite"></div>

    <div class="card" style="padding:10px">
      <div class="composer">
        <div>
          <textarea id="msg" placeholder="Napisz wiadomość… użyj :emotes: np. 🙂👍🔥"></textarea>
          <div class="toolbar" style="margin-top:6px">
            <label class="btn ghost">📎 Obraz (demo)
              <input type="file" id="file" accept="image/*" hidden>
            </label>
            <button id="btnEmoji" class="btn ghost" type="button">😊 Reakcje</button>
            <span class="muted">Enter — wyślij • Shift+Enter — nowa linia</span>
          </div>
        </div>
        <button id="btnSend" class="btn ok">Wyślij ➤</button>
      </div>
      <div id="emojiBar" class="toolbar" style="margin-top:8px;display:none">
        <button class="btn ghost em">👍</button>
        <button class="btn ghost em">❤️</button>
        <button class="btn ghost em">😂</button>
        <button class="btn ghost em">🔥</button>
        <button class="btn ghost em">✅</button>
        <button class="btn ghost em">🎉</button>
        <button class="btn ghost em">👀</button>
      </div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="pane rightbar">
    <div class="card" style="padding:10px">
      <b>Obecność</b>
      <ul id="presenceList" class="list" style="margin-top:6px"></ul>
    </div>
    <div class="card" style="padding:10px;margin-top:8px">
      <b>Wskazówki</b>
      <div class="hint" style="margin-top:6px">
        • Przy pierwszym uruchomieniu kliknij <b>„Zapisz / Połącz”</b>.<br>
        • Pokoje i konta są zapisywane w LocalStorage — gotowe do wielu „kont”.<br>
        • SQL w nagłówku wklej w Supabase → SQL editor (zanim zaczniesz).<br>
        • Załączniki w demo zapisują DataURL w wiadomości (Storage można dodać później).
      </div>
    </div>
  </aside>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
'use strict';
/* ====== CONFIG ====== */
const SUPABASE_URL = 'https://phxgjrqiltkzcwnygaha.supabase.co'; // Twój projekt
let SUPABASE_ANON_KEY = localStorage.getItem('sb_key') || '';     // Wklej w Ustawieniach
document.getElementById('sbUrlTxt').textContent = SUPABASE_URL;

let sb = null;        // obiekt supabase
let roomId = null;    // id aktualnego pokoju
let account = localStorage.getItem('chat_account') || 'arkon-crm';
let me = {
  id: localStorage.getItem('chat_uid') || ('user-'+Math.random().toString(36).slice(2,7)),
  name: localStorage.getItem('chat_name') || 'Gość'
};
document.getElementById('inAccount').value = account;
document.getElementById('inUser').value = me.name;
document.getElementById('inUserId').value = me.id;
document.getElementById('inKey').value = SUPABASE_ANON_KEY;
document.getElementById('accountName').textContent = account;

/* ====== DOM helpers ====== */
const $ = (s)=>document.querySelector(s);
const feed = $('#feed');
function esc(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
function time(ts){ const d=new Date(ts||Date.now()); return d.toLocaleString('pl-PL'); }

/* ====== INIT ====== */
function connect(){
  if(!SUPABASE_ANON_KEY){ alert('Wklej Supabase ANON KEY w Ustawieniach.'); return; }
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime:{params:{eventsPerSecond:5}} });
  listRooms().then(()=> selectOrCreateRoom('global'));
  presenceJoin();
}
$('#btnApply').addEventListener('click', ()=>{
  account = $('#inAccount').value.trim() || 'arkon-crm';
  me.name = $('#inUser').value.trim() || 'Gość';
  me.id   = $('#inUserId').value.trim() || ('user-'+Math.random().toString(36).slice(2,7));
  SUPABASE_ANON_KEY = $('#inKey').value.trim();
  localStorage.setItem('chat_account', account);
  localStorage.setItem('chat_name', me.name);
  localStorage.setItem('chat_uid', me.id);
  localStorage.setItem('sb_key', SUPABASE_ANON_KEY);
  $('#accountName').textContent = account;
  connect();
});

/* ====== ROOMS ====== */
async function listRooms(){
  const { data, error } = await (sb ? sb.from('rooms').select('*').eq('account', account).order('created_at', {ascending:true}) : {data:[]});
  if(error){ console.warn(error); $('#rooms').innerHTML='<div class="muted">Brak połączenia lub tabele nie istnieją.</div>'; return; }
  const wrap = $('#rooms'); wrap.innerHTML='';
  data.forEach(r=> wrap.appendChild(roomTile(r)));
  if(!data.length){
    wrap.innerHTML = '<div class="muted">Brak pokoi. Kliknij „+ Nowy”.</div>';
  }
}
function roomTile(r){
  const el = document.createElement('div');
  el.className='room';
  el.innerHTML = `<div><b>${esc(r.name)}</b><div class="muted">${esc(r.description||'')}</div></div>
  <div><button class="btn ghost">Wejdź</button></div>`;
  if(roomId===r.id) el.classList.add('active');
  el.querySelector('button').addEventListener('click', ()=>{ joinRoom(r.id, r.name); });
  return el;
}
$('#btnNewRoom').addEventListener('click', async ()=>{
  const name = prompt('Nazwa pokoju'); if(!name) return;
  const { data, error } = await sb.from('rooms').insert({ name, account }).select().single();
  if(error){ alert('Błąd tworzenia pokoju: '+error.message); return; }
  await listRooms(); joinRoom(data.id, data.name);
});
async function selectOrCreateRoom(name){
  const { data, error } = await sb.from('rooms').select('*').eq('account', account).eq('name', name).maybeSingle();
  if(error){ console.warn(error); return; }
  if(data){ joinRoom(data.id, data.name); }
  else{
    const ins = await sb.from('rooms').insert({ name, account }).select().single();
    if(!ins.error){ joinRoom(ins.data.id, ins.data.name); listRooms(); }
  }
}

/* ====== JOIN ROOM ====== */
let msgSub = null, updSub = null, reactSub = null;
async function joinRoom(id, name){
  if(msgSub) { sb.removeChannel(msgSub); msgSub=null; }
  if(updSub) { sb.removeChannel(updSub); updSub=null; }
  if(reactSub){ sb.removeChannel(reactSub); reactSub=null; }
  roomId = id; $('#roomName').textContent = name;
  document.querySelectorAll('.room').forEach(x=>x.classList.remove('active'));
  listRooms();

  feed.innerHTML = '<div class="muted">Ładowanie…</div>';
  // load history
  const { data, error } = await sb.from('messages').select('*').eq('room_id', roomId).eq('deleted', false).order('created_at',{ascending:true}).limit(500);
  if(error){ feed.innerHTML='<div class="muted">Błąd odczytu wiadomości.</div>'; return; }
  feed.innerHTML='';
  data.forEach(renderMessage);
  scrollBottom();

  // subscribe to new messages
  msgSub = sb.channel('room-'+roomId)
    .on('postgres_changes',
      { event:'INSERT', schema:'public', table:'messages', filter:`room_id=eq.${roomId}` },
      payload => { renderMessage(payload.new); scrollBottom(); if(payload.new.user_id!==me.id){ markDelivered(payload.new.id); } }
    )
    .on('postgres_changes',
      { event:'UPDATE', schema:'public', table:'messages', filter:`room_id=eq.${roomId}` },
      payload => { updateMessageDom(payload.new); }
    )
    .subscribe();

  // reactions live
  reactSub = sb.channel('reac-'+roomId)
    .on('postgres_changes', {event:'INSERT', schema:'public', table:'reactions'}, payload => onReaction(payload.new))
    .on('postgres_changes', {event:'DELETE', schema:'public', table:'reactions'}, payload => onReactionDelete(payload.old))
    .subscribe();

  // send read receipt for last batch
  markAllRead();
}

/* ====== PRESENCE & TYPING ====== */
let presenceChannel = null;
function presenceJoin(){
  if(presenceChannel){ sb.removeChannel(presenceChannel); }
  presenceChannel = sb.channel('presence:'+account, {
    config: { presence: { key: me.id } }
  });
  presenceChannel.on('presence', { event:'sync' }, () => {
    const state = presenceChannel.presenceState();
    renderPresence(state);
  });
  presenceChannel.subscribe(async (status) => {
    if(status==='SUBSCRIBED'){
      await presenceChannel.track({ id: me.id, name: me.name, t: Date.now() });
      setInterval(()=> presenceChannel.track({ id: me.id, name: me.name, t: Date.now() }), 12000);
    }
  });
}
function renderPresence(state){
  const list = $('#presenceList'); list.innerHTML='';
  let count = 0;
  Object.values(state).forEach(arr=>{
    arr.forEach(p=>{ count++; const li=document.createElement('li'); li.className='li'; li.innerHTML=`<span>${esc(p.name)}</span><span class="muted">${new Date(p.t).toLocaleTimeString('pl-PL')}</span>`; list.appendChild(li); });
  });
  $('#present').textContent = count;
}
let typingTimer = null;
$('#msg').addEventListener('input', ()=>{
  if(!presenceChannel) return;
  presenceChannel.track({ id: me.id, name: me.name, typing:true, t:Date.now() });
  clearTimeout(typingTimer);
  typingTimer = setTimeout(()=> presenceChannel.track({ id: me.id, name: me.name, typing:false, t:Date.now() }), 1500);
});
if(presenceChannel){
  presenceChannel.on('broadcast', {event:'typing'}, payload =>{});
}
function showTyping(name){ const el=$('#typing'); el.textContent = name ? (name+' pisze…') : '—'; setTimeout(()=>{ if(el.textContent===name+' pisze…') el.textContent='—'; }, 1500); }

/* ====== MESSAGES ====== */
function messageHtml(m){
  const mine = m.user_id===me.id;
  const read = m.read_by?.includes(me.id);
  const dlvd = m.delivered_to?.includes(me.id);
  const checks = mine ? ( (m.read_by && m.read_by.length>1) ? '✓✓' : (m.delivered_to && m.delivered_to.length>1) ? '✓' : '' ) : '';
  const at = time(m.created_at);
  const name = esc(m.user_name||'Użytkownik');
  const txt = esc(m.text||'');
  let attach = '';
  if(m.attach && m.attach.type && m.attach.data){
    if(m.attach.type.startsWith('image/')){
      attach = `<div class="drop"><img src="${m.attach.data}" alt="img" style="max-width:260px;border-radius:8px"></div>`;
    }
  }
  const reactions = (m.reactions||[]).map(r=>`<span class="reaction" data-mid="${m.id}" data-emo="${r.emoji}">${r.emoji} ${r.count}</span>`).join(' ');
  return `<div class="msg ${mine?'me':''}" id="m_${m.id}">
    <div class="avatar" title="${name}">${esc((name||'?').charAt(0).toUpperCase())}</div>
    <div class="bubble">
      <div class="meta"><b>${name}</b><span class="muted">${at}</span><span class="muted">${checks}</span></div>
      <div class="text">${txt}</div>
      ${attach}
      <div class="actions">
        <button class="btn ghost act-react" data-id="${m.id}">😊</button>
        ${mine?'<button class="btn ghost act-edit" data-id="'+m.id+'">✏️</button>':''}
        ${mine?'<button class="btn ghost act-del" data-id="'+m.id+'">🗑️</button>':''}
        <span class="muted">id:${m.id.slice(0,8)}</span>
      </div>
      <div class="reactions" id="r_${m.id}" style="margin-top:6px">${reactions}</div>
    </div>
  </div>`;
}
function renderMessage(m){
  // ensure arrays
  m.delivered_to = m.delivered_to || [];
  m.read_by = m.read_by || [];
  m.reactions = m.reactions || [];
  const tmp = document.createElement('div'); tmp.innerHTML = messageHtml(m);
  const el = tmp.firstElementChild;
  feed.appendChild(el);
  bindMsgActions(el, m);
}
function updateMessageDom(m){
  const el = document.getElementById('m_'+m.id);
  if(!el) return;
  el.outerHTML = messageHtml(m);
  bindMsgActions(document.getElementById('m_'+m.id), m);
}
function bindMsgActions(el, m){
  el.querySelector('.act-react').addEventListener('click', ()=> openEmojiBarFor(m.id));
  const ed = el.querySelector('.act-edit'); if(ed) ed.addEventListener('click', ()=> editMessage(m));
  const del = el.querySelector('.act-del'); if(del) del.addEventListener('click', ()=> deleteMessage(m.id));
  el.querySelectorAll('.reaction').forEach(btn=> btn.addEventListener('click', ()=> toggleReaction(m.id, btn.dataset.emo)));
}
function scrollBottom(){ feed.scrollTop = feed.scrollHeight; }

/* ====== SEND ====== */
$('#btnEmoji').addEventListener('click', ()=>{
  const bar = $('#emojiBar'); bar.style.display = bar.style.display==='none' ? 'flex' : 'none';
});
document.querySelectorAll('#emojiBar .em').forEach(b=> b.addEventListener('click', ()=> insertAtCursor($('#msg'), ' '+b.textContent+' ')));
function insertAtCursor(el, txt){ const s=el.selectionStart; const e=el.selectionEnd; const v=el.value; el.value=v.slice(0,s)+txt+v.slice(e); el.focus(); el.selectionStart=el.selectionEnd=s+txt.length; }
$('#msg').addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }
});
$('#btnSend').addEventListener('click', send);
$('#file').addEventListener('change', handleFile);
let lastAttach = null;
function handleFile(ev){
  const f = ev.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ lastAttach = { type:f.type, name:f.name, data: reader.result }; alert('Załącznik gotowy (demo). Zostanie wysłany z nast. wiadomością.'); };
  reader.readAsDataURL(f);
}
async function send(){
  if(!roomId) return;
  const text = $('#msg').value.trim();
  if(!text && !lastAttach){ return; }
  const payload = { room_id: roomId, account, text, user_id: me.id, user_name: me.name, attach: lastAttach, deleted:false };
  $('#msg').value=''; lastAttach=null;
  const { data, error } = await sb.from('messages').insert(payload).select().single();
  if(error){ alert('Błąd wysyłki: '+error.message); return; }
  // auto mark delivered to self
  await markDelivered(data.id);
  scrollBottom();
}

/* ====== RECEIPTS ====== */
async function markDelivered(id){
  await sb.from('messages').update({ delivered_to: sb.rpc ? undefined : undefined }).eq('id', id); // no-op
  // Append me to delivered_to using an RPC-less trick: select + update
  const { data } = await sb.from('messages').select('delivered_to').eq('id', id).single();
  const arr = Array.isArray(data?.delivered_to) ? data.delivered_to : [];
  if(!arr.includes(me.id)){
    arr.push(me.id);
    await sb.from('messages').update({ delivered_to: arr }).eq('id', id);
  }
}
async function markAllRead(){
  if(!roomId) return;
  const { data, error } = await sb.from('messages').select('id, read_by').eq('room_id', roomId).eq('deleted', false);
  if(error) return;
  for(const m of data){
    const arr = Array.isArray(m.read_by)? m.read_by: [];
    if(!arr.includes(me.id)){
      arr.push(me.id);
      await sb.from('messages').update({ read_by: arr }).eq('id', m.id);
    }
  }
}

/* ====== EDIT/DELETE ====== */
async function editMessage(m){
  const txt = prompt('Edytuj wiadomość:', m.text||''); if(txt==null) return;
  const { error } = await sb.from('messages').update({ text: txt }).eq('id', m.id).eq('user_id', me.id);
  if(error) alert('Błąd edycji: '+error.message);
}
async function deleteMessage(id){
  if(!confirm('Usunąć wiadomość?')) return;
  const { error } = await sb.from('messages').update({ deleted:true, text:'(usunięto)' }).eq('id', id).eq('user_id', me.id);
  if(error) alert('Błąd usuwania: '+error.message);
}

/* ====== REACTIONS ====== */
async function toggleReaction(messageId, emoji){
  // sprawdź czy istnieje
  const { data } = await sb.from('reactions').select('*').eq('message_id', messageId).eq('user_id', me.id).eq('emoji', emoji).maybeSingle();
  if(data){
    await sb.from('reactions').delete().eq('id', data.id);
  }else{
    await sb.from('reactions').insert({ message_id: messageId, user_id: me.id, user_name: me.name, emoji });
  }
}
function openEmojiBarFor(mid){
  const ems = ['👍','❤️','😂','🔥','✅','🎉','👀','😮','😢'];
  const bar = document.createElement('div');
  bar.className='toolbar';
  ems.forEach(e=>{ const b=document.createElement('button'); b.className='btn ghost'; b.textContent=e; b.addEventListener('click', ()=>{ toggleReaction(mid,e); bar.remove(); }); bar.appendChild(b); });
  const host = document.getElementById('r_'+mid);
  host.parentElement.insertBefore(bar, host);
  setTimeout(()=>bar.remove(), 4000);
}
function onReaction(r){
  const host = document.getElementById('r_'+r.message_id); if(!host) return;
  // refresh counts
  refreshReactions(r.message_id);
}
function onReactionDelete(r){
  refreshReactions(r.message_id);
}
async function refreshReactions(mid){
  const { data } = await sb.from('reactions').select('emoji,count:emoji').eq('message_id', mid).group('emoji');
  const host = document.getElementById('r_'+mid); if(!host) return;
  host.innerHTML = (data||[]).map(x=>`<span class="reaction" data-mid="${mid}" data-emo="${x.emoji}">${x.emoji} ${x.count}</span>`).join(' ');
  host.querySelectorAll('.reaction').forEach(btn=> btn.addEventListener('click', ()=> toggleReaction(mid, btn.dataset.emo)));
}

/* ====== SEARCH & EXPORT ====== */
$('#q').addEventListener('input', ()=>{
  const q = $('#q').value.trim().toLowerCase();
  document.querySelectorAll('.msg').forEach(el=>{
    const t = el.textContent.toLowerCase();
    el.style.display = t.includes(q) ? '' : 'none';
  });
});
$('#btnExport').addEventListener('click', async ()=>{
  if(!roomId) return;
  const { data } = await sb.from('messages').select('*').eq('room_id', roomId).order('created_at',{ascending:true});
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='chat_'+roomId+'.json'; a.click(); URL.revokeObjectURL(a.href);
});
$('#btnClearMine').addEventListener('click', async ()=>{
  if(!roomId) return;
  if(!confirm('Usunąć (soft) wszystkie moje wiadomości w tym pokoju?')) return;
  await sb.from('messages').update({ deleted:true, text:'(usunięto)' }).eq('room_id', roomId).eq('user_id', me.id);
});

/* ====== COPY SQL ====== */
const SQL_SCHEMA = `
-- Tabele
create table if not exists public.rooms (
  id uuid primary key default gen_random_uuid(),
  account text not null,
  name text not null,
  description text,
  created_at timestamptz default now()
);

create table if not exists public.messages (
  id uuid primary key default gen_random_uuid(),
  room_id uuid not null references public.rooms(id) on delete cascade,
  account text not null,
  user_id text not null,
  user_name text not null,
  text text,
  attach jsonb,
  delivered_to text[] default array[]::text[],
  read_by text[] default array[]::text[],
  deleted boolean default false,
  created_at timestamptz default now(),
  updated_at timestamptz default now()
);

create table if not exists public.reactions (
  id bigserial primary key,
  message_id uuid not null references public.messages(id) on delete cascade,
  user_id text not null,
  user_name text not null,
  emoji text not null,
  created_at timestamptz default now()
);

-- Policy (otwarte dla testów; w produkcji zawęź do JWT)
alter table public.rooms enable row level security;
alter table public.messages enable row level security;
alter table public.reactions enable row level security;

do $$ begin
  create policy if not exists "rooms all" on public.rooms for all using (true) with check (true);
  create policy if not exists "messages all" on public.messages for all using (true) with check (true);
  create policy if not exists "reactions all" on public.reactions for all using (true) with check (true);
exception when others then null; end $$;

-- Realtime
begin;
  alter publication supabase_realtime add table public.rooms;
  alter publication supabase_realtime add table public.messages;
  alter publication supabase_realtime add table public.reactions;
commit;
`;
$('#btnSQL').addEventListener('click', ()=>{
  navigator.clipboard.writeText(SQL_SCHEMA).then(()=> alert('Skrypt SQL skopiowany do schowka. Wklej w Supabase → SQL Editor i uruchom.'));
});

/* ====== BOOT ====== */
// auto-connect jeśli mamy klucz
if(SUPABASE_ANON_KEY){ connect(); }
</script>
</body>
</html>
