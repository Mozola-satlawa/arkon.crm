<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ARKON CRM — Komponenty (edytowalne)</title>
<style>
  :root{
    --bg:#0b1020;--card:#0f1636;--line:#263168;--accent:#3a6df0;
    --text:#e7ecff;--muted:#a3b3ff;--chip:#1a244d;--field:#0e1330;
    --good:#2fbf71;--warn:#ffb84d;--bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%}
  body{font:14px/1.45 system-ui,-apple-system,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:#cfe0ff;text-decoration:none}
  .container{max-width:1280px;margin:0 auto;padding:16px}
  .nav{position:sticky;top:0;z-index:10;display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line);background:var(--bg)}
  .brand{font-weight:700;letter-spacing:.4px}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:10px 14px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid var(--accent);color:#cfe0ff}
  .btn.bad{background:transparent;border:1px solid var(--bad);color:#ffb4b4}
  .btn.good{background:var(--good)}
  .grid{display:grid;gap:16px}
  .layout{display:grid;grid-template-columns:1fr 360px;gap:16px}
  @media (max-width:1000px){ .layout{grid-template-columns:1fr} .side{position:static;max-height:none} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .field{background:var(--field);border:1px solid var(--line);color:var(--text);border-radius:8px;padding:10px 12px;outline:0;width:100%}
  table{width:100%;border-collapse:collapse}
  th{font-weight:600;text-align:left;border-bottom:1px solid var(--line);padding:8px 6px;color:var(--muted);font-size:13px;white-space:nowrap}
  td{border-bottom:1px solid #1a244d;padding:8px 6px;vertical-align:top}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:var(--chip)}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .small{opacity:.85;color:var(--muted);font-size:13px}
  .side{position:sticky;top:64px;max-height:calc(100vh - 96px);overflow:auto}
  .spacer{height:6px}
</style>
</head>
<body>
  <!-- NAV -->
  <div class="nav">
    <div class="brand">ARKON CRM</div>
    <a class="tab" href="index.html">← Umowy</a>
    <span class="tab" style="background:var(--chip);border-radius:8px;padding:6px 10px">Komponenty</span>
  </div>

  <div class="container">
    <h1>Komponenty (edytowalne)</h1>

    <!-- Filtry -->
    <div class="card">
      <div class="row">
        <input id="q" class="field" placeholder="Szukaj po nazwie / SKU / kategorii…" style="flex:2">
        <select id="cat" class="field" style="max-width:220px">
          <option value="__all">Wszystkie kategorie</option>
        </select>
        <select id="sort" class="field" style="max-width:220px">
          <option value="name_asc">Nazwa A→Z</option>
          <option value="name_desc">Nazwa Z→A</option>
          <option value="price_asc">Cena rosnąco</option>
          <option value="price_desc">Cena malejąco</option>
          <option value="sku_asc">SKU A→Z</option>
          <option value="sku_desc">SKU Z→A</option>
        </select>
        <input id="min" class="field" type="number" min="0" step="0.01" placeholder="Cena min" style="max-width:140px">
        <input id="max" class="field" type="number" min="0" step="0.01" placeholder="Cena max" style="max-width:140px">
        <button id="clear" class="btn ghost">Wyczyść</button>
      </div>
    </div>

    <div class="layout">
      <!-- Lista -->
      <div class="grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="small" id="count"></div>
            <div class="row">
              <button class="btn ghost" id="prev">◀</button>
              <div class="chip" id="page">1 / 1</div>
              <button class="btn ghost" id="next">▶</button>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="card" style="padding:0">
            <table>
              <thead>
                <tr><th>SKU</th><th>Nazwa</th><th>Kategoria</th><th style="white-space:nowrap">Cena (zł)</th><th>Akcje</th></tr>
              </thead>
              <tbody id="rows"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Panel boczny: edycja + koszyk + import/eksport -->
      <aside class="side">
        <div class="card">
          <h2>Dodaj / Edytuj</h2>
          <input id="f-sku" class="field" placeholder="SKU (unikalne)">
          <input id="f-name" class="field" placeholder="Nazwa">
          <input id="f-cat" class="field" placeholder="Kategoria (np. hydraulika)">
          <input id="f-price" class="field" type="number" step="0.01" min="0" placeholder="Cena (zł)">
          <div class="right" style="margin-top:8px">
            <button id="save" class="btn">Zapisz</button>
            <button id="reset" class="btn ghost">Wyczyść</button>
          </div>
          <div class="small" id="edit-info" style="margin-top:6px;display:none"></div>
        </div>

        <div class="card">
          <h2>Koszyk</h2>
          <div id="cart-empty" class="small">Pusty.</div>
          <div id="cart"></div>
          <div class="row" style="margin-top:8px">
            <div class="card" style="flex:1"><div class="small">Suma</div><h2 id="sum">0 zł</h2></div>
            <div class="right" style="flex:1">
              <button id="cart-clear" class="btn bad">Wyczyść</button>
              <button id="cart-export" class="btn">CSV</button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Import / Eksport</h2>
          <div class="row">
            <button id="export-json" class="btn">Eksport JSON</button>
            <label class="btn ghost">Import JSON
              <input id="import-json" type="file" accept="application/json" hidden>
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="export-csv" class="btn">Eksport CSV</button>
            <label class="btn ghost">Import CSV
              <input id="import-csv" type="file" accept=".csv,text/csv" hidden>
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn" onclick="window.print()">Drukuj / PDF</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
/* ====== Utility ====== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const money = x => (+(x||0)).toLocaleString("pl-PL",{minimumFractionDigits:2,maximumFractionDigits:2})+" zł";
function csvEscape(s){ return /[;"\n]/.test(s)?('"'+String(s).replace(/"/g,'""')+'"'):String(s); }

/* ====== Dane + stan ====== */
const LS_ITEMS = "arkon_components_v2";
const LS_CART  = "arkon_components_cart_v2";
const PAGE_SIZE = 10;

let items = loadItems();
let cart  = loadCart();
let editKey = null; // aktualnie edytowane SKU

function loadItems(){ try{ return JSON.parse(localStorage.getItem(LS_ITEMS)||"[]"); }catch{return []} }
function saveItems(){ localStorage.setItem(LS_ITEMS, JSON.stringify(items)); }
function loadCart(){ try{ return JSON.parse(localStorage.getItem(LS_CART)||"[]"); }catch{return []} }
function saveCart(){ localStorage.setItem(LS_CART, JSON.stringify(cart)); }

/* Inicjalne dane (jeśli pusto) */
if(!items.length){
  items = [
    {sku:"HP-9KW", name:"Pompa ciepła 9kW", category:"pompy", price:15500},
    {sku:"HP-BUF", name:"Bufor 100l", category:"pompy", price:850},
    {sku:"HY-PEX16", name:"Rury PEX 16 (mb)", category:"hydraulika", price:3.8},
    {sku:"HY-CU15", name:"Rury miedziane 15 (mb)", category:"hydraulika", price:14.5},
    {sku:"HY-RAD2", name:"Grzejnik dwukomorowy 120", category:"hydraulika", price:740},
    {sku:"OC-STY15", name:"Styropian 15cm (m²)", category:"ocieplenie", price:42},
    {sku:"OC-ADH", name:"Klej do styropianu 25kg", category:"ocieplenie", price:45},
    {sku:"OC-REN", name:"Tynk silikonowy 25kg", category:"ocieplenie", price:120},
    {sku:"PV-410", name:"Panel 410W", category:"fotowoltaika", price:520},
    {sku:"PV-INV8", name:"Inwerter 8kW", category:"fotowoltaika", price:4100}
  ];
  saveItems();
}

/* ====== Filtry/paginacja ====== */
const state = { q:"", cat:"__all", sort:"name_asc", min:"", max:"", page:1 };

function categories(){
  return [...new Set(items.map(i=>i.category))].sort((a,b)=>a.localeCompare(b,"pl"));
}
function applyFilters(){
  let list = items.slice();
  const q = state.q.trim().toLowerCase();
  if(q) list = list.filter(i => (i.sku+i.name+i.category).toLowerCase().includes(q));
  if(state.cat!=="__all") list = list.filter(i=>i.category===state.cat);
  const min = parseFloat(state.min), max = parseFloat(state.max);
  if(!Number.isNaN(min)) list = list.filter(i=>+i.price>=min);
  if(!Number.isNaN(max)) list = list.filter(i=>+i.price<=max);

  list.sort((a,b)=>{
    switch(state.sort){
      case "name_asc":  return a.name.localeCompare(b.name,"pl");
      case "name_desc": return b.name.localeCompare(a.name,"pl");
      case "price_asc": return a.price - b.price;
      case "price_desc":return b.price - a.price;
      case "sku_asc":   return a.sku.localeCompare(b.sku,"pl");
      case "sku_desc":  return b.sku.localeCompare(a.sku,"pl");
      default: return 0;
    }
  });
  return list;
}

/* ====== Render listy ====== */
function renderList(){
  // zasilić kategorie
  const catSel=$("#cat");
  if(catSel && catSel.options.length<=1){
    categories().forEach(c=>{ const o=document.createElement("option"); o.value=c; o.textContent=c; catSel.appendChild(o); });
  }

  const all = applyFilters();
  const total = all.length;
  const pages = Math.max(1, Math.ceil(total/PAGE_SIZE));
  state.page = Math.min(Math.max(1,state.page), pages);

  $("#count").textContent = total ? ${total} wyników : "Brak wyników…";
  $("#page").textContent = ${state.page} / ${pages};
  $("#prev").disabled = state.page<=1;
  $("#next").disabled = state.page>=pages;

  const start = (state.page-1)*PAGE_SIZE;
  const pageItems = all.slice(start, start+PAGE_SIZE);

  const tb=$("#rows"); tb.innerHTML="";
  pageItems.forEach(i=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${i.sku}</td>
      <td>${i.name}</td>
      <td><span class="chip">${i.category}</span></td>
      <td style="white-space:nowrap">${money(i.price)}</td>
      <td>
        <button class="btn ghost" data-edit="${i.sku}">Edytuj</button>
        <button class="btn bad" data-del="${i.sku}">Usuń</button>
        <button class="btn" data-add="${i.sku}">Dodaj do koszyka</button>
      </td>`;
    tb.appendChild(tr);
  });

  tb.querySelectorAll("[data-edit]").forEach(b=>b.addEventListener("click",()=>fillForm(b.dataset.edit)));
  tb.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>removeItem(b.dataset.del)));
  tb.querySelectorAll("[data-add]").forEach(b=>b.addEventListener("click",()=>cartAdd(b.dataset.add)));
}

/* ====== Form: dodawanie/edycja ====== */
function fillForm(sku){
  const it = items.find(x=>x.sku===sku); if(!it) return;
  editKey = it.sku;
  $("#f-sku").value = it.sku;
  $("#f-name").value = it.name;
  $("#f-cat").value  = it.category;
  $("#f-price").value= it.price;
  $("#edit-info").style.display="block";
  $("#edit-info").textContent = Edycja pozycji: ${it.sku};
}
function clearForm(){
  editKey = null;
  $("#f-sku").value = "";
  $("#f-name").value = "";
  $("#f-cat").value  = "";
  $("#f-price").value= "";
  $("#edit-info").style.display="none";
}
function saveForm(){
  const sku = $("#f-sku").value.trim();
  const name= $("#f-name").value.trim();
  const cat = $("#f-cat").value.trim();
  const price = parseFloat($("#f-price").value);
  if(!sku || !name || !cat || Number.isNaN(price)){ alert("Uzupełnij SKU, nazwę, kategorię i cenę."); return; }

  if(editKey && editKey!==sku && items.some(x=>x.sku===sku)){
    alert("SKU musi być unikalne."); return;
  }
  if(editKey){
    const i = items.findIndex(x=>x.sku===editKey);
    items[i] = {sku,name,category:cat,price:+price};
  }else{
    if(items.some(x=>x.sku===sku)){ alert("SKU już istnieje."); return; }
    items.push({sku,name,category:cat,price:+price});
  }
  saveItems(); clearForm(); renderList();
}
function removeItem(sku){
  if(!confirm("Usunąć pozycję "+sku+"?")) return;
  items = items.filter(x=>x.sku!==sku);
  saveItems(); renderList();
}

/* ====== Koszyk ====== */
function cartAdd(sku){
  const p = items.find(x=>x.sku===sku); if(!p) return;
  const row = cart.find(x=>x.sku===sku);
  if(row) row.qty++;
  else cart.push({sku:p.sku,name:p.name,price:+p.price,qty:1});
  saveCart(); renderCart();
}
function cartDel(i){ cart.splice(i,1); saveCart(); renderCart(); }
function cartSum(){ return cart.reduce((s,r)=>s + r.price*r.qty, 0); }
function renderCart(){
  const list=$("#cart"), empty=$("#cart-empty");
  list.innerHTML="";
  if(!cart.length){ empty.style.display="block"; $("#sum").textContent="0 zł"; return; }
  empty.style.display="none";

  cart.forEach((r,i)=>{
    const row=document.createElement("div");
    row.className="row";
    row.style.alignItems="center";
    row.innerHTML = `
      <div style="flex:1">${r.name} <span class="chip small">${r.sku}</span></div>
      <input type="number" min="1" value="${r.qty}" data-i="${i}" class="field" style="max-width:80px">
      <div style="width:110px;text-align:right">${money(r.price*r.qty)}</div>
      <button class="btn ghost" data-del="${i}">Usuń</button>`;
    list.appendChild(row);
  });

  list.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.addEventListener("input",()=>{
      const i=+inp.dataset.i, v=Math.max(1, +inp.value||1);
      cart[i].qty=v; saveCart(); renderCart();
    });
  });
  list.querySelectorAll("[data-del]").forEach(btn=>btn.addEventListener("click",()=>cartDel(+btn.dataset.del)));

  $("#sum").textContent = money(cartSum());
}
$("#cart-clear").addEventListener("click",()=>{ if(confirm("Wyczyścić koszyk?")){ cart=[]; saveCart(); renderCart(); }});
$("#cart-export").addEventListener("click",()=>{
  if(!cart.length){ alert("Koszyk pusty."); return; }
  const header="sku;nazwa;cena;ilosc;wartosc\n";
  const rows=cart.map(r=>[r.sku,csvEscape(r.name),String(r.price).replace(".",","),r.qty,String(r.price*r.qty).replace(".",",")].join(";")).join("\n");
  const blob = new Blob([header+rows],{type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="koszyk-komponenty.csv"; a.click(); URL.revokeObjectURL(url);
});

/* ====== Import/Eksport listy ====== */
$("#export-json").addEventListener("click",()=>{
  const blob=new Blob([JSON.stringify(items,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="komponenty.json"; a.click(); URL.revokeObjectURL(url);
});
$("#import-json").addEventListener("change",async (e)=>{
  const f=e.target.files[0]; e.target.value="";
  if(!f) return;
  try{
    const obj=JSON.parse(await f.text());
    if(!Array.isArray(obj)) throw new Error("Zły format (oczekuję tablicy).");
    // Walidacja bardzo prosta
    items=obj.map(x=>({sku:String(x.sku),name:String(x.name),category:String(x.category),price:+x.price||0}));
    saveItems(); state.page=1; renderList();
  }catch(err){ alert("Błąd importu JSON: "+err.message); }
});
$("#export-csv").addEventListener("click",()=>{
  const header="sku;nazwa;kategoria;cena\n";
  const rows=items.map(i=>[i.sku,csvEscape(i.name),csvEscape(i.category),String(i.price).replace(".",",")].join(";")).join("\n");
  const blob=new Blob([header+rows],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="komponenty.csv"; a.click(); URL.revokeObjectURL(url);
});
$("#import-csv").addEventListener("change",async (e)=>{
  const f=e.target.files[0]; e.target.value="";
  if(!f) return;
  const text = await f.text();
  // prosty parser CSV (separator ; )
  const lines=text.trim().split(/\r?\n/);
  const data=[];
  for(let i=0;i<lines.length;i++){
    let line = lines[i];
    if(i===0 && /sku/i.test(line) && /nazwa/i.test(line)) continue; // pomiń nagłówek
    const cols = [];
    let cur="", inq=false;
    for(let c of line){
      if(c=='"'){ inq=!inq; continue; }
      if(c==';' && !inq){ cols.push(cur); cur=""; } else cur+=c;
    }
    cols.push(cur);
    const [sku,name,category,price] = cols;
    if(!sku) continue;
    data.push({sku:sku.trim(),name:(name||"").trim(),category:(category||"").trim(),price:parseFloat(String(price).replace(",","."))||0});
  }
  items = data; saveItems(); state.page=1; renderList();
});

/* ====== Zdarzenia filtrów ====== */
$("#q").addEventListener("input",()=>{ state.q=$("#q").value; state.page=1; renderList(); });
$("#cat").addEventListener("change",()=>{ state.cat=$("#cat").value; state.page=1; renderList(); });
$("#sort").addEventListener("change",()=>{ state.sort=$("#sort").value; renderList(); });
$("#min").addEventListener("input",()=>{ state.min=$("#min").value; state.page=1; renderList(); });
$("#max").addEventListener("input",()=>{ state.max=$("#max").value; state.page=1; renderList(); });
$("#clear").addEventListener("click",()=>{
  state.q=""; state.cat="__all"; state.sort="name_asc"; state.min=""; state.max=""; state.page=1;
  $("#q").value=""; $("#cat").value="__all"; $("#sort").value="name_asc"; $("#min").value=""; $("#max").value="";
  renderList();
});

/* ====== Zdarzenia form ====== */
$("#save").addEventListener("click",saveForm);
$("#reset").addEventListener("click",clearForm);

/* ====== Paginacja ====== */
$("#prev").addEventListener("click",()=>{ state.page=Math.max(1,state.page-1); renderList(); });
$("#next").addEventListener("click",()=>{ state.page=state.page+1; renderList(); });

/* ====== Boot ====== */
renderList();
renderCart();
</script>
</body>
</html>
